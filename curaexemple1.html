<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DebtRelief Solutions - Your Path to Financial Freedom</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .slider-thumb { -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; background: #2563eb; cursor: pointer; margin-top: -10px; border: 4px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,.2); }
    input[type=range]::-webkit-slider-runnable-track { height: 8px; background: #e5e7eb; border-radius: 9999px; }
    .chat-overlay { position: fixed; inset: 0; background: rgba(17,24,37,.7); backdrop-filter: blur(2px); display:none; z-index:60; }
    .chat-sheet { position:absolute; inset:0; display:grid; place-items:center; }
    .chat-panel { width:100%; max-width:920px; height:88vh; background:#fff; border-radius:18px; box-shadow: 0 25px 60px rgba(0,0,0,.25); display:grid; grid-template-rows:auto 1fr auto; overflow:hidden; }
    .chat-header { display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid #e5e7eb; background:#f9fafb; }
    .agent-avatar { width:44px; height:44px; border-radius:9999px; background:#dbeafe url('https://placehold.co/88x88/1d4ed8/ffffff?text=L') center/cover no-repeat; box-shadow: inset 0 0 0 1px #93c5fd; }
    .chat-body { padding:18px; overflow-y:auto; background:#f3f4f6; }
    .bubble { max-width:75%; padding:12px 14px; border-radius:16px; margin:6px 0; font-size:15px; line-height:1.45; box-shadow:0 1px 1px rgba(0,0,0,.06);}
    .bot { background:#fff; color:#111827; border-top-left-radius:6px; }
    .me { background:#2563eb; color:#fff; border-top-right-radius:6px; margin-left:auto; }
    .chat-footer { padding:14px; border-top:1px solid #e5e7eb; background:#fff; }
    .choice { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:9999px; background:#1f2937; color:#fff; font-weight:600; margin:6px 6px 0 0; cursor:pointer; }
    .choice.primary { background:#2563eb; }
    .mini { font-size:12px; color:#6b7280; }
    .hidden { display:none; }
    .error-tooltip{position:absolute;top:50%;left:105%;transform:translateY(-50%);background:#fef2f2;border:1px solid #ef4444;color:#b91c1c;font-size:.75rem;padding:.5rem;border-radius:.5rem;white-space:nowrap;z-index:10;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <iframe name="hidden_post_target" id="hidden_post_target" style="display:none;"></iframe>

  <!-- Hidden POST (CuraDebt) -->
  <form id="hidden-curadebt-post" action="https://signup.curadebt.com/apkconnect/" method="POST" target="hidden_post_target" style="display:none;">
    <input name="f_fname"><input name="f_lname"><input name="f_email"><input name="f_phone">
    <input name="f_whereyoulive"><input name="f_totaldebt">
    <input name="f_comments" value="Lead from DebtRelief Solutions Funnel">
    <input name="data1"><input name="data2" value="CLICKID2">
    <input name="f_ip"><input name="f_mobilephone"><input name="f_city"><input name="f_zip">
  </form>

  <!-- Hidden POST (TrackDrive) -->
  <form id="hidden-trackdrive-post" action="https://estherkasinde.trackdrive.com/api/v1/leads" method="POST" target="hidden_post_target" style="display:none;">
    <input name="lead_token" value="3346b0458309406ba4b8beac90a8a532">
    <input name="caller_id"><input name="first_name"><input name="last_name"><input name="email"><input name="state">
    <input name="unsecured_debt_total"><input name="traffic_source_id" value="1000">
    <input name="ip_address"><input name="source_url"><input name="useragent">
    <input name="gclid"><input name="fbeventid"><input name="msclkid">
    <input name="call_now" value="1"><input name="tcpa_opt_in" value="true"><input name="tcpa_optin_consent_language">
    <input name="email_unverified" value="0"><input name="otp_verified" value="0">
    <input name="click_id">
  </form>

  <div id="landing-page">
    <header class="bg-white shadow-sm sticky top-0 z-50">
      <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-blue-700">DebtRelief Solutions</h1>
        <a href="#estimator" class="hidden md:inline-block bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition duration-300">Get a Free Estimate</a>
      </nav>
    </header>

    <main>
      <section id="estimator" class="bg-white py-16 md:py-24">
        <div class="container mx-auto px-6 text-center">
          <div class="max-w-3xl mx-auto">
            <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight">Free Debt Relief Consultation. See If You Qualify In 1 Minute.</h2>
            <p class="mt-4 text-lg text-gray-600">Take the first step towards financial freedom today.</p>
          </div>

          <div class="mt-12 max-w-2xl mx-auto bg-gray-100 rounded-2xl shadow-lg p-8">
            <label for="debt-slider" class="text-xl font-semibold text-gray-700">Select Amount Of Credit Card & Personal Loan Debts</label>
            <p id="debt-amount-display" class="text-6xl font-bold text-blue-600 my-4">$25,000</p>
            <input type="range" id="debt-slider" min="0" max="100000" value="25000" step="100" class="w-full slider-thumb">
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 items-center gap-3">
              <label class="text-sm text-gray-700 sm:col-span-1" for="debt-number">Or type exact amount</label>
              <input type="text" id="debt-number" inputmode="numeric" placeholder="e.g. 12,450" class="sm:col-span-2 w-full p-3 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500" value="25,000">
            </div>
            <p id="slider-text" class="text-sm text-gray-600 mt-2 text-center hidden"></p>
            <p id="move-hint" class="text-sm text-yellow-700 mt-2">Move the slider to confirm your amount.</p>
            <div id="qualify-msg" class="text-sm text-red-600 mt-2 hidden">You don’t qualify for the program. A minimum of $10,000 is required.</div>

            <!-- NOTE: novalidate removes native balloons; we show our own messages -->
            <form id="lead-form" novalidate class="mt-8" method="POST" action="https://signup.curadebt.com/apkconnect/">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="relative">
                  <input type="text" id="first-name" name="f_fname" placeholder="First Name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition">
                  <span id="first-name-error-tooltip" class="error-tooltip hidden">Please fill out this field.</span>
                </div>
                <div class="relative">
                  <input type="text" id="last-name" name="f_lname" placeholder="Last Name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition">
                  <span id="last-name-error-tooltip" class="error-tooltip hidden">Please fill out this field.</span>
                </div>
              </div>

              <div class="relative">
                <input type="email" id="email" name="f_email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-md mb-1 focus:ring-2 focus:ring-blue-500 transition">
                <span id="email-error-tooltip" class="error-tooltip hidden">Please fill out this field.</span>
              </div>
              <div id="email-hint" class="text-xs mb-3 text-gray-500"></div>

              <div class="relative">
                <select id="state" name="f_whereyoulive" class="w-full p-3 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 transition bg-white">
                  <option value="" disabled selected>Select Your State</option>
                </select>
                <span id="state-error-tooltip" class="error-tooltip hidden">Please fill out this field.</span>
              </div>

              <div class="relative">
                <input type="tel" id="phone" name="f_phone" placeholder="Phone Number" class="w-full p-3 border border-gray-300 rounded-md mb-1 focus:ring-2 focus:ring-blue-500 transition">
                <span id="phone-error-tooltip" class="error-tooltip hidden">Please fill out this field.</span>
              </div>
              <div id="phone-hint" class="text-xs text-gray-500"></div>

              <!-- OTP UI -->
              <div id="otp-ui" class="mt-2">
                <button type="button" id="send-otp" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">
                  Send verification code
                </button>
                <div id="otp-verify" class="hidden mt-2 flex gap-2 items-center">
                  <input id="otp-code" class="border p-2 rounded w-40" placeholder="6-digit code" maxlength="6" />
                  <button type="button" id="check-otp" class="px-3 py-2 rounded bg-green-600 text-white text-sm" disabled>
                    Verify
                  </button>
                  <span id="otp-status" class="text-xs text-gray-600"></span>
                </div>
                <!-- reCAPTCHA container (invisible) -->
                <div id="recaptcha-container" style="height:0;width:0;overflow:hidden;"></div>
              </div>

              <div class="relative">
                <label class="flex items-start gap-3 text-sm text-gray-700 mt-4 mb-4">
                  <input type="checkbox" id="tcpa" class="mt-1 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                  <span>
                    By clicking “See My Savings Estimate”, you agree to be contacted by
                    <strong>CuraDebt</strong> and its partners at the number and email provided
                    (including via <strong>automated dialing/texts and prerecorded messages</strong>).
                    <strong>Your consent is not required to make a purchase</strong>. Message/data rates may apply.
                  </span>
                </label>
                <span id="tcpa-error-tooltip" class="error-tooltip hidden">Please agree to continue.</span>
              </div>

              <!-- Hidden fields -->
              <input type="hidden" id="f_totaldebt" name="f_totaldebt" value="">
              <input type="hidden" id="f_mobilephone" name="f_mobilephone" value="">
              <input type="hidden" id="f_city" name="f_city" value="">
              <input type="hidden" id="f_zip" name="f_zip" value="">
              <input type="hidden" id="f_comments" name="f_comments" value="Lead from DebtRelief Solutions Funnel">
              <input type="hidden" id="data1" name="data1" value="">
              <input type="hidden" id="data2" name="data2" value="">
              <input type="hidden" id="f_ip" name="f_ip" value="">
              <input type="hidden" id="consent_text" name="consent_text" value="">
              <input type="hidden" id="consent_ts" name="consent_ts" value="">

              <button type="submit" id="submit-button" class="w-full bg-red-600 text-white font-bold text-lg py-4 rounded-lg hover:bg-red-700 transition duration-300 transform hover:scale-105" disabled>
                See My Savings Estimate →
              </button>
              <div id="form-error" class="text-red-600 font-semibold mt-4 text-center hidden"></div>
            </form>
          </div>
        </div>
      </section>

      <!-- (Your Steps / Testimonials / FAQ sections here — unchanged from your last paste) -->
      <!-- … -->
    </main>

    <footer class="bg-gray-800 text-white">
      <div class="container mx-auto px-6 py-8 text-center">
        <p>&copy; 2025 DebtRelief Solutions. All Rights Reserved.</p>
        <div class="mt-4">
          <a href="#" class="text-gray-400 hover:text-white mx-2">Privacy Policy</a>
          <a href="#" class="text-gray-400 hover:text-white mx-2">Terms of Service</a>
        </div>
      </div>
    </footer>
  </div>

  <!-- Chat Overlay -->
  <div id="chat-overlay" class="chat-overlay" aria-modal="true" role="dialog">
    <div class="chat-sheet">
      <div class="chat-panel">
        <div class="chat-header">
          <div class="agent-avatar" id="agent-avatar" aria-hidden="true"></div>
          <div>
            <div class="text-xs text-gray-500 leading-none">Customer Support Specialist</div>
            <div class="font-semibold leading-none" id="agent-name">Laura</div>
            <div class="mini">Live connect in ~1 minute (toll-free)</div>
          </div>
          <div class="ml-auto text-xs text-gray-500">Closes after you confirm</div>
        </div>
        <div id="chat-body" class="chat-body" tabindex="0"></div>
        <div id="chat-footer" class="chat-footer"></div>
      </div>
    </div>
  </div>

  <script type="module">
    /********** CONFIG **********/
    const TD_DEBUG = true;
    const TRACKDRIVE_POST_URL = "https://estherkasinde.trackdrive.com/api/v1/leads"; // keep if your account uses lead_token param
    const TD_TRAFFIC_SOURCE_ID = "1000";
    const VALIDATE_PHONE_ENDPOINT = "https://silent-sea-a717.kasindeesther.workers.dev/";
    const VALIDATE_EMAIL_ENDPOINT = "https://solitary-base-4a8b.kasindeesther.workers.dev/";

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    const app = initializeApp({
      apiKey: "AIzaSyBF5wdHyOlOi_bntJHXto7f6RbJMkOdMSE",
      authDomain: "otp-c6311.firebaseapp.com",
      projectId: "otp-c6311",
      storageBucket: "otp-c6311.firebasestorage.app",
      messagingSenderId: "637495517002",
      appId: "1:637495517002:web:7bd220994a7611a5606bb3"
    });
    const auth = getAuth(app);

    /********** DOM **********/
    const debtSlider = document.getElementById("debt-slider");
    const debtAmountDisplay = document.getElementById("debt-amount-display");
    const debtNumber = document.getElementById("debt-number");
    const moveHint = document.getElementById("move-hint");
    const qualifyMsg = document.getElementById("qualify-msg");
    const stateSelect = document.getElementById("state");
    const formError = document.getElementById("form-error");
    const submitButton = document.getElementById("submit-button");
    const leadForm = document.getElementById("lead-form");
    const hiddenCuraForm = document.getElementById("hidden-curadebt-post");
    const hiddenTDForm = document.getElementById("hidden-trackdrive-post");
    const phoneInput = document.getElementById("phone");
    const emailInput = document.getElementById("email");
    const emailHint = document.getElementById("email-hint");
    const phoneHint = document.getElementById("phone-hint");
    const sliderText = document.getElementById("slider-text");
    const chatOverlay = document.getElementById("chat-overlay");
    const chatBody = document.getElementById("chat-body");
    const chatFooter = document.getElementById("chat-footer");
    const sendBtn = document.getElementById("send-otp");
    const verifyBox = document.getElementById("otp-verify");
    const checkBtn = document.getElementById("check-otp");
    const otpCodeInput = document.getElementById("otp-code");
    const otpStatusEl = document.getElementById("otp-status");

    /********** HELPERS **********/
    const TD_STATES_EXCLUDED = ['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','WY'];
    const ALL_STATES = ["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"];
    ALL_STATES.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSelect.appendChild(o); });

    const fmtMoney = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0}).format(n);
    const toInt = (s)=>{ const n=parseInt(String(s||'').replace(/[^\d]/g,''),10); return isNaN(n)?0:n; };
    const digitsOnly = (s)=> String(s||'').replace(/\D+/g,'');
    const params = new URLSearchParams(location.search);
    const clickId = ()=> params.get('data1') || params.get('click_id') || params.get('gclid') || params.get('fbclid') || params.get('msclkid') || 'no_click_id';

    let debugBox;
    if (TD_DEBUG) {
      debugBox = document.createElement('div');
      debugBox.style.cssText='position:fixed;right:12px;bottom:12px;max-width:360px;background:#111827;color:#e5e7eb;padding:10px 12px;border-radius:12px;font:12px/1.4 monospace;z-index:70;opacity:.9;';
      debugBox.innerHTML='<b>TD Debug</b><div id="dbg"></div>';
      document.body.appendChild(debugBox);
    }
    function dbg(msg){ if(TD_DEBUG){ document.getElementById('dbg').innerHTML += `<div>${String(msg).replace(/[<>]/g,m=>({"<":"&lt;",">":"&gt;"}[m]))}</div>`; } }

    function parseNANPtoE164US(raw){
      const d = digitsOnly(raw);
      const m = d.match(/^1?([2-9]\d{2})([2-9]\d{2})(\d{4})$/);
      if(!m) return null;
      const [ , a,b,c ] = m;
      if(/^[2-9]11$/.test(a) || /^[2-9]11$/.test(b)) return null; // N11s
      if(a==='900') return null;
      if(b==='555' && /^01\d{2}$/.test(c)) return null;
      const ten = a+b+c;
      if(/^(\d)\1{9}$/.test(ten)) return null;
      return `+1${a}${b}${c}`;
    }

    async function validatePhoneServer(e164){
      try{
        const r = await fetch(VALIDATE_PHONE_ENDPOINT,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone: e164 }) });
        const j = await r.json();
        return j.ok ? { ok:true, ...j } : { ok:false, error:j.error||'Validation failed' };
      }catch{ return { ok:true }; }
    }
    async function validateEmailServer(email){
      try{
        const r = await fetch(VALIDATE_EMAIL_ENDPOINT,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        const j = await r.json();
        return typeof j.ok==='boolean' ? j : { ok: /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) };
      }catch{ return { ok: /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) }; }
    }

    function addBubble(t, who='bot'){ const d=document.createElement('div'); d.className=`bubble ${who==='bot'?'bot':'me'}`; d.innerHTML=t; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight; }
    function setChoices(choices){ chatFooter.innerHTML=''; choices.forEach(({label,primary,onClick})=>{ const b=document.createElement('button'); b.type='button'; b.className=`choice ${primary?'primary':''}`; b.textContent=label; b.onclick=onClick; chatFooter.appendChild(b); }); }
    function openChat(){ document.getElementById('chat-overlay').style.display='block'; setTimeout(()=> chatBody.focus(), 50); }
    function closeChat(){ document.getElementById('chat-overlay').style.display='none'; chatFooter.innerHTML=''; chatBody.innerHTML=''; }
    function ensureInput(form, name){ let el=form.querySelector(`[name="${name}"]`); if(!el){ el=document.createElement('input'); el.type='hidden'; el.name=name; form.appendChild(el); } return el; }

    // Slider + amount
    function applyAmount(raw){
      const v=Math.max(0,Math.min(100000,toInt(raw)));
      debtSlider.value=v; debtNumber.value=v.toLocaleString('en-US');
      debtAmountDisplay.textContent = v>=100000 ? `${fmtMoney(v)}+` : fmtMoney(v);
      document.getElementById('f_totaldebt').value=String(v);
      const qualifies=v>=10000;
      if (qualifyMsg) qualifyMsg.classList.toggle('hidden', qualifies);
      if (moveHint) moveHint.classList.add('hidden'); if (document.getElementById('slider-text')){ const st=document.getElementById('slider-text'); st.classList.remove('hidden'); st.textContent = qualifies ? `Your selected debt is ${fmtMoney(v)}.` : `You are below the minimum qualifying amount of ${fmtMoney(10000)}.`; }
      updateSubmitEnabled();
    }
    debtSlider.addEventListener('input', ()=>applyAmount(debtSlider.value));
    debtNumber.addEventListener('input', ()=>applyAmount(debtNumber.value));
    debtNumber.addEventListener('blur', ()=> debtNumber.value = toInt(debtNumber.value).toLocaleString('en-US'));
    applyAmount(debtSlider.value);

    // IP
    let clientIp = '';
    const ipPromise = fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(j=>{ clientIp=j.ip||''; }).catch(()=>{ clientIp=''; });

    // Hints
    emailInput.addEventListener('blur', async ()=>{
      if(!emailInput.value){ emailHint.textContent=''; return; }
      emailHint.textContent = 'Checking email…';
      const res = await validateEmailServer(emailInput.value.trim());
      emailHint.textContent = res.ok ? '✅ Looks good' : `❌ ${res.error || 'Invalid email'}`;
    });
    phoneInput.addEventListener('blur', async ()=>{
      if(!phoneInput.value){ phoneHint.textContent=''; return; }
      phoneHint.textContent='Checking number…';
      const e164=parseNANPtoE164US(phoneInput.value);
      if(!e164){ phoneHint.textContent='❌ Enter a valid US number.'; return; }
      const res = await validatePhoneServer(e164);
      phoneHint.textContent = res.ok ? `✅ ${e164}` : `❌ ${res.error}`;
    });

    // Enable/disable submit
    window.otpOK = false;
    function updateSubmitEnabled(){
      const amountOK = Number(document.getElementById('f_totaldebt').value||'0') >= 10000;
      const stateOK = stateSelect.value && !TD_STATES_EXCLUDED.includes(stateSelect.value);
      const consentOK = document.getElementById('tcpa').checked;
      const basicOK = firstName.value && lastName.value && emailInput.value && phoneInput.value;
      submitButton.disabled = !(amountOK && stateOK && consentOK && basicOK && window.otpOK);
      submitButton.textContent = submitButton.disabled ? 'Verify your phone to continue' : 'See My Savings Estimate →';
    }
    ['change','input'].forEach(ev=>{
      stateSelect.addEventListener(ev, updateSubmitEnabled);
      document.getElementById('tcpa').addEventListener(ev, updateSubmitEnabled);
      ['first-name','last-name','email','phone'].forEach(id=> document.getElementById(id).addEventListener(ev, ()=>{
        if(id==='phone'){ window.otpOK=false; otpStatusEl.textContent=''; }
        updateSubmitEnabled();
      }));
    });
    const firstName=document.getElementById('first-name');
    const lastName=document.getElementById('last-name');

    // OTP — Recaptcha + send + verify
    let recaptchaVerifier, confirmationResult;
    function initRecaptcha(){
      if (recaptchaVerifier) return recaptchaVerifier;
      recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size:'invisible' });
      // Render ensures the widget exists before we use it
      return recaptchaVerifier.render().then(()=>recaptchaVerifier);
    }

    sendBtn.addEventListener('click', async ()=>{
      const e164=parseNANPtoE164US(phoneInput.value);
      otpStatusEl.className='text-xs text-gray-600';
      if(!e164){ otpStatusEl.textContent='Enter a valid US number.'; return; }
      otpStatusEl.textContent='Sending code…'; sendBtn.disabled=true;
      try{
        await initRecaptcha();
        confirmationResult = await signInWithPhoneNumber(auth, e164, recaptchaVerifier);
        verifyBox.classList.remove('hidden');
        otpStatusEl.textContent='Code sent. Check SMS.';
      }catch(e){
        console.error('OTP send error:', e);
        otpStatusEl.textContent = `Failed to send (${e?.code||'unknown'}).`;
      }finally{ sendBtn.disabled=false; }
    });

    otpCodeInput.addEventListener('input', ()=> checkBtn.disabled = (otpCodeInput.value.trim().length!==6) );
    checkBtn.addEventListener('click', async ()=>{
      const code = otpCodeInput.value.trim();
      if(!confirmationResult){ otpStatusEl.textContent='Click “Send verification code” first.'; return; }
      otpStatusEl.textContent='Verifying…'; checkBtn.disabled=true;
      try{
        await confirmationResult.confirm(code);
        window.otpOK=true;
        otpStatusEl.textContent='Verified ✓';
        otpStatusEl.className='text-xs text-green-700';
      }catch(e){
        window.otpOK=false;
        console.error('OTP verify error:', e);
        otpStatusEl.textContent='Verification failed. Try again.';
        otpStatusEl.className='text-xs text-red-700';
      }finally{
        updateSubmitEnabled();
        checkBtn.disabled=false;
      }
    });

    // Remove native balloons by preventing default submit and handling ourselves
    leadForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      formError.classList.add('hidden');

      // simple front-end check
      const amount = Number(document.getElementById('f_totaldebt').value||'0');
      if(amount<10000){ formError.textContent='Minimum debt of $10,000 is required to qualify.'; formError.classList.remove('hidden'); return; }
      if(!stateSelect.value || TD_STATES_EXCLUDED.includes(stateSelect.value)){ formError.textContent='Unfortunately, we do not service your state.'; formError.classList.remove('hidden'); return; }
      if(!document.getElementById('tcpa').checked){ formError.textContent='Please agree to the consent to continue.'; formError.classList.remove('hidden'); return; }
      if(!window.otpOK){ formError.textContent='Please verify your phone to continue.'; formError.classList.remove('hidden'); return; }

      // deep checks
      const e164=parseNANPtoE164US(phoneInput.value);
      if(!e164){ formError.textContent='Enter a valid US number.'; formError.classList.remove('hidden'); return; }
      const [emailRes, phoneRes] = await Promise.all([
        validateEmailServer(emailInput.value.trim()),
        validatePhoneServer(e164)
      ]);
      if(!emailRes.ok){ formError.textContent=emailRes.error||'Invalid email.'; formError.classList.remove('hidden'); return; }
      if(!phoneRes.ok){ formError.textContent=phoneRes.error||'Invalid phone.'; formError.classList.remove('hidden'); return; }

      submitButton.disabled=true; submitButton.textContent='Submitting…';
      await ipPromise;

      // ---- Post to CuraDebt (hidden iframe) ----
      const fd = new FormData(leadForm);
      hiddenCuraForm.elements['f_fname'].value  = fd.get('f_fname') || '';
      hiddenCuraForm.elements['f_lname'].value  = fd.get('f_lname') || '';
      hiddenCuraForm.elements['f_email'].value  = emailInput.value.trim();
      hiddenCuraForm.elements['f_phone'].value  = e164.replace('+1','');
      hiddenCuraForm.elements['f_whereyoulive'].value = stateSelect.value || '';
      hiddenCuraForm.elements['f_totaldebt'].value  = String(amount);
      hiddenCuraForm.elements['data1'].value  = clickId();
      hiddenCuraForm.elements['f_ip'].value   = clientIp;
      hiddenCuraForm.submit();

      // ---- Confirm + TrackDrive ----
      openChat();
      addBubble(`Hi <b>${fd.get('f_fname')}</b> — thanks! Confirm your details below.`, 'bot');
      addBubble(`<b>Name</b>: ${fd.get('f_fname')} ${fd.get('f_lname')}<br><b>Email</b>: ${emailInput.value.trim()}<br><b>Phone</b>: ${e164}<br><b>State</b>: ${stateSelect.value}<br><b>Unsecured Debt</b>: ${fmtMoney(amount)}`, 'bot');
      setChoices([
        { label:'Confirm & Connect Me Now', primary:true, onClick: ()=>{
            // Fill TD form and submit via iframe
            hiddenTDForm.setAttribute('action', TRACKDRIVE_POST_URL);
            ensureInput(hiddenTDForm, 'caller_id').value = e164;
            ensureInput(hiddenTDForm, 'first_name').value = fd.get('f_fname') || '';
            ensureInput(hiddenTDForm, 'last_name').value  = fd.get('f_lname') || '';
            ensureInput(hiddenTDForm, 'email').value      = emailInput.value.trim();
            ensureInput(hiddenTDForm, 'state').value      = stateSelect.value || '';
            ensureInput(hiddenTDForm, 'unsecured_debt_total').value = String(amount);
            ensureInput(hiddenTDForm, 'traffic_source_id').value = "1000";
            ensureInput(hiddenTDForm, 'ip_address').value = clientIp || '';
            ensureInput(hiddenTDForm, 'source_url').value = location.href;
            ensureInput(hiddenTDForm, 'useragent').value  = navigator.userAgent || '';
            ensureInput(hiddenTDForm, 'gclid').value      = params.get('gclid')||'';
            ensureInput(hiddenTDForm, 'fbeventid').value  = params.get('fbclid')||'';
            ensureInput(hiddenTDForm, 'msclkid').value    = params.get('msclkid')||'';
            ensureInput(hiddenTDForm, 'tcpa_opt_in').value = 'true';
            ensureInput(hiddenTDForm, 'tcpa_optin_consent_language').value = document.querySelector('label[for="tcpa"] + span')?.innerText || 'TCPA consent captured';
            ensureInput(hiddenTDForm, 'call_now').value   = '1';
            ensureInput(hiddenTDForm, 'otp_verified').value = '1';
            ensureInput(hiddenTDForm, 'click_id').value   = clickId();

            if (TD_DEBUG){
              dbg('Posting to TrackDrive…');
              Array.from(hiddenTDForm.elements).forEach(el=>{ if(el.name){ dbg(`${el.name}: ${el.value}`); } });
            }
            hiddenTDForm.submit();
            addBubble('Great — connecting you now. If you see a toll-free caller ID, that’s us.', 'bot');
            setChoices([{ label:'Okay', primary:true, onClick: ()=> { closeChat(); submitButton.disabled=false; submitButton.textContent='Submitted ✔'; } }]);
          }},
        { label:'Edit Info', onClick: ()=>{ closeChat(); submitButton.disabled=false; updateSubmitEnabled(); } }
      ]);
    });

    // Initial state
    updateSubmitEnabled();
    // Show OTP verify UI when a code is sent
    verifyBox.classList.add('hidden');
  </script>
</body>
</html>
