<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OCR Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tesseract.js v5 -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<main class="max-w-xl mx-auto px-4 py-10 space-y-4">

  <div class="rounded-2xl border border-slate-200 bg-white p-5 space-y-3">
    <div class="flex items-center justify-between">
      <h1 class="font-semibold">OCR Debug</h1>
      <span class="text-xs text-slate-500 mono" id="env"></span>
    </div>

    <div class="text-xs text-slate-600">
      If OCR fails, the error message below will tell you exactly why.
    </div>

    <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
      <div class="flex items-center justify-between">
        <span class="text-xs text-slate-600">Progress</span>
        <span id="pct" class="text-xs text-slate-600 mono">0%</span>
      </div>
      <div class="mt-2 h-2 rounded-full bg-slate-200 overflow-hidden">
        <div id="bar" class="h-full bg-indigo-600" style="width:0%"></div>
      </div>
      <p id="msg" class="text-xs text-slate-600 mt-2"></p>
      <p id="err" class="text-xs text-red-600 mt-1"></p>
    </div>

    <div class="space-y-2">
      <input id="file" type="file" accept="image/*"
        class="block w-full text-sm text-slate-700 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:text-sm file:font-semibold hover:file:bg-slate-200"/>

      <button id="run" class="w-full rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-40" disabled>
        Run OCR
      </button>
    </div>

    <div class="rounded-xl border border-slate-200 bg-white p-3">
      <p class="text-xs text-slate-600">Text output:</p>
      <pre id="out" class="text-xs text-slate-800 whitespace-pre-wrap mt-2"></pre>
    </div>
  </div>

</main>

<script>
  const env = document.getElementById("env");
  const pct = document.getElementById("pct");
  const bar = document.getElementById("bar");
  const msg = document.getElementById("msg");
  const err = document.getElementById("err");
  const out = document.getElementById("out");
  const file = document.getElementById("file");
  const run = document.getElementById("run");

  env.textContent = location.protocol;

  function setProgress(p, m) {
    const v = Math.max(0, Math.min(100, Math.round(p)));
    pct.textContent = v + "%";
    bar.style.width = v + "%";
    if (m) msg.textContent = m;
  }

  let worker = null;

  async function getWorker() {
    if (location.protocol === "file:") {
      throw new Error("You are using file:// . Upload/host this page on HTTPS (https://) and try again.");
    }
    if (!window.Tesseract) throw new Error("Tesseract.js did not load (check adblock / network).");
    if (worker) return worker;

    // ✅ Most reliable: language data from @tesseract.js-data package
    // This provides: eng.traineddata.gz
    const LANG_PATH = "https://cdn.jsdelivr.net/npm/@tesseract.js-data/eng/4.0.0_best/";

    worker = await Tesseract.createWorker({
      logger: m => {
        if (m.status === "loading tesseract core") setProgress(5, "Loading OCR core…");
        if (m.status === "loading language traineddata") setProgress(12, "Loading language data…");
        if (m.status === "initializing tesseract") setProgress(18, "Initializing OCR…");
        if (m.status === "recognizing text") setProgress(25 + (m.progress || 0) * 75, "Recognizing text…");
      },
      workerPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",
      corePath:   "https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js",
      langPath:   LANG_PATH
    });

    await worker.loadLanguage("eng");
    await worker.initialize("eng");

    // Better for subject lines
    try { await worker.setParameters({ tessedit_pageseg_mode: "6" }); } catch {}

    return worker;
  }

  file.addEventListener("change", () => {
    err.textContent = "";
    out.textContent = "";
    setProgress(0, "");
    run.disabled = !(file.files && file.files[0]);
  });

  run.addEventListener("click", async () => {
    err.textContent = "";
    out.textContent = "";
    setProgress(1, "Starting…");

    try {
      const w = await getWorker();
      const f = file.files[0];
      const { data } = await w.recognize(f);
      setProgress(100, "Done.");
      out.textContent = (data && data.text) ? data.text : "";
    } catch (e) {
      setProgress(0, "Failed.");
      err.textContent = String(e?.message || e || "Unknown error");
    }
  });

  window.addEventListener("beforeunload", async () => {
    try { if (worker) await worker.terminate(); } catch {}
  });
</script>
</body>
</html>
