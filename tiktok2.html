<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Survey</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { border: 1px solid rgb(226 232 240); border-radius: 18px; }
    input[type="radio"] { width: 16px; height: 16px; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<main class="max-w-xl mx-auto px-4 py-10">

  <!-- MAIN -->
  <section class="card bg-white shadow-sm p-6 space-y-5">
    <div class="space-y-2">
      <p class="text-sm text-slate-600">App experience research study</p>
      <p class="text-lg font-semibold leading-snug">Help us understand first-time experience</p>
    </div>

    <div class="space-y-3 text-sm text-slate-700">
      <p>
        The purpose of this study is to understand how people who have
        <strong>not used TikTok before</strong> experience the app when they try it for the first time.
      </p>

      <p>
        Click the button below to open the download page in a new tab. After you finish,
        return here and complete the feedback questions.
      </p>

      <p class="text-xs text-slate-500">
        Tip: For the best OCR result, zoom in so the subject line is large, then take the screenshot.
      </p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <button id="btnOpen" type="button"
        class="rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition">
        Open download page
      </button>

      <button id="btnGoFeedback" type="button"
        class="rounded-xl px-4 py-3 text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition disabled:opacity-40 disabled:cursor-not-allowed"
        disabled>
        Continue to feedback
      </button>
    </div>

    <p id="hint" class="text-xs text-slate-500"></p>

    <!-- Upload + OCR preview -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4 space-y-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-sm font-semibold text-slate-900">Upload screenshot (required)</p>
          <p class="text-xs text-slate-600">
            Upload a screenshot of the welcome email/message you received. You can use “Read screenshot text”
            to confirm you selected the right image.
          </p>
        </div>
        <div class="text-xs text-slate-500 mono" id="statusChip"></div>
      </div>

      <input id="shot" type="file" accept="image/*"
        class="block w-full text-sm text-slate-700 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:text-sm file:font-semibold hover:file:bg-slate-200"/>

      <div id="previewWrap" class="hidden">
        <img id="preview" class="w-full rounded-xl border border-slate-200" alt="Preview"/>
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <button id="btnOcr" type="button"
          class="rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition disabled:opacity-40 disabled:cursor-not-allowed"
          disabled>
          Read screenshot text
        </button>

        <div class="flex-1 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
          <div class="flex items-center justify-between">
            <span class="text-xs text-slate-600">OCR status</span>
            <span id="ocrPct" class="text-xs text-slate-600 mono">—</span>
          </div>
          <p id="ocrMsg" class="text-xs text-slate-600 mt-2"></p>
        </div>
      </div>

      <div id="ocrResult" class="hidden rounded-xl border border-slate-200 bg-white p-3">
        <p class="text-xs text-slate-600">Detected text (preview):</p>
        <pre id="ocrText" class="text-xs text-slate-700 whitespace-pre-wrap mt-2"></pre>
      </div>
    </div>
  </section>

  <!-- FEEDBACK -->
  <section id="feedback" class="card bg-white shadow-sm p-6 mt-6 space-y-5 hidden">
    <div class="space-y-1">
      <p class="text-sm text-slate-600">Feedback</p>
      <p class="text-lg font-semibold">Tell us about your experience</p>
    </div>

    <div class="space-y-4">
      <div class="rounded-2xl border border-slate-200 p-4 space-y-2">
        <p class="font-semibold">What was your overall first impression?</p>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="very_positive"> Very positive</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="somewhat_positive"> Somewhat positive</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="neutral"> Neutral</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="somewhat_negative"> Somewhat negative</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="very_negative"> Very negative</label>
      </div>

      <div class="rounded-2xl border border-slate-200 p-4 space-y-2">
        <p class="font-semibold">How easy was sign-up?</p>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="very_easy"> Very easy</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="easy"> Easy</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="ok"> Okay</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="hard"> Difficult</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="very_hard"> Very difficult</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="did_not"> I didn’t complete sign-up</label>
      </div>

      <div class="rounded-2xl border border-slate-200 p-4 space-y-2">
        <p class="font-semibold">How likely are you to use it again?</p>
        <div class="flex gap-2">
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="1">1</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="2">2</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="3">3</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="4">4</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="5">5</label>
        </div>
        <p class="text-xs text-slate-500">1 = Not likely, 5 = Very likely</p>
      </div>
    </div>

    <button id="btnSubmit" type="button"
      class="w-full rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition disabled:opacity-40 disabled:cursor-not-allowed"
      disabled>
      Submit & finish
    </button>

    <p id="hint2" class="text-xs text-slate-500"></p>
  </section>

</main>

<script>
  // =========================
  // CONFIG
  // =========================
  const OFFER_BASE_URL = "https://smrturl.co/a/scd13071c18/86?s1="; // will append RID
  const COMPLETE_URL   = "https://connect.cloudresearch.com/participant/project/31CCC7C024/complete";

  // OCR.Space: https://ocr.space/ocrapi  (get a free API key)
  const OCR_SPACE_API_KEY = "PASTE_YOUR_OCRSPACE_KEY_HERE";

  // We will "detect" with fuzzy patterns for highlighted/ocr-messed text (display only)
  const TARGET_DISPLAY = "welcome to tiktok";

  // =========================
  // RID
  // =========================
  const qp = new URLSearchParams(location.search);
  let rid = qp.get("RID") || qp.get("transaction_id") || qp.get("s1") || sessionStorage.getItem("RID");
  if (!rid) rid = "tx_" + Date.now().toString(36) + Math.random().toString(36).slice(2);
  sessionStorage.setItem("RID", rid);

  const offerUrl = OFFER_BASE_URL + encodeURIComponent(rid);

  // =========================
  // DOM
  // =========================
  const btnOpen = document.getElementById("btnOpen");
  const btnGoFeedback = document.getElementById("btnGoFeedback");
  const hint = document.getElementById("hint");

  const shot = document.getElementById("shot");
  const previewWrap = document.getElementById("previewWrap");
  const preview = document.getElementById("preview");
  const statusChip = document.getElementById("statusChip");

  const btnOcr = document.getElementById("btnOcr");
  const ocrPct = document.getElementById("ocrPct");
  const ocrMsg = document.getElementById("ocrMsg");
  const ocrResult = document.getElementById("ocrResult");
  const ocrText = document.getElementById("ocrText");

  const feedback = document.getElementById("feedback");
  const btnSubmit = document.getElementById("btnSubmit");
  const hint2 = document.getElementById("hint2");

  let openedOnce = false;
  let currentPreviewUrl = null;

  function hasFile(){
    return !!(shot.files && shot.files[0]);
  }

  function normalizeOCR(s) {
    return (s || "")
      .toLowerCase()
      .replace(/\s+/g, " ")
      .replace(/[’‘]/g, "'")
      .replace(/[“”]/g, '"')
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  // Fuzzy patterns for common OCR errors on TikTok + highlights
  function looksLikeWelcomeToTikTok(text) {
    const t = normalizeOCR(text);

    const patterns = [
      /welcome\s+to\s+tiktok/,
      /welcome\s+to\s+tik\s+tok/,
      /welcome\s+to\s+tik\s*tok/,
      /welcome\s+to\s+tikto[kx]/,
      /welcome\s+to\s+tikt0k/,
      /welcome\s+to\s+tikrok/,
      /welcome\s+to\s+ti[kx]tok/,
      /welco?me\s+to\s+tiktok/,
    ];
    return patterns.some(rx => rx.test(t));
  }

  // =========================
  // Preprocess image for highlighted subject lines
  // - downscale
  // - crop top area (email header/subject)
  // - run two versions: original crop + black/white
  // =========================
  async function makeCrops(file) {
    const img = new Image();
    const url = URL.createObjectURL(file);
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });

    const maxW = 1200;
    const scale = Math.min(1, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    ctx.drawImage(img, 0, 0, w, h);

    // crop top ~38% (subject line area)
    const cropH = Math.round(h * 0.38);
    const crop = document.createElement("canvas");
    crop.width = w; crop.height = cropH;
    crop.getContext("2d", { willReadFrequently: true }).drawImage(canvas, 0, 0, w, cropH, 0, 0, w, cropH);

    // high-contrast / binarized copy to fight highlight blocks
    const bw = document.createElement("canvas");
    bw.width = w; bw.height = cropH;
    const bctx = bw.getContext("2d", { willReadFrequently: true });
    bctx.drawImage(crop, 0, 0);

    const imgData = bctx.getImageData(0, 0, w, cropH);
    const d = imgData.data;

    // contrast + threshold (tuned for email UI)
    for (let i = 0; i < d.length; i += 4) {
      const r = d[i], g = d[i+1], b = d[i+2];
      const gray = 0.299*r + 0.587*g + 0.114*b;

      // boost contrast
      const c = (gray - 128) * 1.8 + 128;

      // adaptive-ish threshold
      const v = c > 165 ? 255 : 0;

      d[i] = d[i+1] = d[i+2] = v;
    }
    bctx.putImageData(imgData, 0, 0);

    URL.revokeObjectURL(url);

    async function toBlobSafe(c, type="image/jpeg", quality=0.92){
      const blob = await new Promise(res => c.toBlob(res, type, quality));
      if (blob) return blob;
      const dataUrl = c.toDataURL(type, quality);
      const resp = await fetch(dataUrl);
      return await resp.blob();
    }

    return {
      cropBlob: await toBlobSafe(crop),
      bwBlob: await toBlobSafe(bw),
    };
  }

  async function ocrSpace(blob) {
    if (!OCR_SPACE_API_KEY || OCR_SPACE_API_KEY.includes("PASTE_YOUR")) {
      throw new Error("Missing OCR.Space API key");
    }

    const form = new FormData();
    form.append("apikey", OCR_SPACE_API_KEY);
    form.append("language", "eng");
    form.append("isOverlayRequired", "false");
    form.append("scale", "true");
    form.append("OCREngine", "2"); // better for UI text
    form.append("file", blob, "crop.jpg");

    const res = await fetch("https://api.ocr.space/parse/image", { method: "POST", body: form });
    const data = await res.json();

    if (data?.IsErroredOnProcessing) {
      throw new Error((data?.ErrorMessage && data.ErrorMessage.join(", ")) || "OCR error");
    }

    return (data?.ParsedResults || []).map(x => x?.ParsedText || "").join("\n").trim();
  }

  // =========================
  // Feedback validation
  // =========================
  function updateSubmitState(){
    const ok =
      hasFile() &&
      document.querySelector('input[name="fb_impression"]:checked') &&
      document.querySelector('input[name="fb_signup"]:checked') &&
      document.querySelector('input[name="fb_likely"]:checked');

    btnSubmit.disabled = !ok;
    hint2.textContent = ok ? "" : "Please upload a screenshot and answer the required questions.";
  }

  // =========================
  // Events
  // =========================
  btnOpen.addEventListener("click", () => {
    window.open(offerUrl, "_blank", "noopener,noreferrer");
    openedOnce = true;
    btnGoFeedback.disabled = false;
    hint.textContent = "Return here after you finish and continue to feedback.";
  });

  btnGoFeedback.addEventListener("click", () => {
    if (!openedOnce) {
      hint.textContent = "Please open the download page first.";
      return;
    }
    feedback.classList.remove("hidden");
    feedback.scrollIntoView({ behavior: "smooth" });
    updateSubmitState();
  });

  shot.addEventListener("change", () => {
    statusChip.textContent = "";
    ocrResult.classList.add("hidden");
    ocrText.textContent = "";
    ocrPct.textContent = "—";
    ocrMsg.textContent = "";

    const file = shot.files && shot.files[0];
    if (!file) {
      previewWrap.classList.add("hidden");
      btnOcr.disabled = true;
      updateSubmitState();
      return;
    }

    if (currentPreviewUrl) URL.revokeObjectURL(currentPreviewUrl);
    currentPreviewUrl = URL.createObjectURL(file);
    preview.src = currentPreviewUrl;
    previewWrap.classList.remove("hidden");

    btnOcr.disabled = false;
    statusChip.textContent = "Uploaded ✅";
    updateSubmitState();
  });

  btnOcr.addEventListener("click", async () => {
    const file = shot.files && shot.files[0];
    if (!file) return;

    btnOcr.disabled = true;
    ocrPct.textContent = "…";
    ocrMsg.textContent = "Reading screenshot…";
    ocrResult.classList.add("hidden");
    ocrText.textContent = "";

    try {
      // two-pass OCR with preprocessing to handle highlights
      const { cropBlob, bwBlob } = await makeCrops(file);

      // pass 1: normal crop
      const t1 = await ocrSpace(cropBlob);

      // pass 2: black/white crop (often fixes highlighted subject)
      const t2 = await ocrSpace(bwBlob);

      const combined = [t1, "\n--- OCR PASS 2 (contrast) ---\n", t2].join("\n").trim();

      ocrResult.classList.remove("hidden");
      ocrText.textContent = combined.slice(0, 3500);
      ocrPct.textContent = "100%";

      // Display-only message
      const match = looksLikeWelcomeToTikTok(combined);
      ocrMsg.textContent = match
        ? `Detected: text appears to include “${TARGET_DISPLAY}”.`
        : `Not detected in OCR preview. Try a closer screenshot focused on the subject line.`;

    } catch (e) {
      ocrPct.textContent = "—";
      ocrMsg.textContent = "OCR failed. Check API key, or try a clearer/zoomed screenshot of the subject line.";
    } finally {
      btnOcr.disabled = false;
    }
  });

  document.querySelectorAll('input[name="fb_impression"], input[name="fb_signup"], input[name="fb_likely"]')
    .forEach(r => r.addEventListener("change", updateSubmitState));

  btnSubmit.addEventListener("click", () => {
    if (btnSubmit.disabled) return;
    window.location.href = COMPLETE_URL;
  });
</script>

</body>
</html>

