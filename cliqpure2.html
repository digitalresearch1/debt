<!DOCTYPE html>
<html lang="en" class="supernova">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Financial Wellness Research Study</title>

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Brevo base styles -->
  <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top, #4f46e5 0, #020617 55%);
      min-height: 100vh;
    }
    .form-container {
      background: white;
      border-radius: 24px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.28);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .header-gradient {
      background: radial-gradient(circle at top left, #6366f1, #4f46e5 40%, #a855f7 100%);
    }
    .step-card {
      background: white;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }
    .primary-btn {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
      color: white;
      transition: all 0.25s ease;
    }
    .primary-btn:hover {
      filter: brightness(0.95);
      transform: translateY(-1px);
      box-shadow: 0 16px 35px rgba(79, 70, 229, 0.35);
    }
    .warning-box {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 14px;
    }
    .info-box {
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      border-radius: 14px;
    }
    .eligibility-box {
      background: #fefce8;
      border: 1px solid #facc15;
      border-radius: 14px;
    }
    .feature-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.9rem;
      background: #eef2ff;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      color: #4338ca;
    }
    .reminder-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.9rem;
      background: #ecfeff;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      color: #0369a1;
    }
    .video-wrapper {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      box-shadow: 0 20px 40px rgba(15,23,42,0.35);
      border-radius: 0.75rem;
      overflow: hidden;
      background: #000;
    }
    .video-wrapper iframe {
      width: 100%;
      height: 100%;
      display: block;
      border: 0;
    }
    @media (max-width: 768px) { .video-wrapper { height: 220px; } }
    @media (min-width: 769px) { .video-wrapper { height: 360px; } }

    /* page panels */
    .page { display: none; }
    .page.active { display: block; }

    /* Sticky overlay after opening secure form */
    .overlay-wrap {
      position: fixed;
      left: 0; right: 0;
      bottom: 18px;
      z-index: 999999;
      display: none;
      justify-content: center;
      padding: 0 14px;
    }
    .overlay {
      width: 100%;
      max-width: 920px;
      border-radius: 16px;
      border: 1px solid rgba(99,102,241,0.25);
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(15,23,42,0.20);
      padding: 14px;
    }
    .ghost-btn {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      color: #0f172a;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      transition: all .15s ease;
    }
    .ghost-btn:hover { background: #e2e8f0; }

    /* Brevo small tweaks */
    #sib-container input::placeholder {
      text-align: left;
      font-family: Helvetica, sans-serif;
      color: #c0ccda;
    }
  </style>
</head>

<body class="min-h-screen p-4 md:p-8 flex items-center justify-center">

<div class="form-container w-full max-w-5xl p-4 md:p-8 lg:p-10">

  <!-- HEADER -->
  <div class="header-gradient rounded-2xl p-6 md:p-8 text-white mb-8">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-5">
      <div>
        <div class="inline-flex items-center gap-2 bg-black/20 backdrop-blur px-4 py-1.5 rounded-full text-xs md:text-sm font-medium">
          <span>üîí</span>
          <span>Confidential Financial Wellness Research</span>
        </div>
        <h1 class="mt-3 text-2xl md:text-3xl lg:text-4xl font-semibold tracking-tight">
          Financial Wellness Research Study
        </h1>
      </div>

      <div class="text-right text-xs md:text-sm text-indigo-100 space-y-1">
        <p>Study Type: <span class="font-semibold">Debt Relief Experience</span></p>
        <p>Estimated Time: <span class="font-semibold">3‚Äì5 minutes</span></p>
      </div>
    </div>

    <p class="text-sm md:text-base text-indigo-100/90 max-w-3xl">
      Please follow each step carefully.
    </p>
  </div>

  <!-- PAGE 1 -->
  <section id="page1" class="page active">
    <div class="step-card p-5 md:p-6 lg:p-7 mb-6">
      <div class="flex items-start gap-3 md:gap-4 mb-5">
        <div class="step-number">1</div>
        <div class="flex-1">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-1.5">
            <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-slate-900">
              STEP 1 ‚Äî Open & Complete the Secure Financial Form
            </h2>
            <span class="text-xs md:text-sm font-medium text-primary-700 bg-primary-50 px-3 py-1 rounded-full">
              Start here
            </span>
          </div>

          <p class="text-sm md:text-base text-slate-600">
            We are collecting feedback from people who are actively looking for real options to reduce or restructure their unsecured debt.
            This step connects you with a real debt specialist for balances of <span class="font-semibold">$15,000+</span> in unsecured debt.
          </p>
        </div>
      </div>

      <div class="eligibility-box p-4 md:p-5">
        <h3 class="font-semibold text-slate-900 mb-2 text-sm md:text-base">Who should continue?</h3>
        <ul class="space-y-1.5 text-xs md:text-sm text-slate-700">
          <li class="flex gap-2"><span class="mt-0.5 text-amber-500">‚Ä¢</span><span>You have <strong>unsecured debt</strong> (credit cards, personal loans, medical bills, etc.).</span></li>
          <li class="flex gap-2"><span class="mt-0.5 text-amber-500">‚Ä¢</span><span>Your <strong>total unsecured balances are typically above $15,000</strong>.</span></li>
          <li class="flex gap-2"><span class="mt-0.5 text-amber-500">‚Ä¢</span><span>You are <strong>seriously interested</strong> in exploring debt reduction options.</span></li>
          <li class="flex gap-2"><span class="mt-0.5 text-amber-500">‚Ä¢</span><span>You are willing to <strong>receive a phone call</strong> at the number you provide.</span></li>
        </ul>

        <p class="mt-3 text-xs md:text-sm text-amber-800 flex items-center gap-2">
          <span>üìû</span>
          <span>A financial specialist will typically call within <strong>24‚Äì48 hours</strong> after you submit the form.</span>
        </p>
      </div>

      <div class="flex flex-wrap gap-3 mt-6">
        <button id="btnStep1Next" class="primary-btn px-6 py-3 rounded-xl font-semibold">Next ‚Üí</button>
        <button id="btnExit1" class="px-6 py-3 bg-slate-50 hover:bg-slate-100 text-slate-700 font-medium rounded-xl border border-slate-200 transition">
          I don't meet the requirements / Don't want to participate
        </button>
      </div>
    </div>
  </section>

  <!-- PAGE 2 -->
  <section id="page2" class="page">
    <div class="step-card p-5 md:p-6 lg:p-7 mb-6">
      <div class="flex items-start gap-3 md:gap-4 mb-5">
        <div class="step-number">2</div>
        <div class="flex-1">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-1.5">
            <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-slate-900">
              STEP 2 ‚Äî Complete the secure form (new tab) & verify
            </h2>
            <span class="text-xs md:text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
              Required
            </span>
          </div>
        </div>
      </div>

      <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 md:p-5 mb-5">
        <h3 class="font-semibold text-slate-900 mb-3 text-sm md:text-base">How this step works</h3>
        <ol class="space-y-2 text-xs md:text-sm text-slate-700">
          <li class="flex gap-2"><span class="font-semibold text-primary-700">1.</span><span>Click <strong>‚ÄúStart secure form‚Äù</strong> below. This opens the secure form in a new tab.</span></li>
          <li class="flex gap-2"><span class="font-semibold text-primary-700">2.</span><span>Complete the secure form with accurate contact and debt details.</span></li>
          <li class="flex gap-2"><span class="font-semibold text-primary-700">3.</span><span>Return to this page and click <strong>‚ÄúI submitted the form‚Äù</strong> so we can verify and unlock the next step.</span></li>
          <li class="flex gap-2"><span class="font-semibold text-primary-700">4.</span><span>Enter your email to receive immediate follow-up emails tracking your call experience.</span></li>
        </ol>

        <div class="mt-6 info-box rounded-lg p-4">
          <div class="flex items-start">
            <span class="text-blue-600 mr-3">üìß</span>
            <div>
              <p class="font-semibold text-gray-900 mb-1">About the Follow-up Emails</p>
              <p class="text-gray-700 text-sm">
                After you submit your email, we'll immediately send you a feedback request. You'll receive reminders for the next 3 days to update us on whether you received the specialist's call and if you got the help you needed.
              </p>
            </div>
          </div>
        </div>

        <div class="mt-3 warning-box p-3.5 md:p-4">
          <div class="flex items-start gap-2.5">
            <span class="mt-0.5 text-amber-600">‚ö†Ô∏è</span>
            <p class="text-xs md:text-sm text-slate-800">
              We automatically verify whether the secure form was submitted. If it is not found as submitted, your participation cannot be approved.
            </p>
          </div>
        </div>
      </div>

      <div class="mb-4 text-center">
        <a id="directFormLink" href="#"
           class="primary-btn inline-flex items-center justify-center px-8 py-3.5 rounded-xl text-sm md:text-base font-semibold w-full md:w-auto">
          <span class="mr-2.5">üöÄ</span>
          Start secure form
          <span class="ml-2.5 text-xs">Opens new tab</span>
        </a>

        <p id="formStatus" class="mt-2 text-[11px] md:text-xs text-slate-500">
          The secure form will open in a new tab. After submitting, come back here and click ‚ÄúI submitted the form‚Äù.
        </p>
      </div>

      <div class="flex flex-wrap gap-3 mt-4">
        <button id="btnFormDone"
                class="px-6 py-3 bg-slate-100 text-slate-400 text-sm md:text-base font-semibold rounded-xl cursor-not-allowed"
                disabled>
          <span class="mr-2">‚è≥</span>
          I submitted the form
        </button>

        <button id="btnExit2"
                class="px-6 py-3 bg-slate-50 hover:bg-slate-100 text-slate-700 text-sm md:text-base font-medium rounded-xl border border-slate-200 transition">
          I don't meet the requirements / Don't want to participate
        </button>

        <button id="btnBackTo1"
                class="px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 text-sm md:text-base font-medium rounded-xl border border-slate-200 transition">
          ‚Üê Back
        </button>
      </div>

      <div class="flex flex-wrap gap-2 mt-5">
        <span class="feature-badge"><span>üìû</span> Live specialist call</span>
        <span class="feature-badge"><span>üí∞</span> $15,000+ unsecured debt</span>
        <span class="reminder-badge"><span>üìß</span> 3-day follow-up</span>
        <span class="feature-badge"><span>‚è±Ô∏è</span> 24‚Äì48h response</span>
      </div>
    </div>
  </section>

  <!-- PAGE 3 -->
  <section id="page3" class="page">
    <div class="step-card p-5 md:p-6 lg:p-7 mb-6">
      <div class="flex items-start gap-3 md:gap-4 mb-4">
        <div class="step-number">3</div>
        <div class="flex-1">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-1.5">
            <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-slate-900">
              Watch the Short Explainer Video
            </h2>
            <span class="text-xs md:text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
              Step 3 of 4
            </span>
          </div>
          <p class="text-xs md:text-sm text-slate-600">
            This quick video explains how the program works for people with higher unsecured debt balances.
          </p>
        </div>
      </div>

      <div class="video-wrapper mb-3">
        <iframe
          src="https://www.facebook.com/plugins/video.php?height=314&href=https%3A%2F%2Fwww.facebook.com%2Freel%2F1205740158030889%2F&show_text=true&width=860&t=0"
          style="border:none; overflow:hidden;" scrolling="no" frameborder="0"
          allowfullscreen="true"
          allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>
      </div>

      <p class="text-[11px] md:text-xs text-slate-500">When you are done, click the button below to continue.</p>

      <div class="flex flex-wrap gap-3 mt-4">
        <button id="btnVideoDone" class="primary-btn px-6 py-3 rounded-xl font-semibold">
          I watched the video ‚Üí Next
        </button>

        <button id="btnBackTo2"
                class="px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 text-sm md:text-base font-medium rounded-xl border border-slate-200 transition">
          ‚Üê Back
        </button>

        <button id="btnExit3"
                class="px-6 py-3 bg-slate-50 hover:bg-slate-100 text-slate-700 text-sm md:text-base font-medium rounded-xl border border-slate-200 transition">
          Exit / Disqualify
        </button>
      </div>
    </div>
  </section>

  <!-- PAGE 4 -->
  <section id="page4" class="page">
    <div class="step-card p-5 md:p-6 lg:p-7 mb-6">
      <div class="flex items-start gap-3 md:gap-4 mb-4">
        <div class="step-number">4</div>
        <div class="flex-1">
          <div class="flex items-center justify-between flex-wrap gap-2 mb-1.5">
            <h2 class="text-lg md:text-xl lg:text-2xl font-semibold text-slate-900">
              Email Confirmation & Finish Study
            </h2>
            <span class="text-xs md:text-sm font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
              Last required step
            </span>
          </div>

          <p class="text-xs md:text-sm text-slate-600">
            Your email is required to confirm your participation and send a short follow-up about your experience.
            After submitting your email, click ‚ÄúVerify & finish study‚Äù to complete the survey.
          </p>
        </div>
      </div>

      <!-- BREVO FORM -->
      <div class="w-full mb-4">
        <div class="sib-form" style="text-align: center; background-color: #EFF2F7; border-radius:16px; overflow:hidden;">
          <div id="sib-form-container" class="sib-form-container">
            <div id="sib-container"
                 class="sib-container--large sib-container--vertical"
                 style="text-align:center; background-color:rgba(255,255,255,1); max-width:700px; border-radius:10px; border-width:1px; border-color:#C0CCD9; border-style:solid; margin:14px auto; box-shadow:0 10px 30px rgba(15,23,42,0.15);">

              <iframe name="brevo_iframe" id="brevo_iframe" style="display:none;"></iframe>

              <form id="sib-form"
                    method="POST"
                    action="https://52bcaf92.sibforms.com/serve/MUIFAO5vlejSCs-rWtk8_hSGgyILb9Oi-aOLbS_zI5_FjrtRovBWkBZlGVuoCXxEbmOMZMrdo0ZllgcfYtt7jPnKOHgyHT2TYdf3Q-xFXArnK8ikp21kPr7-iXsfMeK4CtD4cAPf2oHHMJLw5OtgVzgyKMt0hXTJ3UiMJVGUXzHbWENuGdgb7j-x2xeZ6iW5f9ix4gocwCjOBdct"
                    target="brevo_iframe">

                <div style="padding: 12px 18px 0 18px;">
                  <div class="sib-form-block"
                       style="font-size:18px; text-align:left; font-weight:700; font-family:Helvetica, sans-serif; color:#111827; background-color:transparent;">
                    <p>Survey feedback reminder</p>
                  </div>
                </div>

                <div style="padding: 6px 18px;">
                  <div class="sib-form-block"
                       style="font-size:13px; text-align:left; font-family:Helvetica, sans-serif; color:#4b5563; background-color:transparent;">
                    <div class="sib-text-form-block">
                      <p>Please provide your email so we can send a reminder about this research and the outcome of your request.</p>
                    </div>
                  </div>
                </div>

                <div style="padding: 8px 18px 0 18px;">
                  <div class="sib-input sib-form-block">
                    <div class="form__entry entry_block">
                      <div class="form__label-row">
                        <label class="entry__label"
                               style="font-weight:700; text-align:left; font-size:14px; font-family:Helvetica, sans-serif; color:#111827;"
                               for="EMAIL" data-required="*">
                          Enter your email address
                        </label>

                        <div class="entry__field">
                          <input class="input" type="text" id="EMAIL" name="EMAIL"
                                 autocomplete="off" placeholder="you@example.com"
                                 data-required="true" required />
                        </div>
                      </div>

                      <label id="email_error"
                             class="entry__error entry__error--primary"
                             style="display:none; font-size:13px; text-align:left; font-family:Helvetica, sans-serif; color:#661d1d; background-color:#ffeded; border-radius:3px; border-color:#ff4949; padding:4px 6px; margin-top:6px;">
                      </label>

                      <label class="entry__specification"
                             style="font-size:11px; text-align:left; font-family:Helvetica, sans-serif; color:#6b7280;">
                        We only use this to send survey-related reminders.
                      </label>
                    </div>
                  </div>
                </div>

                <div style="padding: 8px 18px 0 18px;">
                  <div class="sib-optin sib-form-block">
                    <div class="form__entry entry_mcq">
                      <div class="form__label-row">
                        <div class="entry__choice">
                          <label style="display:flex; align-items:flex-start; gap:6px;">
                            <input type="checkbox" class="input_replaced" value="1" id="OPT_IN" name="OPT_IN" />
                            <span class="checkbox checkbox_tick_positive"></span>
                            <span style="font-size:12px; text-align:left; font-family:Helvetica, sans-serif; color:#374151;">
                              I agree to receive your email and accept the data privacy statement.
                            </span>
                          </label>
                        </div>
                      </div>

                      <label id="optin_error"
                             class="entry__error entry__error--primary"
                             style="display:none; font-size:13px; text-align:left; font-family:Helvetica, sans-serif; color:#661d1d; background-color:#ffeded; border-radius:3px; border-color:#ff4949; padding:4px 6px; margin-top:6px;">
                      </label>

                      <label class="entry__specification"
                             style="font-size:11px; text-align:left; font-family:Helvetica, sans-serif; color:#6b7280;">
                        You may unsubscribe at any time using the link in our emails.
                      </label>
                    </div>
                  </div>
                </div>

                <div style="padding: 12px 18px 16px 18px;">
                  <div class="sib-form-block" style="text-align: left">
                    <button id="brevoSubmitBtn"
                            class="sib-form-block__button sib-form-block__button-with-loader"
                            style="font-size:14px; text-align:center; font-weight:700; font-family:Helvetica, sans-serif; color:#FFFFFF; background-color:#4f46e5; border-radius:9999px; border-width:0px; width:100%; padding:10px 0; cursor:pointer;"
                            type="submit">
                      SUBMIT EMAIL
                    </button>
                  </div>
                </div>

                <input type="text" name="email_address_check" value="" class="input--hidden">
                <input type="hidden" name="locale" value="en">
                <input type="hidden" name="html_type" value="simple">
              </form>
            </div>
          </div>
        </div>
      </div>

      <button id="btnFinalVerify"
              class="mt-2 px-6 py-3 bg-slate-300 text-slate-500 text-sm md:text-base font-semibold rounded-xl cursor-not-allowed w-full md:w-auto"
              disabled>
        Verify & finish study
      </button>

      <p id="finalStatus" class="mt-2 text-[11px] md:text-xs text-slate-500">
        If our system cannot verify your secure form submission, you will be redirected to a disqualification page instead of completion.
      </p>

      <div class="flex flex-wrap gap-3 mt-4">
        <button id="btnBackTo3"
                class="px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 text-sm md:text-base font-medium rounded-xl border border-slate-200 transition">
          ‚Üê Back
        </button>

        <button id="btnExit4"
                class="px-6 py-3 bg-slate-50 hover:bg-slate-100 text-slate-700 text-sm md:text-base font-medium rounded-xl border border-slate-200 transition">
          Exit / Disqualify
        </button>
      </div>
    </div>
  </section>
</div>

<!-- Sticky overlay -->
<div class="overlay-wrap" id="overlayWrap">
  <div class="overlay">
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div class="flex gap-3">
        <div class="w-9 h-9 rounded-full flex items-center justify-center bg-cyan-50 text-cyan-700 font-bold">‚úÖ</div>
        <div>
          <p class="font-semibold text-slate-900">Secure form opened in a new tab</p>
          <p class="text-sm text-slate-600">Please complete the form, then return here.</p>
          <p class="text-sm text-slate-600">This page will stay open.</p>
          <p class="text-sm text-slate-600 mt-1"><strong>1Ô∏è‚É£ After ‚ÄúStart secure form‚Äù click</strong> and you finish, come back and press <strong>‚ÄúI submitted the form‚Äù</strong>.</p>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="reopenBtn" class="ghost-btn">Re-open secure form</button>
        <button id="closeOverlayBtn" class="ghost-btn">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Show one "page" at a time
  function showPage(n) {
    const ids = ['page1','page2','page3','page4'];
    ids.forEach((id, idx) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('active', idx === (n - 1));
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Get transaction id (transaction_id, RID, cint) and persist for the session
  const urlParams = new URLSearchParams(window.location.search);
  let transactionId =
    urlParams.get('transaction_id') ||
    urlParams.get('RID') ||
    urlParams.get('cint') ||
    sessionStorage.getItem('transaction_id');

  if (!transactionId) {
    transactionId = 'tx_' + Date.now().toString(36) + Math.random().toString(36).substring(2);
  }
  sessionStorage.setItem('transaction_id', transactionId);

  // PureSpectrum URLs
  const completionUrl  = `https://spectrumsurveys.com/surveydone?st=21&transaction_id=${encodeURIComponent(transactionId)}`;
  const terminationUrl = `https://spectrumsurveys.com/surveydone?st=18&transaction_id=${encodeURIComponent(transactionId)}`;

  // Marketcall offer (NEW TAB)
  const offerBaseUrl    = 'https://trkmcl.com/wy8odpg43k/p98vjj0e83';
  const offerTrackedUrl = `${offerBaseUrl}${offerBaseUrl.includes('?') ? '&' : '?'}subid=${encodeURIComponent(transactionId)}`;

  // Worker verify URL
  const verifyFormUrl = `https://marketcall.kayembakasongo.workers.dev/verify-form?transaction_id=${encodeURIComponent(transactionId)}`;

  async function safeVerify() {
    // Important: do NOT auto-disqualify on network/CORS/JSON issues
    const resp = await fetch(verifyFormUrl, { method: 'GET', cache: 'no-store' });

    if (!resp.ok) {
      // Example: 500/403/404
      return { ok: false, submitted: false, error: `Worker HTTP ${resp.status}` };
    }

    // If worker returns non-JSON, this will throw; we catch above usage
    const data = await resp.json();
    return { ok: true, submitted: !!(data && data.submitted) };
  }

  // PAGE 1 buttons
  document.getElementById('btnStep1Next')?.addEventListener('click', () => showPage(2));
  document.getElementById('btnExit1')?.addEventListener('click', () => window.location.href = terminationUrl);

  // PAGE 2 buttons + overlay
  const directFormLink = document.getElementById('directFormLink');
  const formStatus = document.getElementById('formStatus');
  const btnFormDone = document.getElementById('btnFormDone');

  const overlayWrap = document.getElementById('overlayWrap');
  const reopenBtn = document.getElementById('reopenBtn');
  const closeOverlayBtn = document.getElementById('closeOverlayBtn');

  let lastOpened = null;

  directFormLink?.addEventListener('click', (e) => {
    e.preventDefault();

    lastOpened = offerTrackedUrl;
    window.open(offerTrackedUrl, '_blank', 'noopener,noreferrer');

    if (overlayWrap) overlayWrap.style.display = 'flex';

    if (formStatus) {
      formStatus.textContent = 'New tab opened. Please complete and submit the secure form, then return here to verify.';
      formStatus.classList.remove('text-slate-500');
      formStatus.classList.add('text-emerald-700');
    }

    if (btnFormDone) {
      btnFormDone.disabled = false;
      btnFormDone.classList.remove('cursor-not-allowed', 'bg-slate-100', 'text-slate-400');
      btnFormDone.classList.add('primary-btn', 'text-white');
      btnFormDone.innerHTML = '<span class="mr-2">üìã</span>I submitted the form';
    }
  });

  reopenBtn?.addEventListener('click', () => {
    if (!lastOpened) return;
    window.open(lastOpened, '_blank', 'noopener,noreferrer');
  });

  closeOverlayBtn?.addEventListener('click', () => {
    if (overlayWrap) overlayWrap.style.display = 'none';
  });

  document.getElementById('btnExit2')?.addEventListener('click', () => window.location.href = terminationUrl);
  document.getElementById('btnBackTo1')?.addEventListener('click', () => showPage(1));

  // Verify after "I submitted the form"
  btnFormDone?.addEventListener('click', async () => {
    if (!btnFormDone || btnFormDone.disabled) return;

    btnFormDone.disabled = true;
    btnFormDone.innerHTML = '<span class="mr-2">‚è≥</span>Verifying your submission...';

    try {
      const result = await safeVerify();

      if (result.ok && result.submitted) {
        btnFormDone.classList.remove('primary-btn');
        btnFormDone.classList.add('bg-emerald-100', 'text-emerald-800');
        btnFormDone.innerHTML = '<span class="mr-2">‚úÖ</span>Form verified';
        setTimeout(() => showPage(3), 600);
        return;
      }

      // Not submitted OR worker error -> do NOT disqualify automatically
      btnFormDone.disabled = false;
      btnFormDone.classList.remove('primary-btn');
      btnFormDone.classList.add('bg-red-100', 'text-red-800');
      btnFormDone.innerHTML = result.ok
        ? '<span class="mr-2">‚ùå</span>Submission not found'
        : '<span class="mr-2">‚ö†Ô∏è</span>Verification error';

      alert(
        result.ok
          ? 'We could not verify your submission. Please make sure you submitted the secure form in the new tab, then try again.'
          : 'We could not reach the verification server. Please try again in 10‚Äì20 seconds.'
      );

      setTimeout(() => {
        btnFormDone.classList.remove('bg-red-100', 'text-red-800');
        btnFormDone.classList.add('primary-btn', 'text-white');
        btnFormDone.innerHTML = '<span class="mr-2">üìã</span>I submitted the form';
      }, 2000);
    } catch (err) {
      // JSON parse / CORS / network
      btnFormDone.disabled = false;
      btnFormDone.classList.remove('primary-btn');
      btnFormDone.classList.add('bg-amber-100', 'text-amber-800');
      btnFormDone.innerHTML = '<span class="mr-2">‚ö†Ô∏è</span>Network error - try again';
    }
  });

  // PAGE 3 buttons
  document.getElementById('btnVideoDone')?.addEventListener('click', () => showPage(4));
  document.getElementById('btnBackTo2')?.addEventListener('click', () => showPage(2));
  document.getElementById('btnExit3')?.addEventListener('click', () => window.location.href = terminationUrl);

  // PAGE 4 (Brevo + final verify)
  const sibForm = document.getElementById('sib-form');
  const emailInput = document.getElementById('EMAIL');
  const optIn = document.getElementById('OPT_IN');
  const emailErr = document.getElementById('email_error');
  const optinErr = document.getElementById('optin_error');
  const brevoSubmitBtn = document.getElementById('brevoSubmitBtn');
  const btnFinalVerify = document.getElementById('btnFinalVerify');
  const finalStatus = document.getElementById('finalStatus');

  document.getElementById('btnBackTo3')?.addEventListener('click', () => showPage(3));
  document.getElementById('btnExit4')?.addEventListener('click', () => window.location.href = terminationUrl);

  // Brevo submit validation -> unlock final verify
  sibForm?.addEventListener('submit', (e) => {
    let hasError = false;

    if (emailErr) emailErr.style.display = 'none';
    if (optinErr) optinErr.style.display = 'none';

    const emailVal = (emailInput?.value || '').trim();

    if (!emailVal) {
      hasError = true;
      if (emailErr) { emailErr.textContent = 'Please enter your email address.'; emailErr.style.display = 'block'; }
    } else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)) {
      hasError = true;
      if (emailErr) { emailErr.textContent = 'Please enter a valid email address.'; emailErr.style.display = 'block'; }
    }

    if (!optIn?.checked) {
      hasError = true;
      if (optinErr) { optinErr.textContent = 'Please agree to the privacy statement to continue.'; optinErr.style.display = 'block'; }
    }

    if (hasError) {
      e.preventDefault();
      return;
    }

    if (brevoSubmitBtn) {
      brevoSubmitBtn.disabled = true;
      brevoSubmitBtn.textContent = 'Submitting...';
    }

    // Unlock finish after Brevo has time to post to the iframe
    setTimeout(() => {
      if (btnFinalVerify) {
        btnFinalVerify.disabled = false;
        btnFinalVerify.classList.remove('cursor-not-allowed', 'bg-slate-300', 'text-slate-500');
        btnFinalVerify.classList.add('primary-btn', 'text-white');
      }
      if (finalStatus) {
        finalStatus.textContent = 'Email received. Now click ‚ÄúVerify & finish study‚Äù to complete.';
      }
    }, 2500);
  });

  // Final verification: completion or termination
  btnFinalVerify?.addEventListener('click', async () => {
    if (!btnFinalVerify || btnFinalVerify.disabled) return;

    btnFinalVerify.disabled = true;
    btnFinalVerify.textContent = '‚è≥ Verifying & finishing...';

    try {
      const result = await safeVerify();

      if (result.ok && result.submitted) {
        window.location.href = completionUrl;
        return;
      }

      // If worker says NOT submitted, then terminate (disqualify)
      if (result.ok && !result.submitted) {
        window.location.href = terminationUrl;
        return;
      }

      // Worker error: do NOT disqualify; allow retry
      alert('Verification server error. Please wait 10‚Äì20 seconds and click ‚ÄúVerify & finish study‚Äù again.');
      btnFinalVerify.disabled = false;
      btnFinalVerify.textContent = 'Verify & finish study';
    } catch (err) {
      alert('Network/CORS error while verifying. Please try again.');
      btnFinalVerify.disabled = false;
      btnFinalVerify.textContent = 'Verify & finish study';
    }
  });
</script>

</body>
</html>
