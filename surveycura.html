<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Debt Settlement Survey — Chloe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1: 28 28 33; /* base */
      --bg2: 17 17 21; /* darker */
    }
    html,body{ height:100%; }
    body{ font-family: 'Inter', sans-serif; }

    /* === Modern background (radial grid + subtle noise) === */
    body::before{
      content:""; position:fixed; inset:-10vmax;
      background:
        radial-gradient(60vmax 60vmax at 10% -10%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(70vmax 70vmax at 110% 10%, rgba(236,72,153,.25), transparent 60%),
        radial-gradient(80vmax 80vmax at 50% 120%, rgba(56,189,248,.20), transparent 60%);
      filter: blur(30px) saturate(120%);
      z-index:-2;
    }
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
      background-image: url('data:image/svg+xml;utf8,\
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">\
          <path d="M0 31h32" stroke="rgba(255,255,255,.03)"/>\
          <path d="M31 0v32" stroke="rgba(255,255,255,.03)"/>\
        </svg>');
      background-size: 32px 32px; opacity:.8;
    }

    /* Glass card frame */
    .glass{ background: rgba(17, 19, 31, .65); backdrop-filter: blur(12px) saturate(140%); }
    .glass-border{ position:relative; }
    .glass-border::before{
      content:""; position:absolute; inset:0; padding:1px; border-radius:1.5rem; pointer-events:none;
      background: linear-gradient(135deg, rgba(255,255,255,.15), rgba(255,255,255,.02));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }

    /* Scrollbar polish */
    #chat-window::-webkit-scrollbar{ width:10px; }
    #chat-window::-webkit-scrollbar-thumb{ background: #374151; border-radius:9999px; border:3px solid transparent; background-clip:padding-box; }
    #chat-window::-webkit-scrollbar-track{ background: transparent; }

    /* Bubble animation */
    .chat-bubble { animation: pop-in 0.25s ease-out; word-wrap: break-word; }
    @keyframes pop-in { 0% { transform: translateY(4px) scale(.98); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }

    /* Loader (buttons) */
    .loader { border: 2px solid #4b5563; border-top: 2px solid #a5b4fc; border-radius: 9999px; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Range aesthetics */
    input[type=range]{ -webkit-appearance:none; width:100%; background:transparent; height: 34px; }
    input[type=range]::-webkit-slider-runnable-track{ height: 8px; background: linear-gradient(90deg, #4b5563, #334155); border-radius: 9999px; }
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; height: 24px; width:24px; border-radius:50%; background: linear-gradient(135deg, #818cf8, #a78bfa); margin-top:-8px; border: 3px solid white; box-shadow: 0 6px 20px rgba(99,102,241,.35); }

    /* Responsive safe area padding for bottom bar */
    .safe-bottom{ padding-bottom: max(1rem, env(safe-area-inset-bottom)); }

    /* Visual progress dot */
    .progress-dot{ height:10px; width:10px; border-radius:9999px; box-shadow: 0 0 0 4px rgba(99,102,241,.15); }
  </style>
</head>
<body class="min-h-screen bg-[#1c1c21] text-white selection:bg-indigo-500/30">

  <!-- Centered phone frame -->
  <div class="mx-auto max-w-md px-4 py-8 md:py-12">
    <div class="glass-border rounded-3xl">
      <div id="chatbot-section" class="glass rounded-3xl border border-white/10 shadow-2xl overflow-hidden flex flex-col h-[85vh]">
        <!-- Header -->
        <header class="bg-gradient-to-b from-white/5 to-white/0 px-5 py-4 border-b border-white/10">
          <div class="flex items-center gap-3">
            <div class="relative">
              <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-500 via-violet-500 to-fuchsia-500 grid place-items-center font-extrabold">C</div>
              <span class="absolute -right-0 -bottom-0 progress-dot bg-emerald-400"></span>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h2 class="text-base font-semibold tracking-tight">Chloe</h2>
                <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/20">online</span>
              </div>
              <p class="text-[11px] text-indigo-200/80">AI Research Assistant · Debt Settlement Feedback Study</p>
            </div>
            <div class="text-xs text-white/60 hidden sm:block">Secure</div>
          </div>
        </header>

        <!-- Progress -->
        <div class="px-5 pb-3 pt-2">
          <div class="w-full h-2 rounded-full bg-white/10 overflow-hidden">
            <div id="progress-bar" class="h-2 w-0 bg-gradient-to-r from-indigo-500 via-violet-500 to-fuchsia-500 transition-all duration-500"></div>
          </div>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="flex-1 px-4 pb-4 overflow-y-auto space-y-3">
          <!-- messages injected here -->
        </div>

        <!-- Input / Controls area -->
        <footer id="chat-input-area" class="safe-bottom px-4 pt-2 pb-4 bg-gradient-to-t from-white/5 via-white/[.03] to-transparent border-t border-white/10"></footer>
      </div>
    </div>
  </div>

  <!-- Hidden background POST (CORS-safe) -->
  <iframe name="hidden_post_target" style="display:none;"></iframe>
  <iframe name="hidden_td_target" style="display:none;"></iframe>

  <!-- Hidden CuraDebt POST -->
  <form id="hidden-curadebt-post" action="https://signup.curadebt.com/apkconnect/" method="POST" target="hidden_post_target" style="display:none;">
    <input name="f_fname">
    <input name="f_lname">
    <input name="f_email">
    <input name="f_phone">
    <input name="f_whereyoulive">
    <input name="f_totaldebt">
    <input name="f_comments" value="Lead from AI Chatbot Survey">
    <input name="data1">
    <input name="data2" value="CLICKID2">
    <input name="f_ip">
    <!-- Optional -->
    <input name="f_mobilephone">
    <input name="f_city">
    <input name="f_zip">
  </form>

  <!-- Hidden TrackDrive POST (Lead-to-Call) -->
  <form id="hidden-trackdrive-post"
        action="https://curadebt.trackdrive.com/api/v1/leads"
        method="POST" target="hidden_td_target" style="display:none;">
    <!-- REQUIRED -->
    <input name="lead_token" value="3346b0458309406ba4b8beac90a8a532">
    <input name="traffic_source_id" value="1000">
    <input name="caller_id">
    <input name="call_now" value="1">
    <!-- OPTIONALS -->
    <input name="first_name">
    <input name="last_name">
    <input name="email">
    <input name="state">
    <input name="zip">
    <input name="ip_address">
    <input name="source_url">
    <input name="useragent">
    <input name="original_lead_submit_date">
    <input name="tcpa_opt_in">
    <input name="tcpa_optin_consent_language">
    <input name="sub_id">
    <input name="gclid">
    <input name="fbeventid">
    <input name="msclkid">
    <input name="traffic_source_lead_id">
  </form>

  <!-- Logic (survey + validation + OTP + posting) -->
  <script type="module">
    /***** Firebase (OTP) *****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBF5wdHyOlOi_bntJHXto7f6RbJMkOdMSE",
      authDomain: "otp-c6311.firebaseapp.com",
      projectId: "otp-c6311",
      storageBucket: "otp-c6311.firebasestorage.app",
      messagingSenderId: "637495517002",
      appId: "1:637495517002:web:7bd220994a7611a5606bb3"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    /***** Globals & DOM *****/
    const chatWindow = document.getElementById('chat-window');
    const chatInputArea = document.getElementById('chat-input-area');
    const progressBar = document.getElementById('progress-bar');

    let currentStepKey = 'start';
    let transactionId = '';
    let clientIp = '';
    window.otpOK = false;         // gate form submission
    let confirmationResult = null; // Firebase confirmation

    const allStates = ["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"];
    const excludedStates = ['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','RI'];

    /***** Validators (Workers) *****/
    const VALIDATE_ENDPOINT = "https://silent-sea-a717.kasindeesther.workers.dev/";
    const VALIDATE_EMAIL_ENDPOINT = "https://solitary-base-4a8b.kasindeesther.workers.dev/";

    function addMessage(message, sender = 'bot') {
      const el = document.createElement('div');
      el.className = `chat-bubble flex items-end gap-2 max-w-full ${sender === 'bot' ? 'self-start' : 'self-end flex-row-reverse'}`;
      const bubble = document.createElement('div');
      bubble.className = [
        'px-4 py-3 rounded-2xl text-sm shadow-lg ring-1',
        sender === 'bot'
          ? 'bg-gradient-to-r from-indigo-500 via-violet-500 to-fuchsia-500 text-white ring-white/10'
          : 'bg-white/10 text-white ring-white/10 backdrop-blur'
      ].join(' ');
      bubble.innerHTML = message;
      el.appendChild(bubble);
      chatWindow.appendChild(el);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function createBaseContainer() {
      chatInputArea.innerHTML = '';
      const container = document.createElement('div');
      container.className = 'sticky bottom-0 w-full safe-bottom pt-2';
      return container;
    }

    function showOptions(options, onSelect, config = {}) {
      const { primaryIndex = 0, showNumbers = true } = config;
      const container = createBaseContainer();

      const hint = document.createElement('div');
      hint.className = 'text-center text-[11px] text-white/60 mb-2';
      hint.textContent = showNumbers ? 'Tap an option or press 1–9 (Enter selects the first)' : 'Tap an option to continue';
      container.appendChild(hint);

      const optionsContainer = document.createElement('div');
      optionsContainer.className = 'flex flex-wrap justify-center gap-2 px-1';
      container.appendChild(optionsContainer);

      const buttons = [];
      const finalize = (value) => {
        buttons.forEach(b => { b.disabled = true; b.classList.add('opacity-60','cursor-not-allowed'); });
        addMessage(value, 'user');
        window.removeEventListener('keydown', keyHandler);
        onSelect(value);
      };

      options.forEach((text, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = [
          'px-4 py-2 rounded-full font-semibold text-sm shadow-sm ring-1 transition',
          'bg-white/10 hover:bg-white/15 text-white ring-white/15',
          'backdrop-blur border border-white/10'
        ].join(' ');
        btn.innerHTML = (showNumbers && i < 9) ? `<span class="mr-1 text-[10px] opacity-80">${i+1}.</span>${text}` : text;
        btn.addEventListener('click', () => finalize(text));
        optionsContainer.appendChild(btn);
        buttons.push(btn);
      });

      const abandon = document.createElement('button');
      abandon.type = 'button';
      abandon.className = 'block mx-auto mt-3 text-rose-300/80 hover:text-rose-200 text-xs';
      abandon.textContent = 'Abandon Survey';
      abandon.addEventListener('click', () => { addMessage('Abandon Survey','user'); window.removeEventListener('keydown', keyHandler); goToStep('leaveSurvey'); });
      container.appendChild(abandon);

      chatInputArea.appendChild(container);
      if (buttons[primaryIndex]) buttons[primaryIndex].focus();

      const keyHandler = (e) => {
        if (/^[1-9]$/.test(e.key)) {
          const idx = parseInt(e.key, 10)-1; if (buttons[idx]) buttons[idx].click();
        } else if (e.key === 'Enter') { if (buttons[primaryIndex]) buttons[primaryIndex].click(); }
        else if (e.key === 'Escape') { abandon.click(); }
      };
      window.addEventListener('keydown', keyHandler);
    }

    function getData1FromUrl() {
      const p = new URLSearchParams(location.search);
      const d1 = p.get('data1') || p.get('click_id') || p.get('gclid') || p.get('fbclid') || p.get('msclkid') || '';
      return d1 || 'no_click_id';
    }

    const digitsOnly = s => String(s||'').replace(/\D+/g,'');
    function parseStrictNANP(raw){
      const d = digitsOnly(raw);
      const m = d.match(/^1?([2-9]\d{2})([2-9]\d{2})(\d{4})$/);
      if(!m) return { ok:false, error:'Enter a valid US number (NANP).' };
      const [, area,prefix,line] = m;
      if(/^[2-9]11$/.test(area) || /^[2-9]11$/.test(prefix)) return { ok:false, error:'N11 service codes are invalid.' };
      if(area==='900') return { ok:false, error:'Premium-rate (900) not accepted.' };
      if(prefix==='555' && /^01\d{2}$/.test(line)) return { ok:false, error:'555-01xx test numbers not accepted.' };
      const ten = area+prefix+line;
      if(/^(\d)\1{9}$/.test(ten)) return { ok:false, error:'Invalid pattern (all digits identical).' };
      const seq='01234567890123456789', rseq='98765432109876543210';
      if(seq.includes(ten) || rseq.includes(ten)) return { ok:false, error:'Invalid pattern (sequential digits).' };
      const TOLL_FREE = new Set(['800','833','844','855','866','877','888','822']);
      return { ok:true, e164:`+1${area}${prefix}${line}`, meta:{ tollFree:TOLL_FREE.has(area) } };
    }

    async function validatePhoneWithSignalWire(raw){
      const strict = parseStrictNANP(raw);
      if(!strict.ok) return strict;
      try{
        const r = await fetch(VALIDATE_ENDPOINT,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone: strict.e164 }) });
        const j = await r.json();
        if(!j.ok) return { ok:false, error: j.error||'Validation failed.' };
        return { ...j, e164: strict.e164, meta: { ...(strict.meta||{}) } };
      }catch{ return { ok:true, e164: strict.e164, meta: strict.meta||{} }; }
    }

    const ROLE_LOCALS = new Set(['admin','administrator','root','support','help','helpdesk','info','contact','sales','marketing','billing','accounts','accounting','abuse','postmaster','webmaster','no-reply','noreply','donotreply','security','compliance','legal','test']);
    const FREEMAIL = new Set(['gmail.com','googlemail.com','yahoo.com','ymail.com','rocketmail.com','outlook.com','hotmail.com','live.com','msn.com','icloud.com','me.com','proton.me','aol.com','mail.com']);
    const DOMAIN_TYPO_MAP = {'gamil.com':'gmail.com','gmial.com':'gmail.com','gmai.com':'gmail.com','gmail.con':'gmail.com','yahoo.con':'yahoo.com','yhoo.com':'yahoo.com','hotnail.com':'hotmail.com','hotmial.com':'hotmail.com','outlok.com':'outlook.com','outllok.com':'outlook.com','icloud,com':'icloud.com','protonn.me':'proton.me'};

    function strictEmailClient(raw){
      const email = String(raw||'').trim();
      const at = email.indexOf('@'); if(at<1 || at===email.length-1) return { ok:false, error:'Enter a valid email address.' };
      const local = email.slice(0,at), domain = email.slice(at+1).toLowerCase();
      if(local.length<3 || local.length>64) return { ok:false, error:'Email local part length is invalid.' };
      if(domain.length<4 || domain.length>255) return { ok:false, error:'Email domain length is invalid.' };
      if(!/^[A-Za-z0-9](?:[A-Za-z0-9._%'+\-]{0,62}[A-Za-z0-9])?$/.test(local)) return { ok:false, error:'Invalid characters in email.' };
      if(local.includes('..')) return { ok:false, error:'Email local has consecutive dots.' };
      if(!/[A-Za-z]/.test(local)) return { ok:false, error:'Email must contain letters.' };
      if((local.match(/\./g)||[]).length>2) return { ok:false, error:'Too many dots in email local.' };
      if(domain.indexOf('.')<1) return { ok:false, error:'Email domain must contain a dot.' };
      const labels = domain.split('.'); for(const lab of labels){ if(lab.length<1||lab.length>63) return { ok:false, error:'Email domain label length is invalid.' }; if(!/^[A-Za-z0-9-]+$/.test(lab)) return { ok:false, error:'Email domain contains invalid chars.' }; if(lab.startsWith('-')||lab.endsWith('-')) return { ok:false, error:'Domain label cannot start/end with -.' }; }
      const tld = labels[labels.length-1]; if(tld.length<2||tld.length>63) return { ok:false, error:'Email TLD invalid.' }; if(/^\d+$/.test(tld)) return { ok:false, error:'Email TLD cannot be all digits.' }; if(tld==='con') return { ok:false, error:'TLD looks mistyped (.con). Did you mean .com?' };
      const info = { role: ROLE_LOCALS.has(local.toLowerCase()), plusAnywhere: local.includes('+'), gmailDot: (domain==='gmail.com'||domain==='googlemail.com') && local.includes('.'), freemail: FREEMAIL.has(domain) };
      return { ok:true, normalized:`${local}@${domain}`, info, suggestion: DOMAIN_TYPO_MAP[domain]||null };
    }

    async function validateEmailWithWorker(raw){
      const base = strictEmailClient(raw);
      if(!base.ok) return base;
      try{
        const r = await fetch(VALIDATE_EMAIL_ENDPOINT,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: base.normalized, want_mx:true }) });
        const j = await r.json();
        if(!j.ok) return { ok:false, error:j.error||'Email validation failed.' };
        return { ok:true, normalized: base.normalized, disposable: !!j.disposable, has_mx: typeof j.has_mx==='boolean'? j.has_mx: undefined, suggestion: j.suggestion||base.suggestion||null, info: base.info };
      }catch{
        return base;
      }
    }

    const surveyFlow = {
      start: {
        message: "Hello! I'm Chloe, an AI assistant for a research study. We're gathering feedback from people to better understand the debt settlement process. Would you be willing to participate?",
        type: 'multiple-choice',
        options: ["Yes, I'll participate", "No, thank you"],
        action: (a)=> a==="Yes, I'll participate" ? goToStep('askDebtAmount') : goToStep('leaveSurvey')
      },

      leaveSurvey: { message: 'No problem at all. Thank you for your time. You will now be redirected.', end: true, status: 18 },

      askDebtAmount: {
        message: 'Great! To ensure this study is relevant for you, approximately how much unsecured debt (like credit cards or personal loans) do you have?',
        type: 'multiple-choice',
        options: ['Under $10,000', '$10,000 or more'],
        action: (a)=> a==='Under $10,000' ? goToStep('disqualify') : goToStep('askIncome')
      },

      askIncome: {
        message: 'Thank you. And do you have a steady source of income? This is usually required for debt settlement programs.',
        type: 'multiple-choice',
        options: ['Yes', 'No'],
        action: (a)=> a==='No' ? goToStep('disqualify') : goToStep('screenIntro')
      },

      screenIntro: {
        message: 'Great—quick heads up: this research includes a **free, no-obligation consultation** with a debt specialist so we can gather real-world feedback. To match you correctly, just a couple of quick questions.',
        next: 'whoConsultFor'
      },

      whoConsultFor: {
        message: 'To confirm we match the consultation correctly, who is it for?',
        type: 'multiple-choice',
        options: ['Myself', 'Me & my partner', 'A family member (I\'m the decision maker)', 'I\'m just researching'],
        action: (a)=> a==="I'm just researching" ? goToStep('disqualify') : goToStep('debtTypeMajority')
      },

      debtTypeMajority: {
        message: 'Which kinds of debt make up most of the amount?',
        type: 'multiple-choice',
        options: ['Credit cards', 'Personal loans', 'Store cards', 'Medical bills', 'Collections', 'Student loans', 'Tax debt', 'Auto loan', 'Mortgage'],
        action: (a)=> (a==='Auto loan' || a==='Mortgage') ? goToStep('securedNotEligible') : goToStep('monthsBehind')
      },

      securedNotEligible: {
        message: 'This study focuses on unsecured debts (credit cards, personal loans, etc.). Secured debts like auto loans or mortgages usually aren’t eligible.',
        next: 'disqualify'
      },

      monthsBehind: {
        message: 'How many months are you behind or struggling with minimums?',
        type: 'multiple-choice',
        options: ['Current but only paying minimums', '30–59 days', '60–89 days', '90+ days'],
        action: ()=> goToStep('numCreditors')
      },

      numCreditors: {
        message: 'How many creditors do you have?',
        type: 'multiple-choice',
        options: ['1–2', '3–5', '6–10', '10+'],
        action: ()=> goToStep('hardshipCause')
      },

      hardshipCause: {
        message: 'What caused the hardship?',
        type: 'multiple-choice',
        options: ['Job/income loss', 'Medical expenses', 'Divorce/household change', 'Cost of living increase', 'Business slowdown', 'Other'],
        action: ()=> goToStep('budgetSetAside')
      },

      budgetSetAside: {
        message: 'What could you realistically set aside monthly if a plan starts?',
        type: 'multiple-choice',
        options: ['<$150', '$150–$249', '$250–$349', '$350–$499', '$500+'],
        action: ()=> goToStep('currentPrograms')
      },

      currentPrograms: {
        message: 'Are you currently in bankruptcy or a debt management program?',
        type: 'multiple-choice',
        options: ['No', 'In/Filed Bankruptcy', 'In a Debt Management Plan', 'Considering'],
        action: (a)=> (a==='In/Filed Bankruptcy' || a==='In a Debt Management Plan') ? goToStep('disqualify') : goToStep('willingStopCards')
      },

      willingStopCards: {
        message: 'If you enroll, are you willing to stop using the cards included in the program?',
        type: 'multiple-choice',
        options: ['Yes', 'No', 'Not sure'],
        action: (a)=> a==='No' ? goToStep('disqualify') : goToStep('okToCall')
      },

      okToCall: {
        message: 'Are you okay to receive a call from a debt specialist in the next 1–3 days?',
        type: 'multiple-choice',
        options: ['Yes', 'Prefer text first', 'No'],
        action: (a)=> a==='No' ? goToStep('disqualify') : goToStep('languagePref')
      },

      languagePref: {
        message: 'Language preference?',
        type: 'multiple-choice',
        options: ['English', 'Español'],
        action: ()=> goToStep('largestCreditor')
      },

      largestCreditor: {
        message: 'Who is your largest creditor?',
        type: 'multiple-choice',
        options: ['Capital One', 'Chase', 'Citi', 'Bank of America', 'Discover', 'American Express', 'Synchrony', 'Wells Fargo', 'Other/Not listed'],
        action: ()=> goToStep('callbackWindow')
      },

      callbackWindow: {
        message: 'What time is best for a quick call?',
        type: 'multiple-choice',
        options: ['Morning (9–12)', 'Afternoon (12–3)', 'Late Afternoon (3–6)', 'Early Evening (6–8)'],
        action: ()=> goToStep('qualified')
      },

      disqualify: {
        message: "I appreciate you answering. Based on your responses, this study isn't the right fit. Thank you for your time. You will be redirected now.",
        end: true, status: 18
      },

      qualified: {
        message: 'Fantastic! You\'ve qualified for the study. The main part of our research involves having you complete a short, secure form to request a free consultation from a debt specialist.',
        next: 'reassure'
      },

      reassure: {
        message: 'Before I show you the form, I want to be transparent. To get genuine feedback, this study is for people who are truly interested in getting help with their debt. We\'ve carefully researched and selected a reputable company, <strong>CuraDebt</strong>, to connect our participants with. They will be the ones to contact you.',
        next: 'educateOnDebtRelief'
      },

      educateOnDebtRelief: {
        message: "Just so you know what to expect, a debt settlement service works to negotiate with your creditors to lower the amount you owe. The goal is often to combine your payments into a single, more manageable monthly amount, with a plan to get you out of debt in about 2–4 years. It's a powerful option for many people.",
        next: 'explainTask'
      },

      explainTask: {
        message: 'Your real-world experience with them is what makes this study so valuable. After you submit this form, a CuraDebt specialist will call you within the next few days. Following their call, you\'ll receive an email from us asking for your feedback on the conversation and to confirm if you were successfully contacted. Your input is vital as it helps us create articles that guide people in similar situations. Are you ready to take the next step?',
        type: 'multiple-choice',
        options: ["Yes, I'm ready"],
        action: ()=> goToStep('showApiForm')
      },

      showApiForm: {
        message: "Excellent! Please complete the secure form below. I'll be here once you've submitted it.",
        type: 'api-form'
      },

      formSuccess: {
        message: 'Thank you! Your information has been sent securely. A debt specialist will be calling you in the next few days.',
        next: 'askToContinueToFeedback'
      },
      askToContinueToFeedback: {
        message: 'Now for the final step. Ready to provide your feedback?',
        type: 'multiple-choice',
        options: ['Yes, Continue to Feedback'],
        action: () => goToStep('askForFeedback')
      },
      askForFeedback: {
        message: 'Please complete the form below. You\'ll need to enter your email address so we can match your feedback to your initial submission.',
        type: 'iframe-form',
        iframeSrc: 'https://digitalresearch1.github.io/debt/brevo.html',
        next: 'complete'
      },

      complete: {
        message: "That's everything! Thank you so much for your valuable feedback. You will now be redirected to finalize your entry.",
        end: true, status: 21
      }
    };

    function showApiForm(){
      chatInputArea.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'w-full bg-white/5 border border-white/10 rounded-2xl p-4 my-2 text-white backdrop-blur';

      const form = document.createElement('form');
      form.id = 'cura-debt-form';
      form.className = 'embedded-form w-full space-y-4';
      form.innerHTML = `
        <div class="text-center">
          <label for="debt-slider" class="text-sm font-medium text-white/80">Select Amount Of Unsecured Debt</label>
          <p id="debt-amount-display" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-violet-400 to-fuchsia-400 my-2">$25,000</p>

          <input type="range" id="debt-slider" min="0" max="100000" value="25000" step="100" class="w-full" list="debt-ticks">
          <datalist id="debt-ticks">
            <option value="0"></option><option value="5000"></option><option value="10000"></option>
            <option value="20000"></option><option value="30000"></option><option value="40000"></option>
            <option value="50000"></option><option value="75000"></option><option value="100000"></option>
          </datalist>

          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 items-center gap-3">
            <label class="text-xs text-white/70 sm:col-span-1" for="debt-number">Or type exact amount</label>
            <input type="text" id="debt-number" inputmode="numeric" placeholder="e.g. 12,450"
                   class="sm:col-span-2 bg-white/10 border border-white/10 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500/60" value="25,000">
          </div>
          <p id="move-hint" class="text-xs text-yellow-300 mt-2">Move the slider to confirm your amount.</p>
          <div id="debt-warning" class="text-[11px] text-amber-300 mt-2 hidden">Minimum debt is $10,000 to qualify.</div>
          <input type="hidden" id="debt-confirmed" value="0">
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <input type="text" name="f_fname" placeholder="First Name" required class="bg-white/10 border border-white/10 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500/60" />
          <input type="text" name="f_lname" placeholder="Last Name" required class="bg-white/10 border border-white/10 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500/60" />
        </div>

        <input type="email" name="f_email" id="f_email" placeholder="Email Address" required class="bg-white/10 border border-white/10 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-indigo-500/60" />
        <div id="email-hint" class="text-[11px] mt-1 text-white/70" aria-live="polite"></div>

        <input type="tel" name="f_phone" id="f_phone" placeholder="Phone Number" required class="bg-white/10 border border-white/10 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-indigo-500/60" />
        <div id="phone-hint" class="text-[11px] mt-1 text-white/70" aria-live="polite"></div>

        <!-- OTP UI (always visible) -->
        <div id="otp-ui" class="mt-2 space-y-2">
          <div class="flex flex-wrap gap-2 items-center">
            <button type="button" id="send-otp"
                    class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-xs shadow ring-1 ring-white/10">
              Send verification code
            </button>

            <div class="flex gap-2 items-center">
              <input id="otp-code"
                     class="bg-white/10 border border-white/10 p-2 rounded w-36 focus:ring-2 focus:ring-indigo-500/60"
                     placeholder="6-digit code" maxlength="6" />
              <button type="button" id="check-otp"
                      class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs shadow ring-1 ring-white/10">
                Verify number
              </button>
            </div>

            <span id="otp-status" class="text-xs text-white/80"></span>
          </div>
          <div id="recaptcha-container"></div>
        </div>

        <select name="f_whereyoulive" required class="bg-white/10 border border-white/10 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-indigo-500/60">
          <option value="" disabled selected>Select Your State</option>
        </select>

        <label class="flex items-start gap-2 text-[11px] text-white/80">
          <input type="checkbox" id="tcpa" required class="mt-1">
          <span>By clicking, you agree to be contacted by CuraDebt and its partners at the number and email provided (including via automated dialing/texts). Your consent is not required to purchase. Message/data rates may apply.</span>
        </label>

        <button type="submit" id="submit-btn"
                class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-base py-3 rounded-xl transition disabled:opacity-60 disabled:cursor-not-allowed shadow">
                Select amount to continue
        </button>

        <div id="form-error" class="text-rose-300 font-semibold text-center text-sm hidden"></div>
      `;

      wrapper.appendChild(form);
      chatWindow.appendChild(wrapper);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // populate states
      const stateSelect = form.querySelector('select[name="f_whereyoulive"]');
      allStates.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; stateSelect.appendChild(o); });

      // slider & amount
      const MIN_QUAL=10000, MAX_DEBT=100000;
      const debtSlider=form.querySelector('#debt-slider'), debtDisplay=form.querySelector('#debt-amount-display'), debtNumber=form.querySelector('#debt-number');
      const submitBtn=form.querySelector('#submit-btn'), debtConfirmedEl=form.querySelector('#debt-confirmed');
      const debtWarning=form.querySelector('#debt-warning'), moveHint=form.querySelector('#move-hint');
      const fmt=(n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0}).format(n);
      const toInt=(s)=>{ const n=parseInt(String(s||'').replace(/[^\d]/g,''),10); return isNaN(n)?0:n; };

      const setSubmitState = ()=>{
        const v = parseInt(debtSlider.value||'0',10);
        const confirmed = debtConfirmedEl.value==='1';
        const state = stateSelect.value;
        const consentOK = form.querySelector('#tcpa')?.checked;
        const amountOK = confirmed && v>=MIN_QUAL;
        const stateOK = !!state && !excludedStates.includes(state);
        const otpOK = window.otpOK === true;

        if(moveHint) moveHint.classList.toggle('hidden', confirmed);

        let btnText='See If I Qualify';
        if(!confirmed){ btnText='Select amount to continue'; }
        else if(v<MIN_QUAL){ btnText='Minimum $10,000 required'; }
        else if(!otpOK){ btnText='Verify your phone to continue'; }
        else if(!consentOK){ btnText='Consent required'; }
        else if(!stateOK){ btnText='State not serviced'; }

        submitBtn.disabled = !(amountOK && stateOK && consentOK && otpOK);
        submitBtn.textContent = btnText;

        debtWarning.classList.toggle('hidden', v>=MIN_QUAL);
      };

      const applyAmount = (raw)=>{
        const clamped = Math.max(0, Math.min(MAX_DEBT, Math.round(raw)));
        debtSlider.value = clamped;
        debtNumber.value = clamped.toLocaleString('en-US');
        debtDisplay.textContent = clamped>=MAX_DEBT ? `${fmt(clamped)}+` : fmt(clamped);
        debtConfirmedEl.value='1';
        setSubmitState();
      };

      debtDisplay.textContent = fmt(parseInt(debtSlider.value,10));
      setSubmitState();

      debtSlider.addEventListener('input', ()=> applyAmount(parseInt(debtSlider.value,10)));
      debtNumber.addEventListener('input', ()=> applyAmount(toInt(debtNumber.value)));
      debtNumber.addEventListener('blur', ()=> debtNumber.value = toInt(debtNumber.value).toLocaleString('en-US'));
      stateSelect.addEventListener('change', setSubmitState);
      form.querySelector('#tcpa').addEventListener('change', setSubmitState);

      // Email validation UI
      const emailInput = form.querySelector('#f_email');
      const emailHint = form.querySelector('#email-hint');
      const runEmailUI = async ()=>{
        if(!emailInput.value){ emailHint.textContent=''; return; }
        emailHint.textContent='Checking email…';
        const res = await validateEmailWithWorker(emailInput.value);
        if(res.ok){
          let msg='✅ Valid';
          if(res.suggestion) msg += ` (did you mean ${emailInput.value.split('@')[0]}@${res.suggestion}?)`;
          if(res.disposable) msg='⚠️ Disposable address detected. Use a personal/work email.';
          if(res.info?.role) msg='⚠️ Role account not accepted.';
          if(res.info?.plusAnywhere) msg='⚠️ Plus-alias not accepted.';
          if(res.info?.gmailDot) msg='⚠️ Gmail dot alias not accepted.';
          emailHint.textContent = msg;
          emailHint.classList.toggle('text-emerald-300', !res.disposable && !res.info?.role && !res.info?.plusAnywhere && !res.info?.gmailDot);
          emailHint.classList.toggle('text-amber-300', !!(res.disposable || res.info?.role || res.info?.plusAnywhere || res.info?.gmailDot));
          emailHint.classList.remove('text-rose-300');
        }else{
          emailHint.textContent = `❌ ${res.error}`;
          emailHint.classList.add('text-rose-300'); emailHint.classList.remove('text-emerald-300','text-amber-300');
        }
      };
      emailInput.addEventListener('blur', runEmailUI);
      emailInput.addEventListener('change', runEmailUI);

      // Phone validation UI
      const phoneInput = form.querySelector('#f_phone');
      const phoneHint = form.querySelector('#phone-hint');
      const runPhoneUI = async ()=>{
        if(!phoneInput.value){ phoneHint.textContent=''; return; }
        phoneHint.textContent='Checking number…';
        const res = await validatePhoneWithSignalWire(phoneInput.value);
        if(res.ok){
          const extra = res?.meta?.tollFree ? ' (toll-free)' : '';
          phoneHint.textContent = `✅ ${res.e164}${extra}`;
          phoneHint.classList.add('text-emerald-300'); phoneHint.classList.remove('text-rose-300','text-amber-300');
        }else{
          phoneHint.textContent = `❌ ${res.error}`;
          phoneHint.classList.add('text-rose-300'); phoneHint.classList.remove('text-emerald-300','text-amber-300');
        }
      };
      phoneInput.addEventListener('blur', runPhoneUI);
      phoneInput.addEventListener('change', runPhoneUI);

      // OTP wiring (Send + Verify)
      const sendBtn  = form.querySelector('#send-otp');
      const checkBtn = form.querySelector('#check-otp');
      const codeInput= form.querySelector('#otp-code');
      const statusEl = form.querySelector('#otp-status');
      const recaptchaDiv = form.querySelector('#recaptcha-container');

      let verifier;
      function ensureRecaptcha(){
        if(!verifier){
          verifier = new RecaptchaVerifier(auth, recaptchaDiv, { size: 'invisible' });
        }
        return verifier;
      }

      sendBtn.addEventListener('click', async ()=>{
        const parsed = parseStrictNANP(phoneInput.value);
        if(!parsed.ok){ statusEl.textContent = parsed.error; statusEl.className='text-xs text-rose-300'; return; }
        try{
          statusEl.textContent = 'Sending code…'; statusEl.className='text-xs text-white/80';
          confirmationResult = await signInWithPhoneNumber(auth, parsed.e164, ensureRecaptcha());
          statusEl.textContent = 'Code sent. Check SMS.'; statusEl.className='text-xs text-emerald-300';
        }catch(e){
          statusEl.textContent = `Failed to send (${e?.code||'unknown'}): ${e?.message||e}`;
          statusEl.className='text-xs text-rose-300';
        }
      });

      checkBtn.addEventListener('click', async ()=>{
        const code = (codeInput.value||'').trim();
        if(!confirmationResult){ statusEl.textContent='Click "Send verification code" first.'; statusEl.className='text-xs text-rose-300'; return; }
        if(code.length !== 6){ statusEl.textContent='Enter the 6-digit code.'; statusEl.className='text-xs text-rose-300'; return; }
        try{
          statusEl.textContent='Verifying…'; statusEl.className='text-xs text-white/80';
          await confirmationResult.confirm(code);
          window.otpOK = true;
          statusEl.textContent='Verified ✓'; statusEl.className='text-xs text-emerald-300';
          setSubmitState();
        }catch(e){
          window.otpOK = false;
          statusEl.textContent = `Verify failed. ${e?.code||''}`; statusEl.className='text-xs text-rose-300';
          setSubmitState();
        }
      });

      phoneInput.addEventListener('input', ()=>{ window.otpOK=false; statusEl.textContent=''; setSubmitState(); });

      form.addEventListener('submit', handleApiFormSubmit);
    }

    async function handleApiFormSubmit(e){
      e.preventDefault();
      const form = e.target;
      const submitButton = form.querySelector('#submit-btn');
      const formError = form.querySelector('#form-error');

      formError.classList.add('hidden');

      if(!window.otpOK){
        formError.textContent = 'Please verify your phone number to continue.';
        formError.classList.remove('hidden');
        return;
      }

      submitButton.disabled = true;
      submitButton.innerHTML = '<div class="loader mx-auto"></div>';

      const debtAmount = parseInt(form.querySelector('#debt-slider').value,10) || 0;
      const selectedState = form.querySelector('select[name="f_whereyoulive"]').value;
      const confirmed = (document.getElementById('debt-confirmed')?.value === '1');

      if(!confirmed){
        formError.textContent = 'Please confirm your debt amount by moving the slider or typing the exact amount.';
        formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return;
      }
      if(debtAmount < 10000){
        formError.textContent = 'Minimum debt of $10,000 is required to qualify.';
        formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return;
      }
      if(excludedStates.includes(selectedState)){
        formError.textContent = 'Unfortunately, we do not service your state at this time.';
        formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return;
      }
      if(!form.querySelector('#tcpa')?.checked){
        formError.textContent = 'Please agree to the consent to continue.';
        formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return;
      }

      // Email validation
      const emailRaw = form.querySelector('input[name="f_email"]').value || '';
      const emailCheck = await validateEmailWithWorker(emailRaw);
      if(!emailCheck.ok || emailCheck.disposable || emailCheck.info?.role || emailCheck.info?.plusAnywhere || emailCheck.info?.gmailDot){
        formError.textContent = emailCheck.ok ? 'Please use a personal, non-role, non-alias email.' : (emailCheck.error||'Invalid email.');
        formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return;
      }
      const normalizedEmail = emailCheck.normalized;
      let emailStatusTag='normal';
      if(emailCheck.disposable) emailStatusTag='disposable';
      else if(emailCheck.info?.role) emailStatusTag='role';
      else if(emailCheck.info?.plusAnywhere) emailStatusTag='plus';
      else if(emailCheck.info?.gmailDot) emailStatusTag='gmaildot';

      // Phone validation (format for posting)
      const phoneRaw = form.querySelector('input[name="f_phone"]').value || '';
      const phoneCheck = await validatePhoneWithSignalWire(phoneRaw);
      if(!phoneCheck.ok){
        formError.textContent = phoneCheck.error || 'Please enter a valid phone number.';
        formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return;
      }
      const normalizedE164 = phoneCheck.e164 || phoneRaw;
      const phoneType = phoneCheck.type || 'unknown';
      const isTollFree = !!(phoneCheck.meta && phoneCheck.meta.tollFree);

      // IP best-effort
      try{
        const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json(); clientIp = j.ip || '';
      }catch{ clientIp=''; }

      // ---- Submit to CuraDebt (hidden iframe) ----
      const hidden = document.getElementById('hidden-curadebt-post');
      const fd = new FormData(form);
      const data1 = getData1FromUrl() || transactionId;

      hidden.elements['f_fname'].value        = fd.get('f_fname') || '';
      hidden.elements['f_lname'].value        = fd.get('f_lname') || '';
      hidden.elements['f_email'].value        = normalizedEmail;
      hidden.elements['f_phone'].value        = normalizedE164.startsWith('+1') ? normalizedE164.replace('+1','') : normalizedE164;
      hidden.elements['f_whereyoulive'].value = fd.get('f_whereyoulive') || '';
      hidden.elements['f_totaldebt'].value    = String(debtAmount);
      hidden.elements['data1'].value          = data1;
      hidden.elements['f_comments'].value     = `Lead from AI Chatbot Survey | phone_type=${phoneType} | email_status=${emailStatusTag} | toll_free=${isTollFree}`;
      hidden.elements['data2'].value          = 'CLICKID2';
      hidden.elements['f_ip'].value           = clientIp;
      hidden.submit();

      // ---- Submit to TrackDrive (hidden iframe) ----
      const tdForm = document.getElementById('hidden-trackdrive-post');
      const qs = new URLSearchParams(location.search);
      const gclid = qs.get('gclid') || '';
      const fbeventid = qs.get('fbclid') || '';
      const msclkid = qs.get('msclkid') || '';

      tdForm.elements['caller_id'].value = normalizedE164;          // must be +1XXXXXXXXXX
      tdForm.elements['first_name'].value= fd.get('f_fname') || '';
      tdForm.elements['last_name'].value = fd.get('f_lname') || '';
      tdForm.elements['email'].value     = normalizedEmail;
      tdForm.elements['state'].value     = fd.get('f_whereyoulive') || '';
      tdForm.elements['zip'].value       = fd.get('f_zip') || '';
      tdForm.elements['ip_address'].value= clientIp || '';
      tdForm.elements['source_url'].value= location.href;
      tdForm.elements['useragent'].value = navigator.userAgent || '';
      tdForm.elements['original_lead_submit_date'].value = new Date().toISOString().replace('T',' ').slice(0,19);
      tdForm.elements['tcpa_opt_in'].value = 'true';
      tdForm.elements['tcpa_optin_consent_language'].value = (document.querySelector('label[for="tcpa"] span')?.innerText || 'TCPA consent captured').trim();
      tdForm.elements['sub_id'].value     = data1;
      tdForm.elements['gclid'].value      = gclid;
      tdForm.elements['fbeventid'].value  = fbeventid;
      tdForm.elements['msclkid'].value    = msclkid;
      tdForm.elements['traffic_source_lead_id'].value = transactionId;

      tdForm.submit();

      // advance
      form.parentElement.remove();
      addMessage("I've submitted my information.", 'user');
      goToStep('formSuccess');
    }

    /* === iframe renderer === */
    function showIframeForm(iframeSrc, onContinue) {
      const container = createBaseContainer();
      const formWrapper = document.createElement('div');
      formWrapper.className = 'w-full h-[70vh] flex-grow bg-white/5 rounded-xl p-1 ring-1 ring-white/10 backdrop-blur';

      const iframe = document.createElement('iframe');
      const rid = transactionId || (window.__rid ||= ('tx_'+Date.now()));
      iframe.src = `${iframeSrc}?rid=${encodeURIComponent(rid)}`;
      iframe.className = 'w-full h-full border-0 rounded-md';
      iframe.setAttribute('loading','lazy');
      iframe.setAttribute('referrerpolicy','no-referrer-when-downgrade');
      formWrapper.appendChild(iframe);

      chatWindow.innerHTML = '';
      chatWindow.appendChild(formWrapper);
      chatWindow.scrollTop = 0;

      const continueButton = document.createElement('button');
      continueButton.className = 'bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold text-base py-3 px-6 rounded-xl transition mt-4 shadow ring-1 ring-white/10';
      continueButton.textContent = "I've Submitted My Feedback";
      continueButton.onclick = () => {
        addMessage("I've Submitted My Feedback", 'user');
        formWrapper.remove();
        onContinue();
      };

      container.appendChild(continueButton);
      chatInputArea.innerHTML = '';
      chatInputArea.appendChild(container);
    }

    function goToStep(stepKey, showMessage=true){
      const step = surveyFlow[stepKey]; if(!step) return;
      currentStepKey = stepKey;
      const keys = Object.keys(surveyFlow);
      updateProgress(keys.indexOf(stepKey), keys.length);

      const delay = 900;
      if(step.message && showMessage) setTimeout(()=> addMessage(step.message, 'bot'), delay/2);

      if(step.end){
        chatInputArea.innerHTML = `<p class="text-center text-white/70 text-sm">You will be redirected shortly...</p>`;
        const finalUrl = `https://spectrumsurveys.com/surveydone?st=${step.status}&transaction_id=${transactionId}`;
        setTimeout(()=>{ window.location.href = finalUrl; }, 2000);
        return;
      }

      const timeout = (step.message && showMessage) ? delay : 100;
      setTimeout(()=>{
        if(step.type==='multiple-choice') showOptions(step.options, step.action, { primaryIndex:0, showNumbers:true });
        else if(step.type==='api-form') showApiForm();
        else if(step.type==='iframe-form') showIframeForm(step.iframeSrc, () => goToStep(step.next));
        else if(step.next) goToStep(step.next);
      }, timeout);
    }

    function updateProgress(index, total){
      const p = Math.max(0, Math.min(100, (index/Math.max(1,total-1))*100));
      progressBar.style.width = `${p}%`;
    }

    async function init(){
      const urlParams = new URLSearchParams(window.location.search);
      transactionId = urlParams.get('transaction_id') || urlParams.get('RID') || `tx_${Date.now()}`;
      try{ const r = await fetch('https://api.ipify.org?format=json'); const j = await r.json(); clientIp = j.ip; }catch{ clientIp=''; }
      goToStep('start');
    }
    init();
  </script>
</body>
</html>

