
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en" class="supernova">
<head>
Â  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=1">
Â  <meta name="HandheldFriendly" content="true">
Â  <title>Financial Wellness Research Study</title>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <!-- SHA3 library for TheoremReach enc -->
Â  <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.2/build/sha3.min.js"></script>
Â  <style type="text/css">
Â  Â  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

Â  Â  .action-btn { transition: background-color 0.3s, transform 0.2s; cursor: pointer; }
Â  Â  .action-btn:hover { transform: translateY(-2px); }

Â  Â  .chat-bubble {
Â  Â  Â  max-width: 80%;
Â  Â  Â  border-radius: 1rem;
Â  Â  Â  padding: 0.75rem 1rem;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â  .chat-botÂ  { background-color: #eef2ff; color: #111827; align-self: flex-start; }
Â  Â  .chat-user { background-color: #4f46e5; color: white; align-self: flex-end; }
    
    /* NEW: Brevo Form Specific Styles */
    @font-face { font-display: block; font-family: Roboto; src: url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/7529907e9eaf8ebb5220c5f9850e3811.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/25c678feafdc175a70922a116c9be3e7.woff) format("woff") }
    @font-face { font-display: fallback; font-family: Roboto; font-weight: 600; src: url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/6e9caeeafb1f3491be3e32744bc30440.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/71501f0d8d5aa95960f6475d5487d4c2.woff) format("woff") }
    /* Brevo Field Hiding */
    .brevo-hidden-fields input { background: transparent !important; color: transparent !important; }
    .disabled-btn { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
    /* END NEW: Brevo Form Specific Styles */

Â  Â  .chat-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 0.5rem;
Â  Â  }

Â  Â  .video-wrapper {
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 1200px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  box-shadow: 0 20px 40px rgba(15,23,42,0.35);
Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  overflow: hidden;
Â  Â  Â  background: #000;
Â  Â  }
Â  Â  .video-wrapper iframe {
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  display: block;
Â  Â  Â  border: 0;
Â  Â  }

Â  Â  @media (max-width: 768px) {
Â  Â  Â  .video-wrapper { height: 220px; }
Â  Â  }
Â  Â  @media (min-width: 769px) {
Â  Â  Â  .video-wrapper { height: 480px; }
Â  Â  }

Â  Â  .fade-out {
Â  Â  Â  animation: fadeOutUp 0.35s forwards ease-out;
Â  Â  }
Â  Â  @keyframes fadeOutUp {
Â  Â  Â  0%Â  Â { opacity: 1; transform: translateY(0); }
Â  Â  Â  100% { opacity: 0; transform: translateY(-6px); }
Â  Â  }
Â  </style>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="chatOverlay" class="w-full bg-white flex flex-col max-w-5xl mx-auto min-h-screen shadow-lg">
Â  <!-- Chat header -->
Â  <div class="p-4 bg-indigo-600 text-white text-center shadow">
Â  Â  <h1 class="text-xl font-bold">Financial Wellness Screening Chat</h1>
Â  Â  <p class="text-xs mt-1 text-indigo-100">
Â  Â  Â  Please answer a few quick questions so we can see if this private study is a good fit for you.
Â  Â  </p>
Â  </div>

Â  <!-- Chat body -->
Â  <div class="flex-1 flex flex-col bg-slate-50 p-4">
Â  Â  <div id="chatWindow" class="chat-container"></div>
Â  Â  <div id="chatControls" class="mt-4 flex flex-wrap gap-2 bg-white border-t border-slate-200 p-3 rounded-lg"></div>
Â  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
Â  const urlParams = new URLSearchParams(window.location.search);
Â  let transactionId = urlParams.get('transaction_id') || urlParams.get('RID');

Â  // src=ps (PureSpectrum) or src=tr (TheoremReach)
Â  const src = urlParams.get('src') || 'ps';

Â  if (!transactionId) {
Â  Â  transactionId = 'tx_' + Date.now().toString(36) +
Â  Â  Â  Math.random().toString(36).substring(2);
Â  }

Â  const chatWindowÂ  Â = document.getElementById('chatWindow');
Â  const chatControls = document.getElementById('chatControls');

Â  // =========================
Â  // TheoremReach constants
Â  // =========================
Â  const TR_BASEÂ  Â  = 'https://surveys.theoremreach.com/respondent_result';
Â  const SECRET_KEY = 'b747a0bc7e7e618c2df9abdd0ab6e2fa89736c86';

Â  function buildTRUrl(result, reason) {
Â  Â  const baseUrl =
Â  Â  Â  TR_BASE +
Â  Â  Â  '?result=' + encodeURIComponent(result) +
Â  Â  Â  '&transaction_id=' + encodeURIComponent(transactionId) +
Â  Â  Â  '&reason=' + encodeURIComponent(reason || 'screen_out');

Â  Â  const hashInput = baseUrl + SECRET_KEY;
Â  Â  const enc = sha3_256(hashInput);

Â  Â  return baseUrl + '&enc=' + enc;
Â  }

Â  // TheoremReach COMPLETE + SCREENOUT URLs (only used if src=tr)
Â  const trCompleteUrlÂ  = buildTRUrl(10, 'survey_complete');
Â  const trScreenoutUrl = buildTRUrl(4,Â  'screen_out');

Â  // =========================
Â  // Other URLs
Â  // =========================

Â  // PureSpectrum screenout URL (st=18)
Â  const psScreenoutUrl =
Â  Â  `https://spectrumsurveys.com/surveydone?st=18&transaction_id=${encodeURIComponent(transactionId)}`;

Â  function getScreenoutUrl(reasonCode) {
Â  Â  if (src === 'tr') {
Â  Â  Â  // TheoremReach
Â  Â  Â  return buildTRUrl(4, reasonCode || 'screen_out');
Â  Â  } else {
Â  Â  Â  // PureSpectrum
Â  Â  Â  return psScreenoutUrl;
Â  Â  }
Â  }

Â  // For pre-screener generic fail:
Â  const abandonUrl = getScreenoutUrl('pre_screener_fail');

Â  // MarketCall offer link with subid=transaction_id
Â  const offerBaseUrlÂ  Â  = 'https://trkmcl.com/wy8odpg43k/p98vjj0e83';
Â  const offerTrackedUrl = offerBaseUrl + '?subid=' + encodeURIComponent(transactionId);

Â  // Worker finish URL (auto-routes PS/TR based on src)
Â  const workerFinishUrl =
Â  Â  'https://marketcall.kayembakasongo.workers.dev/finish' +
Â  Â  '?transaction_id=' + encodeURIComponent(transactionId) +
Â  Â  '&src=' + encodeURIComponent(src) +
Â  Â  '&tr_complete=' + encodeURIComponent(trCompleteUrl) +
Â  Â  '&tr_screenout=' + encodeURIComponent(trScreenoutUrl);

Â  // ----- Helpers -----
Â  function scrollToBottom() {
Â  Â  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
Â  }

Â  function addBotMessage(text) {
Â  Â  const bubble = document.createElement('div');
Â  Â  bubble.className = 'chat-bubble chat-bot';
Â  Â  bubble.textContent = text;
Â  Â  chatWindow.appendChild(bubble);
Â  Â  scrollToBottom();
Â  }

Â  function addUserMessage(text) {
Â  Â  const bubble = document.createElement('div');
Â  Â  bubble.className = 'chat-bubble chat-user ml-auto';
Â  Â  bubble.textContent = text;
Â  Â  chatWindow.appendChild(bubble);
Â  Â  scrollToBottom();
Â  }

Â  function clearControls() {
Â  Â  chatControls.innerHTML = '';
Â  }

Â  function renderOptions(options) {
Â  Â  clearControls();
Â  Â  options.forEach(opt => {
Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  btn.className =
Â  Â  Â  Â  'px-3 py-2 text-xs md:text-sm rounded-full border border-slate-300 bg-white hover:bg-slate-100 text-slate-900';
Â  Â  Â  btn.textContent = opt.label;
Â  Â  Â  btn.addEventListener('click', () => opt.onClick());
Â  Â  Â  chatControls.appendChild(btn);
Â  Â  });
Â  Â  scrollToBottom();
Â  }

Â  function fadeOutAllAndThen(nextFn) {
Â  Â  const nodes = Array.from(chatWindow.children);
Â  Â  if (!nodes.length) {
Â  Â  Â  nextFn();
Â  Â  Â  return;
Â  Â  }
Â  Â  nodes.forEach(node => node.classList.add('fade-out'));
Â  Â  setTimeout(() => {
Â  Â  Â  chatWindow.innerHTML = '';
Â  Â  Â  nextFn();
Â  Â  }, 360);
Â  }

Â  function addVideoBubble() {
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className = 'w-full mb-4';

Â  Â  const title = document.createElement('p');
Â  Â  title.className = 'text-[11px] font-semibold text-slate-700 mb-2';
Â  Â  title.textContent =
Â  Â  Â  'Here is a short video explaining the program for people with high balances:';
Â  Â  wrapper.appendChild(title);

Â  Â  const videoContainer = document.createElement('div');
Â  Â  videoContainer.className = 'video-wrapper';

Â  Â  const iframe = document.createElement('iframe');
Â  Â  iframe.src =
Â  Â  Â  'https://www.facebook.com/plugins/video.php?height=314&href=' +
Â  Â  Â  encodeURIComponent('https://www.facebook.com/reel/1205740158030889/') +
Â  Â  Â  '&show_text=true&width=860&t=0';
Â  Â  iframe.style.border = 'none';
Â  Â  iframe.style.overflow = 'hidden';
Â  Â  iframe.scrolling = 'no';
Â  Â  iframe.frameBorder = '0';
Â  Â  iframe.allowFullscreen = true;
Â  Â  iframe.setAttribute(
Â  Â  Â  'allow',
Â  Â  Â  'autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share'
Â  Â  );

Â  Â  videoContainer.appendChild(iframe);
Â  Â  wrapper.appendChild(videoContainer);

Â  Â  const hint = document.createElement('p');
Â  Â  hint.className = 'text-[11px] text-slate-600 mt-2';
Â  Â  hint.textContent =
Â  Â  Â  'When you finish watching, scroll down and click â€œI\'ve watched the videoâ€ to keep going.';
Â  Â  wrapper.appendChild(hint);

Â  Â  chatWindow.appendChild(wrapper);
Â  Â  scrollToBottom();
Â  }

Â  // Website link instead of iframe
Â  function addOfferLinkBubble() {
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className = 'w-full mb-4';

Â  Â  const title = document.createElement('p');
Â  Â  title.className = 'text-[11px] font-semibold text-slate-700 mb-2';
Â  Â  title.textContent =
Â  Â  Â  'Next, open the secure website in a new tab and complete the full form:';
Â  Â  wrapper.appendChild(title);

Â  Â  const card = document.createElement('div');
Â  Â  card.className =
Â  Â  Â  'w-full max-w-xl mx-auto bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col items-center gap-3';

Â  Â  const desc = document.createElement('p');
Â  Â  desc.className = 'text-xs text-slate-700 text-center';
Â  Â  desc.textContent =
Â  Â  Â  'Click the button below to open the form. Fill everything out honestly, then return here.';
Â  Â  card.appendChild(desc);

Â  Â  const linkBtn = document.createElement('a');
Â  Â  linkBtn.href = offerTrackedUrl;
Â  Â  linkBtn.target = '_blank';
Â  Â  linkBtn.relÂ  Â  = 'noopener noreferrer';
Â  Â  linkBtn.className =
Â  Â  Â  'action-btn inline-flex items-center justify-center px-5 py-3 rounded-full bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700';
Â  Â  linkBtn.textContent = 'Open Secure Form';
Â  Â  card.appendChild(linkBtn);

Â  Â  const note = document.createElement('p');
Â  Â  note.className = 'text-[11px] text-slate-500 text-center';
Â  Â  note.textContent =
Â  Â  Â  'After submitting the form, come back and click â€œI completed the formâ€ below.';
Â  Â  card.appendChild(note);

Â  Â  wrapper.appendChild(card);
Â  Â  chatWindow.appendChild(wrapper);
Â  Â  scrollToBottom();
Â  }

Â  function disqualify(reasonText, reasonCode) {
Â  Â  const finalReason =
Â  Â  Â  reasonText ||
Â  Â  Â  'Based on your answers, you do not match the profile for this particular research study.';

Â  Â  addBotMessage(finalReason);
Â  Â  addBotMessage(
Â  Â  Â  'Please click the button below to exit this survey. Thank you for your time.'
Â  Â  );

Â  Â  const screenoutUrl = getScreenoutUrl(reasonCode || 'pre_screener_fail');

Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Exit survey',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  window.location.href = screenoutUrl;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }
Â  
Â  // -------------------------------------------------------------
Â  // NEW: Brevo Success Handler (Must be defined before use)
Â  // -------------------------------------------------------------
Â  window.sib = {
Â  Â  callback: function(data) {
Â  Â  Â  if (data.status === 'success') {
Â  Â  Â  Â  console.log("Brevo submission successful. Enabling Continue button.");
Â  Â  Â  Â  addUserMessage('Save my email & continue');
Â  Â  Â  Â  
Â  Â  Â  Â  // Hide the Brevo form
Â  Â  Â  Â  const brevoBlock = document.getElementById('brevoBlock');
Â  Â  Â  Â  const continueButton = document.getElementById('mandatoryContinueBtn');

Â  Â  Â  Â  if (brevoBlock) brevoBlock.classList.add('hidden');
Â  Â  Â  Â  if (continueButton) {
Â  Â  Â  Â  Â  continueButton.disabled = false;
Â  Â  Â  Â  Â  continueButton.classList.remove('disabled-btn', 'bg-slate-400', 'cursor-not-allowed');
Â  Â  Â  Â  Â  continueButton.classList.add('bg-green-600', 'hover:bg-green-700');
Â  Â  Â  Â  Â  addBotMessage('âœ… **Success!** Your email is secured. Please click the green button to finalize your participation.');
Â  Â  Â  Â  }
Â  Â  Â  } else if (data.status === 'failure') {
Â  Â  Â  Â  console.error("Brevo submission failed.");
Â  Â  Â  Â  addBotMessage('âš ï¸ **Error:** There was an issue submitting your email. Please try again or ensure your email address is valid.');
Â  Â  Â  }
Â  Â  }
Â  };
Â  // -------------------------------------------------------------


Â  // ----- Chat Steps (same logic as before) -----

Â  function startChat() {
Â  Â  addBotMessage(
Â  Â  Â  "Hi, I'm Chloe. I'll quickly check if this private financial study is a good fit for you."
Â  Â  );
Â  Â  setTimeout(stepDebtAmount, 700);
Â  }

Â  function stepDebtAmount() {
Â  Â  addBotMessage(
Â  Â  Â  'First, roughly how much unsecured debt do you currently have? ' +
Â  Â  Â  '(Credit cards, personal loans, etc. â€” not including mortgage or auto loans.)'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Less than $5,000',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Less than $5,000');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'For this specific project, we are focusing on people with more than $15,000 in unsecured balances.',
Â  Â  Â  Â  Â  Â  Â  'debt_too_low'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: '$5,000 - $9,999',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('$5,000 - $9,999');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'For this specific project, we are focusing on people with more than $15,000 in unsecured balances.',
Â  Â  Â  Â  Â  Â  Â  'debt_too_low'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: '$10,000 - $14,999',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('$10,000 - $14,999');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'For this specific project, we are focusing on people with more than $15,000 in unsecured balances.',
Â  Â  Â  Â  Â  Â  Â  'debt_too_low'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: '$15,000 - $24,999',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('$15,000 - $24,999');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepUSResidency);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: '$25,000 - $39,999',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('$25,000 - $39,999');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepUSResidency);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: '$40,000 or more',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('$40,000 or more');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepUSResidency);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepUSResidency() {
Â  Â  addBotMessage('Do you currently live in the United States?');
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, I live in the U.S.',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, I live in the U.S.');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepStateAvailability);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, I live outside the U.S.',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, I live outside the U.S.');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'Right now this particular project is limited to U.S. residents only.',
Â  Â  Â  Â  Â  Â  Â  'non_us'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepStateAvailability() {
Â  Â  addBotMessage(
Â  Â  Â  'Our partners only operate in certain U.S. states. To the best of your knowledge, ' +
Â  Â  Â  'do you live in a state where debt relief programs like this are allowed? ' +
Â  Â  Â  '(Most states are included, but not all.)'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, I believe my state is eligible',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, my state is eligible');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepPaymentAbility);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, I know my state does not allow this',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, my state does not allow this');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'This project is limited to states where our partners are allowed to operate.',
Â  Â  Â  Â  Â  Â  Â  'state_not_allowed'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: "I'm not sure",
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage("I'm not sure");
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'For compliance reasons, this project requires participants who are confident ' +
Â  Â  Â  Â  Â  Â  Â  'that their state allows these programs.',
Â  Â  Â  Â  Â  Â  Â  'state_unknown'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepPaymentAbility() {
Â  Â  addBotMessage(
Â  Â  Â  'Could you realistically afford to put at least about $300 per month toward a structured plan ' +
Â  Â  Â  'if it helped you resolve your high balances faster?'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, I could afford that',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, I could afford that');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepTCPA1);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, I really cannot',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, I really cannot');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'This project focuses on people who are able to commit at least around $300/month to a structured plan.',
Â  Â  Â  Â  Â  Â  Â  'cannot_afford'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepTCPA1() {
Â  Â  addBotMessage(
Â  Â  Â  'Are you willing to receive a phone call from a financial specialist to discuss your situation ' +
Â  Â  Â  'and possible options?'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, Iâ€™m willing to receive a call',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, Iâ€™m willing to receive a call');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepTCPA2);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, I do not want any calls',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, I do not want any calls');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'This project is only for people who are open to being contacted by phone.',
Â  Â  Â  Â  Â  Â  Â  'no_call_consent'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepTCPA2() {
Â  Â  addBotMessage(
Â  Â  Â  'Do you agree that you may be contacted by phone or text, including automated or prerecorded messages, ' +
Â  Â  Â  'regarding financial services related to this program?'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, I agree',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, I agree');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepPhoneValidity);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, I do not agree',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, I do not agree');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'For legal reasons, we can only include people who consent to being contacted about this program.',
Â  Â  Â  Â  Â  Â  Â  'no_tcp_consent'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepPhoneValidity() {
Â  Â  addBotMessage(
Â  Â  Â  'Will you be providing your real personal mobile phone number that you can actually answer?'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, it will be my real mobile',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, it will be my real mobile');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepDuplicate);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, it might be a fake / other number',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, it might be a fake / other number');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'This project requires valid contact information so the specialist can actually reach you.',
Â  Â  Â  Â  Â  Â  Â  'invalid_contact'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepDuplicate() {
Â  Â  addBotMessage(
Â  Â  Â  'Have you already applied for a debt relief or consolidation program in the last 30 days ' +
Â  Â  Â  'with your current phone number?'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, I already applied recently',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, I already applied recently');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'This project is not accepting recent duplicate applications.',
Â  Â  Â  Â  Â  Â  Â  'duplicate'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, this is my first time applying',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, this is my first time applying');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepLanguage);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepLanguage() {
Â  Â  addBotMessage('Are you able to comfortably complete the call and discussion in English?');
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, I can speak English',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, I can speak English');
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepIntent);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, I only speak Spanish or another language',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, I only speak Spanish or another language');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'Right now this particular project is only set up for English-language calls.',
Â  Â  Â  Â  Â  Â  Â  'language'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepIntent() {
Â  Â  addBotMessage(
Â  Â  Â  'Are you actively looking for real help with your debt right now (not just testing or clicking for a reward)?'
Â  Â  );
Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Yes, Iâ€™m seriously looking for help',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('Yes, Iâ€™m seriously looking for help');
Â  Â  Â  Â  Â  fadeOutAllAndThen(finishQual);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: 'No, Iâ€™m just testing / curious',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('No, Iâ€™m just testing / curious');
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'This project is only for people who are actively looking for real help with their debt.',
Â  Â  Â  Â  Â  Â  Â  'incentivized_or_test'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function finishQual() {
Â  Â  addBotMessage('Great, you look like a strong match for this study. ðŸŽ‰');
Â  Â  addBotMessage(
Â  Â  Â  'Before we move forward, please watch this short video about the program. ' +
Â  Â  Â  'When you\'re done, scroll down and click â€œI\'ve watched the videoâ€ to continue.'
Â  Â  );
Â  Â  addVideoBubble();

Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: "I've watched the video",
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage("I've watched the video");
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepWebsiteLinkStep);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  function stepWebsiteLinkStep() {
Â  Â  addBotMessage(
Â  Â  Â  'Next, you\'ll open a secure website in a new tab to complete the full financial form. ' +
Â  Â  Â  'Please fill it out with accurate information, then return to this page. ' +
Â  Â  Â  'âš ï¸ We automatically verify if the form was successfully submitted. ' +
Â  Â  Â  'If it is not submitted, your participation will NOT be approved.'
Â  Â  );
Â  Â  addOfferLinkBubble();

Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'I completed the form',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage('I completed the form');
Â  Â  Â  Â  Â  // NEW: Go directly to the mandatory email gate
Â  Â  Â  Â  Â  fadeOutAllAndThen(stepEmailGate);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  label: "I don't want to continue",
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  addUserMessage("I don't want to continue");
Â  Â  Â  Â  Â  fadeOutAllAndThen(() => {
Â  Â  Â  Â  Â  Â  disqualify(
Â  Â  Â  Â  Â  Â  Â  'No problem at all. We will not count this as a full participation.',
Â  Â  Â  Â  Â  Â  Â  'user_quit'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);
Â  }

Â  // -------------------------------------------------------------
Â  // NEW: Mandatory Email Collection Gate
Â  // This function replaces the content of the old finalStep.
Â  // -------------------------------------------------------------
Â  function stepEmailGate() {
Â  Â  addBotMessage(
Â  Â  Â  'Before we can proceed to verification, your email is **mandatory** to send you a summary of your financial options and confirm your interest. ' +
Â  Â  Â  'You must submit your email below to activate the "Continue" button.'
Â  Â  );

Â  Â  // Brevo Form Injection
Â  Â  const formHtml = `
Â  Â  Â  Â  <div id="brevoBlock" class="p-4 mt-4 mb-4 bg-white border border-indigo-200 rounded-xl shadow-md">
Â  Â  Â  Â  Â  Â  <form id="brevoForm" action="https://spec-endpoint.ac-sib.workers.dev/23_4523773/submit" method="POST" data-sib-form-type="contact" class="sib-form-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sib-form-block" style="text-align: left;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="sib-input sib-input--required sib-email-area brevo-hidden-fields" data-style="inline">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="EMAIL_ADDRESS" class="text-sm font-medium text-gray-700 block mb-1">Your Email Address (Required)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" name="email_address" id="EMAIL_ADDRESS" required placeholder="Enter your email address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Hidden fields to capture essential data from URL params -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="SOURCE" value="SPEC-CHAT-FINAL">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="RID" value="${transactionId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Explicit consent checkbox is still critical for GDPR/CCPA -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sib-form-block sib-toggle-area mt-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="CONSENT" name="CONTACT_EMAIL_CONSENT" value="1" required class="form-checkbox text-indigo-600 rounded">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="CONSENT" class="ml-2 text-sm text-gray-600">I agree to receive communications regarding my financial options.</label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="sib-form-block">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="action-btn w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Submit Email
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="html_type" value="simple">
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  `;

Â  Â  // Append the form to the chat window
Â  Â  const formWrapper = document.createElement('div');
Â  Â  formWrapper.className = 'w-full mb-4';
Â  Â  formWrapper.innerHTML = formHtml;
Â  Â  chatWindow.appendChild(formWrapper);
Â  Â  
Â  Â  // Final Continue Button (Initially Disabled)
Â  Â  clearControls();
Â  Â  const continueButton = document.createElement('button');
Â  Â  continueButton.id = 'mandatoryContinueBtn';
Â  Â  continueButton.className =
Â  Â  Â  'action-btn w-full px-5 py-3 rounded-full bg-slate-400 text-white font-bold disabled-btn cursor-not-allowed';
Â  Â  continueButton.textContent = 'Continue to Finish Screen (Email Required)';
Â  Â  continueButton.disabled = true;
Â  Â  
Â  Â  chatControls.appendChild(continueButton);
Â  Â  
Â  Â  // Attach listener to the mandatory continue button
Â  Â  continueButton.addEventListener('click', () => {
Â  Â  Â  addUserMessage('Continue to Finish Screen');
Â  Â  Â  fadeOutAllAndThen(stepWaitAndFinish);
Â  Â  });
Â  Â  
Â  Â  // Load Brevo's own form submission script if not already loaded
Â  Â  if (!document.querySelector('script[src*="sib-modal.js"]')) {
Â  Â  Â  const script = document.createElement('script');
Â  Â  Â  script.type = 'text/javascript';
Â  Â  Â  script.src = 'https://assets.brevo.com/js/sib-modal.js';
Â  Â  Â  document.head.appendChild(script);
Â  Â  }

Â  Â  scrollToBottom();
Â  }
Â  
Â  // 60s waiting step before sending to Worker (Existing function, kept the same)
Â  function stepWaitAndFinish() {
Â  Â  let seconds = 60;

Â  Â  addBotMessage(
Â  Â  Â  'Thank you. We will now verify your form and email submission with our partner system. ' +
Â  Â  Â  'This usually takes under a minute.'
Â  Â  );

Â  Â  const countdownBubble = document.createElement('div');
Â  Â  countdownBubble.className = 'chat-bubble chat-bot';
Â  Â  countdownBubble.id = 'countdownBubble';
Â  Â  countdownBubble.textContent = 'Checking your submission... 60 seconds remaining';
Â  Â  chatWindow.appendChild(countdownBubble);
Â  Â  scrollToBottom();

Â  Â  renderOptions([
Â  Â  Â  {
Â  Â  Â  Â  label: 'Cancel and exit',
Â  Â  Â  Â  onClick: () => {
Â  Â  Â  Â  Â  window.location.href = getScreenoutUrl('user_cancel_wait');
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ]);

Â  Â  const interval = setInterval(() => {
Â  Â  Â  seconds--;
Â  Â  Â  if (seconds <= 0) {
Â  Â  Â  Â  clearInterval(interval);
Â  Â  Â  Â  countdownBubble.textContent = 'Done! Redirecting now...';
Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  window.location.href = workerFinishUrl;
Â  Â  Â  Â  }, 800);
Â  Â  Â  } else {
Â  Â  Â  Â  countdownBubble.textContent =
Â  Â  Â  Â  Â  'Checking your submission... ' + seconds + ' seconds remaining';
Â  Â  Â  }
Â  Â  }, 1000);
Â  }

Â  // The original finalStep is now replaced by stepEmailGate
Â  // function finalStep() { ... }

Â  // Start
Â  startChat();
});
</script>

</body>
</html>

