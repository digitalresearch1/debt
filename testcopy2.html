<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debt Relief Information & Consultation Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .slider::-webkit-slider-thumb{ -webkit-appearance:none; width:24px; height:24px; background:linear-gradient(135deg,#6366f1,#8b5cf6); border:4px solid #fff; border-radius:50%; box-shadow:0 6px 18px rgba(99,102,241,.35); cursor: pointer; }
    .slider::-moz-range-thumb{ width:24px; height:24px; background:linear-gradient(135deg,#6366f1,#8b5cf6); border:4px solid #fff; border-radius:50%; box-shadow:0 6px 18px rgba(99,102,241,.35); cursor: pointer; }
  </style>
</head>
<body class="bg-slate-50 text-slate-700">

  <div class="max-w-3xl mx-auto p-4 sm:p-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center gap-4">
        <div class="w-16 h-16 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-bold text-3xl shadow-lg">C</div>
        <div>
          <h1 class="text-3xl font-bold text-slate-800">Debt Relief Research Study</h1>
          <p class="text-slate-500 mt-1">Request a free consultation and provide feedback.</p>
        </div>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-xl">

      <!-- Who Can Participate -->
      <div class="mb-8 p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
        <h2 class="text-2xl font-bold text-slate-800">Who Can Participate?</h2>
        <div class="prose prose-slate mt-4 max-w-none text-slate-600">
          <p>We are seeking feedback to better understand the debt relief process. Please proceed if you meet the following qualifications:</p>
          <ul class="list-disc pl-5 space-y-1">
            <li>You have over $10,000 in unsecured debt (credit cards, personal loans, etc.).</li>
            <li>You have a steady source of income.</li>
            <li>You are actively looking for help to reduce or resolve your unsecured debt.</li>
          </ul>
        </div>
      </div>
      <!-- Opt-out quick action under Who Can Participate -->
      <div class="-mt-4 mb-6 text-center">
        <button id="opt-out-btn-top" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm hover:border-red-200 hover:text-red-600 hover:shadow transition">
          <svg viewBox="0 0 24 24" class="h-4 w-4"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm1 5v6a1 1 0 0 1-2 0V7a1 1 0 0 1 2 0Zm-1 10a1.5 1.5 0 1 1 1.5-1.5A1.5 1.5 0 0 1 12 17Z"/></svg>
          I do not wish to participate
        </button>
      </div>

      <!-- About This Study -->
      <h2 class="text-2xl font-bold text-slate-800">About This Study</h2>
      <div class="prose prose-slate mt-4 max-w-none text-slate-600 space-y-3">
        <p>The main part of our research involves having you complete a short, secure form to request a free 10–15-minute consultation to review options for lowering unsecured debt with no obligation to enroll. This study is for people who are truly interested in getting help with their debt.</p>
        <p>A debt settlement service works to negotiate with your creditors to lower the amount you owe. The goal is often to combine your payments into a single, more manageable monthly amount, with a plan to help you get out of debt in about 2–4 years.</p>
        <p><strong>How your information is used:</strong> This is an independent research study, not a service offered by CuraDebt. Your information will be used only to connect you with a specialist and to collect research feedback. We’ve carefully researched and selected CuraDebt as a reputable company to connect our participants with. We will send you an email reminder to share your feedback.</p>
                              <p><strong>This study helps others:</strong> We’re writing an article about debt to help others in situations like them. We’ll ask a few short questions, then—if you choose—connect you to a trusted partner (CuraDebt) for a free consultation and later ask for brief feedback.</p>

      </div>

      <!-- Review Tiles -->
      <div class="mt-8">
        <h3 class="font-semibold text-slate-900 mb-4 text-center text-lg">Independent Reviews</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <!-- Trustpilot tile -->
          <a href="https://uk.trustpilot.com/review/www.curadebt.com?page=3" target="_blank" rel="nofollow noopener" class="block rounded-2xl border border-slate-200 bg-white p-6 md:p-8 shadow-sm hover:shadow-lg transition">
            <div class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-sm font-semibold text-emerald-700">
              <svg viewBox="0 0 24 24" aria-hidden="true" class="h-4 w-4" fill="#00B67A"><polygon points="12,2 14.9,9 22.3,9.2 16.7,13.4 18.7,20.2 12,16.3 5.3,20.2 7.3,13.4 1.7,9.2 9.1,9"/></svg>
              Trustpilot
            </div>
            <div class="mt-3 text-slate-700">CuraDebt reviews</div>
            <div class="mt-3 flex items-center justify-between">
              <div class="flex items-center gap-1" aria-label="4.9 out of 5 stars">
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-emerald-500"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-emerald-500"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-emerald-500"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-emerald-500"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-emerald-500"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
              </div>
              <div class="text-right">
                <div class="text-slate-900 font-semibold">4.9</div>
                <div class="text-xs text-slate-500">160 reviews on Trustpilot</div>
              </div>
            </div>
          </a>

          <!-- Google tile -->
          <a href="https://www.google.com/maps/place/CuraDebt/@25.9704379,-80.169098,9455m/data=!3m2!1e3!5s0x88d9a9be4a479643:0xf7172abdc2f82499!4m8!3m7!1s0x88d9abe11e968fab:0xede6e70fcbc1421f!8m2!3d26.0105652!4d-80.1836621!9m1!1b1!16s%2Fg%2F11cn9ngvsm?entry=ttu" target="_blank" rel="nofollow noopener" class="block rounded-2xl border border-slate-200 bg-white p-6 md:p-8 shadow-sm hover:shadow-lg transition">
            <img src="https://www.gstatic.com/images/branding/googlelogo/svg/googlelogo_clr_74x24px.svg" alt="Google" class="h-6 w-auto object-contain mb-2" loading="lazy">
            <div class="text-slate-700">CuraDebt reviews</div>
            <div class="mt-3 flex items-center justify-between">
              <div class="flex items-center gap-1" aria-label="4.8 out of 5 stars">
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"/></svg>
                <svg viewBox="0 0 20 20" class="h-5 w-5"><defs><linearGradient id="halfStarFill" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="50%" stop-color="#f59e0b" /><stop offset="50%" stop-color="#e5e7eb" /></linearGradient></defs><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1" fill="url(#halfStarFill)"/></svg>
              </div>
              <div class="text-right">
                <div class="text-slate-900 font-semibold">4.8</div>
                <div class="text-xs text-slate-500">336 reviews on Google</div>
              </div>
            </div>
          </a>
        </div>
        <p class="mt-4 text-center text-slate-500 text-sm">Tap a tile to open the source in a new tab.</p>
        <div class="mt-6 text-center text-sm text-slate-500 italic">“The consultation helped me understand realistic options without pressure.” — Maria G.</div>
      </div>

      <hr class="my-10 border-slate-200">

      <!-- Section 2: Main Form (High-visibility) -->
      <div id="main-form-section">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-slate-800">Request Your Free Consultation</h2>
          <p class="text-slate-500 mt-2">Complete the secure form below. All fields are required.</p>
        </div>

        <form id="lead-form" novalidate class="mt-8 space-y-6">
          <!-- Debt Slider -->
          <div class="text-center">
            <label class="text-base font-semibold text-slate-900">How much unsecured debt do you have?</label>
            <div id="debt-amount-display" class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-500 my-3">$25,000</div>
            <input id="debt-slider" class="w-full slider" type="range" min="10000" max="100000" value="25000" step="100">
            <input id="f_totaldebt" type="hidden">
          </div>

          <!-- Personal Info (card) -->
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-6">
              <!-- First Name -->
              <div>
                <label for="f_fname" class="block text-[15px] font-semibold text-slate-900 tracking-tight">First Name</label>
                <div class="relative mt-2">
                  <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 4.5V21h16v-2.5C20 16.17 16.33 14 12 14Z"/></svg>
                  <input type="text" id="f_fname" name="f_fname" placeholder="e.g., Maria" class="h-12 w-full rounded-lg border border-slate-400 bg-white pl-11 pr-3 text-slate-900 shadow-sm outline-none transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" required>
                </div>
              </div>
              <!-- Last Name -->
              <div>
                <label for="f_lname" class="block text-[15px] font-semibold text-slate-900 tracking-tight">Last Name</label>
                <div class="relative mt-2">
                  <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.33 0-8 2.17-8 4.5V21h16v-2.5C20 16.17 16.33 14 12 14Z"/></svg>
                  <input type="text" id="f_lname" name="f_lname" placeholder="e.g., Garcia" class="h-12 w-full rounded-lg border border-slate-400 bg-white pl-11 pr-3 text-slate-900 shadow-sm outline-none transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" required>
                </div>
              </div>
              <!-- Email -->
              <div>
                <label for="email" class="block text-[15px] font-semibold text-slate-900 tracking-tight">Email Address</label>
                <div class="relative mt-2">
                  <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v.35l-10 6.25L2 6.35V6Zm0 3.24V18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9.24l-9.34 5.83a2 2 0 0 1-2.32 0L2 9.24Z"/></svg>
                  <input type="email" id="email" name="f_email" placeholder="you@example.com" class="h-12 w-full rounded-lg border border-slate-400 bg-white pl-11 pr-3 text-slate-900 shadow-sm outline-none transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" required>
                </div>
              </div>
              <!-- Phone -->
              <div>
                <label for="phone" class="block text-[15px] font-semibold text-slate-900 tracking-tight">Phone Number</label>
                <div class="relative mt-2">
                  <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24 11.36 11.36 0 0 0 3.56.57 1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 7a1 1 0 0 1 1-1h2.5a1 1 0 0 1 1 1 11.36 11.36 0 0 0 .57 3.56 1 1 0 0 1-.24 1.01l-2.21 2.22Z"/></svg>
                  <input type="tel" id="phone" name="f_phone" inputmode="numeric" autocomplete="tel" placeholder="(555) 123-4567" class="h-12 w-full rounded-lg border border-slate-400 bg-white pl-11 pr-3 text-slate-900 shadow-sm outline-none transition focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <p class="mt-1 text-xs text-slate-500">We use your phone only to verify and connect you to the specialist. No sales spam.</p>
              </div>
            </div>
          </div>

          <!-- OTP -->
          <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
            <label class="block text-sm font-medium text-slate-900">Phone Verification</label>
            <p class="text-xs text-slate-500 mb-3">To continue, please verify your phone number.</p>
            <div class="flex items-center gap-4">
              <button type="button" id="send-otp" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition">Send Code</button>
              <div id="otp-verify-box" class="hidden flex-1 flex items-center gap-2">
                <input id="otp-code" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="6-digit code">
                <button type="button" id="check-otp" class="bg-emerald-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-emerald-600 transition">Verify</button>
              </div>
              <span id="otp-status" class="text-sm font-medium"></span>
            </div>
            <div id="recaptcha-container" class="mt-2"></div>
          </div>

          <!-- State & Consent -->
          <div>
            <label for="state" class="block text-[15px] font-semibold text-slate-900">State</label>
            <select id="state" name="f_whereyoulive" class="mt-2 block w-full rounded-lg border border-slate-400 bg-white p-3 text-slate-900 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500" required>
              <option value="" disabled selected>Select Your State</option>
            </select>
          </div>
          <div class="flex items-start pt-2">
            <div class="flex items-center h-5"><input id="tcpa" name="tcpa" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-slate-300 rounded" required></div>
            <div class="ml-3 text-sm"><label for="tcpa" class="text-slate-600">By checking this box, you agree to be contacted by our partners. Consent is not required for purchase.</label></div>
          </div>

          <!-- Submit -->
          <button id="submit-button" type="submit" class="w-full bg-emerald-600 text-white font-bold py-4 px-4 rounded-lg shadow-md hover:bg-emerald-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-lg">Submit & Continue to Final Step</button>
          <div id="form-error" class="text-red-600 text-center font-semibold hidden pt-2"></div>
        </form>
      </div>

      <!-- Section 3: Feedback Form (Initially Hidden) -->
      <div id="feedback-section" class="hidden mt-10">
        <hr class="my-10 border-slate-200">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-slate-800">Final Step: Feedback Reminder</h2>
          <p class="text-slate-500 mt-2">We will email you a reminder to write your feedback. You can proceed once the reminder is queued.</p>
        </div>
        <div id="brevo-container" class="w-full mt-8"></div>
        <button id="feedback-continue" class="mt-4 w-full bg-indigo-600 text-white font-bold py-4 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition disabled:opacity-50 text-lg" disabled>I've Submitted My Email</button>
      </div>

      <div class="text-center mt-12">
        <button id="opt-out-btn" class="text-sm text-slate-500 hover:text-red-600">I do not wish to participate</button>
      </div>
    </div>
  </div>

  <!-- Hidden elements for submission -->
  <iframe name="form_iframe_1" class="hidden"></iframe>
  <iframe name="form_iframe_2" class="hidden"></iframe>
  <form id="hidden-lead-form-1" method="POST" target="form_iframe_1" class="hidden">
    <input type="hidden" name="f_fname"><input type="hidden" name="f_lname"><input type="hidden" name="f_email"><input type="hidden" name="f_phone"><input type="hidden" name="f_whereyoulive"><input type="hidden" name="f_totaldebt"><input type="hidden" name="data1"><input type="hidden" name="f_ip">
  </form>
  <form id="hidden-lead-form-2" method="POST" target="form_iframe_2" class="hidden">
    <input type="hidden" name="campaign_id"><input type="hidden" name="caller_id"><input type="hidden" name="phone"><input type="hidden" name="first_name"><input type="hidden" name="last_name"><input type="hidden" name="email"><input type="hidden" name="state"><input type="hidden" name="unsecured_debt_total"><input type="hidden" name="ip_address"><input type="hidden" name="useragent"><input type="hidden" name="gclid"><input type="hidden" name="fbeventid"><input type="hidden" name="msclkid"><input type="hidden" name="tcpa_opt_in"><input type="hidden" name="tcpa_optin_consent_language"><input type="hidden" name="call_now" value="1"><input type="hidden" name="email_unverified"><input type="hidden" name="otp_verified">
  </form>

  <script type="module">
    // --- CONFIGURATION ---
    const CONFIG = {
      FIREBASE_CONFIG: {"apiKey":"AIzaSyBF5wdHyOlOi_bntJHXto7f6RbJMkOdMSE","authDomain":"otp-c6311.firebaseapp.com","projectId":"otp-c6311","storageBucket":"otp-c6311.firebasestorage.app","messagingSenderId":"637495517002","appId":"1:637495517002:web:7bd220994a7611a5606bb3"},
      LEAD_POST_URL_1: "https://www.curadebt.com/submit-api.php",
      LEAD_POST_URL_2: "https://estherkasinde.trackdrive.com/campaigns/1000/leads?api_token=3346b0458309406ba4b8beac90a8a532",
      TRACKDRIVE_CAMPAIGN_ID: "1000",
      BREVO_FORM_URL: "https://52bcaf92.sibforms.com/serve/MUIFABmWYWf3cwFJgrPQjj77APgtEF8JJ634OSD8-qQ0EDQNiYN4wKPaqF51FAIz5p1vc-yLf5DzMhxB9w2mxDBu1Y0b87khoYUFn2eK-KLi_obHRBTplKxc2k8CzNCwM-uTcb6i0GlaxcU49zWeQXP5s5cGwd7q1sahZ8i6BR5E43UzfKJflMtJ7R5ild_uKdD9alhHh3f8n_Mt",
      PURESPECTRUM_COMPLETE_URL: "https://spectrumsurveys.com/surveydone?st=21",
      PURESPECTRUM_TERMINATE_URL: "https://spectrumsurveys.com/surveydone?st=18",
      MIN_DEBT_AMOUNT: 10000,
      EXCLUDED_STATES: ['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','WY']
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const URL_PARAMS = new URLSearchParams(window.location.search);
    const TRANSACTION_ID = URL_PARAMS.get('transaction_id') || '';
    const app = initializeApp(CONFIG.FIREBASE_CONFIG);
    const auth = getAuth(app);

    const ipPromise = fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(j=>j.ip || '').catch(()=>'');
    let state = { ip: '' };
    ipPromise.then(ip => { state.ip = ip; });

    // --- DOM Elements ---
    const leadForm = document.getElementById('lead-form');
    const debtSlider = document.getElementById('debt-slider');
    const debtAmountDisplay = document.getElementById('debt-amount-display');
    const debtHidden = document.getElementById('f_totaldebt');
    const stateSelect = document.getElementById('state');
    const submitButton = document.getElementById('submit-button');
    const phoneInput = document.getElementById('phone');
    const sendBtn = document.getElementById('send-otp');
    const verifyBox = document.getElementById('otp-verify-box');
    const checkBtn = document.getElementById('check-otp');
    const otpCode = document.getElementById('otp-code');
    const otpStatus = document.getElementById('otp-status');
    const recaptchaContainer = document.getElementById('recaptcha-container');
    const feedbackBtn = document.getElementById('feedback-continue');
    const brevoContainer = document.getElementById('brevo-container');

    let isOtpVerified = false;
    let recaptchaVerifier = null;
    let confirmationResult = null;

    const toInt = s => parseInt(String(s||'').replace(/[^\d]/g,''),10) || 0;
    const digitsOnly = s => String(s||'').replace(/\D+/g,'');
    const toE164US = raw => { const d = digitsOnly(raw); const m = d.match(/^1?([2-9]\d{2})([2-9]\d{2})(\d{4})$/); return m ? `+1${m[1]}${m[2]}${m[3]}` : null; }

    // State select population
    const allStates = ["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"];
    allStates.forEach(st => { if (!CONFIG.EXCLUDED_STATES.includes(st)) { const o = document.createElement('option'); o.value = st; o.textContent = st; stateSelect.appendChild(o); }});

    function updateSubmitEnabled() {
      const allFieldsOK = Array.from(leadForm.querySelectorAll('input[required], select[required]')).every(el => el.type === 'checkbox' ? el.checked : !!el.value);
      submitButton.disabled = !(isOtpVerified && allFieldsOK);
      submitButton.textContent = isOtpVerified ? (allFieldsOK ? 'Submit & Continue to Final Step' : 'Please complete all fields') : 'Verify your phone to continue';
    }

    // Initialize button state
    updateSubmitEnabled();

    // Debt slider
    debtSlider.addEventListener('input', e => {
      const val = toInt(e.target.value);
      debtAmountDisplay.textContent = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0}).format(val);
      debtHidden.value = val;
    });
    debtSlider.dispatchEvent(new Event('input'));

    // reCAPTCHA
    function setupRecaptcha() { if (!recaptchaVerifier) { recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaContainer, { size: 'invisible' }); } }

    // OTP send
    sendBtn.addEventListener('click', async () => {
      const e164 = toE164US(phoneInput.value);
      verifyBox.classList.remove('hidden');
      if(!e164){ otpStatus.textContent = 'Invalid US number.'; return; }
      otpStatus.textContent = 'Sending…';
      try { setupRecaptcha(); confirmationResult = await signInWithPhoneNumber(auth, e164, recaptchaVerifier); otpStatus.textContent = 'Code Sent'; }
      catch(e) { otpStatus.textContent = 'Failed'; try { if (window.grecaptcha && recaptchaVerifier) { recaptchaVerifier.render().then(id => { if (typeof id !== 'undefined') window.grecaptcha.reset(id); }).catch(()=>{}); } } catch(_) {} }
    });

    // OTP verify
    checkBtn.addEventListener('click', async () => {
      const code = otpCode.value.trim();
      if(!confirmationResult || code.length !== 6) { otpStatus.textContent='Enter 6-digit code.'; return; }
      otpStatus.textContent='Verifying…';
      try { await confirmationResult.confirm(code); isOtpVerified = true; otpStatus.textContent='Verified ✓'; otpStatus.style.color = '#16a34a'; updateSubmitEnabled(); }
      catch(e) { isOtpVerified = false; otpStatus.textContent='Verification failed.'; otpStatus.style.color = '#dc2626'; updateSubmitEnabled(); }
    });

    // Enable button when fields change
    leadForm.querySelectorAll('input, select').forEach(el => { el.addEventListener('input', updateSubmitEnabled); el.addEventListener('change', updateSubmitEnabled); });

    // Submit handler
    leadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (leadForm.dataset.lock === '1') return; // guard
      leadForm.dataset.lock = '1';

      const formError = document.getElementById('form-error');
      const allFieldsOK = Array.from(leadForm.querySelectorAll('input[required], select[required]')).every(el => el.type === 'checkbox' ? el.checked : !!el.value);
      if (!isOtpVerified || !allFieldsOK) { formError.textContent = 'Please complete all fields and verify your phone before submitting.'; formError.classList.remove('hidden'); leadForm.dataset.lock = ''; return; }

      if (submitButton.disabled) { leadForm.dataset.lock = ''; return; }
      submitButton.disabled = true; submitButton.textContent='Submitting…'; leadForm.style.pointerEvents = 'none'; await ipPromise;

      const fd = new FormData(leadForm); const leadData = {}; fd.forEach((v,k)=>leadData[k]=v); const debtAmount = toInt(debtHidden.value);

      const form1 = document.getElementById('hidden-lead-form-1'); form1.action = CONFIG.LEAD_POST_URL_1;
      form1.elements['f_fname'].value = `${leadData.f_fname || ''} (Debt Relief)`; form1.elements['f_lname'].value = leadData.f_lname || '';
      form1.elements['f_email'].value = leadData.f_email || ''; form1.elements['f_phone'].value = digitsOnly(leadData.f_phone);
      form1.elements['f_whereyoulive'].value = leadData.f_whereyoulive || ''; form1.elements['f_totaldebt'].value = String(debtAmount);
      form1.elements['data1'].value = TRANSACTION_ID; form1.elements['f_ip'].value = state.ip;

      const form2 = document.getElementById('hidden-lead-form-2'); form2.action = CONFIG.LEAD_POST_URL_2; const safeE164 = toE164US(leadData.f_phone);
      form2.elements['caller_id'].value = safeE164 || digitsOnly(leadData.f_phone); form2.elements['phone'].value = digitsOnly(leadData.f_phone);
      form2.elements['campaign_id'].value = CONFIG.TRACKDRIVE_CAMPAIGN_ID; form2.elements['first_name'].value = `${leadData.f_fname || ''} (Debt Relief)`;
      form2.elements['last_name'].value = leadData.f_lname || ''; form2.elements['email'].value = leadData.f_email || '';
      form2.elements['state'].value = leadData.f_whereyoulive || ''; form2.elements['unsecured_debt_total'].value = String(debtAmount);
      form2.elements['ip_address'].value = state.ip; form2.elements['useragent'].value = navigator.userAgent;
      form2.elements['gclid'].value = URL_PARAMS.get('gclid') || ''; form2.elements['fbeventid'].value = URL_PARAMS.get('fbclid') || '';
      form2.elements['msclkid'].value = URL_PARAMS.get('msclkid') || ''; form2.elements['tcpa_opt_in'].value = 'true';
      form2.elements['tcpa_optin_consent_language'].value = leadForm.querySelector('label[for="tcpa"]')?.innerText || 'TCPA consent captured';
      form2.elements['otp_verified'].value = '1'; form2.elements['email_unverified'].value = '1';

      try {
        form1.submit(); setTimeout(() => form2.submit(), 100);
        window.AUTO_SUBMIT_BREVO = true; // Brevo auto-submit on next step
        document.getElementById('main-form-section').style.display = 'none';
        document.getElementById('feedback-section').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch(err) {
        formError.textContent = 'An error occurred during submission.'; formError.classList.remove('hidden');
        submitButton.disabled = false; leadForm.style.pointerEvents = 'auto'; leadForm.dataset.lock = '';
      }
    });

    // Brevo iframe
    const iframe = document.createElement('iframe'); iframe.style.cssText = 'width: 100%; height: 350px; border: none;'; brevoContainer.appendChild(iframe);
    iframe.srcdoc = `
      <html><head><link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css"></head><body>
      <div class="sib-form" style="background-color: #FFF;"><div id="sib-form-container" class="sib-form-container">
      <div id="success-message" style="display:none;"></div>
      <form id="sib-form" method="POST" action="${CONFIG.BREVO_FORM_URL}" data-type="subscription">
        <div style="padding: 8px 0;"><div class="sib-input sib-form-block"><div class="form__entry entry_block"><div class="form__label-row "><label class="entry__label" for="EMAIL" data-required="*">Enter your email address</label><div class="entry__field"><input class="input " type="text" id="EMAIL" name="EMAIL" autocomplete="off" required /></div></div><label class="entry__error entry__error--primary"></label></div></div></div>
        <div style="padding: 8px 0;"><div class="sib-form-block" style="text-align: left"><button id="brevo-submit-btn" class="sib-form-block__button sib-form-block__button-with-loader" type="submit">SUBMIT</button></div></div>
      </form></div></div>
      <script src="https://sibforms.com/forms/end-form/build/main.js"><\/script></body></html>`;

    iframe.onload = () => {
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      const form = doc.getElementById('sib-form');
      const btn = doc.getElementById('brevo-submit-btn');
      const emailInner = doc.getElementById('EMAIL');
      const emailOuter = document.getElementById('email');
      const looksLikeEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((s||'').trim());

      if (emailInner && emailOuter) emailInner.value = emailOuter.value || '';
      if (emailOuter && emailInner) {
        const sync = () => { emailInner.value = emailOuter.value || ''; };
        emailOuter.addEventListener('input', sync); emailOuter.addEventListener('change', sync);
      }

      btn?.addEventListener('click', () => {
        const v = (emailInner?.value || '').trim();
        if (looksLikeEmail(v)) { setTimeout(() => { feedbackBtn.disabled = false; brevoContainer.innerHTML = `<div class=\"text-center p-8\"><p class=\"font-semibold text-slate-700\">Thank you! Please click below to complete the survey.</p></div>`; }, 500); }
      });

      if (window.AUTO_SUBMIT_BREVO && looksLikeEmail(emailInner?.value) && !iframe.dataset.submitted) {
        iframe.dataset.submitted = '1';
        setTimeout(() => {
          try { if (form?.requestSubmit) form.requestSubmit(); else form?.submit(); } catch(_) {}
          setTimeout(() => { feedbackBtn.disabled = false; brevoContainer.innerHTML = `<div class=\"text-center p-8\"><p class=\"font-semibold text-slate-700\">Thank you! Please click below to complete the survey.</p></div>`; }, 800);
        }, 500);
      }
    };

    // Opt-out buttons (top & bottom)
    const optOutBottom = document.getElementById('opt-out-btn');
    optOutBottom?.addEventListener('click', () => { window.location.href = `${CONFIG.PURESPECTRUM_TERMINATE_URL}&transaction_id=${TRANSACTION_ID}`; });
    const optOutTop = document.getElementById('opt-out-btn-top');
    optOutTop?.addEventListener('click', () => { window.location.href = `${CONFIG.PURESPECTRUM_TERMINATE_URL}&transaction_id=${TRANSACTION_ID}`; });

    // Final continue
    document.getElementById('feedback-continue').addEventListener('click', () => { window.location.href = `${CONFIG.PURESPECTRUM_COMPLETE_URL}&transaction_id=${TRANSACTION_ID}`; });
  </script>
</body>
</html>
