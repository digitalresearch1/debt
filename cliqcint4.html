
<!DOCTYPE HTML>
<html lang="en" class="supernova">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=1">
  <meta name="HandheldFriendly" content="true">
  <title>Survey</title>

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary: {
        50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',
        500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'
      }}}}
    }
  </script>

  <!-- Brevo base styles -->
  <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:radial-gradient(circle at top,#4f46e5 0,#020617 55%);min-height:100vh;}
    .shell{background:#fff;border-radius:24px;box-shadow:0 24px 60px rgba(15,23,42,.28);border:1px solid rgba(148,163,184,.35);}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;}
    .btn{background:linear-gradient(135deg,#4f46e5 0%,#6366f1 100%);color:#fff;transition:.2s ease;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 16px 35px rgba(79,70,229,.35);}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none;}
    a.btn{color:#fff;text-decoration:none;}
    .danger{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;border:1px solid rgba(220,38,38,.35);box-shadow:0 14px 30px rgba(220,38,38,.25);transition:.2s ease;}
    .danger:hover{transform:translateY(-1px);box-shadow:0 18px 40px rgba(220,38,38,.35);}
    .notice{border-radius:14px;border:1px solid;padding:12px 14px;}
    .notice-amber{background:#fff7ed;border-color:#fed7aa;color:#7c2d12;}
    .notice-emerald{background:#ecfdf5;border-color:#6ee7b7;color:#065f46;}
    .progress-bar{height:10px;border-radius:999px;background:#e5e7eb;overflow:hidden;}
    .progress-bar>div{height:100%;width:0%;background:linear-gradient(135deg,#4f46e5,#6366f1);transition:width .15s ease;}
    .hidden{display:none!important;}
    .qwrap{max-width:720px;margin:0 auto;}
    .qtext{font-size:1.05rem;color:#0f172a;font-weight:600;}
    .opt{display:flex;gap:10px;align-items:center;padding:12px 14px;border:1px solid #e5e7eb;border-radius:14px;cursor:pointer;transition:.12s ease;}
    .opt:hover{background:#f8fafc;}
    .opt input{width:18px;height:18px;}
    #sib-container input::placeholder{text-align:left;font-family:Helvetica,sans-serif;color:#c0ccda;}
    #sib-container a{text-decoration:underline;color:#2BB2FC;}
  </style>
</head>

<body class="p-4 md:p-8 flex items-center justify-center">
<main class="shell w-full max-w-5xl p-4 md:p-8 lg:p-10">

  <!-- TOP STRIP -->
  <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
    <div class="inline-flex items-center gap-2 bg-white/10 text-white px-4 py-2 rounded-full text-xs md:text-sm backdrop-blur">
      <span>üîí</span><span>Private research survey</span>
    </div>
    <div class="text-white/80 text-xs md:text-sm">
      <span class="font-semibold text-white">Estimated:</span> 3‚Äì5 minutes
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="mb-6">
    <div class="flex items-center justify-between text-xs font-semibold text-white/80 mb-2">
      <span id="progressLabel">1 / 5</span>
      <span id="progressHint">Answer the question</span>
    </div>
    <div class="progress-bar"><div id="progressFill"></div></div>
  </div>

  <!-- PAGE 1 -->
  <section id="p1" class="card p-5 md:p-7 qwrap">
    <div class="qtext">Do you currently have unsecured debt (credit cards, personal loans, medical bills, etc.)?</div>
    <div class="mt-4 space-y-3">
      <label class="opt"><input type="radio" name="q1" value="yes"><span>Yes</span></label>
      <label class="opt"><input type="radio" name="q1" value="no"><span>No</span></label>
    </div>
    <div class="mt-5">
      <button id="p1Next" class="btn px-5 py-3 rounded-xl font-semibold w-full" disabled>Continue</button>
    </div>
  </section>

  <!-- PAGE 2 -->
  <section id="p2" class="card p-5 md:p-7 qwrap hidden">
    <div class="qtext">Is your total unsecured debt approximately <span class="font-semibold">$15,000 or more</span>?</div>
    <div class="mt-4 space-y-3">
      <label class="opt"><input type="radio" name="q2" value="yes"><span>Yes</span></label>
      <label class="opt"><input type="radio" name="q2" value="no"><span>No</span></label>
    </div>
    <div class="mt-5">
      <button id="p2Next" class="btn px-5 py-3 rounded-xl font-semibold w-full" disabled>Continue</button>
    </div>
  </section>

  <!-- PAGE 3 (Consent / explanation) -->
  <section id="p4" class="card p-5 md:p-7 hidden">
    <div class="text-slate-900 text-xl md:text-2xl font-semibold">Are you willing to participate?</div>

    <div class="mt-3 text-slate-700 text-sm md:text-base space-y-3">
      <p>
        We are writing articles and research studies about debt relief experiences. We are <strong>not</strong> a debt settlement company.
        For this study, we are collecting feedback from people in debt who are willing to be contacted by a debt settlement company we selected.
      </p>
      <p>
        If you choose to proceed, you will open a secure form (in a new tab) so the company can contact you.
        A specialist may call within <strong>24‚Äì48 hours</strong>.
      </p>

      <div class="notice notice-amber">
        <div class="font-semibold">About the Follow-up Emails</div>
        <div class="text-sm mt-1">
          After you submit your email, we‚Äôll send you a short follow-up survey immediately. You‚Äôll receive reminders for the next 3 days to tell us
          whether you received a call, whether you got the help you wanted, and how the agent treated you.
        </div>
        <div class="text-xs mt-2">‚è± The secure form typically takes about <strong>1 minute</strong> to complete.</div>
      </div>
    </div>

    <div class="mt-4 flex items-center gap-3">
      <input id="consentCheck" type="checkbox" class="w-5 h-5">
      <label for="consentCheck" class="text-sm text-slate-800">I understand this is a research study and I agree to continue.</label>
    </div>

    <div class="mt-5 flex flex-wrap gap-3">
      <button id="p4Next" class="btn px-5 py-3 rounded-xl font-semibold w-full md:w-auto" disabled>Continue</button>
      <button id="p4Exit" class="danger px-5 py-3 rounded-xl font-semibold w-full md:w-auto">I don‚Äôt want to continue</button>
    </div>
  </section>

  <!-- PAGE 4 (Open new tab + OCR) -->
  <section id="p5" class="card p-5 md:p-7 hidden">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="text-slate-900 text-lg md:text-xl font-semibold">Complete the secure form</div>
      <button id="p5ExitTop" class="danger px-4 py-2 rounded-xl font-semibold text-sm">Exit</button>
    </div>

    <div id="importantBox" class="notice notice-amber mt-4">
      <div class="font-semibold">Important</div>
      <div class="mt-1 text-sm">
        Open the secure form in a new tab.Complete it, then return here and this page will still be open.
      </div>
      <div class="mt-2 text-sm">
        You will typically:
        <ul class="list-disc list-inside mt-1">
          <li>Answer <strong>3 quick YES/NO</strong> eligibility questions</li>
          <li>Enter your <strong>phone number</strong> (may require verification)</li>
          <li>Provide <strong>email</strong>, basic identity and <strong>address</strong> details</li>
          <li><strong>Submit</strong> and reach a <strong>confirmation / thank you</strong> page</li>
        </ul>
      </div>
      <div class="mt-2 text-sm">
        Take a screenshot of the confirmation/thank-you page after submitting the secure form and upload it , to allow us to verify that you have complete the form.
        We verify your screenshot using OCR (text detection). If confirmation keywords are not detected, the next step stays locked.
      </div>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <div class="text-xs md:text-sm font-medium text-slate-800">Secure form</div>
      <div id="formStatus" class="text-[11px] md:text-xs text-slate-500">Click ‚ÄúOpen Secure Form (New Tab)‚Äù to begin.</div>
    </div>

    <!-- NEW TAB OPEN -->
    <div class="mt-3">
      <div class="notice notice-amber">
        <div class="font-semibold">Open the secure form in a new tab</div>
        <div class="text-sm mt-1">
          Click below to open the secure form. Complete it, then return here and upload your confirmation screenshot.
        </div>
      </div>

      <div class="mt-3 flex flex-col md:flex-row gap-3">
        <a
          id="openFormBtn"
          href="https://trkmcl.com/wy8odpg43k/p98vjj0e83"
          target="_blank"
          rel="noopener noreferrer"
          class="btn px-5 py-3 rounded-xl font-semibold w-full md:w-auto text-center"
        >
          Open Secure Form (New Tab)
        </a>

        <button
          id="copiedBtn"
          type="button"
          class="px-5 py-3 rounded-xl font-semibold w-full md:w-auto border border-slate-200 bg-white hover:bg-slate-50"
        >
          Copy Link
        </button>
      </div>
    </div>

    <div class="mt-4 grid md:grid-cols-2 gap-4">
      <!-- OCR panel -->
      <div class="border border-slate-200 rounded-2xl p-4 bg-white">
        <div class="font-semibold text-slate-900">Upload confirmation screenshot</div>

        <div class="mt-3">
          <label class="block text-xs md:text-sm font-semibold text-slate-800 mb-1" for="proofFile">Upload screenshot (PNG/JPG)</label>
          <input id="proofFile" type="file" accept="image/*"
                 class="block w-full text-sm text-slate-700
                        file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0
                        file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700
                        hover:file:bg-primary-100" />
        </div>

        <div class="mt-3">
          <button id="btnRunOCR" class="btn w-full px-4 py-3 rounded-xl font-semibold" disabled>Verify screenshot</button>
        </div>

        <div class="mt-3">
          <div class="progress-bar"><div id="ocrProgressFill"></div></div>
          <div id="ocrStatus" class="mt-2 text-xs md:text-sm text-slate-600">Upload a screenshot to begin.</div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="border border-slate-200 rounded-2xl p-4 bg-slate-50 flex flex-col gap-3">
        <div id="continueMsg" class="text-sm font-semibold text-red-700 hidden"></div>

        <button id="p5Next" class="btn px-5 py-3 rounded-xl font-semibold w-full" disabled>Continue</button>
        <button id="p5Exit" class="danger px-5 py-3 rounded-xl font-semibold w-full">I don‚Äôt meet requirements</button>
      </div>
    </div>
  </section>

  <!-- PAGE 5 (Email) -->
  <section id="p6" class="card p-5 md:p-7 hidden">
    <div class="text-slate-900 text-lg md:text-xl font-semibold">Email reminder</div>

    <div class="mt-5">
      <iframe name="brevo_iframe" id="brevo_iframe" style="display:none;"></iframe>

      <div id="sib-container"
           class="sib-container--large sib-container--vertical"
           style="text-align:center; background-color:rgba(255,255,255,1); max-width:540px; border-radius:10px; border-width:1px; border-color:#C0CCD9; border-style:solid; margin:0 auto; box-shadow:0 10px 30px rgba(15,23,42,0.12); padding:14px 16px;">

        <form id="sib-form"
              method="POST"
              action="https://52bcaf92.sibforms.com/serve/MUIFAO5vlejSCs-rWtk8_hSGgyILb9Oi-aOLbS_zI5_FjrtRovBWkBZlGVuoCXxEbmOMZMrdo0ZllgcfYtt7jPnKOHgyHT2TYdf3Q-xFXArnK8ikp21kPr7-iXsfMeK4CtD4cAPf2oHHMJLw5OtgVzgyKMt0hXTJ3UiMJVGUXzHbWENuGdgb7j-x2xeZ6iW5f9ix4gocwCjOBdct"
              target="brevo_iframe">

          <div style="padding: 6px 6px 0 6px;">
            <div class="sib-form-block" style="font-size:18px; text-align:left; font-weight:700; font-family:Helvetica, sans-serif; color:#111827;">
              <p>Survey feedback reminder</p>
            </div>
          </div>

          <div style="padding: 8px 6px 0 6px;">
            <div class="sib-input sib-form-block">
              <div class="form__entry entry_block">
                <div class="form__label-row">
                  <label class="entry__label" style="font-weight:700; text-align:left; font-size:14px; font-family:Helvetica, sans-serif; color:#111827;" for="EMAIL" data-required="*">
                    Enter your email address
                  </label>
                  <div class="entry__field">
                    <input class="input" type="text" id="EMAIL" name="EMAIL" autocomplete="off" placeholder="you@example.com" data-required="true" required />
                  </div>
                </div>

                <label id="email_error" class="entry__error entry__error--primary"
                       style="display:none; font-size:13px; text-align:left; font-family:Helvetica, sans-serif; color:#661d1d; background-color:#ffeded; border-radius:3px; border-color:#ff4949; padding:4px 6px; margin-top:6px;"></label>
              </div>
            </div>
          </div>

          <div style="padding: 8px 6px 0 6px;">
            <div class="sib-optin sib-form-block">
              <div class="form__entry entry_mcq">
                <div class="form__label-row">
                  <div class="entry__choice">
                    <label style="display:flex; align-items:flex-start; gap:6px;">
                      <input type="checkbox" class="input_replaced" value="1" id="OPT_IN" name="OPT_IN" />
                      <span class="checkbox checkbox_tick_positive"></span>
                      <span style="font-size:12px; text-align:left; font-family:Helvetica, sans-serif; color:#374151;">
                        I agree to receive emails and accept the data privacy statement.
                      </span>
                    </label>
                  </div>
                </div>

                <label id="optin_error" class="entry__error entry__error--primary"
                       style="display:none; font-size:13px; text-align:left; font-family:Helvetica, sans-serif; color:#661d1d; background-color:#ffeded; border-radius:3px; border-color:#ff4949; padding:4px 6px; margin-top:6px;"></label>
              </div>
            </div>
          </div>

          <div style="padding: 10px 6px 12px 6px;">
            <div class="sib-form-block" style="text-align: left">
              <button id="brevoSubmitBtn"
                      style="font-size:14px; text-align:center; font-weight:700; font-family:Helvetica, sans-serif; color:#FFFFFF; background-color:#4f46e5; border-radius:9999px; border-width:0px; width:100%; padding:10px 0; cursor:pointer;"
                      type="submit">SUBMIT EMAIL</button>
            </div>
          </div>

          <input type="text" name="email_address_check" value="" class="input--hidden">
          <input type="hidden" name="locale" value="en">
          <input type="hidden" name="html_type" value="simple">
        </form>
      </div>
    </div>

    <div class="mt-5 flex flex-wrap gap-3">
      <button id="finishBtn" class="btn px-5 py-3 rounded-xl font-semibold w-full md:w-auto" disabled>Verify & finish</button>
      <button id="p6Exit" class="danger px-5 py-3 rounded-xl font-semibold w-full md:w-auto">Exit</button>
    </div>
  </section>

</main>

<script>
  // -----------------------------
  // Tracking / Redirects
  // -----------------------------
  const urlParams = new URLSearchParams(window.location.search);
  let transactionId = urlParams.get('transaction_id') || urlParams.get('RID') || urlParams.get('participant_id');
  if (!transactionId) transactionId = 'tx_' + Date.now().toString(36) + Math.random().toString(36).substring(2);

  const completionUrl  = `https://notch.insights.supply/cb?token=c9212f78-5226-4e99-bd51-29845ea96d16&RID=${encodeURIComponent(transactionId)}`;
  const terminationUrl = `https://samplicio.us/s/ClientCallBack.aspx?RIS=20&RID=${encodeURIComponent(transactionId)}`;

  function disqualifyNow(){ window.location.href = terminationUrl; }

  // -----------------------------
  // Pages + Progress (5 pages)
  // -----------------------------
  const pages = ['p1','p2','p4','p5','p6'];
  let idx = 0;

  const progressLabel = document.getElementById('progressLabel');
  const progressHint  = document.getElementById('progressHint');
  const progressFill  = document.getElementById('progressFill');

  function showPage(i){
    idx = i;
    pages.forEach((id, n) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden', n !== i);
    });

    const pct = Math.round(((i+1)/pages.length)*100);
    if (progressFill) progressFill.style.width = pct + '%';
    if (progressLabel) progressLabel.textContent = `${i+1} / ${pages.length}`;

    if (progressHint){
      progressHint.textContent =
        (i <= 1) ? 'Answer the question' :
        (i === 2) ? 'Read and consent' :
        (i === 3) ? 'Complete the secure form' :
        'Email & finish';
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // -----------------------------
  // Prescreen gating (q1 + q2)
  // -----------------------------
  function bindRadioEnable(name, btnId){
    const btn = document.getElementById(btnId);
    if (!btn) return;
    document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
      r.addEventListener('change', () => { btn.disabled = false; });
    });
  }
  bindRadioEnable('q1','p1Next');
  bindRadioEnable('q2','p2Next');

  document.getElementById('p1Next')?.addEventListener('click', () => {
    const v = document.querySelector('input[name="q1"]:checked')?.value;
    if (v !== 'yes') return disqualifyNow();
    showPage(1);
  });

  document.getElementById('p2Next')?.addEventListener('click', () => {
    const v = document.querySelector('input[name="q2"]:checked')?.value;
    if (v !== 'yes') return disqualifyNow();
    showPage(2);
  });

  // -----------------------------
  // Consent
  // -----------------------------
  const consentCheck = document.getElementById('consentCheck');
  const p4Next = document.getElementById('p4Next');

  consentCheck?.addEventListener('change', () => {
    if (p4Next) p4Next.disabled = !consentCheck.checked;
  });

  document.getElementById('p4Exit')?.addEventListener('click', () => disqualifyNow());
  p4Next?.addEventListener('click', () => showPage(3));

  // -----------------------------
  // New Tab UX (replaces iframe UX)
  // -----------------------------
  const openFormBtn = document.getElementById('openFormBtn');
  const copiedBtn = document.getElementById('copiedBtn');
  const formStatus = document.getElementById('formStatus');
  const importantBox = document.getElementById('importantBox');

  const proofFile = document.getElementById('proofFile');
  const btnRunOCR = document.getElementById('btnRunOCR');

  // lock upload until they click open
  let formOpened = false;
  if (proofFile) proofFile.disabled = true;
  if (btnRunOCR) btnRunOCR.disabled = true;

  function markFormOpened(){
    formOpened = true;

    if (formStatus){
      formStatus.textContent = "Opened in new tab. Complete the form, then return here and upload your confirmation screenshot.";
      formStatus.classList.remove('text-slate-500');
      formStatus.classList.add('text-emerald-700');
    }
    if (importantBox){
      importantBox.classList.remove('notice-amber');
      importantBox.classList.add('notice-emerald');
    }
    if (proofFile) proofFile.disabled = false;
  }

  openFormBtn?.addEventListener('click', () => {
    markFormOpened();
  });

  copiedBtn?.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(openFormBtn?.href || "https://trkmcl.com/wy8odpg43k/xwndpp7qne");
      copiedBtn.textContent = "Copied!";
      setTimeout(() => copiedBtn.textContent = "Copy Link", 1400);
    }catch(e){
      alert("Copy failed. Please copy manually:\n" + (openFormBtn?.href || "https://trkmcl.com/wy8odpg43k/xwndpp7qne"));
    }
  });

  document.getElementById('p5ExitTop')?.addEventListener('click', () => disqualifyNow());
  document.getElementById('p5Exit')?.addEventListener('click', () => disqualifyNow());

  // -----------------------------
  // OCR gate
  // -----------------------------
  const REQUIRED_KEYWORDS = ["thank you","thanks","submitted","submission","confirmation","completed","success","we received","your request","you are all set"];

  const ocrStatus = document.getElementById('ocrStatus');
  const ocrProgressFill = document.getElementById('ocrProgressFill');

  const p5Next = document.getElementById('p5Next');
  const continueMsg = document.getElementById('continueMsg');

  let ocrPassed = false;

  function showLockedMessage(msg){
    if (!continueMsg) return;
    continueMsg.textContent = msg;
    continueMsg.classList.remove('hidden');
    setTimeout(() => continueMsg.classList.add('hidden'), 2500);
  }

  function normalizeText(s){
    return (s||"").toLowerCase()
      .replace(/\s+/g," ")
      .replace(/[^\p{L}\p{N}\s]/gu," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function setOCRProgress(p){
    if (!ocrProgressFill) return;
    const pct = Math.max(0, Math.min(100, Math.round(p)));
    ocrProgressFill.style.width = pct + "%";
  }

  async function preprocessToCanvas(file){
    const img = new Image();
    const url = URL.createObjectURL(file);
    await new Promise((res, rej) => { img.onload=res; img.onerror=rej; img.src=url; });

    const maxW = 1400;
    const scale = Math.min(1.8, maxW / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    ctx.drawImage(img, 0, 0, w, h);
    URL.revokeObjectURL(url);

    const imgData = ctx.getImageData(0,0,w,h);
    const d = imgData.data;
    const contrast = 1.25;
    const intercept = 128 * (1 - contrast);

    for (let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let y = 0.299*r + 0.587*g + 0.114*b;
      y = y*contrast + intercept;
      y = Math.max(0, Math.min(255, y));
      d[i]=d[i+1]=d[i+2]=y;
    }
    ctx.putImageData(imgData,0,0);
    return canvas;
  }

  function countHits(textNorm){
    let hits=0;
    for (const k of REQUIRED_KEYWORDS){
      const kk = normalizeText(k);
      if (kk && textNorm.includes(kk)) hits++;
    }
    return hits;
  }

  proofFile?.addEventListener('change', () => {
    if (!formOpened){
      if (ocrStatus) ocrStatus.textContent = "Please click ‚ÄúOpen Secure Form (New Tab)‚Äù first.";
      proofFile.value = "";
      return;
    }

    const hasFile = proofFile.files && proofFile.files[0];
    if (btnRunOCR) btnRunOCR.disabled = !hasFile;

    ocrPassed = false;
    if (p5Next) p5Next.disabled = true;

    setOCRProgress(0);
    if (ocrStatus){
      ocrStatus.className = "mt-2 text-xs md:text-sm text-slate-600";
      ocrStatus.textContent = hasFile ? "Ready." : "Upload a screenshot to begin.";
    }
  });

  btnRunOCR?.addEventListener('click', async () => {
    if (!proofFile?.files?.[0]) return;
    const file = proofFile.files[0];

    btnRunOCR.disabled = true;
    if (p5Next) p5Next.disabled = true;
    ocrPassed = false;

    setOCRProgress(3);
    if (ocrStatus){
      ocrStatus.className = "mt-2 text-xs md:text-sm text-slate-600";
      ocrStatus.textContent = "Preparing‚Ä¶";
    }

    try{
      const canvas = await preprocessToCanvas(file);
      setOCRProgress(10);
      if (ocrStatus) ocrStatus.textContent = "Scanning‚Ä¶";

      const result = await Tesseract.recognize(canvas, "eng", {
        logger: (m) => {
          if (m && m.status === "recognizing text" && typeof m.progress === "number"){
            setOCRProgress(10 + m.progress * 85);
          }
        }
      });

      const raw = (result?.data?.text) ? result.data.text : "";
      const norm = normalizeText(raw);
      const hits = countHits(norm);
      setOCRProgress(100);

      if (hits >= 1){
        ocrPassed = true;
        if (ocrStatus){
          ocrStatus.className = "mt-2 text-xs md:text-sm text-emerald-700 font-semibold";
          ocrStatus.textContent = "Verified.";
        }
        if (p5Next) p5Next.disabled = false;
      } else {
        ocrPassed = false;
        if (ocrStatus){
          ocrStatus.className = "mt-2 text-xs md:text-sm text-red-700 font-semibold";
          ocrStatus.textContent = "Verification failed. Upload a clearer screenshot of the confirmation page.";
        }
        if (p5Next) p5Next.disabled = true;
      }

      btnRunOCR.disabled = false;
    }catch(e){
      setOCRProgress(0);
      ocrPassed = false;
      if (p5Next) p5Next.disabled = true;
      if (ocrStatus){
        ocrStatus.className = "mt-2 text-xs md:text-sm text-amber-700 font-semibold";
        ocrStatus.textContent = "OCR error ‚Äî please try again.";
      }
      btnRunOCR.disabled = false;
    }
  });

  p5Next?.addEventListener('click', () => {
    if (!ocrPassed){
      showLockedMessage("Please verify your screenshot first.");
      return;
    }
    showPage(4);
  });

  // -----------------------------
  // Brevo -> enable finish
  // -----------------------------
  const sibForm = document.getElementById('sib-form');
  const emailInput = document.getElementById('EMAIL');
  const optIn = document.getElementById('OPT_IN');
  const emailErr = document.getElementById('email_error');
  const optinErr = document.getElementById('optin_error');
  const brevoSubmitBtn = document.getElementById('brevoSubmitBtn');
  const finishBtn = document.getElementById('finishBtn');

  function setErr(el, msg){
    if (!el) return;
    if (!msg){ el.style.display='none'; el.textContent=''; return; }
    el.style.display='block'; el.textContent=msg;
  }

  sibForm?.addEventListener('submit', (e) => {
    setErr(emailErr, ""); setErr(optinErr, "");
    const emailVal = (emailInput?.value || "").trim();
    let bad = false;

    if (!emailVal){ bad = true; setErr(emailErr, "Please enter your email address."); }
    else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)){ bad = true; setErr(emailErr, "Please enter a valid email address."); }

    if (!optIn?.checked){ bad = true; setErr(optinErr, "Please agree to continue."); }
    if (bad){ e.preventDefault(); return; }

    if (brevoSubmitBtn){
      brevoSubmitBtn.disabled = true;
      brevoSubmitBtn.textContent = "Submitting‚Ä¶";
    }

    setTimeout(() => {
      if (finishBtn) finishBtn.disabled = false;
      if (brevoSubmitBtn){
        brevoSubmitBtn.disabled = false;
        brevoSubmitBtn.textContent = "SUBMIT EMAIL";
      }
    }, 2500);
  });

  document.getElementById('p6Exit')?.addEventListener('click', () => disqualifyNow());
  finishBtn?.addEventListener('click', () => { window.location.href = completionUrl; });

  // Start
  showPage(0);
</script>
</body>
</html>
