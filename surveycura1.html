<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Debt Settlement Survey</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .chat-bubble { animation: pop-in 0.3s ease-out; word-wrap: break-word; }
    @keyframes pop-in { 0% { transform: scale(0.8) translateY(10px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
    .loader { border: 2px solid #4b5563; border-top: 2px solid #a5b4fc; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .embedded-form input, .embedded-form select { background-color: #1f2937; color: white; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s; }
    .embedded-form input:focus, .embedded-form select:focus { outline: none; border-color: #818cf8; }
    .slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -8px; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    input[type=range]::-webkit-slider-runnable-track { height: 8px; background: #4b5563; border-radius: 9999px; }
  </style>
</head>
<body class="bg-gray-900">
  <!-- Chatbot Section -->
  <div id="chatbot-section" class="flex flex-col h-screen max-w-lg mx-auto bg-gray-800 border-x border-gray-700">
    <header class="bg-gray-900 p-4 text-white text-center shadow-md flex items-center justify-center space-x-3">
      <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center font-bold text-lg">C</div>
      <div>
        <h2 class="text-xl font-bold">Chloe | AI Research Assistant</h2>
        <p class="text-xs text-indigo-300">Debt Settlement Feedback Study</p>
      </div>
    </header>

    <!-- Progress Bar -->
    <div class="w-full bg-gray-700 h-2" aria-hidden="true">
      <div id="progress-bar" class="bg-indigo-500 h-2 transition-all duration-500" style="width: 0%;"></div>
    </div>

    <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4 flex flex-col"></div>
    <footer id="chat-input-area" class="p-0 bg-gray-900 border-t border-gray-700"></footer>
  </div>

  <!-- Hidden background POST (CORS-safe) -->
  <iframe name="hidden_post_target" style="display:none;"></iframe>
  <iframe name="hidden_td_target" style="display:none;"></iframe>

  <!-- Hidden CuraDebt POST -->
  <form id="hidden-curadebt-post" action="https://signup.curadebt.com/apkconnect/" method="POST" target="hidden_post_target" style="display:none;">
    <input name="f_fname">
    <input name="f_lname">
    <input name="f_email">
    <input name="f_phone">
    <input name="f_whereyoulive">
    <input name="f_totaldebt">
    <input name="f_comments" value="Lead from AI Chatbot Survey">
    <input name="data1">
    <!-- data2 is FIXED as requested -->
    <input name="data2" value="CLICKID2">
    <input name="f_ip">
    <!-- Optional fields if required later by CuraDebt -->
    <input name="f_mobilephone">
    <input name="f_city">
    <input name="f_zip">
  </form>

  <!-- Hidden TrackDrive POST (Lead-to-Call) -->
  <form id="hidden-trackdrive-post"
        action="https://curadebt.trackdrive.com/api/v1/leads"
        method="POST" target="hidden_td_target" style="display:none;">
    <!-- REQUIRED -->
    <input name="lead_token" value="3346b0458309406ba4b8beac90a8a532">
    <input name="traffic_source_id" value="1000">
    <input name="caller_id">

    <!-- RECOMMENDED OPTIONALS -->
    <input name="first_name">
    <input name="last_name">
    <input name="email">
    <input name="state">
    <input name="zip">
    <input name="ip_address">
    <input name="source_url">
    <input name="useragent">
    <input name="original_lead_submit_date">
    <input name="tcpa_opt_in">
    <input name="tcpa_optin_consent_language">
    <input name="sub_id">
    <input name="gclid">
    <input name="fbeventid">
    <input name="msclkid">
    <input name="traffic_source_lead_id">
  </form>

  <script>
    const chatWindow = document.getElementById('chat-window');
    const chatInputArea = document.getElementById('chat-input-area');
    const progressBar = document.getElementById('progress-bar');

    let currentStepKey = 'start';
    let transactionId = '';
    let clientIp = '';

    const allStates = ["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"];
    // Exclusions confirmed
    const excludedStates = ['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','RI'];

    // === Phone Validation using your Cloudflare Worker + SignalWire ===
    const VALIDATE_ENDPOINT = "https://silent-sea-a717.kasindeesther.workers.dev/";

    function parseStrictNANP(raw) {
      const digits = String(raw || '').replace(/\D+/g, '');
      const m = digits.match(/^1?([2-9]\d{2})([2-9]\d{2})(\d{4})$/);
      if (!m) return { ok: false, error: 'Enter a valid US number (NANP).' };

      const [, area, prefix, line] = m;
      const isN11 = (s) => /^[2-9]11$/.test(s);
      if (isN11(area) || isN11(prefix)) return { ok: false, error: 'N11 service codes are not valid phone numbers.' };

      const TOLL_FREE = new Set(['800','833','844','855','866','877','888','822']);
      const tollFree = TOLL_FREE.has(area);

      if (area === '900') return { ok: false, error: 'Premium-rate (900) numbers are not accepted.' };
      if (prefix === '555' && /^01\d{2}$/.test(line)) return { ok: false, error: '555-01xx test numbers are not accepted.' };

      const ten = area + prefix + line;
      if (/^(\d)\1{9}$/.test(ten)) return { ok: false, error: 'Invalid pattern (all digits identical).' };
      const seq = '01234567890123456789';
      const rseq = '98765432109876543210';
      if (seq.includes(ten) || rseq.includes(ten)) return { ok: false, error: 'Invalid pattern (sequential digits).' };

      return { ok: true, e164: `+1${area}${prefix}${line}`, meta: { area, prefix, line, tollFree } };
    }

    async function validatePhoneWithSignalWire(raw) {
      const strict = parseStrictNANP(raw);
      if (!strict.ok) return strict;
      const r = await fetch(VALIDATE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: strict.e164 })
      });
      const j = await r.json().catch(() => ({}));
      if (!j.ok) return { ok: false, error: j.error || 'Validation failed.' };
      return { ...j, e164: strict.e164, meta: { ...(strict.meta || {}) } };
    }

    // === Email Validation (Cloudflare Worker) ===
    const VALIDATE_EMAIL_ENDPOINT = "https://solitary-base-4a8b.kasindeesther.workers.dev/";

    const REQUIRE_ALPHA_IN_LOCAL = true;
    const MIN_LOCAL_LEN = 3;
    const MAX_LOCAL_DOTS = 2;

    const ROLE_LOCALS = new Set([
      'admin','administrator','root','support','help','helpdesk','info','contact','sales',
      'marketing','billing','accounts','accounting','abuse','postmaster','webmaster',
      'no-reply','noreply','donotreply','security','compliance','legal','test'
    ]);

    const FREEMAIL = new Set([
      'gmail.com','googlemail.com','yahoo.com','ymail.com','rocketmail.com','outlook.com',
      'hotmail.com','live.com','msn.com','icloud.com','me.com','proton.me','aol.com','mail.com'
    ]);

    const DOMAIN_TYPO_MAP = {
      'gamil.com': 'gmail.com', 'gmial.com': 'gmail.com', 'gmai.com': 'gmail.com', 'gmail.con': 'gmail.com',
      'yahoo.con': 'yahoo.com', 'yhoo.com': 'yahoo.com', 'hotnail.com': 'hotmail.com', 'hotmial.com': 'hotmail.com',
      'outlok.com': 'outlook.com', 'outllok.com': 'outlook.com', 'icloud,com': 'icloud.com', 'protonn.me': 'proton.me'
    };

    function strictEmailClient(raw) {
      const email = String(raw || '').trim();
      const at = email.indexOf('@');
      if (at < 1 || at === email.length - 1) return { ok: false, error: 'Enter a valid email address.' };

      const local = email.slice(0, at);
      const domain = email.slice(at + 1).toLowerCase();

      if (local.length < MIN_LOCAL_LEN || local.length > 64) return { ok: false, error: 'Email local part length is invalid.' };
      if (domain.length < 4 || domain.length > 255) return { ok: false, error: 'Email domain length is invalid.' };

      if (!/^[A-Za-z0-9](?:[A-Za-z0-9._%'+\-]{0,62}[A-Za-z0-9])?$/.test(local)) return { ok: false, error: 'Invalid characters in email.' };
      if (local.includes('..')) return { ok: false, error: 'Email local part has consecutive dots.' };

      if (REQUIRE_ALPHA_IN_LOCAL && !/[A-Za-z]/.test(local)) return { ok: false, error: 'Email must contain letters (not only numbers).' };
      if (/^\d+$/.test(local)) return { ok: false, error: 'Email local part cannot be only digits.' };
      if ((local.match(/\./g) || []).length > MAX_LOCAL_DOTS) return { ok: false, error: 'Too many dots in email local part.' };

      if (domain.indexOf('.') < 1) return { ok: false, error: 'Email domain must contain a dot.' };

      const labels = domain.split('.');
      for (const label of labels) {
        if (label.length < 1 || label.length > 63) return { ok: false, error: 'Email domain label length is invalid.' };
        if (!/^[A-Za-z0-9-]+$/.test(label)) return { ok: false, error: 'Email domain contains invalid characters.' };
        if (label.startsWith('-') || label.endsWith('-')) return { ok: false, error: 'Email domain label cannot start/end with a hyphen.' };
      }

      const tld = labels[labels.length - 1];
      if (tld.length < 2 || tld.length > 63) return { ok: false, error: 'Email TLD is invalid.' };
      if (/^\d+$/.test(tld)) return { ok: false, error: 'Email TLD cannot be all digits.' };
      if (tld === 'con') return { ok: false, error: 'TLD looks mistyped (.con). Did you mean .com?' };

      const localLower = local.toLowerCase();
      const info = {
        role: ROLE_LOCALS.has(localLower),
        plusAnywhere: local.includes('+'),
        gmailDot: (domain === 'gmail.com' || domain === 'googlemail.com') && local.includes('.'),
        freemail: FREEMAIL.has(domain),
        numericOnly: /^\d+$/.test(local)
      };

      const suggestion = DOMAIN_TYPO_MAP[domain] || null;
      return { ok: true, normalized: `${local}@${domain}`, info, suggestion };
    }

    async function validateEmailWithWorker(raw) {
      const c = strictEmailClient(raw);
      if (!c.ok) return c;
      const r = await fetch(VALIDATE_EMAIL_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: c.normalized, want_mx: true })
      });
      const j = await r.json().catch(() => ({}));
      if (!j.ok) return { ok: false, error: j.error || 'Email validation failed.' };

      return {
        ok: true,
        normalized: c.normalized,
        disposable: !!j.disposable,
        has_mx: typeof j.has_mx === 'boolean' ? j.has_mx : undefined,
        suggestion: j.suggestion || c.suggestion || null,
        info: c.info
      };
    }

    // ---- Helpers ----
    function addMessage(message, sender = 'bot') {
      const messageEl = document.createElement('div');
      messageEl.className = `chat-bubble flex items-start gap-3 max-w-full ${sender === 'bot' ? 'self-start' : 'self-end flex-row-reverse'}`;
      messageEl.innerHTML = `<p class="p-3 rounded-lg ${sender === 'bot' ? 'bg-indigo-600 text-white' : 'bg-gray-600 text-white'}">${message}</p>`;
      chatWindow.appendChild(messageEl);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function createBaseContainer() {
      chatInputArea.innerHTML = '';
      const container = document.createElement('div');
      container.className = 'sticky bottom-0 w-full bg-gray-900 pt-3 pb-4 border-t border-gray-700 before:content-[""] before:block before:h-3 before:-mt-3 before:bg-gradient-to-t before:from-gray-900 before:to-transparent';
      return container;
    }

    function showOptions(options, onSelect, config = {}) {
      const { primaryIndex = 0, showNumbers = true } = config;
      const container = createBaseContainer();

      const hint = document.createElement('div');
      hint.className = 'text-center text-xs text-gray-400 mb-2';
      hint.textContent = showNumbers
        ? 'Tap an option or press 1–9 (Enter selects the first)'
        : 'Tap an option to continue';
      container.appendChild(hint);

      const optionsContainer = document.createElement('div');
      optionsContainer.className = 'flex flex-wrap justify-center gap-2 px-2';
      container.appendChild(optionsContainer);

      const buttons = [];
      const finalize = (value) => {
        buttons.forEach(b => { b.disabled = true; b.classList.add('opacity-60', 'cursor-not-allowed'); });
        addMessage(value, 'user');
        window.removeEventListener('keydown', keyHandler);
        onSelect(value);
      };

      options.forEach((text, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = [
          'px-4 py-2 rounded-full font-semibold transition shadow-sm',
          'bg-indigo-500 hover:bg-indigo-600 text-white',
          i === primaryIndex ? 'ring-2 ring-indigo-300' : ''
        ].join(' ').trim();

        btn.innerHTML = (showNumbers && i < 9)
          ? `<span class="mr-1 text-xs opacity-80">${i + 1}.</span>${text}`
          : text;

        btn.setAttribute('aria-label', text);
        btn.dataset.index = String(i + 1);
        btn.addEventListener('click', () => finalize(text));
        optionsContainer.appendChild(btn);
        buttons.push(btn);
      });

      const abandon = document.createElement('button');
      abandon.type = 'button';
      abandon.className = 'block mx-auto mt-3 text-red-400 hover:text-red-300 text-xs';
      abandon.textContent = 'Abandon Survey';
      abandon.addEventListener('click', () => {
        addMessage('Abandon Survey', 'user');
        window.removeEventListener('keydown', keyHandler);
        goToStep('leaveSurvey');
      });
      container.appendChild(abandon);

      chatInputArea.appendChild(container);

      if (buttons[primaryIndex]) buttons[primaryIndex].focus();

      const keyHandler = (e) => {
        if (/^[1-9]$/.test(e.key)) {
          const idx = parseInt(e.key, 10) - 1;
          if (buttons[idx]) buttons[idx].click();
        } else if (e.key === 'Enter') {
          if (buttons[primaryIndex]) buttons[primaryIndex].click();
        } else if (e.key === 'Escape') {
          abandon.click();
        }
      };
      window.addEventListener('keydown', keyHandler);
    }

    function getData1FromUrl() {
      const p = new URLSearchParams(location.search);
      const d1 = p.get('data1') || p.get('click_id') || p.get('gclid') || p.get('fbclid') || p.get('msclkid') || '';
      return d1 || 'no_click_id';
    }

    function digitsOnly(s) { return String(s || '').replace(/\D+/g, ''); }

    // ---- Survey Flow ----
    const surveyFlow = {
      'start': {
        message: "Hello! I'm Chloe, an AI assistant for a research study. We're gathering feedback from people to better understand the debt settlement process. Would you be willing to participate?",
        type: 'multiple-choice',
        options: ["Yes, I'll participate", "No, thank you"],
        action: (answer) => { if (answer === "Yes, I'll participate") { goToStep('askDebtAmount'); } else { goToStep('leaveSurvey'); } }
      },
      'leaveSurvey': { message: 'No problem at all. Thank you for your time. You will now be redirected.', end: true, status: 18 },
      'askDebtAmount': {
        message: 'Great! To ensure this study is relevant for you, approximately how much unsecured debt (like credit cards or personal loans) do you have?',
        type: 'multiple-choice', options: ['Under $10,000', '$10,000 or more'],
        action: (answer) => { if (answer === 'Under $10,000') { goToStep('disqualify'); } else { goToStep('askIncome'); } }
      },
      'askIncome': {
        message: 'Thank you. And do you have a steady source of income? This is usually required for debt settlement programs.',
        type: 'multiple-choice', options: ['Yes', 'No'],
        action: (answer) => { if (answer === 'No') { goToStep('disqualify'); } else { goToStep('qualified'); } }
      },
      'disqualify': { message: "I appreciate you answering. Based on your responses, this study isn't the right fit. Thank you for your time. You will be redirected now.", end: true, status: 18 },
      'qualified': { message: 'Fantastic! You\'ve qualified for the study. The main part of our research involves having you complete a short, secure form to request a free consultation from a debt specialist.', next: 'reassure' },
      'reassure': { message: 'Before I show you the form, I want to be transparent. To get genuine feedback, this study is for people who are truly interested in getting help with their debt. We\'ve carefully researched and selected a reputable company, <strong>CuraDebt</strong>, to connect our participants with. They will be the ones to contact you.', next: 'educateOnDebtRelief' },
      'educateOnDebtRelief': { message: "Just so you know what to expect, a debt settlement service works to negotiate with your creditors to lower the amount you owe. The goal is often to combine your payments into a single, more manageable monthly amount, with a plan to get you out of debt in about 2-4 years. It's a powerful option for many people.", next: 'explainTask' },
      'explainTask': {
        message: 'Your real-world experience with them is what makes this study so valuable. After you submit this form, a CuraDebt specialist will call you within the next few days. Following their call, you\'ll receive an email from us asking for your feedback on the conversation and to confirm if you were successfully contacted. Your input is vital as it helps us create articles that guide people in similar situations. Are you ready to take the next step?',
        type: 'multiple-choice', options: ["Yes, I'm ready"], action: () => goToStep('showApiForm')
      },
      'showApiForm': { message: "Excellent! Please complete the secure form below. I'll be here once you've submitted it.", type: 'api-form' },
      'formSuccess': { message: 'Thank you! Your information has been sent securely. A debt specialist will be calling you in the next few days.', next: 'askToContinueToFeedback' },
      'askToContinueToFeedback': { message: 'Now for the final step. Ready to provide your feedback?', type: 'multiple-choice', options: ['Yes, Continue to Feedback'], action: () => goToStep('askForFeedback') },
      'askForFeedback': { message: 'Please complete the form below. You\'ll need to enter your email address so we can match your feedback to your initial submission.', type: 'iframe-form', iframeSrc: 'https://digitalresearch1.github.io/debt/brevo.html', next: 'complete' },
      'complete': { message: "That's everything! Thank you so much for your valuable feedback. You will now be redirected to finalize your entry.", end: true, status: 21 }
    };

    function showApiForm() {
      chatInputArea.innerHTML = '';
      const formWrapper = document.createElement('div');
      formWrapper.className = 'w-full bg-gray-900 border-2 border-gray-700 rounded-lg p-4 my-2 text-white';

      const formContainer = document.createElement('form');
      formContainer.id = 'cura-debt-form';
      formContainer.className = 'embedded-form w-full space-y-4';
      formContainer.innerHTML = `
        <div class="text-center">
          <label for="debt-slider" class="text-lg font-semibold text-gray-300">Select Amount Of Unsecured Debt</label>
          <p id="debt-amount-display" class="text-4xl font-bold text-indigo-400 my-2">$25,000</p>

          <!-- Slider: exact control (step $100) -->
          <input type="range" id="debt-slider" min="0" max="100000" value="25000" step="100" class="w-full slider-thumb" list="debt-ticks">
          <datalist id="debt-ticks">
            <option value="0"></option>
            <option value="5000"></option>
            <option value="10000"></option>
            <option value="20000"></option>
            <option value="30000"></option>
            <option value="40000"></option>
            <option value="50000"></option>
            <option value="75000"></option>
            <option value="100000"></option>
          </datalist>

          <!-- Exact numeric entry -->
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 items-center gap-3">
            <label class="text-sm text-gray-300 sm:col-span-1" for="debt-number">Or type exact amount</label>
            <input type="text" id="debt-number" inputmode="numeric" placeholder="e.g. 12,450"
                   class="sm:col-span-2 bg-gray-800 border border-gray-700 rounded-md px-3 py-2 w-full" value="25,000">
          </div>
          <!-- Move slider hint -->
          <p id="move-hint" class="text-sm text-yellow-300 mt-2">Move the slider to confirm your amount.</p>

          <div id="debt-warning" class="text-xs text-yellow-400 mt-2 hidden">Minimum debt is $10,000 to qualify.</div>
          <input type="hidden" id="debt-confirmed" value="0">
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2">
          <input type="text" name="f_fname" placeholder="First Name" required>
          <input type="text" name="f_lname" placeholder="Last Name" required>
        </div>

        <input type="email" name="f_email" id="f_email" placeholder="Email Address" required>
        <div id="email-hint" class="text-xs mt-1 text-gray-400" aria-live="polite"></div>

        <input type="tel" name="f_phone" id="f_phone" placeholder="Phone Number" required>
        <div id="phone-hint" class="text-xs mt-1 text-gray-400" aria-live="polite"></div>

        <select name="f_whereyoulive" required>
          <option value="" disabled selected>Select Your State</option>
        </select>
        <label class="flex items-start gap-2 text-xs text-gray-300">
          <input type="checkbox" id="tcpa" required class="mt-1">
          <span>By clicking, you agree to be contacted by CuraDebt and its partners at the number and email provided (including via automated dialing/texts). Your consent is not required to purchase. Message/data rates may apply.</span>
        </label>
        <button type="submit" id="submit-btn"
                class="w-full bg-green-600 text-white font-bold text-lg py-3 rounded-lg transition opacity-60 cursor-not-allowed"
                disabled> Select amount to continue
        </button>

        <div id="form-error" class="text-red-400 font-semibold text-center text-sm hidden"></div>
      `;

      formWrapper.appendChild(formContainer);
      chatWindow.appendChild(formWrapper);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // populate states
      const stateSelect = formContainer.querySelector('select[name="f_whereyoulive"]');
      allStates.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; stateSelect.appendChild(o); });

      const MIN_QUAL = 10000;
      const MAX_DEBT = 100000;

      const debtSlider      = formContainer.querySelector('#debt-slider');
      const debtDisplay     = formContainer.querySelector('#debt-amount-display');
      const debtNumber      = formContainer.querySelector('#debt-number');
      const submitBtn       = formContainer.querySelector('#submit-btn');
      const debtConfirmedEl = formContainer.querySelector('#debt-confirmed');
      const debtWarning     = formContainer.querySelector('#debt-warning');
      const moveHint       = formContainer.querySelector('#move-hint');

      const formatCurrency = (amt) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(amt);
      const toInt = (s) => { const n = parseInt(String(s||'').replace(/[^\d]/g,''),10); return isNaN(n) ? 0 : n; };

      const setSubmitState = () => {
        const v = parseInt(debtSlider.value,10) || 0;
        const confirmed = debtConfirmedEl.value === '1';
        if (moveHint) moveHint.classList.toggle('hidden', confirmed);
        if (!confirmed) {
          submitBtn.disabled = true;
          submitBtn.classList.add('opacity-60','cursor-not-allowed');
          submitBtn.textContent = 'Select amount to continue';
          return;
        }
        if (v < MIN_QUAL) {
          submitBtn.disabled = true;
          submitBtn.classList.add('opacity-60','cursor-not-allowed');
          submitBtn.textContent = 'Minimum $10,000 required';
          debtWarning.classList.remove('hidden');
        } else {
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-60','cursor-not-allowed');
          submitBtn.textContent = 'See If I Qualify';
          debtWarning.classList.add('hidden');
        }
      };

      const applyAmount = (raw) => {
        const clamped = Math.max(0, Math.min(MAX_DEBT, Math.round(raw)));
        debtSlider.value = clamped;
        debtNumber.value = clamped.toLocaleString('en-US');
        debtDisplay.textContent = clamped >= MAX_DEBT ? `${formatCurrency(clamped)}+` : `${formatCurrency(clamped)}`;
        debtConfirmedEl.value = '1';
        setSubmitState();
      };

      // init
      debtDisplay.textContent = formatCurrency(parseInt(debtSlider.value,10));
      setSubmitState();

      // events
      debtSlider.addEventListener('input', () => applyAmount(parseInt(debtSlider.value,10)));
      debtNumber.addEventListener('input', () => applyAmount(toInt(debtNumber.value)));
      debtNumber.addEventListener('blur', () => { debtNumber.value = toInt(debtNumber.value).toLocaleString('en-US'); });

      // Email validation UI (uses validateEmailWithWorker)
      const emailInput = formContainer.querySelector('#f_email');
      const emailHint  = formContainer.querySelector('#email-hint');
      const runEmailValidationUI = async () => {
        if (!emailInput || !emailHint) return;
        if (!emailInput.value) { emailHint.textContent = ''; return; }
        emailHint.textContent = 'Checking email…';
        const res = await validateEmailWithWorker(emailInput.value);
        if (res.ok) {
          let msg = '✅ Valid';
          if (res.suggestion) msg += ` (did you mean ${emailInput.value.split('@')[0]}@${res.suggestion}?)`;
          if (res.disposable) msg = '⚠️ Disposable address detected. Please use a personal or work email.';
          if (res.info?.role) msg = '⚠️ Role account (e.g., info@) is not accepted.';
          if (res.info?.plusAnywhere) msg = '⚠️ Plus-addressing is not accepted.';
          if (res.info?.gmailDot) msg = '⚠️ Gmail dot aliases are not accepted.';
          emailHint.textContent = msg;
          const warn = res.disposable || res.info?.role || res.info?.plusAnywhere || res.info?.gmailDot;
          emailHint.classList.toggle('text-green-400', !warn);
          emailHint.classList.toggle('text-yellow-400', warn);
          emailHint.classList.remove('text-red-400');
        } else {
          emailHint.textContent = `❌ ${res.error}`;
          emailHint.classList.add('text-red-400'); emailHint.classList.remove('text-green-400','text-yellow-400');
        }
      };
      emailInput.addEventListener('blur', runEmailValidationUI);
      emailInput.addEventListener('change', runEmailValidationUI);

      // Phone validation UI
      const phoneInput = formContainer.querySelector('#f_phone');
      const phoneHint  = formContainer.querySelector('#phone-hint');
      const runPhoneValidationUI = async () => {
        if (!phoneInput || !phoneHint) return;
        if (!phoneInput.value) { phoneHint.textContent = ''; return; }
        phoneHint.textContent = 'Checking number…';
        const res = await validatePhoneWithSignalWire(phoneInput.value);
        if (res.ok) {
          const extra = res?.meta?.tollFree ? ' (toll-free)' : '';
          phoneHint.textContent = `✅ Valid ${res.country || ''} ${res.type || ''}: ${res.e164}${extra}`.trim();
          phoneHint.classList.add('text-green-400'); phoneHint.classList.remove('text-red-400','text-yellow-400');
        } else {
          phoneHint.textContent = `❌ ${res.error}`;
          phoneHint.classList.add('text-red-400'); phoneHint.classList.remove('text-green-400','text-yellow-400');
        }
      };
      phoneInput.addEventListener('blur', runPhoneValidationUI);
      phoneInput.addEventListener('change', runPhoneValidationUI);

      formContainer.addEventListener('submit', handleApiFormSubmit);
    }

    function showIframeForm(iframeSrc, onContinue) {
      const container = createBaseContainer();
      const formWrapper = document.createElement('div');
      formWrapper.className = 'w-full h-full flex-grow bg-gray-900 rounded-lg p-1 my-2';

      const iframe = document.createElement('iframe');
      iframe.src = `${iframeSrc}?rid=${transactionId}`;
      iframe.className = 'w-full h-full border-0 rounded-md';
      formWrapper.appendChild(iframe);

      chatWindow.innerHTML = '';
      chatWindow.appendChild(formWrapper);
      chatWindow.scrollTop = 0;

      const continueButton = document.createElement('button');
      continueButton.className = 'bg-green-600 hover:bg-green-700 text-white font-bold text-lg py-3 px-6 rounded-lg transition mt-4';
      continueButton.textContent = "I've Submitted My Feedback";
      continueButton.onclick = () => { addMessage("I've Submitted My Feedback", 'user'); formWrapper.remove(); onContinue(); };
      container.appendChild(continueButton);
      chatInputArea.appendChild(container);
    }

    async function handleApiFormSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const submitButton = form.querySelector('button[type="submit"]');
      const formError = form.querySelector('#form-error');

      formError.classList.add('hidden');
      submitButton.disabled = true;
      submitButton.innerHTML = '<div class="loader mx-auto"></div>';

      const debtAmount = parseInt(form.querySelector('#debt-slider').value, 10) || 0;
      const selectedState = form.querySelector('select[name="f_whereyoulive"]').value;

      // Require explicit confirmation/change of debt amount
      const debtConfirmedEl = document.getElementById('debt-confirmed');
      if (!debtConfirmedEl || debtConfirmedEl.value !== '1') {
        formError.textContent = 'Please confirm your debt amount by moving the slider or typing the exact amount.';
        formError.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'See If I Qualify';
        return;
      }

      if (debtAmount < 10000) {
        formError.textContent = 'Minimum debt of $10,000 is required to qualify.';
        formError.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'See If I Qualify';
        return;
      }
      if (excludedStates.includes(selectedState)) {
        formError.textContent = 'Unfortunately, we do not service your state at this time.';
        formError.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'See If I Qualify';
        return;
      }

      // >>> Email validation (tight policy on submit)
      const emailRaw = form.querySelector('input[name="f_email"]').value || '';
      const emailCheck = await validateEmailWithWorker(emailRaw);
      if (!emailCheck.ok) {
        formError.textContent = emailCheck.error || 'Please enter a valid email address.';
        formError.classList.remove('hidden');
        submitButton.disabled = false; submitButton.textContent = 'See If I Qualify';
        return;
      }
      if (emailCheck.disposable) {
        formError.textContent = 'Disposable email addresses are not accepted. Please use a personal or work email.';
        formError.classList.remove('hidden'); submitButton.disabled = false; submitButton.textContent = 'See If I Qualify'; return;
      }
      if (emailCheck.info?.role) {
        formError.textContent = 'Role-based emails (e.g., info@, support@) are not accepted. Please use your personal email.';
        formError.classList.remove('hidden'); submitButton.disabled = false; submitButton.textContent = 'See If I Qualify'; return;
      }
      if (emailCheck.info?.plusAnywhere) {
        formError.textContent = 'Plus-alias emails are not accepted. Please use your base address.';
        formError.classList.remove('hidden'); submitButton.disabled = false; submitButton.textContent = 'See If I Qualify'; return;
      }
      if (emailCheck.info?.gmailDot) {
        formError.textContent = 'Gmail dot aliases are not accepted. Remove dots from your Gmail username.';
        formError.classList.remove('hidden'); submitButton.disabled = false; submitButton.textContent = 'See If I Qualify'; return;
      }
      const normalizedEmail = emailCheck.normalized;
      let emailStatusTag = 'normal';
      if (emailCheck.disposable) emailStatusTag = 'disposable';
      else if (emailCheck.info?.role) emailStatusTag = 'role';
      else if (emailCheck.info?.plusAnywhere) emailStatusTag = 'plus';
      else if (emailCheck.info?.gmailDot) emailStatusTag = 'gmaildot';

      // >>> Phone validation
      const phoneRaw = form.querySelector('input[name="f_phone"]').value || '';
      const phoneCheck = await validatePhoneWithSignalWire(phoneRaw);
      if (!phoneCheck.ok) {
        formError.textContent = phoneCheck.error || 'Please enter a valid phone number.';
        formError.classList.remove('hidden');
        submitButton.disabled = false; submitButton.textContent = 'See If I Qualify';
        return;
      }
      const normalizedE164 = phoneCheck.e164 || phoneRaw; // e.g. +1XXXXXXXXXX
      const phoneType = phoneCheck.type || 'unknown';
      const isTollFree = !!(phoneCheck.meta && phoneCheck.meta.tollFree);

      // get IP best-effort
      try {
        const r = await fetch('https://api.ipify.org?format=json');
        const j = await r.json();
        clientIp = j.ip || '';
      } catch (err) { clientIp = ''; }

      // Build & submit hidden POST to CuraDebt (CORS-safe)
      const hidden = document.getElementById('hidden-curadebt-post');
      const fd = new FormData(form);
      const data1 = getData1FromUrl() || transactionId;

      hidden.elements['f_fname'].value        = fd.get('f_fname') || '';
      hidden.elements['f_lname'].value        = fd.get('f_lname') || '';
      hidden.elements['f_email'].value        = normalizedEmail;
      hidden.elements['f_phone'].value        = normalizedE164.startsWith('+1') ? normalizedE164.replace('+1','') : normalizedE164;
      hidden.elements['f_whereyoulive'].value = fd.get('f_whereyoulive') || '';
      hidden.elements['f_totaldebt'].value    = String(debtAmount);
      hidden.elements['data1'].value          = data1;
      hidden.elements['f_comments'].value     = `Lead from AI Chatbot Survey | phone_type=${phoneType} | email_status=${emailStatusTag} | toll_free=${isTollFree}`;
      hidden.elements['data2'].value          = 'CLICKID2';
      hidden.elements['f_ip'].value           = clientIp;
      hidden.submit();

      // --- TrackDrive Lead-to-Call POST (separate iframe) ---
      const tdForm = document.getElementById('hidden-trackdrive-post');
      const qs = new URLSearchParams(location.search);
      const gclid = qs.get('gclid') || '';
      const fbeventid = qs.get('fbclid') || '';
      const msclkid = qs.get('msclkid') || '';
      const tcpaBox = document.getElementById('tcpa');

      // REQUIRED
      tdForm.elements['caller_id'].value = normalizedE164; // must be +1XXXXXXXXXX

      // OPTIONALS
      tdForm.elements['first_name'].value  = fd.get('f_fname') || '';
      tdForm.elements['last_name'].value   = fd.get('f_lname') || '';
      tdForm.elements['email'].value       = normalizedEmail;
      tdForm.elements['state'].value       = fd.get('f_whereyoulive') || '';
      tdForm.elements['zip'].value         = fd.get('f_zip') || '';
      tdForm.elements['ip_address'].value  = clientIp || '';
      tdForm.elements['source_url'].value  = location.href;
      tdForm.elements['useragent'].value   = navigator.userAgent || '';
      tdForm.elements['original_lead_submit_date'].value = new Date().toISOString().replace('T',' ').slice(0,19); // "YYYY-MM-DD HH:MM:SS"
      tdForm.elements['tcpa_opt_in'].value = tcpaBox && tcpaBox.checked ? 'true' : 'false';
      tdForm.elements['tcpa_optin_consent_language'].value =
        (document.querySelector('label[for="tcpa"] span')?.innerText || '').trim();
      tdForm.elements['sub_id'].value      = data1;
      tdForm.elements['gclid'].value       = gclid;
      tdForm.elements['fbeventid'].value   = fbeventid;
      tdForm.elements['msclkid'].value     = msclkid;
      tdForm.elements['traffic_source_lead_id'].value = transactionId;

      // Submit to TrackDrive (this triggers the call on their side)
      tdForm.submit();

      // advance flow immediately
      form.parentElement.remove();
      addMessage("I've submitted my information.", 'user');
      goToStep('formSuccess');
    }

    function goToStep(stepKey, showMessage = true) {
      const step = surveyFlow[stepKey];
      if (!step) return;

      currentStepKey = stepKey;
      const keys = Object.keys(surveyFlow);
      const stepIndex = keys.indexOf(stepKey);
      updateProgress(stepIndex, keys.length);

      const delay = 1200;
      if (step.message && showMessage) setTimeout(() => addMessage(step.message, 'bot'), delay / 2);

      if (step.end) {
        chatInputArea.innerHTML = `<p class="text-center text-gray-400 text-sm">You will be redirected shortly...</p>`;
        const finalUrl = `https://spectrumsurveys.com/surveydone?st=${step.status}&transaction_id=${transactionId}`;
        setTimeout(() => { window.location.href = finalUrl; }, 2500);
        return;
      }

      const timeout = (step.message && showMessage) ? delay : 100;
      setTimeout(() => {
        if (step.type === 'multiple-choice') {
          showOptions(step.options, step.action, { primaryIndex: 0, showNumbers: true });
        } else if (step.type === 'api-form') {
          showApiForm();
        } else if (step.type === 'iframe-form') {
          showIframeForm(step.iframeSrc, () => goToStep(step.next));
        } else if (step.next) {
          goToStep(step.next);
        }
      }, timeout);
    }

    function updateProgress(index, total) {
      const progress = Math.max(0, Math.min(100, (index / Math.max(1, total - 1)) * 100));
      progressBar.style.width = `${progress}%`;
    }

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      transactionId = urlParams.get('transaction_id') || urlParams.get('RID') || `tx_${Date.now()}`;

      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        clientIp = data.ip;
      } catch (_) { clientIp = ''; }

      goToStep('start');
    }

    init();
  </script>
</body>
</html>
