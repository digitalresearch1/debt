<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chloe — IRS Tax Relief Survey</title>
    <!-- Tailwind CSS for review cards -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Brevo/Sendinblue styles for the feedback form -->
    <style>
        @font-face {
            font-display: block;
            font-family: Roboto;
            src: url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/7529907e9eaf8ebb5220c5f9850e3811.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/25c678feafdc175a70922a116c9be3e7.woff) format("woff")
        }
        @font-face {
            font-display: fallback;
            font-family: Roboto;
            font-weight: 600;
            src: url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/6e9caeeafb1f3491be3e32744bc30440.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/71501f0d8d5aa95960f6475d5487d4c2.woff) format("woff")
        }
        @font-face {
            font-display: fallback;
            font-family: Roboto;
            font-weight: 700;
            src: url(https://assets.brevo.com/font/Roboto/Latin/bold/normal/3ef7cf158f310cf752d5ad08cd0e7e60.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/bold/normal/ece3a1d82f18b60bcce0211725c476aa.woff) format("woff")
        }
        #sib-container input:-ms-input-placeholder { text-align: left; font-family: Helvetica, sans-serif; color: #c0ccda; }
        #sib-container input::placeholder { text-align: left; font-family: Helvetica, sans-serif; color: #c0ccda; }
        #sib-container textarea::placeholder { text-align: left; font-family: Helvetica, sans-serif; color: #c0ccda; }
        #sib-container a { text-decoration: underline; color: #2BB2FC; }
    </style>
    <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">
    
    <!-- Main application styles -->
    <style>
        :root{--bg:#f6f7fb;--ink:#0f172a;--sub:#475569;--ring:#e2e8f0;--card:#ffffff;--grad1:#6366f1;--grad2:#a78bfa;--grad3:#ec4899}
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
        .frame{display:flex;flex-direction:column;height:100vh;background:var(--card);overflow:hidden}
        header{padding:14px 20px;background:linear-gradient(#fff,#ffffffb0);border-bottom:1px solid rgba(0,0,0,.06)}
        header .title{font-weight:700}
        .progress-wrap{padding:8px 20px 6px}
        .progress{height:8px;border-radius:9999px;background:#e5e7eb;overflow:hidden}
        .progress>div{height:8px;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));transition:width .5s}
        .scroll-area{position:relative;flex:1;overflow:hidden}
        #scroll-box{position:absolute;inset:0;overflow-y:auto}
        #question-bar{background:linear-gradient(135deg,#f5f3ff,#eef2ff);border:none;border-bottom:1px solid var(--ring);padding:16px 20px;box-shadow:0 4px 12px rgba(15,23,42,.04)}
        .q-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--grad1);font-weight:700}
        #q-text{font-size:16px;font-weight:500;color:#1e293b;line-height:1.5}
        #q-hint{font-size:11px;color:#64748b;margin-top:4px;display:none}
        .history{padding:10px 16px 20px}
        .history > .card{max-width:560px;margin-left:auto;margin-right:auto}
        .bubble{display:flex;justify-content:flex-end;margin:8px 0}
        .bubble>div{background:#f1f5f9;border:1px solid rgba(15,23,42,.08);border-radius:18px;padding:10px 12px;font-size:14px;box-shadow:0 2px 10px rgba(15,23,42,.05);max-width:75%;word-wrap:break-word}
        footer{padding:12px 16px;background:linear-gradient(0deg,#fff,#ffffffb0);border-top:1px solid rgba(0,0,0,.06)}
        .btn{width:100%;text-align:left;padding:12px 14px;border-radius:9999px;background:#fff;border:1px solid #e2e8f0;box-shadow:0 1px 0 rgba(0,0,0,.03);font-weight:600;cursor:pointer}
        .btn:hover{background:#f8fafc}
        .btn[disabled]{opacity:.6;cursor:not-allowed}
        .abandon{display:block;margin:8px auto 0;color:#e11d48;background:none;border:none;font-size:12px;cursor:pointer}
        .card{background:#fff;border:1px solid var(--ring);border-radius:18px;padding:16px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .field{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#fff}
        .label{font-size:12px;color:#475569}
        .help{font-size:12px;color:#64748b;margin:8px 0}
        .hidden{display:none}
        .money{font-size:36px;font-weight:800;background:linear-gradient(90deg,#4f46e5,#a78bfa,#ec4899);-webkit-background-clip:text;background-clip:text;color:transparent;margin:6px 0}
        .slider{width:100%;-webkit-appearance:none;appearance:none;background:transparent;height:34px}
        .slider::-webkit-slider-runnable-track{height:8px;background:#d1d5db;border-radius:999px}
        .slider::-moz-range-track{height:8px;background:#d1d5db;border-radius:999px}
        .slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:linear-gradient(135deg,var(--grad1),var(--grad2));border:3px solid #fff;border-radius:50%;margin-top:-7px;box-shadow:0 6px 18px rgba(99,102,241,.35)}
        .slider::-moz-range-thumb{width:22px;height:22px;background:linear-gradient(135deg,var(--grad1),var(--grad2));border:3px solid #fff;border-radius:50%;box-shadow:0 6px 18px rgba(99,102,241,.35)}
        .cta{padding:12px 14px;width:100%;border:none;border-radius:12px;font-weight:700;color:#fff;background:linear-gradient(90deg,#10b981,#14b8a6);cursor:pointer}
        .cta[disabled]{opacity:.6;cursor:not-allowed; background: #ccc;}
        .cta:not(:disabled) { background: linear-gradient(90deg,#10b981,#14b8a6); }
        .notice{font-size:12px;color:#166534;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:8px;padding:6px 8px;margin-top:6px;display:none}
        .otp-row{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
        .otp-send,.otp-verify{padding:10px 12px;border:none;border-radius:12px;font-weight:700;color:#fff}
        .otp-send{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
        .otp-verify{background:linear-gradient(90deg,#10b981,#059669)}
        .otp-code{flex:1;min-width:140px;max-width:220px}
        .spacer{height:6px}
        .muted{color:var(--sub);font-size:14px}
        .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:9999px;background:#eef2ff;color:#3730a3;margin-left:6px}
    </style>
</head>
<body>
    <div class="shell">
        <div class="frame">
            <header>
                <div style="display:flex;gap:10px;align-items:center">
                    <div style="width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#6366f1,#a78bfa,#ec4899);display:grid;place-items:center;color:#fff;font-weight:800">C</div>
                    <div style="flex:1">
                        <div class="title">Chloe</div>
                        <div class="muted">AI Research Assistant · Tax Settlement Study</div>
                    </div>
                    <div class="muted">Secure</div>
                </div>
            </header>
            <div class="progress-wrap"><div class="progress"><div id="progress-bar"></div></div></div>
            <div class="scroll-area">
                <div id="scroll-box">
                    <div id="question-bar">
                        <div class="q-label">Question</div>
                        <div id="q-text"></div>
                        <div id="q-hint">Scroll to the end to continue</div>
                    </div>
                    <div class="history" id="chat-window"><div class="spacer"></div></div>
                </div>
            </div>
            <footer id="chat-input-area"></footer>
        </div>
    </div>
    
    <!-- Hidden forms for API submission. These are populated by the script before submission. -->
    <form id="hidden-lead-form-1" method="POST" action="" style="display:none;" target="form_iframe">
        <input type="hidden" name="f_fname">
        <input type="hidden" name="f_lname">
        <input type="hidden" name="f_email">
        <input type="hidden" name="f_phone">
        <input type="hidden" name="f_whereyoulive">
        <input type="hidden" name="f_totaldebt">
        <input type="hidden" name="data1">
        <input type="hidden" name="f_ip">
    </form>
    <form id="hidden-lead-form-2" method="POST" action="" style="display:none;" target="form_iframe">
        <input type="hidden" name="campaign_id">
        <input type="hidden" name="caller_id">
        <input type="hidden" name="first_name">
        <input type="hidden" name="last_name">
        <input type="hidden" name="email">
        <input type="hidden" name="state">
        <input type="hidden" name="unsecured_debt_total">
        <input type="hidden" name="ip_address">
        <input type="hidden" name="useragent">
        <input type="hidden" name="gclid">
        <input type="hidden" name="fbeventid">
        <input type="hidden" name="msclkid">
        <input type="hidden" name="tcpa_opt_in">
        <input type="hidden" name="tcpa_optin_consent_language">
        <input type="hidden" name="call_now" value="1">
        <input type="hidden" name="email_unverified">
        <input type="hidden" name="otp_verified">
    </form>
    <iframe name="form_iframe" style="display:none;"></iframe>

    <script type="module">
        /********************************************************************
         * CONFIGURATION
         * -----------------
         * Update all the values in this section to customize the survey.
         ********************************************************************/
        const CONFIG = {
            // Set to `false` for production to hide the debugging box.
            DEBUG_MODE: false,

            // CRITICAL: Replace these placeholders with your actual Firebase project configuration.
            FIREBASE_CONFIG: {
                apiKey: "AIzaSyBF5wdHyOlOi_bntJHXto7f6RbJMkOdMSE",
                authDomain: "otp-c6311.firebaseapp.com",
                projectId: "otp-c6311",
                storageBucket: "otp-c6311.firebasestorage.app",
                messagingSenderId: "637495517002",
                appId: "1:637495517002:web:7bd220994a7611a5606bb3"
            },
            
            // Endpoints for lead submission.
            LEAD_POST_URL_1: "https://www.curadebt.com/submit-api.php", // CuraDebt
            LEAD_POST_URL_2: "https://td.trackdrive.com/api/v1/leads",  // TrackDrive
            
            // TrackDrive specific campaign ID.
            TRACKDRIVE_CAMPAIGN_ID: "1000",

            // Brevo (Sendinblue) form action URL for feedback collection.
            BREVO_FORM_URL: "https://52bcaf92.sibforms.com/serve/MUIFABmWYWf3cwFJgrPQjj77APgtEF8JJ634OSD8-qQ0EDQNiYN4wKPaqF51FAIz5p1vc-yLf5DzMhxB9w2mxDBu1Y0b87khoYUFn2eK-KLi_obHRBTplKxc2k8CzNCwM-uTcb6i0GlaxcU49zWeQXP5s5cGwd7q1sahZ8i6BR5E43UzfKJflMtJ7R5ild_uKdD9alhHh3f8n_Mt",
            
            // The final URL for users who successfully complete the entire survey.
            PURESPECTRUM_COMPLETE_URL: "https://spectrumsurveys.com/surveydone?st=21",

            // The URL for users who are disqualified or abandon the survey.
            PURESPECTRUM_TERMINATE_URL: "https://spectrumsurveys.com/surveydone?st=18",

            // Minimum debt amount required to qualify for the survey.
            MIN_DEBT_AMOUNT: 10000,
            
            // List of two-letter state codes to exclude from the survey.
            EXCLUDED_STATES: ['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','WY'],
        };
        /********************************************************************
         * END OF CONFIGURATION
         ********************************************************************/

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Capture Transaction ID on load ---
        const URL_PARAMS = new URLSearchParams(window.location.search);
        const TRANSACTION_ID = URL_PARAMS.get('transaction_id') || '';

        // Initialize Firebase
        const app = initializeApp(CONFIG.FIREBASE_CONFIG);
        const auth = getAuth(app);

        // --- Global UI elements ---
        const scrollBox = document.getElementById('scroll-box');
        const chatWindow = document.getElementById('chat-window');
        const chatInputArea = document.getElementById('chat-input-area');
        const progressBar = document.getElementById('progress-bar');
        const qbar = document.getElementById('question-bar');
        const qtext = document.getElementById('q-text');

        // --- Core UI & State Management ---
        
        function updateSticky() { 
            const isAtBottom = scrollBox.scrollHeight - (scrollBox.scrollTop + scrollBox.clientHeight) < 16;
            qbar.style.position = isAtBottom ? 'sticky' : 'relative'; 
            qbar.style.top = isAtBottom ? '0' : 'auto';
        }
        scrollBox.addEventListener('scroll', updateSticky);
        
        function ensureBottom() { 
            requestAnimationFrame(() => { 
                scrollBox.scrollTop = scrollBox.scrollHeight; 
                updateSticky(); 
            }); 
        }
        
        function createBaseContainer() { 
            chatInputArea.innerHTML = ''; 
            const c = document.createElement('div'); 
            return chatInputArea.appendChild(c); 
        }
        
        function setQuestion(text) { qtext.innerHTML = text || ''; }
        
        function addAnswer(text) { 
            const el = document.createElement('div'); 
            el.className = 'bubble'; 
            el.innerHTML = `<div>${text}</div>`; 
            chatWindow.appendChild(el); 
        }
        
        function addAbandon(container) { 
            const a = document.createElement('button'); 
            a.className = 'abandon'; 
            a.textContent = 'Abandon Survey'; 
            a.onclick = () => goToStep('leaveSurvey'); 
            container.appendChild(a); 
        }

        // --- Knowledge Base for FAQ ---
        const Q_OPTION = 'I have a question about tax relief';
        const DEBT_KB = [
            { q: 'What is an Offer in Compromise?', a: 'An Offer in Compromise (OIC) is an agreement between a taxpayer and the IRS that settles tax liabilities for less than the full amount owed.', k: ['offer', 'compromise', 'oic', 'settle'] },
            { q: 'Which tax debts qualify?', a: 'Generally, tax debt from income tax, payroll tax, and other federal taxes can be included. A specialist can review your specific situation.', k: ['qualify', 'eligible', 'irs'] },
            { q: 'What is Penalty Abatement?', a: 'Penalty Abatement is a request to the IRS to remove penalties after they have been assessed. This is typically granted for reasonable cause, such as a serious illness or natural disaster.', k: ['penalty', 'abatement', 'remove'] },
        ];
        function answerDebtQuestion(q) { 
            const qq = (q || '').toLowerCase(); 
            let best = null, score = 0; 
            for (const item of DEBT_KB) { 
                let s = 0; 
                item.k.forEach(kw => { if (qq.includes(kw)) s++; }); 
                if (s > score) { score = s; best = item; } 
            } 
            if (!best) return 'A tax specialist can provide detailed answers to your specific questions.'; 
            return `<strong>${best.q}</strong><br>${best.a}`; 
        }
        
        function openQAModal() {
            const overlay = document.createElement('div'); 
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:60';
            const box = document.createElement('div'); 
            box.style.cssText = 'background:#fff;width:min(92%,420px);border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(15,23,42,.2)';
            box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Ask a Question</div><button id="qa-close" style="border:none;background:none;font-size:22px;color:#475569;cursor:pointer">×</button></div><div class="muted" style="margin-top:6px">General info only.</div><div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px"><input id="qa-input" class="field" placeholder="What is an OIC?"><button id="qa-ask" class="cta" style="width:auto;padding:10px 14px">Ask</button></div><div id="qa-ans" style="margin-top:10px;font-size:14px;"></div>`;
            overlay.appendChild(box); 
            document.body.appendChild(overlay);
            const ans = box.querySelector('#qa-ans');
            box.querySelector('#qa-close').onclick = () => overlay.remove();
            box.querySelector('#qa-ask').onclick = () => { const v = box.querySelector('#qa-input').value.trim(); if (v) ans.innerHTML = answerDebtQuestion(v); };
        }

        function showOptions(options, onSelect, delay = 0) {
            const c = createBaseContainer();
            const btns = options.map(opt => { 
                const b = document.createElement('button'); 
                b.className = 'btn'; 
                b.textContent = opt; 
                b.onclick = () => finalize(opt); 
                c.appendChild(b); 
                return b; 
            });

            if (delay > 0 && btns.length > 0) {
                const primaryBtn = btns[0];
                primaryBtn.disabled = true;
                let countdown = delay;
                const originalText = primaryBtn.textContent;
                primaryBtn.textContent = `Please read carefully (${countdown}s)`;

                const timer = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        primaryBtn.textContent = `Please read carefully (${countdown}s)`;
                    } else {
                        clearInterval(timer);
                        primaryBtn.disabled = false;
                        primaryBtn.textContent = originalText;
                    }
                }, 1000);
            }

            const qaBtn = document.createElement('button'); 
            qaBtn.className = 'btn'; 
            qaBtn.textContent = Q_OPTION; 
            qaBtn.onclick = openQAModal; 
            c.appendChild(qaBtn);
            addAbandon(c);

            function finalize(v) { 
                [...btns, qaBtn].forEach(b => b.disabled = true); 
                onSelect(v); 
            }
            ensureBottom();
        }

        // --- Survey Flow State Machine ---
        let prefillDebtAmount = null;
        const surveyFlow = {
            start: { message: "Hello! I'm Chloe, an AI assistant for a research study on the IRS tax settlement process. Would you be willing to participate?", type: 'multiple-choice', options: ["Yes, I'll participate", "No, thank you"], action: (a) => a.startsWith('Yes') ? goToStep('qDebtRange') : goToStep('leaveSurvey') },
            leaveSurvey: { message: 'No problem. Thank you for your time. Redirecting...', terminate: true },
            qDebtRange: { message: `About how much tax debt do you have (IRS, State, etc.)?`, type: 'multiple-choice', options: [`Below $${(CONFIG.MIN_DEBT_AMOUNT).toLocaleString()}`, `$${(CONFIG.MIN_DEBT_AMOUNT).toLocaleString()}–$40,000`, '$40,000+'], action: (a) => { if (a.startsWith('Below')) return goToStep('disqualify'); prefillDebtAmount = a.includes('$40,000') ? 50000 : 25000; return goToStep('qIncome'); } },
            qIncome: { message: 'Do you have a steady source of income?', type: 'multiple-choice', options: ['Yes', 'No'], action: (a) => a === 'Yes' ? goToStep('qWilling') : goToStep('disqualify') },
            qWilling: { message: 'As part of the study, would you speak with a tax specialist for a free, no-obligation consultation?', type: 'multiple-choice', options: ['Yes', 'No'], action: (a) => a === 'Yes' ? goToStep('preFormInfo') : goToStep('disqualify') },
            preFormInfo: { 
                delay: 15,
                message: `Fantastic! You’ve qualified for the study.<br><br><p class="text-center font-bold text-indigo-600 my-4">Please take a moment to read the following information carefully.</p>The main part of our research involves having you complete a short, secure form to request a free consultation from a tax specialist. To ensure we collect genuine feedback, this study is for people who are truly interested in resolving their tax issues.<br><br>A tax relief service works with the IRS to negotiate your tax liabilities. The goal is often to find a resolution program like an Offer in Compromise or Penalty Abatement, with a plan to help you resolve your tax debt.<br><br>After you submit this form, you may receive a call from a toll-free number. We will also send an email to confirm your participation — please reply to that email to let us know how your call went.<br><br><strong>How your information is used</strong><br><br>This is an independent research study. Your information will be used only to connect you with a specialist and to collect research feedback. We share details with CuraDebt solely to allow them to contact you. We do not sell your information.<br><br>We’ve carefully researched and selected CuraDebt as a reputable company to connect our participants with tax specialists.
            
                <div class="mt-6 text-left">
                    <h4 class="font-semibold text-slate-900 mb-2 text-center sm:text-left">Independent reviews</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 place-items-center">
                        <!-- Trustpilot tile -->
                        <a href="https://uk.trustpilot.com/review/www.curadebt.com?page=3" target="_blank" class="group block w-full border border-slate-200 rounded-2xl overflow-hidden hover:shadow-xl p-6 md:p-8 bg-white min-h-44">
                            <div class="flex flex-col items-center text-center">
                                <div class="mb-3 inline-flex items-center gap-2 rounded-xl px-3 py-2 bg-[#f4f3ee] shadow-[0_10px_30px_rgba(0,0,0,.12)]">
                                    <svg viewBox="0 0 24 24" aria-hidden="true" class="w-6 h-6" fill="#00B67A">
                                        <polygon points="12,2 14.9,9 22.3,9.2 16.7,13.4 18.7,20.2 12,16.3 5.3,20.2 7.3,13.4 1.7,9.2 9.1,9"></polygon>
                                    </svg>
                                    <span class="text-lg md:text-xl font-extrabold tracking-tight text-slate-900">Trustpilot</span>
                                </div>
                                <div class="text-sm text-slate-700 font-medium mb-2">CuraDebt reviews</div>
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center gap-1" aria-label="4.9 out of 5 stars on Trustpilot">
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-emerald-600"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-emerald-600"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-emerald-600"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-emerald-600"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-emerald-600"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                    </div>
                                    <div class="text-base font-semibold">4.9</div>
                                </div>
                                <div class="text-xs text-slate-600 mt-2">160 reviews on Trustpilot</div>
                            </div>
                        </a>
                        <!-- Google Reviews tile -->
                        <a href="https://www.google.com/maps/place/CuraDebt/@25.9704379,-80.169098,9455m/data=!3m2!1e3!5s0x88d9a9be4a479643:0xf7172abdc2f82499!4m8!3m7!1s0x88d9abe11e968fab:0xede6e70fcbc1421f!8m2!3d26.0105652!4d-80.1836621!9m1!1b1!16s%2Fg%2F11cn9ngvsm?entry=ttu" target="_blank" class="group block w-full border border-slate-200 rounded-2xl overflow-hidden hover:shadow-xl p-6 md:p-8 bg-white min-h-44">
                            <div class="flex flex-col items-center text-center">
                                <img src="https://www.gstatic.com/images/branding/googlelogo/svg/googlelogo_clr_74x24px.svg" alt="Google" class="h-7 md:h-8 w-auto object-contain mb-3">
                                <div class="text-sm text-slate-700 font-medium mb-2">CuraDebt reviews</div>
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center gap-1" aria-label="4.8 out of 5 stars on Google Reviews">
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6 fill-amber-400"><polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1"></polygon></svg>
                                        <svg viewBox="0 0 20 20" class="w-6 h-6">
                                            <defs>
                                                <linearGradient id="halfStarFill" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="50%" stop-color="#f59e0b"></stop>
                                                    <stop offset="50%" stop-color="#e5e7eb"></stop>
                                                </linearGradient>
                                            </defs>
                                            <polygon points="10,1 12.9,7.1 19.6,7.3 14,11.6 15.9,18.2 10,14.5 4.1,18.2 6,11.6 0.4,7.3 7.1,7.1" fill="url(#halfStarFill)"></polygon>
                                        </svg>
                                    </div>
                                    <div class="text-base font-semibold">4.8</div>
                                </div>
                                <div class="text-xs text-slate-600 mt-2">336 reviews on Google</div>
                            </div>
                        </a>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 text-center">Tap a tile to open the source in a new tab.</p>
                </div>
            <br><br>Do you agree to continue under these terms?`, 
            type: 'multiple-choice', options: ["Yes, I agree and want to continue"], action: () => goToStep('showApiForm') },
            showApiForm: { message: "Excellent! Please complete the secure form below.", type: 'api-form' },
            formSuccess: { message: 'Thank you! Your information has been sent. Watch for a call from a toll free number and check your email for confirmation.', next: 'askForFeedback' },
            askForFeedback: { message: "This is the final step. Please submit your email below to complete the survey.", type: 'brevo-form' },
            complete: { message: "That's everything! Thank you for your valuable feedback. You will now be redirected...", action: () => { 
                const finalUrl = `${CONFIG.PURESPECTRUM_COMPLETE_URL}&transaction_id=${TRANSACTION_ID}`;
                setTimeout(() => { window.location.href = finalUrl; }, 1500); 
            }},
            disqualify: { message: "Based on your responses, this study isn't the right fit. Thank you for your time. Redirecting...", terminate: true }
        };

        function updateProgress(stepKey) { 
            const keys = Object.keys(surveyFlow); 
            progressBar.style.width = `${(keys.indexOf(stepKey) / Math.max(1, keys.length - 1)) * 100}%`; 
        }

        function goToStep(stepKey) {
            const step = surveyFlow[stepKey];
            if (!step) return;

            // Clear bubbles when arriving at the pre-form informational step
            if (stepKey === 'preFormInfo') {
                const bubbles = chatWindow.querySelectorAll('.bubble');
                bubbles.forEach(bubble => bubble.remove());
            }

            updateProgress(stepKey);
            setQuestion(step.message);
            
            const action = step.action || (() => step.next ? goToStep(step.next) : null);

            if (step.terminate) { 
                chatInputArea.innerHTML = `<div class="muted" style="text-align:center">You will be redirected shortly.</div>`; 
                const finalUrl = `${CONFIG.PURESPECTRUM_TERMINATE_URL}&transaction_id=${TRANSACTION_ID}`;
                setTimeout(() => { window.location.href = finalUrl; }, 1500);
                return; 
            }
            
            if (step.type === 'multiple-choice') {
                showOptions(step.options, (val) => { addAnswer(val); action(val); ensureBottom(); }, step.delay || 0);
            } else if (step.type === 'api-form') {
                showApiForm();
            } else if (step.type === 'brevo-form') {
                showBrevoForm(() => goToStep('complete'));
            } else {
                action();
            }
        }

        function showIntro() {
            chatWindow.innerHTML = ''; chatInputArea.innerHTML = '';
            const card = document.createElement('div'); 
            card.className = 'card'; 
            card.style.cssText = 'text-align:center; padding:24px;';
            card.innerHTML = `<div style="width:64px;height:64px;margin:0 auto 16px;border-radius:20px;background:linear-gradient(135deg,#6366f1,#a78bfa,#ec4899);display:grid;place-items:center;color:#fff;font-weight:800;font-size:32px;">C</div><h2 style="margin:0 0 8px 0;font-size:22px;">IRS Tax Relief Research Study</h2><div class="muted" style="font-size:15px;max-width:300px;margin:0 auto 16px;">Help us improve the tax settlement process.</div><ul style="text-align:left;max-width:280px;margin:24px auto;padding-left:20px;font-size:14px;color:var(--sub);list-style-type:'✓  '"><li style="margin-bottom:8px;padding-left:8px;">Answer a few quick questions.</li><li style="margin-bottom:8px;padding-left:8px;">Securely verify your information.</li><li style="margin-bottom:8px;padding-left:8px;">Provide optional feedback.</li></ul><button id="begin-btn" class="cta" style="margin-top:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));">Begin Secure Survey</button>`;
            chatWindow.appendChild(card);
            document.getElementById('begin-btn').onclick = () => { card.remove(); goToStep('start'); };
            ensureBottom();
        }
        
        // --- Main Form Logic & UI ---
        function showApiForm() {
            // Clear previous answers from the chat history to focus on the form.
            const bubbles = chatWindow.querySelectorAll('.bubble');
            bubbles.forEach(bubble => bubble.remove());

            chatInputArea.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'card';
            wrapper.innerHTML = `
                <form id="lead-form" novalidate>
                    <div style="text-align:center">
                        <div class="label">Select Amount Of Tax Debt</div>
                        <div id="debt-amount-display" class="money">$25,000</div>
                        <input id="debt-slider" class="slider" type="range" min="${CONFIG.MIN_DEBT_AMOUNT}" max="100000" value="25000" step="100">
                        <div class="help" id="move-hint">Move the slider or type the exact amount below.</div>
                        <div id="slider-text" class="help hidden"></div>
                        <div class="row" style="margin-top:6px">
                            <label class="label" style="align-self:center">Exact Amount</label>
                            <input id="debt-number" class="field" inputmode="numeric">
                        </div>
                        <input id="f_totaldebt" type="hidden">
                        <div id="qualify-msg" class="help hidden" style="color:#ef4444;">Minimum tax debt is $${CONFIG.MIN_DEBT_AMOUNT.toLocaleString()} to qualify.</div>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <input class="field" name="f_fname" placeholder="First Name" required>
                        <input class="field" name="f_lname" placeholder="Last Name" required>
                    </div>
                    <input class="field" id="email" name="f_email" type="email" placeholder="Email Address" style="margin-top:8px" required>
                    <input class="field" id="phone" name="f_phone" type="tel" placeholder="Phone Number" style="margin-top:8px" required>
                    <div class="otp-row">
                        <button type="button" id="send-otp" class="otp-send">Send Code</button>
                        <div id="otp-verify-box" class="hidden" style="flex:1; display:flex; gap:8px;">
                            <input id="otp-code" class="field otp-code" placeholder="6-digit code">
                            <button type="button" id="check-otp" class="otp-verify">Verify</button>
                        </div>
                        <span id="otp-status" class="badge"></span>
                    </div>
                    <div id="recaptcha-container" style="margin-top:8px;"></div>
                    <select id="state" class="field" name="f_whereyoulive" style="margin-top:8px" required>
                        <option value="" disabled selected>Select Your State</option>
                    </select>
                    <div id="state-error" class="help hidden" style="color:#ef4444;">Unfortunately, this service is not available in your state.</div>
                    <label style="display:flex;gap:8px;margin-top:8px;font-size:12px;color:#334155">
                        <input id="tcpa" name="tcpa" type="checkbox" required>
                        <span>By clicking Submit, you agree to be contacted by our partners (autodial/texts may be used). Consent not required for purchase.</span>
                    </label>
                    <button id="submit-button" class="cta" disabled style="margin-top:10px">Complete All Fields to Submit</button>
                    <div id="form-error" style="color:#b91c1c;text-align:center;font-weight:600;display:none;margin-top:6px"></div>
                </form>`;
            chatWindow.appendChild(wrapper);
            
            // Scroll form into view
            requestAnimationFrame(() => {
                const y = wrapper.offsetTop - qbar.offsetHeight - 8;
                scrollBox.scrollTop = Math.max(0, y);
                updateSticky();
            });

            // --- Attach all event listeners for the newly created form ---
            initializeFormLogic(wrapper); 
        }

        // This function sets up all the logic for the dynamic form
        function initializeFormLogic(formWrapper) {
            const leadForm = formWrapper.querySelector('#lead-form');
            const debtSlider = formWrapper.querySelector('#debt-slider');
            const debtAmountDisplay = formWrapper.querySelector('#debt-amount-display');
            const debtNumber = formWrapper.querySelector('#debt-number');
            const debtHidden = formWrapper.querySelector('#f_totaldebt');
            const qualifyMsg = formWrapper.querySelector('#qualify-msg');
            const stateSelect = formWrapper.querySelector('#state');
            const stateError = formWrapper.querySelector('#state-error');
            const submitButton = formWrapper.querySelector('#submit-button');
            const formError = formWrapper.querySelector('#form-error');
            
            // OTP elements
            const phoneInput = formWrapper.querySelector('#phone');
            const sendBtn = formWrapper.querySelector('#send-otp');
            const verifyBox = formWrapper.querySelector('#otp-verify-box');
            const checkBtn = formWrapper.querySelector('#check-otp');
            const otpCode = formWrapper.querySelector('#otp-code');
            const otpStatus = formWrapper.querySelector('#otp-status');
            const recaptchaContainer = formWrapper.querySelector('#recaptcha-container');

            let clientIp = '';
            let isOtpVerified = false;
            let recaptchaVerifier = null;
            let confirmationResult = null;
            
            // --- Helper functions ---
            const allStates = ["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"];
            allStates.forEach(state => {
                const o = document.createElement('option');
                o.value = state;
                o.textContent = state;
                stateSelect.appendChild(o);
            });

            const fmtMoney = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0}).format(n);
            const toInt = s => { const n = parseInt(String(s||'').replace(/[^\d]/g,''),10); return isNaN(n)?0:n; };
            const digitsOnly = s => String(s||'').replace(/\D+/g,'');
            const toE164US = raw => { const d = digitsOnly(raw); const m = d.match(/^1?([2-9]\d{2})([2-9]\d{2})(\d{4})$/); return m ? `+1${m[1]}${m[2]}${m[3]}` : null; }
            
            // --- IP Capture ---
            fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(j=>{ clientIp = j.ip || ''; }).catch(()=>{ clientIp=''; });

            // --- Form state and submission gating ---
            function updateSubmitEnabled() {
                const amountOK  = toInt(debtHidden.value) >= CONFIG.MIN_DEBT_AMOUNT;
                const stateOK   = stateSelect.value && !CONFIG.EXCLUDED_STATES.includes(stateSelect.value);
                const consentOK = formWrapper.querySelector('#tcpa')?.checked;
                const allFieldsOK = Array.from(leadForm.querySelectorAll('input[required], select[required]')).every(el => el.type === 'checkbox' ? el.checked : !!el.value);

                submitButton.disabled = !(amountOK && stateOK && consentOK && isOtpVerified && allFieldsOK);
                if (isOtpVerified) {
                    submitButton.textContent = submitButton.disabled ? 'Please complete all fields' : 'See My Savings Estimate →';
                } else {
                    submitButton.textContent = 'Verify your phone to continue';
                }
            }

            // --- Debt Slider Logic ---
            function setSliderUI(val) {
                const v = Math.max(0, Math.min(100000, toInt(val)));
                debtSlider.value = String(v);
                debtNumber.value = v.toLocaleString('en-US');
                debtAmountDisplay.textContent = v >= 100000 ? `${fmtMoney(v)}+` : fmtMoney(v);
                debtHidden.value = String(v);
                qualifyMsg.classList.toggle('hidden', v >= CONFIG.MIN_DEBT_AMOUNT);
                updateSubmitEnabled();
            }
            debtSlider.addEventListener('input', e => setSliderUI(e.target.value));
            debtNumber.addEventListener('input', e => setSliderUI(e.target.value));
            debtNumber.addEventListener('blur', () => { debtNumber.value = toInt(debtNumber.value).toLocaleString('en-US'); });
            setSliderUI(prefillDebtAmount || 25000);

            // --- OTP Logic ---
            function setupRecaptcha() {
                if (!recaptchaVerifier) {
                     recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaContainer, { size: "invisible" });
                }
            }
            
            sendBtn.addEventListener('click', async () => {
                const e164 = toE164US(phoneInput.value);
                verifyBox.classList.remove('hidden');
                if(!e164){ otpStatus.textContent = 'Enter a valid US number.'; return; }
                otpStatus.textContent = 'Sending code…';
                try {
                    setupRecaptcha();
                    confirmationResult = await signInWithPhoneNumber(auth, e164, recaptchaVerifier);
                    otpStatus.textContent = 'Code sent. Check SMS.';
                } catch(e) {
                    console.error('OTP send error:', e);
                    otpStatus.textContent = `Failed: ${e.code || 'unknown'}`;
                    if (window.grecaptcha && recaptchaVerifier) {
                        recaptchaVerifier.render().then(widgetId => grecaptcha.reset(widgetId));
                    }
                }
            });

            checkBtn.addEventListener('click', async () => {
                const code = (otpCode.value||'').trim();
                if(!confirmationResult) { otpStatus.textContent='Click “Send code” first.'; return; }
                if(code.length !== 6) { otpStatus.textContent='Enter the 6-digit code.'; return; }
                otpStatus.textContent='Verifying…';
                try {
                    await confirmationResult.confirm(code);
                    isOtpVerified = true;
                    otpStatus.textContent='Verified ✓';
                    otpStatus.style.color = '#166534';
                    updateSubmitEnabled();
                } catch(e) {
                    isOtpVerified = false;
                    console.error('OTP verify error:', e);
                    otpStatus.textContent='Verification failed. Try again.';
                    otpStatus.style.color = '#b91c1c';
                    updateSubmitEnabled();
                }
            });
            
            // Re-validate if phone changes
            phoneInput.addEventListener('input', () => { isOtpVerified = false; otpStatus.textContent=''; updateSubmitEnabled(); });

            // Attach listeners to all fields for live validation/gating
            leadForm.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', updateSubmitEnabled);
                el.addEventListener('input', updateSubmitEnabled);
            });
            stateSelect.addEventListener('change', () => {
                stateError.classList.toggle('hidden', !CONFIG.EXCLUDED_STATES.includes(stateSelect.value));
            });

            // --- Form Submission ---
            leadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (submitButton.disabled) return;
                
                formError.classList.add('hidden');
                submitButton.disabled = true; 
                submitButton.textContent='Submitting…';

                const formData = new FormData(leadForm);
                const leadData = {};
                formData.forEach((value, key) => leadData[key] = value);
                const debtAmount = toInt(debtHidden.value);
                
                // Populate Form 1 (CuraDebt)
                const form1 = document.getElementById('hidden-lead-form-1');
                form1.action = CONFIG.LEAD_POST_URL_1;
                form1.elements['f_fname'].value = leadData.f_fname || '';
                form1.elements['f_lname'].value = leadData.f_lname || '';
                form1.elements['f_email'].value = leadData.f_email || '';
                form1.elements['f_phone'].value = digitsOnly(leadData.f_phone);
                form1.elements['f_whereyoulive'].value = leadData.f_whereyoulive || '';
                form1.elements['f_totaldebt'].value = `${String(debtAmount)} (tax)`;
                form1.elements['data1'].value = TRANSACTION_ID || URL_PARAMS.get('data1') || URL_PARAMS.get('gclid') || 'N/A';
                form1.elements['f_ip'].value = clientIp;

                // Populate Form 2 (TrackDrive)
                const form2 = document.getElementById('hidden-lead-form-2');
                form2.action = CONFIG.LEAD_POST_URL_2;
                form2.elements['campaign_id'].value = CONFIG.TRACKDRIVE_CAMPAIGN_ID;
                form2.elements['caller_id'].value = toE164US(leadData.f_phone);
                form2.elements['first_name'].value = leadData.f_fname || '';
                form2.elements['last_name'].value = leadData.f_lname || '';
                form2.elements['email'].value = leadData.f_email || '';
                form2.elements['state'].value = leadData.f_whereyoulive || '';
                form2.elements['unsecured_debt_total'].value = `${String(debtAmount)} (tax)`;
                form2.elements['ip_address'].value = clientIp;
                form2.elements['useragent'].value = navigator.userAgent;
                form2.elements['gclid'].value = URL_PARAMS.get('gclid') || '';
                form2.elements['fbeventid'].value = URL_PARAMS.get('fbclid') || '';
                form2.elements['msclkid'].value = URL_PARAMS.get('msclkid') || '';
                form2.elements['tcpa_opt_in'].value = 'true';
                form2.elements['tcpa_optin_consent_language'].value = formWrapper.querySelector('#tcpa + span')?.innerText || 'TCPA consent captured';
                form2.elements['otp_verified'].value = '1';

                try {
                    // Submit the first form, then the second after a brief delay.
                    // This prevents the second submission from interrupting the first.
                    form1.submit();
                    setTimeout(() => {
                        form2.submit();
                    }, 100);

                    goToStep('formSuccess');
                } catch(err) {
                    console.error('Submission failed:', err);
                    formError.textContent = 'An error occurred during submission. Please try again.';
                    formError.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.textContent = 'See My Savings Estimate →';
                }
            });
        }
        
        // --- Brevo Feedback Form (Updated Logic) ---
        function showBrevoForm(onContinue) {
            const bubbles = chatWindow.querySelectorAll('.bubble');
            bubbles.forEach(bubble => bubble.remove());
            chatInputArea.innerHTML = '';
            
            const box = document.createElement('div');
            box.className = 'card';
            
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'width: 100%; height: 520px; border: none;';
            
            const continueBtn = document.createElement('button');
            continueBtn.className = 'cta';
            continueBtn.style.marginTop = '10px';
            continueBtn.textContent = 'I have submitted my feedback';
            continueBtn.disabled = true;

            const brevoFormHTML = `
                <html><head>
                <style>
                    @font-face { font-display: block; font-family: Roboto; src: url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/7529907e9eaf8ebb5220c5f9850e3811.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/25c678feafdc175a70922a116c9be3e7.woff) format("woff") }
                    @font-face { font-display: fallback; font-family: Roboto; font-weight: 600; src: url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/6e9caeeafb1f3491be3e32744bc30440.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/71501f0d8d5aa95960f6475d5487d4c2.woff) format("woff") }
                    @font-face { font-display: fallback; font-family: Roboto; font-weight: 700; src: url(https://assets.brevo.com/font/Roboto/Latin/bold/normal/3ef7cf158f310cf752d5ad08cd0e7e60.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/bold/normal/ece3a1d82f18b60bcce0211725c476aa.woff) format("woff") }
                    #sib-container input:-ms-input-placeholder { text-align: left; font-family: Helvetica, sans-serif; color: #c0ccda; }
                    #sib-container input::placeholder { text-align: left; font-family: Helvetica, sans-serif; color: #c0ccda; }
                    body { margin: 0; }
                </style>
                <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">
                </head><body>
                <div class="sib-form" style="text-align: center; background-color: #FFF;">
                    <div id="sib-form-container" class="sib-form-container">
                         <div id="success-message" class="sib-form-message-panel" style="font-size:16px; text-align:left; font-family:Helvetica, sans-serif; color:#085229; background-color:#e7faf0; border-radius:3px; border-color:#13ce66;max-width:540px; display:none;">
                             <div class="sib-form-message-panel__text sib-form-message-panel__text--center">
                                 <svg viewBox="0 0 512 512" class="sib-icon sib-notification__icon"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 464c-118.664 0-216-96.055-216-216 0-118.663 96.055-216 216-216 118.664 0 216 96.055 216 216 0 118.663-96.055 216-216 216zm141.63-274.961L217.15 376.071c-4.705 4.667-12.303 4.637-16.97-.068l-85.878-86.572c-4.667-4.705-4.637-12.303.068-16.97l8.52-8.451c4.705-4.667 12.303-4.637 16.97.068l68.976 69.533 163.441-162.13c4.705-4.667 12.303-4.637 16.97.068l8.451 8.52c4.668 4.705 4.637 12.303-.068 16.97z" /></svg>
                                 <span class="sib-form-message-panel__inner-text">Your subscription has been successful.</span>
                             </div>
                         </div>
                         <div id="sib-container" class="sib-container--large sib-container--vertical" style="text-align:center; background-color:rgba(255,255,255,1); max-width:540px; border-radius:3px; border-width:0px;">
                            <form id="sib-form" method="POST" action="${CONFIG.BREVO_FORM_URL}" data-type="subscription">
                                <div style="padding: 8px 0;"><div class="sib-form-block" style="font-size:32px; text-align:left; font-weight:700; font-family:Helvetica, sans-serif; color:#3C4858;"><p>Survey Feedback</p></div></div>
                                <div style="padding: 8px 0;"><div class="sib-form-block" style="font-size:16px; text-align:left; font-family:Helvetica, sans-serif; color:#3C4858;"><div class="sib-text-form-block"><p>Please provide your email to receive a reminder for the feedback of the survey</p></div></div></div>
                                <div style="padding: 8px 0;"><div class="sib-input sib-form-block"><div class="form__entry entry_block"><div class="form__label-row "><label class="entry__label" style="font-weight: 700; font-size:16px; color:#3c4858;" for="EMAIL" data-required="*">Enter your email address</label><div class="entry__field"><input class="input " type="text" id="EMAIL" name="EMAIL" autocomplete="off" placeholder="EMAIL" data-required="true" required /></div></div><label class="entry__error entry__error--primary"></label></div></div></div>
                                <div style="padding: 8px 0;"><div class="sib-form-block" style="text-align: left"><button id="brevo-submit-btn" class="sib-form-block__button sib-form-block__button-with-loader" style="font-size:16px; font-weight:700; font-family:Helvetica, sans-serif; color:#FFFFFF; background-color:#3E4857; border-radius:3px; border-width:0px;" form="sib-form" type="submit">SUBMIT</button></div></div>
                            </form>
                        </div>
                    </div>
                </div>
                <script src="https://sibforms.com/forms/end-form/build/main.js"><\/script>
                </body></html>`;

            box.appendChild(iframe);
            chatWindow.appendChild(box);
            chatInputArea.appendChild(continueBtn);
            addAbandon(chatInputArea);

            iframe.srcdoc = brevoFormHTML;

            function onFormSubmitAttempt() {
                continueBtn.disabled = false;
                continueBtn.textContent = 'Click Here to Complete the Survey';
                box.innerHTML = `<div style="text-align: center; padding: 20px;"><p style="font-size: 18px; color: #333;">Thank you! Please click the button below to finish.</p></div>`;
            }

            continueBtn.addEventListener('click', () => {
                chatInputArea.innerHTML = ''; // Clear buttons
                onContinue();
            });

            iframe.onload = () => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const submitButton = iframeDoc.getElementById('brevo-submit-btn');
                    const emailInput = iframeDoc.getElementById('EMAIL');
                    if (submitButton && emailInput) {
                        submitButton.addEventListener('click', () => {
                            const emailValue = emailInput.value.trim();
                            if (emailValue && emailValue.includes('@')) {
                                setTimeout(onFormSubmitAttempt, 100);
                            }
                        });
                    }
                } catch (e) {
                    console.error("Error accessing iframe for Brevo form:", e);
                }
            };
            ensureBottom();
        }

        // --- Initial Load ---
        showIntro();

    </script>
</body>
</html>


