<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mobile App Feedback Survey</title>

  <!-- Tailwind (optional, for styling) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ Tesseract.js (latest major v6) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@6/dist/tesseract.min.js"></script>

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .card { border:1px solid rgb(226 232 240); border-radius: 18px; background:#fff; }
    .mono { font-variant-numeric: tabular-nums; }
    .btn { border-radius: 12px; padding: 10px 14px; font-weight: 600; }
    .btn-primary { background:#111827; color:#fff; }
    .btn-secondary { background:#f3f4f6; color:#111827; }
    .small { font-size: 12px; color: #6b7280; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <main class="max-w-xl mx-auto p-4 sm:p-6">
    <div class="card p-5 sm:p-6 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h1 class="text-lg font-semibold">Quick App Feedback Survey</h1>
          <p class="text-sm text-slate-600 mt-1">
            This survey would like your feedback on an app. To take part, you‚Äôll need to use your mobile phone to download a mobile app.
          </p>
        </div>
        <div class="text-xs text-slate-500 mono" id="txBox"></div>
      </div>

      <!-- Status banner -->
      <div id="banner" class="mt-4 hidden rounded-xl border p-3 text-sm"></div>

      <!-- Step container -->
      <div id="stepWrap" class="mt-5 space-y-6">

        <!-- STEP 0: Auto device check -->
        <div id="autoCheck" class="rounded-xl border border-slate-200 p-4">
          <div class="flex items-start gap-3">
            <div class="mt-0.5">üì±</div>
            <div>
              <div class="font-semibold">Device check</div>
              <div class="text-sm text-slate-600 mt-1">
                We are verifying device eligibility. This study is <b>iOS only</b> (iPhone / iPad).
              </div>

              <div class="mt-2 text-xs text-slate-500 mono space-y-1">
                <div id="envLine"></div>
                <div id="uaInfo"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- STEP 1: Q1 Device question -->
        <div id="q1" class="space-y-3 hidden">
          <div class="font-semibold">1) What device are you using right now?</div>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="device" value="ios" id="devIOS" />
              <span>iPhone / iPad (iOS)</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="device" value="android" id="devAndroid" />
              <span>Android phone / tablet</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="device" value="desktop" id="devDesktop" />
              <span>Desktop / Laptop</span>
            </label>
          </div>

          <div class="flex gap-2 pt-2">
            <button class="btn btn-primary" id="q1Next">Next</button>
          </div>

          <div class="small">
            Note: This study is <b>iOS only</b>. Android and Desktop/Laptop will be disqualified.
          </div>
        </div>

        <!-- STEP 2: Consent screener -->
        <div id="q2" class="space-y-3 hidden">
          <div class="font-semibold">
            2) This survey would like your feedback on a new app. To take part, you'll need to use your mobile phone to download a mobile app. Are you willing to participate?
          </div>
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="consent" value="yes" />
              <span>Yes</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-200 hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="consent" value="no" />
              <span>No</span>
            </label>
          </div>
          <div class="flex gap-2 pt-2">
            <button class="btn btn-secondary" id="q2Back">Back</button>
            <button class="btn btn-primary" id="q2Next">Next</button>
          </div>
        </div>

        <!-- STEP 3: Open link + instructions -->
        <div id="task" class="space-y-3 hidden">
          <div class="font-semibold">3) Download & test the app</div>
          <div class="text-sm text-slate-600">
            Tap the button below to open the link in a new tab. Follow the instructions there to download the app.
            When you finish, come back to this page.
          </div>

          <div class="rounded-xl border border-slate-200 p-4 bg-slate-50">
            <div class="font-semibold text-sm">Proof of completion</div>
            <ul class="list-disc pl-5 text-sm text-slate-700 mt-2 space-y-1">
              <li>After installing, take a screenshot showing the app on your Home Screen.</li>
              <li>The app name must be visible: <b>OpenVPN</b>.</li>
              <li>Upload that screenshot on the next step for verification.</li>
            </ul>
          </div>

          <div class="flex flex-wrap gap-2 pt-1">
            <a
              id="openLinkBtn"
              class="btn btn-primary inline-flex items-center gap-2"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
            >
              Open the link
              <span aria-hidden="true">‚Üó</span>
            </a>
            <button class="btn btn-secondary" id="taskNext">I‚Äôm done ‚Äî upload proof</button>
          </div>

          <div class="small">
            If the proof screenshot can‚Äôt be verified, you may be disqualified.
          </div>
        </div>

        <!-- STEP 4: Upload + OCR -->
        <div id="upload" class="space-y-3 hidden">
          <div class="font-semibold">4) Upload your Home Screen screenshot (must show ‚ÄúOpenVPN‚Äù)</div>

          <input id="file" type="file" accept="image/*" class="block w-full text-sm" />

          <div class="rounded-xl border border-slate-200 p-4">
            <div class="text-sm text-slate-700">
              OCR will check your screenshot for the word: <b>openvpn</b>
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button class="btn btn-primary" id="verifyBtn">Verify screenshot</button>
              <button class="btn btn-secondary" id="uploadBack">Back</button>
            </div>

            <div id="ocrStatus" class="mt-3 text-sm text-slate-600"></div>
            <div class="mt-2 small mono" id="attemptsBox"></div>
          </div>

          <div class="small">
            Tip: Make sure the app name is clearly visible in the screenshot (not cropped).
          </div>
        </div>

        <!-- STEP 5: Finish -->
        <div id="finish" class="space-y-3 hidden">
          <div class="font-semibold">All set</div>
          <div class="text-sm text-slate-600">
            Verification passed. Click finish to submit.
          </div>
          <div class="flex gap-2 pt-2">
            <button class="btn btn-primary" id="finishBtn">Finish</button>
          </div>
        </div>

      </div>
    </div>

    <p class="small mt-4 text-center">
      iOS only ‚Ä¢ Desktop/Android disqualify automatically
    </p>
  </main>

<script>
  // ========= CONFIG =========
  const SURVEY_LINK = "https://data527.click/d96ed81366e2820b1e47/bc5a542fa7/?placementName=default";

  // PureSpectrum redirect URLs:
  const COMPLETE_URL_BASE = "https://spectrumsurveys.com/surveydone?st=21&transaction_id="; // complete
  const DISQUAL_URL_BASE  = "https://spectrumsurveys.com/surveydone?st=18&transaction_id="; // disqualify

  const REQUIRED_WORD = "openvpn";
  const MAX_FAILS = 3;

  // ========= HELPERS =========
  const $ = (id) => document.getElementById(id);

  function getTx() {
    const u = new URL(window.location.href);
    return u.searchParams.get("transaction_id")
        || u.searchParams.get("tid")
        || u.searchParams.get("tx")
        || "";
  }

  function showBanner(type, msg) {
    const b = $("banner");
    b.classList.remove("hidden");
    b.textContent = msg;

    b.className = "mt-4 rounded-xl border p-3 text-sm";
    if (type === "disqualify") b.classList.add("border-red-200","bg-red-50","text-red-800");
    else if (type === "ok")    b.classList.add("border-emerald-200","bg-emerald-50","text-emerald-800");
    else                       b.classList.add("border-slate-200","bg-slate-50","text-slate-700");
  }

  function showStep(stepId) {
    ["autoCheck","q1","q2","task","upload","finish"].forEach(id => $(id).classList.add("hidden"));
    $(stepId).classList.remove("hidden");
  }

  function goDisqualify(reason) {
    showBanner("disqualify", reason || "You are not eligible for this study.");
    const tx = getTx();
    window.location.href = DISQUAL_URL_BASE + encodeURIComponent(tx);
  }

  function goComplete() {
    const tx = getTx();
    window.location.href = COMPLETE_URL_BASE + encodeURIComponent(tx);
  }

  // ========= DEVICE DETECTION (AUTO) =========
  function detectEnvironment() {
    const ua = (navigator.userAgent || "").toLowerCase();
    const platform = (navigator.platform || "").toLowerCase();

    // iPadOS can identify as Mac; detect by touch points.
    const isIPadOS = (platform.includes("mac") && navigator.maxTouchPoints && navigator.maxTouchPoints > 1);

    const isIOS = /iphone|ipad|ipod/.test(ua) || isIPadOS;
    const isAndroid = /android/.test(ua);

    // Desktop-like if neither iOS nor Android.
    const isDesktopLike = (!isIOS && !isAndroid);

    return { isIOS, isAndroid, isDesktopLike, ua, platform, isIPadOS };
  }

  // extra ‚Äúguard‚Äù you asked for: run the device check not just on load,
  // but ALSO whenever user tries to continue (Q1/Q2/Task/Upload/Finish).
  function enforceIOSOrDisqualify() {
    const env = detectEnvironment();
    if (env.isAndroid) {
      goDisqualify("Disqualified: Android devices are not eligible. This study is iOS only.");
      return false;
    }
    if (env.isDesktopLike && !env.isIOS) {
      goDisqualify("Disqualified: Desktop/Laptop devices are not eligible. Please use an iPhone or iPad.");
      return false;
    }
    // Must be iOS
    if (!env.isIOS) {
      goDisqualify("Disqualified: This study is iOS only (iPhone/iPad).");
      return false;
    }
    return true;
  }

  // ========= STATE =========
  let fails = 0;

  // ========= INIT =========
  (function init() {
    $("openLinkBtn").href = SURVEY_LINK;

    const tx = getTx();
    $("txBox").textContent = tx ? `transaction_id: ${tx}` : "";

    const env = detectEnvironment();
    $("envLine").textContent = `Detected: ${env.isIOS ? "iOS" : env.isAndroid ? "Android" : "Desktop/Other"}${env.isIPadOS ? " (iPadOS)" : ""}`;
    $("uaInfo").textContent = `UA: ${env.ua}`;

    // Auto-disqualify immediately if not iOS
    if (!enforceIOSOrDisqualify()) return;

    // If iOS, auto-select iOS on Q1 (still shows the question as you wanted)
    $("devIOS").checked = true;

    // Optional: you can disable Android/Desktop choices since you only allow iOS
    // (keeps the question but prevents wrong selections)
    $("devAndroid").disabled = true;
    $("devDesktop").disabled = true;

    showBanner("ok", "Eligible device detected (iOS). Please answer the questions below.");
    showStep("q1");
  })();

  // ========= Q1 logic =========
  $("q1Next").addEventListener("click", () => {
    // Re-check device right here too
    if (!enforceIOSOrDisqualify()) return;

    const sel = document.querySelector('input[name="device"]:checked');
    if (!sel) { showBanner("info", "Please select your device."); return; }

    // Even if they somehow select wrong, disqualify
    if (sel.value === "desktop") return goDisqualify("Disqualified: Desktop/Laptop devices are not eligible. Please use an iPhone or iPad.");
    if (sel.value === "android") return goDisqualify("Disqualified: Android devices are not eligible. This study is iOS only.");

    showStep("q2");
  });

  // ========= Q2 logic =========
  $("q2Back").addEventListener("click", () => {
    if (!enforceIOSOrDisqualify()) return;
    showStep("q1");
  });

  $("q2Next").addEventListener("click", () => {
    if (!enforceIOSOrDisqualify()) return;

    const sel = document.querySelector('input[name="consent"]:checked');
    if (!sel) { showBanner("info", "Please answer the consent question."); return; }
    if (sel.value === "no") {
      goDisqualify("Disqualified: You selected that you are not willing to participate.");
      return;
    }
    showStep("task");
  });

  // ========= Task logic =========
  $("taskNext").addEventListener("click", () => {
    if (!enforceIOSOrDisqualify()) return;
    showStep("upload");
  });

  // ========= Upload logic =========
  $("uploadBack").addEventListener("click", () => {
    if (!enforceIOSOrDisqualify()) return;
    showStep("task");
  });

  function normalizeText(t) {
    return (t || "")
      .toLowerCase()
      .replace(/[^\w\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function setOCRStatus(msg) {
    $("ocrStatus").textContent = msg;
    $("attemptsBox").textContent = `Failed attempts: ${fails} / ${MAX_FAILS}`;
  }

  $("verifyBtn").addEventListener("click", async () => {
    if (!enforceIOSOrDisqualify()) return;

    const file = $("file").files && $("file").files[0];
    if (!file) { setOCRStatus("Please choose an image first."); return; }

    if (file.size > 12 * 1024 * 1024) {
      setOCRStatus("That image is quite large. Please upload a smaller screenshot (under 12MB).");
      return;
    }

    setOCRStatus("Reading screenshot‚Ä¶");

    try {
      const { data } = await Tesseract.recognize(file, "eng", {
        logger: (m) => {
          if (m.status === "recognizing text" && typeof m.progress === "number") {
            const pct = Math.round(m.progress * 100);
            setOCRStatus(`OCR in progress‚Ä¶ ${pct}%`);
          }
        }
      });

      const raw = data && data.text ? data.text : "";
      const text = normalizeText(raw);

      if (text.includes(REQUIRED_WORD)) {
        showBanner("ok", "‚úÖ Verified: ‚ÄúOpenVPN‚Äù detected in your screenshot.");
        showStep("finish");
        return;
      }

      fails += 1;
      if (fails >= MAX_FAILS) {
        goDisqualify("Disqualified: We could not verify the required proof screenshot after multiple attempts.");
        return;
      }

      setOCRStatus(`Not verified: we could not detect ‚Äú${REQUIRED_WORD}‚Äù. Please upload a clearer Home Screen screenshot showing the app name.`);
    } catch (err) {
      fails += 1;
      if (fails >= MAX_FAILS) {
        goDisqualify("Disqualified: Verification failed multiple times.");
        return;
      }
      setOCRStatus("OCR error occurred. Please try again with a clearer screenshot.");
      console.error(err);
    }
  });

  // ========= Finish =========
  $("finishBtn").addEventListener("click", () => {
    if (!enforceIOSOrDisqualify()) return;
    goComplete();
  });
</script>
</body>
</html>
