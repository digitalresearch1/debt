<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Survey</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    input[type="radio"] { width: 16px; height: 16px; }
  </style>
</head>

<body class="bg-white text-slate-900">
<main class="max-w-md mx-auto px-4 py-10">

  <!-- PAGE 1 -->
  <section class="page space-y-4">
    <p class="text-base font-semibold">Which device are you using right now?</p>
    <label class="flex gap-2"><input type="radio" name="q_device" value="iphone"> iPhone</label>
    <label class="flex gap-2"><input type="radio" name="q_device" value="ipad"> iPad</label>
    <label class="flex gap-2"><input type="radio" name="q_device" value="other"> Other / Not sure</label>
  </section>

  <!-- PAGE 2 -->
  <section class="page hidden space-y-4">
    <p class="text-base font-semibold">Have you ever used TikTok before on this device or Apple ID?</p>
    <label class="flex gap-2"><input type="radio" name="q_new" value="never"> No — never</label>
    <label class="flex gap-2"><input type="radio" name="q_new" value="used"> Yes — I have</label>
  </section>

  <!-- PAGE 3 (COMBINED ACTION PAGE) -->
  <section class="page hidden space-y-5 border-t pt-6">

    <p class="text-sm text-slate-700">
     This study is for participants who pay close attention to instructions.
      We automatically verify whether the required in-app activity was completed
      before allowing the survey to continue.
    </p>

    <p class="text-base font-semibold">
      Click the button below to download the app.
      You will be taken to the App Store to install it.
      After installing, open the app, complete the sign-up, and spend about one minute using it.
      Then return to this page and continue.
    </p>

    <label class="flex gap-2 text-sm">
      <input type="radio" name="q_ready" value="yes">
      OK — I understand and will do this now
    </label>
    <label class="flex gap-2 text-sm">
      <input type="radio" name="q_ready" value="no">
      No
    </label>

    <button id="btnOpen"
      class="w-full rounded-lg px-4 py-2.5 text-sm font-semibold bg-slate-900 text-white disabled:opacity-40"
      disabled>
      Click to download
    </button>

    <button id="btnContinue"
      class="w-full rounded-lg px-4 py-2.5 text-sm font-semibold bg-indigo-600 text-white disabled:opacity-40"
      disabled>
      Continue
    </button>

    <p id="hint" class="text-xs text-slate-500"></p>
  </section>

</main>

<script>
const OFFER_BASE_URL = "https://smrturl.co/a/scd13071c18/86?s1=";
const WORKER_BASE = "https://adblue.kayembakasongo.workers.dev";

const COMPLETE_URL = rid =>
  `https://spectrumsurveys.com/surveydone?st=21&transaction_id=${encodeURIComponent(rid)}`;
const SCREENOUT_URL = rid =>
  `https://spectrumsurveys.com/surveydone?st=18&transaction_id=${encodeURIComponent(rid)}`;

const MIN_WAIT_MS = 60 * 1000;

const qp = new URLSearchParams(location.search);
let rid = qp.get("RID") || qp.get("transaction_id") || qp.get("s1");
if (!rid) rid = "tx_" + Date.now().toString(36);
sessionStorage.setItem("RID", rid);

const offerUrl = OFFER_BASE_URL + encodeURIComponent(rid);

const pages = document.querySelectorAll(".page");
let current = 0;
function showPage(i){ pages.forEach((p,idx)=>p.classList.toggle("hidden",idx!==i)); current=i;}
showPage(0);

function getVal(n){const e=document.querySelector(`input[name="${n}"]:checked`);return e?e.value:null;}
function screenout(){location.href=SCREENOUT_URL(rid);}

document.querySelectorAll('input[type="radio"]').forEach(r=>{
  r.addEventListener("change",()=>{
    if(getVal("q_device")==="other") screenout();
    if(getVal("q_new")==="used") screenout();
    if(getVal("q_ready")==="no") screenout();

    if(current===0 && getVal("q_device")) showPage(1);
    else if(current===1 && getVal("q_new")) showPage(2);

    check();
  });
});

const btnOpen=document.getElementById("btnOpen");
const btnContinue=document.getElementById("btnContinue");
const hint=document.getElementById("hint");

let opened=false, openedAt=0;

function check(){
  const eligible = (["iphone","ipad"].includes(getVal("q_device")))
    && getVal("q_new")==="never"
    && getVal("q_ready")==="yes";

  btnOpen.disabled=!eligible;
  btnContinue.disabled=!(eligible && opened && Date.now()-openedAt>=MIN_WAIT_MS);

  if(!eligible) hint.textContent="";
  else if(!opened) hint.textContent="Click “Click to download” to open the App Store.";
  else hint.textContent="Return after completing the task, then click Continue.";
}

btnOpen.onclick=()=>{
  window.open(offerUrl,"_blank","noopener,noreferrer");
  opened=true; openedAt=Date.now();
  check();
};

btnContinue.onclick=async()=>{
  const r=await fetch(`${WORKER_BASE}/status?s1=${encodeURIComponent(rid)}`,{cache:"no-store"});
  const j=await r.json();
  location.href = j && j.converted ? COMPLETE_URL(rid) : SCREENOUT_URL(rid);
};
</script>
</body>
</html>

