<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chloe — Debt Relief Survey (Full • Original Buttons)</title>
  <style>
    :root{
      --bg:#f6f7fb; --ink:#0f172a; --sub:#475569; --ring:#e2e8f0; --card:#ffffff;
      --grad1:#6366f1; --grad2:#8b5cf6; --grad3:#ec4899; /* brand accents */
      --cta1:#6366f1; --cta2:#8b5cf6; /* ORIGINAL CTA: indigo→violet */
      /* If you ever want green CTA, change to: --cta1:#10b981; --cta2:#14b8a6 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .frame{display:flex;flex-direction:column;min-height:100vh;background:var(--card)}
    header{padding:14px 20px;background:linear-gradient(#fff,#ffffffb0);border-bottom:1px solid rgba(0,0,0,.06)}
    header .title{font-weight:700}
    .progress-wrap{padding:8px 20px 6px}
    .progress{height:8px;border-radius:9999px;background:#e5e7eb;overflow:hidden}
    .progress>div{height:8px;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));transition:width .5s}
    .scroll-area{position:relative;flex:1;overflow:hidden}
    #scroll-box{position:absolute;inset:0;overflow-y:auto}

    #question-bar{background:linear-gradient(135deg,#f5f3ff,#eef2ff);border-bottom:1px solid var(--ring);padding:16px 20px;box-shadow:0 4px 12px rgba(15,23,42,.04)}
    .q-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--grad1);font-weight:700}
    #q-text{font-size:16px;font-weight:500;color:#1e293b;line-height:1.5}

    .history{padding:10px 16px 20px}
    .card{background:#fff;border:1px solid var(--ring);border-radius:18px;padding:16px;max-width:640px;margin:0 auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#fff}
    .label{font-size:12px;color:#475569}
    .help{font-size:12px;color:#64748b;margin:8px 0}
    .hidden{display:none}
    .money{font-size:36px;font-weight:800;background:linear-gradient(90deg,#4f46e5,#a78bfa,#ec4899);-webkit-background-clip:text;background-clip:text;color:transparent;margin:6px 0}
    .slider{width:100%;touch-action:pan-y;pointer-events:auto;position:relative;z-index:10;-webkit-appearance:none;appearance:none;background:transparent;height:34px}
    .slider::-webkit-slider-runnable-track{height:8px;background:#d1d5db;border-radius:999px}
    .slider::-moz-range-track{height:8px;background:#d1d5db;border-radius:999px}
    .slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:linear-gradient(135deg,var(--grad1),var(--grad2));border:3px solid #fff;border-radius:50%;margin-top:-7px;box-shadow:0 6px 18px rgba(99,102,241,.35)}
    .slider::-moz-range-thumb{width:22px;height:22px;background:linear-gradient(135deg,var(--grad1),var(--grad2));border:3px solid #fff;border-radius:50%;box-shadow:0 6px 18px rgba(99,102,241,.35)}
    .cta{padding:12px 14px;width:100%;border:none;border-radius:12px;font-weight:700;color:#fff;background:linear-gradient(90deg,var(--cta1),var(--cta2));cursor:pointer}
    .cta[disabled]{opacity:.6;cursor:not-allowed}
    .notice{font-size:12px;color:#166534;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:8px;padding:6px 8px;margin-top:6px;display:none}
    .otp-row{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .otp-send,.otp-verify{padding:10px 12px;border:none;border-radius:12px;font-weight:700;color:#fff}
    .otp-send{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
    .otp-verify{background:linear-gradient(90deg,#10b981,#059669)}
    .otp-code{flex:1;min-width:140px;max-width:220px}
    .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-left:6px}
    footer{padding:12px 16px;background:linear-gradient(0deg,#fff,#ffffffb0);border-top:1px solid rgba(0,0,0,.06)}
    .abandon{display:block;margin:8px auto 0;color:#e11d48;background:none;border:none;font-size:12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="frame">
    <header>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#6366f1,#a78bfa,#ec4899);display:grid;place-items:center;color:#fff;font-weight:800">C</div>
        <div style="flex:1">
          <div class="title">Chloe</div>
          <div class="help" style="margin:0">AI Research Assistant · Debt Settlement Study</div>
        </div>
        <div class="help">Secure</div>
      </div>
    </header>

    <div class="progress-wrap"><div class="progress"><div id="progress-bar"></div></div></div>

    <div class="scroll-area">
      <div id="scroll-box">
        <div id="question-bar">
          <div class="q-label">Question</div>
          <div id="q-text"></div>
        </div>
        <div class="history" id="chat-window"><div class="spacer"></div></div>
      </div>
    </div>

    <footer id="chat-input-area"></footer>
  </div>

  <div id="recaptcha-container" style="display:none"></div>

  <script type="module">
    /***********************
     * PREVIEW vs PRODUCTION
     * - Add ?preview=1 to simulate OTP without Firebase
     ***********************/
    const PREVIEW_MODE = new URLSearchParams(location.search).has('preview');

    // ---- Firebase config (replace with real keys) ----
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };

    // Lazy-load Firebase only when not in preview
    let fb = null;
    if (!PREVIEW_MODE) {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const { getAuth, RecaptchaVerifier, signInWithPhoneNumber } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        fb = { app, auth, RecaptchaVerifier, signInWithPhoneNumber };
      } catch (err) {
        console.warn('Firebase SDK failed to load. Using preview mode.', err);
      }
    }

    // DOM refs
    const scrollBox = document.getElementById('scroll-box');
    const chatWindow = document.getElementById('chat-window');
    const chatInputArea = document.getElementById('chat-input-area');
    const progressBar = document.getElementById('progress-bar');
    const qbar = document.getElementById('question-bar');
    const qtext = document.getElementById('q-text');

    function isAtBottom(){ return scrollBox.scrollHeight - (scrollBox.scrollTop + scrollBox.clientHeight) < 16; }
    function updateSticky(){ const stick=isAtBottom(); qbar.style.position = stick? 'sticky':'relative'; qbar.style.top = stick? '0':'auto'; }
    scrollBox.addEventListener('scroll', updateSticky);
    function ensureBottom(){ requestAnimationFrame(()=>{ scrollBox.scrollTop = scrollBox.scrollHeight; updateSticky(); }); }

    function createBaseContainer(){ chatInputArea.innerHTML=''; const c=document.createElement('div'); return chatInputArea.appendChild(c); }
    function setQuestion(html){ qtext.innerHTML = html || ''; }
    function addAnswer(text){ const el=document.createElement('div'); el.className='bubble'; const b=document.createElement('div'); b.textContent=text; el.appendChild(b); chatWindow.appendChild(el); }
    function addAbandon(container){ const a=document.createElement('button'); a.className='abandon'; a.textContent='Abandon Survey'; a.onclick=()=> goToStep('leaveSurvey'); container.appendChild(a); }

    // ===== Full Survey Flow =====
    let prefillDebtAmount=null; let transactionId='tx_'+Date.now();
    const surveyFlow = {
      start: { message: "Hello! I'm Chloe, an AI assistant for a research study. We're gathering feedback from people to better understand the debt settlement process. Would you be willing to participate?", type:'multiple-choice', options:["Yes, I'll participate","No, thank you"], action:(a)=> a.startsWith('Yes')? goToStep('qDebtRange'): goToStep('leaveSurvey') },
      leaveSurvey: { message: 'No problem at all. Thank you for your time. You will now be redirected.', end:true, status:18 },
      qDebtRange: { message:'About how much unsecured debt do you have? (credit cards, personal loans, medical bills, etc.)', type:'multiple-choice', options:['Below $10,000','$10,000–$40,000','$40,000+'], action:(a)=>{ if(a==='Below $10,000') return goToStep('disqualify'); if(a==='$10,000–$40,000'){ prefillDebtAmount=25000; return goToStep('qIncome'); } if(a==='$40,000+'){ prefillDebtAmount=50000; return goToStep('qIncome'); } } },
      qIncome: { message:'Do you have a steady source of income?', type:'multiple-choice', options:['Yes','No'], action:(a)=> a==='Yes'? goToStep('qWilling'): goToStep('disqualify') },
      qWilling: { message:'As part of the study, are you willing to speak with a debt specialist for a free, no-obligation consultation?', type:'multiple-choice', options:['Yes','No'], action:(a)=> a==='Yes'? goToStep('preFormInfo'): goToStep('disqualify') },
      preFormInfo: { message:`<strong>Fantastic! You've qualified for the study.</strong>
        <p style="margin:8px 0">The main part of our research involves having you complete a short, secure form to request a free consultation from a debt specialist. To get genuine feedback, this study is for people who are truly interested in getting help with their debt. We've carefully researched and selected a reputable company, <strong>CuraDebt</strong>, to connect our participants with.</p>
        <p style="margin:8px 0">A debt settlement service works to negotiate with your creditors to lower the amount you owe. The goal is often to combine your payments into a single, more manageable monthly amount, with a plan to get you out of debt in about 2–4 years.</p>
        <p style="margin:8px 0">After you submit this form, you may receive a call from <strong>+1 855-306-5699</strong> to connect you to a specialist.</p>`, type:'multiple-choice', options:["Yes, I'm ready"], action:()=> goToStep('showApiForm') },
      showApiForm: { message:"Excellent! Please complete the secure form below. I'll be here once you've submitted it.", type:'api-form' },
      formSuccess: { message:'Thank you! Your information has been sent securely. Watch for a call from +1 855-306-5699 to connect you to a debt specialist. Also, check your email for confirmation.', next:'askToContinueToFeedback' },
      askToContinueToFeedback: { message:'Now for the final step. Ready to provide your feedback?', type:'multiple-choice', options:['Yes, Continue to Feedback'], action:()=> goToStep('askForFeedback') },
      askForFeedback: { message:"Please complete the form below. You'll need to enter your email address so we can match your feedback to your initial submission.", type:'iframe-form', next:'complete' },
      complete: { message:"That's everything! Thank you so much for your valuable feedback. You will now be redirected to finalize your entry.", end:true, status:21 },
      disqualify: { message:"I appreciate you answering. Based on your responses, this study isn't the right fit. Thank you for your time. You will be redirected now.", end:true, status:18 }
    };

    function updateProgress(index,total){ const p=Math.max(0, Math.min(100, (index/Math.max(1,total-1))*100)); progressBar.style.width=p+'%'; }

    function goToStep(key){
      const step=surveyFlow[key]; if(!step) return; const keys=Object.keys(surveyFlow); updateProgress(keys.indexOf(key), keys.length);
      setQuestion(step.message||'');
      if(step.end){ chatInputArea.innerHTML='<div class="help" style="text-align:center">You will be redirected shortly…</div>'; return; }
      if(step.type==='multiple-choice'){
        const c=createBaseContainer();
        step.options.forEach(opt=>{ const b=document.createElement('button'); b.className='cta'; b.style.width='100%'; b.style.marginTop='8px'; b.textContent=opt; b.onclick=()=>{ b.disabled=true; addAnswer(opt); step.action(opt); ensureBottom(); }; c.appendChild(b); });
        addAbandon(c);
      } else if(step.type==='api-form'){
        chatWindow.innerHTML='<div class="spacer"></div>'; showApiForm();
      } else if(step.type==='iframe-form'){
        chatWindow.innerHTML='<div class="spacer"></div>'; showFeedbackEmbed(()=> goToStep(step.next));
      } else if(step.next){ goToStep(step.next); }
    }

    function showIntro(){ chatWindow.innerHTML=''; chatInputArea.innerHTML=''; const card=document.createElement('div'); card.className='card'; card.style.textAlign='center'; card.style.padding='24px'; card.innerHTML=`
      <div style="width:64px;height:64px;margin:0 auto 16px;border-radius:20px;background:linear-gradient(135deg,#6366f1,#a78bfa,#ec4899);display:grid;place-items:center;color:#fff;font-weight:800;font-size:32px;">C</div>
      <h2 style="margin:0 0 8px 0; font-size:22px; color:var(--ink);">Debt Relief Research Study</h2>
      <div class="help" style="font-size:15px; max-width: 300px; margin: 0 auto 16px;">Help us improve the debt settlement process. Your feedback matters.</div>
      <button id="begin-btn" class="cta" style="margin-top:12px;">Begin Secure Survey</button>`;
      chatWindow.appendChild(card);
      document.getElementById('begin-btn').onclick=()=>{ card.remove(); goToStep('start'); ensureBottom(); };
      ensureBottom();
    }

    // ======== API FORM (slider + OTP) ========
    function showApiForm(){
      chatInputArea.innerHTML='';
      const box=document.createElement('div');
      box.className='card';
      box.innerHTML=`
        <div style="text-align:center">
          <div class="label">Select Amount Of Unsecured Debt</div>
          <div id="debtAmountDisplay" class="money">$25,000</div>
          <input id="debtSlider" class="slider" type="range" min="0" max="100000" value="25000" step="100">
          <div class="help">Move the slider to select the exact amount you owe.</div>
          <div class="row" style="margin-top:6px"><label class="label" style="align-self:center">Or type exact amount</label><input id="debtNumber" class="field" inputmode="numeric" value="25,000"></div>
          <input id="debtHidden" type="hidden" value="25000" />
          <div id="slider-text" class="help hidden"></div>
          <div id="qualifyMsg" class="help hidden" style="color:#ef4444">Minimum debt is $10,000 to qualify.</div>
        </div>
        <div class="row" style="margin-top:8px">
          <input class="field" id="f_fname" placeholder="First Name">
          <input class="field" id="f_lname" placeholder="Last Name">
        </div>
        <input class="field" id="f_email" placeholder="Email Address" style="margin-top:8px">
        <div id="email-hint" class="help"></div>
        <input class="field" id="f_phone" placeholder="Phone Number" style="margin-top:8px">
        <div id="phone-hint" class="help"></div>
        <div class="otp-row">
          <button type="button" id="send-otp" class="otp-send">Send verification code</button>
          <input id="otp-code" class="field otp-code" placeholder="6-digit code" inputmode="numeric" maxlength="6">
          <button type="button" id="check-otp" class="otp-verify">Verify number</button>
          <span id="otp-countdown" class="badge hidden">60s</span>
        </div>
        <div id="otp-status" class="help" style="min-height:18px"></div>
        <div id="tf-call-note" class="notice">✅ Number verified. You may receive a call from +1 855-306-5699.</div>
        <select id="state" class="field" style="margin-top:8px"><option value="" disabled selected>Select Your State</option></select>
        <label style="display:flex;gap:8px;margin-top:8px;font-size:12px;color:#334155"><input id="tcpa" type="checkbox"> <span>By clicking, you agree to be contacted by CuraDebt and its partners at the number and email provided (including via automated dialing/texts). Your consent is not required to purchase.</span></label>
        <button id="submit-btn" class="cta" disabled style="margin-top:10px">Verify your phone to continue</button>
        <div id="form-error" style="color:#b91c1c;text-align:center;font-weight:600;display:none;margin-top:6px"></div>
      `;
      chatWindow.appendChild(box);
      requestAnimationFrame(()=>{ const y=box.offsetTop - qbar.offsetHeight - 8; scrollBox.scrollTop=Math.max(0,y); updateSticky(); });

      // States
      const allStates=["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"]; 
      const excluded=["NH","MI","MN","CO","VA","IA","WA","PA","IL","KS","OR","TN","UT","VI","WV","RI"]; 
      const stateSel=box.querySelector('#state'); 
      allStates.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSel.appendChild(o); });

      // Slider sync
      const debtSlider = box.querySelector('#debtSlider');
      const debtNumber = box.querySelector('#debtNumber');
      const debtAmountDisplay = box.querySelector('#debtAmountDisplay');
      const debtHidden = box.querySelector('#debtHidden');
      const qualifyMsg = box.querySelector('#qualifyMsg');
      const sliderText = box.querySelector('#slider-text');

      const toInt = (val)=>{ const n = Number(String(val ?? '').replace(/\D+/g,'')); return Number.isFinite(n) ? n : 0; };
      const fmtMoney = (n)=> `$${Number(n||0).toLocaleString('en-US')}`;

      function updateSubmitEnabled(){
        const amount = toInt(debtHidden.value);
        const consent = box.querySelector('#tcpa').checked;
        const stateOK = stateSel.value && !excluded.includes(stateSel.value);
        const ready = amount>=10000 && consent && stateOK && otpVerified;
        const submitBtn = box.querySelector('#submit-btn');
        submitBtn.disabled = !ready;
        submitBtn.textContent = ready ? 'Submit' : (otpVerified ? 'See If I Qualify' : 'Verify your phone to continue');
      }

      function setSliderUI(val){
        const v = Math.max(0, Math.min(100000, toInt(val)));
        debtSlider.value = String(v);
        debtNumber.value = v.toLocaleString('en-US');
        debtAmountDisplay.textContent = v >= 100000 ? `${fmtMoney(v)}+` : fmtMoney(v);
        debtHidden.value = String(v);
        const qualifies = v >= 10000;
        if (sliderText){
          sliderText.textContent = qualifies ? `Your selected debt is ${fmtMoney(v)}.` : `You are below the minimum qualifying amount of ${fmtMoney(10000)}.`;
          sliderText.classList.remove('hidden');
          sliderText.style.color = qualifies ? '#4b5563' : '#ef4444';
        }
        if (qualifyMsg) qualifyMsg.classList.toggle('hidden', qualifies);
        updateSubmitEnabled();
      }

      debtSlider.addEventListener('input', (e)=> setSliderUI(e.target.value), { passive:true });
      debtSlider.addEventListener('change', (e)=> setSliderUI(e.target.value));
      debtNumber.addEventListener('input', (e)=> setSliderUI(e.target.value));
      debtNumber.addEventListener('blur', ()=>{ const v = toInt(debtNumber.value); debtNumber.value = v? v.toLocaleString('en-US') : ''; setSliderUI(v); });
      setSliderUI(typeof prefillDebtAmount === 'number' && prefillDebtAmount>0 ? prefillDebtAmount : debtSlider.value);

      // Email & phone hints
      const email=box.querySelector('#f_email'); const eHint=box.querySelector('#email-hint'); 
      email.addEventListener('blur', ()=>{ if(!email.value){ eHint.textContent=''; return; } const ok=/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email.value); eHint.textContent= ok? 'Looks good.' : 'Enter a valid email.'; eHint.style.color = ok? '#166534':'#b91c1c'; });

      const phone=box.querySelector('#f_phone'); const pHint=box.querySelector('#phone-hint'); 
      const isUSPhone=(v)=> /(^\+?1?[2-9]\d{2}[2-9]\d{6}$)|(^\(?[2-9]\d{2}\)?[-. ]?[2-9]\d{2}[-. ]?[2-9]\d{4}$)/.test(v);
      const toE164US=(v)=>{ const digits=(v||'').replace(/\D+/g,''); if(digits.length<10) return ''; const d=digits.startsWith('1')? digits : '1'+digits; return '+'+d; };
      phone.addEventListener('blur', ()=>{ if(!phone.value){ pHint.textContent=''; return; } const ok=isUSPhone(phone.value); pHint.textContent= ok? 'OK' : 'Enter a valid US number.'; pHint.style.color = ok? '#166534':'#b91c1c'; });

      // OTP (Firebase v10 or preview)
      const sendBtn = box.querySelector('#send-otp');
      const codeInput = box.querySelector('#otp-code');
      const verifyBtn = box.querySelector('#check-otp');
      const statusEl = box.querySelector('#otp-status');
      const callNote = box.querySelector('#tf-call-note');
      const countdown = box.querySelector('#otp-countdown');
      const formError = box.querySelector('#form-error');
      let otpVerified=false; let confirmationResult=null; let timer=null; let secondsLeft=0; let recaptcha=null;

      function setErr(msg){ formError.textContent=msg||''; formError.style.display= msg?'block':'none'; }
      function setStatus(t, ok){ statusEl.textContent=t||''; statusEl.style.color = ok? '#166534':'#b91c1c'; }
      function setVerifiedUI(){ otpVerified=true; callNote.style.display='block'; verifyBtn.disabled=true; sendBtn.disabled=true; codeInput.disabled=true; sendBtn.textContent='Verified'; updateSubmitEnabled(); setStatus('Verified ✓', true); }
      function startCountdown(sec=60){ secondsLeft=sec; countdown.classList.remove('hidden'); countdown.textContent=`${secondsLeft}s`; sendBtn.disabled=true; timer && clearInterval(timer); timer=setInterval(()=>{ secondsLeft--; countdown.textContent=`${secondsLeft}s`; if(secondsLeft<=0){ clearInterval(timer); countdown.classList.add('hidden'); sendBtn.disabled=false; sendBtn.textContent='Resend code'; } }, 1000); }

      async function realSend(){
        setErr(''); setStatus('', true);
        if(!isUSPhone(phone.value)){ pHint.textContent='Please enter a valid US number first.'; pHint.style.color='#b91c1c'; phone.style.borderColor='#ef4444'; setTimeout(()=> phone.style.borderColor='', 1400); return; }
        try {
          sendBtn.textContent='Sending…'; sendBtn.disabled=true;
          if(!recaptcha && fb){ recaptcha = new fb.RecaptchaVerifier(fb.auth, 'recaptcha-container', { size:'invisible' }); }
          const e164 = toE164US(phone.value);
          confirmationResult = await fb.signInWithPhoneNumber(fb.auth, e164, recaptcha);
          setStatus('Code sent. Check SMS.', true); sendBtn.textContent='Code Sent!'; codeInput.focus(); startCountdown(60);
        } catch (e) {
          console.error('OTP send error', e); let msg='Failed to send code. Please try again.';
          if(e?.code==='auth/too-many-requests') msg='Too many attempts. Try again later.';
          if(e?.code==='auth/invalid-phone-number') msg='Invalid phone number format.';
          setStatus(msg, false); sendBtn.textContent='Send verification code'; sendBtn.disabled=false;
          try { const id = await recaptcha?.render?.(); if(id!==undefined) grecaptcha.reset(id); } catch(_){}
        }
      }

      async function realVerify(){
        setErr(''); setStatus('', true);
        const code=(codeInput.value||'').trim();
        if(!confirmationResult){ setStatus('Please send the code first.', false); return; }
        if(code.length!==6){ setStatus('Enter the 6-digit code.', false); return; }
        try {
          verifyBtn.textContent='Verifying…'; verifyBtn.disabled=true;
          await confirmationResult.confirm(code);
          setVerifiedUI();
        } catch (e) {
          console.error('OTP verify error', e); let msg='Verification failed. Please try again.'; if(e?.code==='auth/code-expired') msg='Code expired. Please resend.'; setStatus(msg,false); verifyBtn.textContent='Verify number'; verifyBtn.disabled=false; }
      }

      function previewSend(){ setErr(''); if(!isUSPhone(phone.value)){ pHint.textContent='Please enter a valid US number first.'; pHint.style.color='#b91c1c'; return; } sendBtn.textContent='Sending…'; sendBtn.disabled=true; setTimeout(()=>{ setStatus('Code sent. (preview mode)', true); sendBtn.textContent='Code Sent!'; startCountdown(8); codeInput.focus(); }, 600); }
      function previewVerify(){ const code=(codeInput.value||'').trim(); if(code.length===6){ setVerifiedUI(); } else { setStatus('Enter the 6-digit code.', false);} }

      sendBtn.addEventListener('click', ()=> (fb && !PREVIEW_MODE) ? realSend() : previewSend());
      verifyBtn.addEventListener('click', ()=> (fb && !PREVIEW_MODE) ? realVerify() : previewVerify());
      codeInput.addEventListener('input', ()=>{ if(codeInput.value.trim().length===6) verifyBtn.click(); });
      phone.addEventListener('input', ()=>{ otpVerified=false; setStatus('', true); callNote.style.display='none'; updateSubmitEnabled(); });

      stateSel.addEventListener('change', updateSubmitEnabled);
      box.querySelector('#tcpa').addEventListener('change', updateSubmitEnabled);

      // Submit (demo)
      const submitBtn = box.querySelector('#submit-btn');
      submitBtn.addEventListener('click', (e)=>{ e.preventDefault(); if(submitBtn.disabled) return; addAnswer('Form submitted'); goToStep('formSuccess'); });

      // Footer
      const abandon=document.createElement('button'); abandon.className='abandon'; abandon.textContent='Abandon Survey'; abandon.onclick=()=> goToStep('leaveSurvey'); chatInputArea.appendChild(abandon);
    }

    function showFeedbackEmbed(onContinue){
      chatInputArea.innerHTML=''; const box=document.createElement('div'); box.className='card'; box.style.height='60vh';
      box.innerHTML='<div class="help">Preview only — feedback iframe disabled.</div><div style="height:100%;display:grid;place-items:center"><div class="help">[Feedback form would appear here]</div></div>'; chatWindow.appendChild(box);
      requestAnimationFrame(()=>{ const y=box.offsetTop - qbar.offsetHeight - 8; scrollBox.scrollTop=Math.max(0,y); updateSticky(); });
      const btn=document.createElement('button'); btn.className='cta'; btn.style.marginTop='10px'; btn.textContent="I\'ve Submitted My Feedback"; btn.onclick=()=> onContinue(); chatInputArea.appendChild(btn); addAbandon(chatInputArea);
    }

    // Boot
    function boot(){ showIntro(); }
    boot();
  </script>
</body>
</html>

