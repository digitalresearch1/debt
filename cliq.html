<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Wellness Research Study</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }

    .chat-bubble {
      max-width: 80%;
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
    }
    .chat-bot { background: #eef2ff; color: #111827; align-self: flex-start; }
    .chat-user { background: #4f46e5; color: #fff; align-self: flex-end; }

    .fade-in { opacity: 1 !important; }

    .full-media-wrapper {
      width: 100%;
      max-width: 1300px;
      margin: 0 auto;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    /* Facebook Video Height */
    .video-block {
      height: 1000px;
    }
    @media (max-width: 768px) {
      .video-block {
        height: 480px;
      }
    }

    /* Offer Iframe */
    .offer-block {
      height: 1200px;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

<div id="chatOverlay" class="fixed inset-0 bg-white z-50 flex flex-col overflow-y-auto">
  <!-- HEADER -->
  <div class="p-4 bg-indigo-600 text-white text-center shadow">
    <h1 class="text-xl font-bold">Financial Wellness Screening Chat</h1>
    <p class="text-xs mt-1 text-indigo-100">We just need a few answers before continuing.</p>
  </div>

  <!-- CHAT BODY -->
  <div id="chatWindow" class="flex-1 flex flex-col p-4 space-y-2"></div>

  <!-- CONTROLS -->
  <div id="chatControls" class="p-4 bg-white border-t border-slate-200 flex flex-wrap gap-2 sticky bottom-0"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const chatWindow = document.getElementById("chatWindow");
  const chatControls = document.getElementById("chatControls");
  const urlParams = new URLSearchParams(window.location.search);

  let transactionId =
    urlParams.get("transaction_id") ||
    urlParams.get("RID") ||
    "tx_" + Date.now().toString(36);

  const offerTrackedUrl =
    "https://trkmcl.com/wy8odpg43k/p98vjj0e83?subid=" +
    encodeURIComponent(transactionId);

  const abandonUrl =
    `https://spectrumsurveys.com/surveydone?st=18&transaction_id=${transactionId}`;

  const finishUrl =
    `https://YOUR-WORKER-NAME.YOUR-SUBDOMAIN.workers.dev/finish?transaction_id=${transactionId}`;

  /* -------------------------
     BASIC CHAT MESSAGE SYSTEM
  ---------------------------*/
  function addBotMessage(text) {
    clearControls();
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble chat-bot";
    bubble.textContent = text;
    chatWindow.appendChild(bubble);
    setTimeout(() => bubble.classList.add("fade-in"), 50);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function addUserMessage(text) {
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble chat-user";
    bubble.textContent = text;
    chatWindow.appendChild(bubble);
    setTimeout(() => bubble.classList.add("fade-in"), 50);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function replaceStep(contentElement) {
    chatWindow.innerHTML = "";
    chatWindow.appendChild(contentElement);
  }

  function clearControls() {
    chatControls.innerHTML = "";
  }

  function addButtons(buttons) {
    clearControls();
    buttons.forEach(btn => {
      const b = document.createElement("button");
      b.textContent = btn.label;
      b.className =
        "px-4 py-2 rounded-full border border-slate-300 bg-white hover:bg-slate-100 text-slate-900 text-sm";
      b.onclick = btn.onClick;
      chatControls.appendChild(b);
    });
  }

  /* -------------------------
     VIDEO STEP WITH SCROLL + TIMER
  ---------------------------*/
  function showVideoStep() {
    clearControls();

    const wrapper = document.createElement("div");
    wrapper.className = "w-full flex flex-col items-center gap-4 pb-8";

    const text = document.createElement("p");
    text.className = "text-sm text-slate-700 mb-2";
    text.textContent =
      "Please watch this short video. Scroll through it and stay for 10 seconds to continue.";

    const container = document.createElement("div");
    container.className = "full-media-wrapper video-block overflow-y-auto";
    container.style.position = "relative";

    const iframe = document.createElement("iframe");
    iframe.src =
      "https://www.facebook.com/plugins/video.php?height=314&href=" +
      encodeURIComponent("https://www.facebook.com/reel/1205740158030889/") +
      "&show_text=false&width=900";
    iframe.width = "100%";
    iframe.height = "100%";
    iframe.style.border = "0";
    iframe.allowFullscreen = true;

    container.appendChild(iframe);

    // Countdown area
    const countdownMsg = document.createElement("p");
    countdownMsg.className = "text-center text-indigo-700 font-semibold mt-4";
    countdownMsg.textContent = "Scroll the video to start verification…";

    wrapper.appendChild(text);
    wrapper.appendChild(container);
    wrapper.appendChild(countdownMsg);

    replaceStep(wrapper);

    let scrolled = false;
    let timerStarted = false;
    let seconds = 10;

    container.addEventListener("scroll", function () {
      const scrollPos = container.scrollTop + container.clientHeight;
      const scrollHeight = container.scrollHeight;

      if (!scrolled && scrollPos >= scrollHeight * 0.85) {
        scrolled = true;
        countdownMsg.textContent = "Verification started… 10 seconds left";

        if (!timerStarted) {
          timerStarted = true;

          let timerInterval = setInterval(() => {
            seconds -= 1;
            countdownMsg.textContent = `Verification… ${seconds} seconds left`;

            if (seconds <= 0) {
              clearInterval(timerInterval);
              countdownMsg.textContent =
                "Verification complete. Click the button below.";
              showVideoCompleteButton();
            }
          }, 1000);
        }
      }
    });
  }

  function showVideoCompleteButton() {
    addButtons([
      {
        label: "I've watched the video",
        onClick: function () {
          addUserMessage("I've watched the video");
          showOfferStep();
        }
      }
    ]);
  }

  /* -------------------------
     OFFER IFRAME STEP
  ---------------------------*/
  function showOfferStep() {
    const wrapper = document.createElement("div");
    wrapper.className = "w-full flex flex-col gap-4 pb-8";

    const title = document.createElement("p");
    title.className = "text-sm text-slate-700";
    title.textContent =
      "Please complete the secure form below with accurate information.";

    const container = document.createElement("div");
    container.className = "full-media-wrapper offer-block";

    const iframe = document.createElement("iframe");
    iframe.src = offerTrackedUrl;
    iframe.width = "100%";
    iframe.height = "100%";
    iframe.style.border = "0";

    container.appendChild(iframe);
    wrapper.appendChild(title);
    wrapper.appendChild(container);

    replaceStep(wrapper);

    addButtons([
      {
        label: "I completed the form",
        onClick: function () {
          addUserMessage("I completed the form");
          showFinishStep();
        }
      },
      {
        label: "I don't want to continue",
        onClick: function () {
          window.open(abandonUrl, "_blank");
        }
      }
    ]);
  }

  /* -------------------------
     FINAL STEP
  ---------------------------*/
  function showFinishStep() {
    const wrapper = document.createElement("div");
    wrapper.className = "w-full flex flex-col gap-4 pb-8";

    const msg = document.createElement("p");
    msg.className = "text-sm text-slate-700";
    msg.textContent =
      "Thank you. After your call, email apkconnex@gmail.com with your experience.";

    wrapper.appendChild(msg);
    replaceStep(wrapper);

    addButtons([
      {
        label: "Finish Survey",
        onClick: function () {
          window.open(finishUrl, "_blank");
        }
      },
      {
        label: "Abandon Survey",
        onClick: function () {
          window.open(abandonUrl, "_blank");
        }
      }
    ]);
  }

  /* -------------------------
     QUALIFICATION STEPS
  ---------------------------*/
  function askBalance() {
    addBotMessage("How much do you currently owe on unsecured balances?");
    addButtons([
      {
        label: "< $15,000",
        onClick: () =>
          disqualify("This project requires at least $15,000 in unsecured balances.")
      },
      {
        label: "$15,000 - $24,999",
        onClick: () => showNextStep(askAbility)
      },
      {
        label: "$25,000 - $39,999",
        onClick: () => showNextStep(askAbility)
      },
      {
        label: "$40,000+",
        onClick: () => showNextStep(askAbility)
      }
    ]);
  }

  function askAbility() {
    addBotMessage("Can you afford about $300/month toward a structured plan?");
    addButtons([
      {
        label: "Yes",
        onClick: () => showNextStep(askInterest)
      },
      {
        label: "No",
        onClick: () =>
          disqualify("This project requires ability to commit to at least ~$300/mo.")
      }
    ]);
  }

  function askInterest() {
    addBotMessage(
      "Are you open to speaking with a financial specialist in the next 24–48 hours?"
    );
    addButtons([
      {
        label: "Yes",
        onClick: () => showNextStep(askLocation)
      },
      {
        label: "No",
        onClick: () =>
          disqualify("This project is only for people actively seeking help.")
      }
    ]);
  }

  function askLocation() {
    addBotMessage("Do you currently live in the United States?");
    addButtons([
      {
        label: "Yes",
        onClick: () => showVideoStep()
      },
      {
        label: "No",
        onClick: () =>
          disqualify("This particular study is limited to U.S. residents.")
      }
    ]);
  }

  /* -------------------------
     HELPER — Fade transition
  ---------------------------*/
  function showNextStep(stepFunction) {
    chatWindow.innerHTML = "";
    chatControls.innerHTML = "";
    setTimeout(stepFunction, 80);
  }

  function disqualify(reason) {
    chatWindow.innerHTML = "";
    addBotMessage(reason);
    addButtons([
      {
        label: "Exit survey",
        onClick: function () {
          window.open(abandonUrl, "_blank");
        }
      }
    ]);
  }

  /* -------------------------
     START
  ---------------------------*/
  addBotMessage("Hi, I'm Chloe. Let's run a quick screening.");
  setTimeout(askBalance, 600);

});
</script>

</body>
</html>

