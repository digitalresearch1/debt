<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debt Relief Survey for Spanish-Speaking Individuals</title>

  <!-- External Scripts & Styles -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- ‚úÖ Tesseract v5 pinned (reliable) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- JotForm Scripts -->
  <script src="https://cdn.jotfor.ms/s/static/8c9e733f989/static/prototype.forms.js" type="text/javascript"></script>
  <script src="https://cdn.jotfor.ms/s/static/8c9e733f989/static/jotform.forms.js" type="text/javascript"></script>
  <script src="https://cdn.jotfor.ms/s/umd/f101c91eb00/for-form-branding-footer.js" type="text/javascript" defer></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="bg-gray-50">

<form class="jotform-form"
      onsubmit="return handleFormSubmit(event);"
      action="https://submit.jotform.com/submit/250893752460159"
      method="post"
      name="form_250893752460159"
      id="250893752460159"
      accept-charset="utf-8"
      autocomplete="on">

  <input type="hidden" name="formID" value="250893752460159" />
  <input type="hidden" id="JWTContainer" value="" />
  <input type="hidden" id="cardinalOrderNumber" value="" />
  <input type="hidden" id="jsExecutionTracker" name="jsExecutionTracker" value="build-date-1750800887869" />
  <input type="hidden" id="submitSource" name="submitSource" value="unknown" />
  <input type="hidden" id="submitDate" name="submitDate" value="undefined" />
  <input type="hidden" id="buildDate" name="buildDate" value="1750800887869" />
  <input type="hidden" name="uploadServerUrl" value="https://upload.jotform.com/upload" />
  <input type="hidden" name="eventObserver" value="1" />
  <input type="hidden" id="transaction_id_field" name="q34_transaction_id" value="" />

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display:none;">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
      <p id="modal-message" class="mb-4 text-gray-700"></p>
      <button id="modal-close" type="button"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
        Close
      </button>
    </div>
  </div>

  <div role="main" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-200">

      <div class="text-center mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 tracking-tight">
          üì¢ Help Improve Debt Relief Services for Spanish-Speaking Individuals
        </h1>
        <p class="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">
          This survey gathers feedback from Spanish-speaking individuals with debt on their customer service experience.
          We are not affiliated with any debt companies; this is for research only and there is no obligation to sign up.
        </p>
      </div>

      <div class="grid md:grid-cols-2 gap-8 md:gap-12">

        <!-- Left Column -->
        <div>
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Participation Requirements</h2>
            <div class="space-y-3">
              <div class="flex items-start p-3 bg-gray-50 rounded-lg mb-2">
                <span class="text-green-500 text-xl mr-3 mt-1">‚úÖ</span>
                <span class="text-gray-700">Have over <strong>$15,000</strong> in unsecured debt.</span>
              </div>
              <div class="flex items-start p-3 bg-gray-50 rounded-lg mb-2">
                <span class="text-green-500 text-xl mr-3 mt-1">üó£Ô∏è</span>
                <span class="text-gray-700">Be able to speak <strong>Spanish</strong> for the call.</span>
              </div>
              <div class="flex items-start p-3 bg-gray-50 rounded-lg mb-2">
                <span class="text-green-500 text-xl mr-3 mt-1">‚è∞</span>
                <span class="text-gray-700">Call must last at least <strong>5 minutes</strong>.</span>
              </div>

              <!-- ‚úÖ Removed instruction encouraging deception -->
              <div class="flex items-start p-3 bg-gray-50 rounded-lg mb-2">
                <span class="text-green-500 text-xl mr-3 mt-1">‚ÑπÔ∏è</span>
                <span class="text-gray-700">Follow the agent‚Äôs questions and answer honestly.</span>
              </div>
            </div>
          </div>

          <div class="my-8 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center">
            <p class="text-blue-800">
              Please review the ad on Facebook before your call:
            </p>

            <!-- ‚úÖ Use button + JS open (more reliable than target=_blank in some environments) -->
            <button id="open-facebook"
                    type="button"
                    class="mt-2 inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition">
              View Facebook Post
            </button>

            <p class="text-xs text-blue-800 mt-2 break-words">
              <span class="font-semibold">Link:</span> https://www.facebook.com/reel/822439956643658
            </p>
          </div>

          <div class="text-center my-8 p-6 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
            <h3 class="text-2xl font-bold text-gray-800">üìû Make Your 5-Minute Call Now</h3>
            <div class="flex justify-center gap-4 flex-wrap mt-4">
              <!-- tel: works only on mobile; we also add JS click -->
              <button id="call-btn"
                      type="button"
                      class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition transform hover:scale-105">
                üì± Call (844) 706-1334
              </button>
            </div>
            <p class="text-xs text-gray-600 mt-3">
              If you‚Äôre on a computer, dial this number on your phone: <span class="font-semibold">(844) 706-1334</span>
            </p>
          </div>

          <div class="mt-6 text-center">
            <button id="exit-survey-btn" type="button"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
              üö™ Exit Survey
            </button>
          </div>
        </div>

        <!-- Right Column -->
        <div>
          <div class="bg-yellow-50 border-2 border-dashed border-yellow-400 rounded-xl p-6 shadow-lg">
            <div class="text-center">
              <div class="text-4xl mb-2">üéÅ</div>
              <h2 class="text-2xl font-bold text-yellow-900">Win a $500 Walmart Voucher!</h2>
              <p class="text-yellow-800 mt-2 mb-4">Complete all steps to enter our draw.</p>
            </div>

            <div class="text-left space-y-4">
              <div class="flex items-start mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold mr-4">1</div>
                <p class="text-gray-700 mt-1">After your call, <strong>screenshot</strong> your call log showing the number and duration.</p>
              </div>

              <div class="flex items-start mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold mr-4">2</div>
                <p class="text-gray-700 mt-1">Upload your screenshot below and click <strong>Validate</strong>.</p>
              </div>

              <div class="flex items-start mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold mr-4">3</div>
                <p class="text-gray-700 mt-1">If successful, email your review and click <strong>Complete Entry</strong>.</p>
              </div>
            </div>
          </div>

          <div class="mt-8 bg-gray-50 p-6 rounded-lg border">
            <h3 class="font-bold text-lg text-gray-800 mb-3 text-center">Upload & Validate Screenshot</h3>

            <div class="flex flex-col sm:flex-row items-center gap-4">
              <input type="file" id="file-input" name="screenshot" accept="image/*"
                     class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>

              <button id="validate-btn" type="button"
                      class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg whitespace-nowrap transition">
                Validate
              </button>
            </div>

            <p id="ocr-message" class="mt-3 text-sm font-semibold text-center"></p>
            <p id="ocr-debug" class="mt-2 text-xs text-gray-500 text-center break-words"></p>
          </div>

          <div class="mt-8 text-center p-4 bg-gray-100 rounded-lg">
            <h4 class="font-semibold text-gray-700">Join Other Participants!</h4>
            <p id="participant-counter" class="text-2xl font-bold text-indigo-600 my-2">27</p>
            <p class="text-sm text-gray-500">people have participated so far today.</p>
          </div>

          <div class="mt-8 text-center p-6 bg-green-50 border border-green-200 rounded-lg">
            <h3 class="text-xl font-bold text-green-800 mt-2">Final Step: Email Your Review!</h3>
            <p class="text-green-700 mt-2">
              To enter the draw, please email your review of the call experience to:
            </p>
            <a href="mailto:apkconnex@gmail.com"
               class="font-bold text-blue-600 underline text-lg my-3 inline-block">
              apkconnex@gmail.com
            </a>

            <button id="complete-btn" type="submit"
                    class="w-full font-bold py-3 px-4 rounded-lg shadow-md transition bg-gray-300 text-gray-500 cursor-not-allowed"
                    disabled>
              Complete Entry
            </button>
            <p id="submitted-message" class="text-sm text-green-600 mt-2" style="display:none;">
              Thank you for your valuable feedback!
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <input type="hidden" class="simple_spc" id="simple_spc" name="simple_spc" value="250893752460159" />
</form>

<script>
  // --- JotForm Configuration ---
  JotForm.newDefaultTheme = true;
  JotForm.extendsNewTheme = false;
  JotForm.singleProduct = false;
  JotForm.newPaymentUIForNewCreatedForms = false;
  JotForm.texts = {"confirmEmail":"E-mail does not match","pleaseWait":"Please wait..."};
  JotForm.newPaymentUI = true;
  JotForm.originalLanguage = "en";
  JotForm.isFormViewTrackingAllowed = false;
  JotForm.uploadServerURL = "https://upload.jotform.com/upload";
  JotForm.clearFieldOnHide="disable";
  JotForm.submitError="jumpToFirstError";
  JotForm.init(function(){});

  // --- Custom Page Logic ---
  let transactionId = '';

  const handleFormSubmit = (event) => {
    event.preventDefault();
    const completeBtn = document.getElementById('complete-btn');
    const submittedMessageEl = document.getElementById('submitted-message');

    completeBtn.textContent = '‚úÖ Entry Submitted!';
    completeBtn.disabled = true;
    submittedMessageEl.style.display = 'block';

    setTimeout(() => {
      window.location.href = `https://spectrumsurveys.com/surveydone?st=21&transaction_id=${encodeURIComponent(transactionId)}`;
    }, 800);
    return false;
  };

  document.addEventListener('DOMContentLoaded', () => {
    // --- IDs ---
    const urlParams = new URLSearchParams(window.location.search);
    transactionId = urlParams.get('transaction_id') || 'TEST_TRANSACTION_ID';
    document.getElementById('transaction_id_field').value = transactionId;

    // --- DOM ---
    const validateBtn = document.getElementById('validate-btn');
    const completeBtn = document.getElementById('complete-btn');
    const exitSurveyBtn = document.getElementById('exit-survey-btn');
    const fileInput = document.getElementById('file-input');
    const ocrMessageEl = document.getElementById('ocr-message');
    const ocrDebugEl = document.getElementById('ocr-debug');
    const participantCounterEl = document.getElementById('participant-counter');

    const modal = document.getElementById('modal');
    const modalMessageEl = document.getElementById('modal-message');
    const modalCloseBtn = document.getElementById('modal-close');

    const openFacebookBtn = document.getElementById("open-facebook");
    const callBtn = document.getElementById("call-btn");

    let isValidationPassed = false;

    // --- modal ---
    const showModal = (message) => {
      modalMessageEl.textContent = message;
      modal.style.display = 'flex';
    };
    modalCloseBtn.addEventListener('click', () => { modal.style.display = 'none'; });

    // --- participant counter demo ---
    let participantCount = 27;
    setInterval(() => {
      if (Math.random() > 0.6) {
        participantCount++;
        participantCounterEl.textContent = participantCount;
      }
    }, 4500);

    // ===== LINKS FIX =====
    openFacebookBtn.addEventListener("click", () => {
      const url = "https://www.facebook.com/reel/822439956643658";
      // direct click => allowed pop-up
      window.open(url, "_blank", "noopener,noreferrer");
    });

    callBtn.addEventListener("click", () => {
      const tel = "tel:+18447061334";
      // On mobile this opens dialer, on desktop it may do nothing.
      // We still attempt it:
      window.location.href = tel;

      // fallback message for desktop
      setTimeout(() => {
        showModal("If the call did not open, please dial this number on your phone: (844) 706-1334");
      }, 450);
    });

    // ===== OCR FIX (Tesseract v5 correct usage) =====
    const TESS = {
      workerPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",
      corePath:   "https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js",
      // ‚úÖ reliable traineddata host
      langPath:   "https://cdn.jsdelivr.net/npm/@tesseract.js-data/eng/4.0.0_best/"
    };

    let ocrWorker = null;

    async function getWorker() {
      if (!window.Tesseract) throw new Error("Tesseract.js failed to load (network/adblock).");
      if (location.protocol === "file:") {
        throw new Error("Open this page from https:// (not file://). Upload it to your website/hosting and retry.");
      }
      if (ocrWorker) return ocrWorker;

      ocrWorker = await Tesseract.createWorker({
        logger: () => {}, // keep quiet (fast)
        workerPath: TESS.workerPath,
        corePath: TESS.corePath,
        langPath: TESS.langPath
      });

      await ocrWorker.loadLanguage("eng");
      await ocrWorker.initialize("eng");

      // Better for call-log text blocks
      try { await ocrWorker.setParameters({ tessedit_pageseg_mode: "6" }); } catch {}

      return ocrWorker;
    }

    function normalizeDigits(s) {
      return (s || "").replace(/[^\d]/g, ""); // keep only digits
    }

    function parseDurationSeconds(text) {
      const t = (text || "").toLowerCase();

      // 00:05:12 or 05:12
      const hms = t.match(/\b(\d{1,2}):(\d{2}):(\d{2})\b/);
      if (hms) return (parseInt(hms[1],10)*3600) + (parseInt(hms[2],10)*60) + parseInt(hms[3],10);

      const ms = t.match(/\b(\d{1,2}):(\d{2})\b/);
      if (ms) return (parseInt(ms[1],10)*60) + parseInt(ms[2],10);

      // "5 min", "5 minutes", "6 mins"
      const mins = t.match(/\b(\d{1,3})\s*(min|mins|minute|minutes)\b/);
      if (mins) return parseInt(mins[1],10) * 60;

      // "300 sec"
      const secs = t.match(/\b(\d{1,5})\s*(sec|secs|second|seconds)\b/);
      if (secs) return parseInt(secs[1],10);

      return 0;
    }

    // --- preprocess like TikTok fix: multi-crop + dehighlight + threshold + invert ---
    async function preprocessBlobs(file) {
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });

      // upscale small screenshots
      const targetW = 1400;
      const scale = img.width < targetW ? (targetW / img.width) : 1;
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const base = document.createElement("canvas");
      base.width = w; base.height = h;
      const bctx = base.getContext("2d", { willReadFrequently: true });
      bctx.imageSmoothingEnabled = true;
      bctx.drawImage(img, 0, 0, w, h);

      URL.revokeObjectURL(url);

      // Call logs may show number/duration in top/middle; try several crops + full
      const cropRatios = [0.25, 0.40, 0.60, 1.0];
      const modes = ["dehighlight", "normal", "invert"];
      const blobs = [];

      const toGray = (r,g,b)=>0.299*r + 0.587*g + 0.114*b;

      function buildVariantCanvas(srcCanvas, mode) {
        const c = document.createElement("canvas");
        c.width = srcCanvas.width;
        c.height = srcCanvas.height;
        const ctx = c.getContext("2d", { willReadFrequently: true });
        ctx.drawImage(srcCanvas, 0, 0);

        const imgData = ctx.getImageData(0, 0, c.width, c.height);
        const d = imgData.data;

        for (let i=0;i<d.length;i+=4){
          const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];
          const max = Math.max(r,g,b), min = Math.min(r,g,b);
          const sat = max === 0 ? 0 : (max - min) / max;
          const gray = toGray(r,g,b);

          let v;
          if (mode === "dehighlight") {
            // remove colored highlight/gradients
            if (sat > 0.18 && gray > 90) v = 255;
            else v = (gray > 155) ? 255 : 0;
          } else if (mode === "normal") {
            v = (gray > 165) ? 255 : 0;
          } else {
            const bw = (gray > 165) ? 255 : 0;
            v = 255 - bw;
          }

          d[i]=d[i+1]=d[i+2]=v;
          d[i+3]=a;
        }

        ctx.putImageData(imgData, 0, 0);
        return c;
      }

      async function canvasToBlob(canvas) {
        const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.92));
        if (blob) return blob;
        const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
        const resp = await fetch(dataUrl);
        return await resp.blob();
      }

      for (const ratio of cropRatios) {
        const cropH = ratio === 1.0 ? h : Math.max(240, Math.round(h * ratio));

        const crop = document.createElement("canvas");
        crop.width = w;
        crop.height = cropH;
        crop.getContext("2d").drawImage(base, 0, 0, w, cropH, 0, 0, w, cropH);

        // upscale crop for OCR
        const up = document.createElement("canvas");
        up.width = crop.width * 2;
        up.height = crop.height * 2;
        const uctx = up.getContext("2d", { willReadFrequently: true });
        uctx.imageSmoothingEnabled = true;
        uctx.drawImage(crop, 0, 0, up.width, up.height);

        for (const mode of modes) {
          const vCanvas = buildVariantCanvas(up, mode);
          blobs.push(await canvasToBlob(vCanvas));
        }
      }

      return blobs;
    }

    async function recognizeBest(file) {
      const w = await getWorker();
      const blobs = await preprocessBlobs(file);

      let bestText = "";
      for (let i=0;i<blobs.length;i++){
        const { data } = await w.recognize(blobs[i]);
        const text = data?.text || "";
        if (text.length > bestText.length) bestText = text;

        // quick early-exit if we already detect both phone + duration hints
        const digits = normalizeDigits(text);
        if (digits.includes("8447061334") && (text.toLowerCase().includes("min") || text.match(/\d{1,2}:\d{2}/))) {
          return bestText;
        }
      }
      return bestText;
    }

    const updateCompleteButtonState = () => {
      if (!isValidationPassed) {
        completeBtn.disabled = true;
        completeBtn.className = 'w-full font-bold py-3 px-4 rounded-lg shadow-md transition bg-gray-300 text-gray-500 cursor-not-allowed';
      } else {
        completeBtn.disabled = false;
        completeBtn.className = 'w-full font-bold py-3 px-4 rounded-lg shadow-md transition bg-green-600 hover:bg-green-700 text-white';
      }
    };

    validateBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        showModal('Please select a screenshot file first.');
        return;
      }

      isValidationPassed = false;
      updateCompleteButtonState();

      ocrMessageEl.textContent = 'Analyzing screenshot, please wait...';
      ocrMessageEl.className = 'mt-3 text-sm font-semibold text-center text-gray-700';
      ocrDebugEl.textContent = '';
      validateBtn.disabled = true;
      validateBtn.textContent = 'Analyzing...';

      try {
        const text = await recognizeBest(file);
        const lower = (text || "").toLowerCase();

        // Phone check
        const digits = normalizeDigits(text);
        const phoneFound = digits.includes("8447061334") || digits.includes("18447061334");

        // Duration check (>= 5 min)
        const durationSeconds = parseDurationSeconds(lower);

        // Debug preview (helpful when OCR misses)
        ocrDebugEl.textContent = "Detected text (snippet): " + (text || "").replace(/\s+/g, " ").slice(0, 220);

        if (!phoneFound) {
          ocrMessageEl.textContent = '‚ùå Validation Failed: The number (844) 706-1334 was not detected.';
          ocrMessageEl.className = 'mt-3 text-sm font-semibold text-center text-red-600';
        } else if (durationSeconds < 300) {
          ocrMessageEl.textContent = `‚ùå Validation Failed: Call must be at least 5 minutes. (Detected: ${Math.floor(durationSeconds/60)}m ${durationSeconds%60}s)`;
          ocrMessageEl.className = 'mt-3 text-sm font-semibold text-center text-red-600';
        } else {
          ocrMessageEl.textContent = '‚úÖ Validation Successful! You can now complete your entry.';
          ocrMessageEl.className = 'mt-3 text-sm font-semibold text-center text-green-600';
          isValidationPassed = true;
        }
      } catch (error) {
        console.error("OCR Error:", error);
        ocrMessageEl.textContent = '‚ùå OCR failed.';
        ocrMessageEl.className = 'mt-3 text-sm font-semibold text-center text-red-600';
        ocrDebugEl.textContent = String(error?.message || error || "Unknown error");
      } finally {
        validateBtn.disabled = false;
        validateBtn.textContent = 'Validate';
        updateCompleteButtonState();
      }
    });

    exitSurveyBtn.addEventListener('click', () => {
      window.location.href = `https://spectrumsurveys.com/surveydone?st=18&transaction_id=${encodeURIComponent(transactionId)}`;
    });

    updateCompleteButtonState();
  });

  // Terminate worker on unload
  window.addEventListener("beforeunload", async () => {
    try {
      if (window.__ocrWorker) await window.__ocrWorker.terminate();
    } catch {}
  });
</script>
</body>
</html>


