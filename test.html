<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chloe — Debt Relief Survey (Updated)</title>
  <!-- START - Brevo styles -->
  <style>
    @font-face {
      font-display: block;
      font-family: Roboto;
      src: url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/7529907e9eaf8ebb5220c5f9850e3811.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/normal/normal/25c678feafdc175a70922a116c9be3e7.woff) format("woff")
    }
  
    @font-face {
      font-display: fallback;
      font-family: Roboto;
      font-weight: 600;
      src: url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/6e9caeeafb1f3491be3e32744bc30440.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/medium/normal/71501f0d8d5aa95960f6475d5487d4c2.woff) format("woff")
    }
  
    @font-face {
      font-display: fallback;
      font-family: Roboto;
      font-weight: 700;
      src: url(https://assets.brevo.com/font/Roboto/Latin/bold/normal/3ef7cf158f310cf752d5ad08cd0e7e60.woff2) format("woff2"), url(https://assets.brevo.com/font/Roboto/Latin/bold/normal/ece3a1d82f18b60bcce0211725c476aa.woff) format("woff")
    }
  
    #sib-container input:-ms-input-placeholder {
      text-align: left;
      font-family: Helvetica, sans-serif;
      color: #c0ccda;
    }
  
    #sib-container input::placeholder {
      text-align: left;
      font-family: Helvetica, sans-serif;
      color: #c0ccda;
    }
  
    #sib-container textarea::placeholder {
      text-align: left;
      font-family: Helvetica, sans-serif;
      color: #c0ccda;
    }
  
    #sib-container a {
      text-decoration: underline;
      color: #2BB2FC;
    }
  </style>
  <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">
  <!-- END - Brevo styles -->
  <style>
    :root{--bg:#f6f7fb;--ink:#0f172a;--sub:#475569;--ring:#e2e8f0;--card:#ffffff;--grad1:#6366f1;--grad2:#a78bfa;--grad3:#ec4899}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .shell{}
    .frame{display:flex;flex-direction:column;height:100vh;background:var(--card);overflow:hidden}
    header{padding:14px 20px;background:linear-gradient(#fff,#ffffffb0);border-bottom:1px solid rgba(0,0,0,.06)}
    header .title{font-weight:700}
    .progress-wrap{padding:8px 20px 6px}
    .progress{height:8px;border-radius:9999px;background:#e5e7eb;overflow:hidden}
    .progress>div{height:8px;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--grad3));transition:width .5s}
    .scroll-area{position:relative;flex:1;overflow:hidden}
    #scroll-box{position:absolute;inset:0;overflow-y:auto}
    
    #question-bar{background:linear-gradient(135deg,#f5f3ff,#eef2ff);border:none;border-bottom:1px solid var(--ring);padding:16px 20px;box-shadow:0 4px 12px rgba(15,23,42,.04)}
    .q-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--grad1);font-weight:700}
    #q-text{font-size:16px;font-weight:500;color:#1e293b;line-height:1.5}
    #q-hint{font-size:11px;color:#64748b;margin-top:4px;display:none}
    
    .history{padding:10px 16px 20px}
    .history > .card{max-width:560px;margin-left:auto;margin-right:auto}
    .bubble{display:flex;justify-content:flex-end;margin:8px 0}
    .bubble>div{background:#f1f5f9;border:1px solid rgba(15,23,42,.08);border-radius:18px;padding:10px 12px;font-size:14px;box-shadow:0 2px 10px rgba(15,23,42,.05);max-width:75%;word-wrap:break-word}
    footer{padding:12px 16px;background:linear-gradient(0deg,#fff,#ffffffb0);border-top:1px solid rgba(0,0,0,.06)}
    .btn{width:100%;text-align:left;padding:12px 14px;border-radius:9999px;background:#fff;border:1px solid #e2e8f0;box-shadow:0 1px 0 rgba(0,0,0,.03);font-weight:600;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .abandon{display:block;margin:8px auto 0;color:#e11d48;background:none;border:none;font-size:12px;cursor:pointer}
    .card{background:#fff;border:1px solid var(--ring);border-radius:18px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#fff}
    .label{font-size:12px;color:#475569}
    .help{font-size:12px;color:#64748b;margin:8px 0}
    .hidden{display:none}
    .money{font-size:36px;font-weight:800;background:linear-gradient(90deg,#4f46e5,#a78bfa,#ec4899);-webkit-background-clip:text;background-clip:text;color:transparent;margin:6px 0}
    .slider{width:100%;-webkit-appearance:none;appearance:none;background:transparent;height:34px}
    .slider::-webkit-slider-runnable-track{height:8px;background:#d1d5db;border-radius:999px}
    .slider::-moz-range-track{height:8px;background:#d1d5db;border-radius:999px}
    .slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:linear-gradient(135deg,var(--grad1),var(--grad2));border:3px solid #fff;border-radius:50%;margin-top:-7px;box-shadow:0 6px 18px rgba(99,102,241,.35)}
    .slider::-moz-range-thumb{width:22px;height:22px;background:linear-gradient(135deg,var(--grad1),var(--grad2));border:3px solid #fff;border-radius:50%;box-shadow:0 6px 18px rgba(99,102,241,.35)}
    .cta{padding:12px 14px;width:100%;border:none;border-radius:12px;font-weight:700;color:#fff;background:linear-gradient(90deg,#10b981,#14b8a6);cursor:pointer}
    .cta[disabled]{opacity:.6;cursor:not-allowed}
    .notice{font-size:12px;color:#166534;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:8px;padding:6px 8px;margin-top:6px;display:none}
    .otp-row{display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap}
    .otp-send,.otp-verify{padding:10px 12px;border:none;border-radius:12px;font-weight:700;color:#fff}
    .otp-send{background:linear-gradient(90deg,#6366f1,#8b5cf6)}
    .otp-verify{background:linear-gradient(90deg,#10b981,#059669)}
    .otp-code{flex:1;min-width:140px;max-width:220px}
    .spacer{height:6px}
    .muted{color:var(--sub);font-size:14px}
    .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-left:6px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="frame">
      <header>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#6366f1,#a78bfa,#ec4899);display:grid;place-items:center;color:#fff;font-weight:800">C</div>
          <div style="flex:1">
            <div class="title">Chloe</div>
            <div class="muted">AI Research Assistant · Debt Settlement Study</div>
          </div>
          <div class="muted">Secure</div>
        </div>
      </header>
      <div class="progress-wrap"><div class="progress"><div id="progress-bar"></div></div></div>
      <div class="scroll-area">
        <div id="scroll-box">
          <div id="question-bar">
            <div class="q-label">Question</div>
            <div id="q-text"></div>
            <div id="q-hint">Scroll to the end to continue</div>
          </div>
          <div class="history" id="chat-window"><div class="spacer"></div></div>
        </div>
      </div>
      <footer id="chat-input-area"></footer>
    </div>
  </div>

  <script type="module">
    // --- IMPORTANT ---
    // For Firebase Phone Auth to work, you MUST add the domain where this is hosted 
    // to the Authorized Domains list in your Firebase Console:
    // Firebase Console > Authentication > Settings > Authorized domains
    const PREVIEW_MODE = new URLSearchParams(location.search).has('preview');

    const firebaseConfig = {
      apiKey: "AIzaSyBF5wdHyOlOi_bntJHXto7f6RbJMkOdMSE",
      authDomain: "otp-c6311.firebaseapp.com",
      projectId: "otp-c6311",
      storageBucket: "otp-c6311.appspot.com",
      messagingSenderId: "637495517002",
      appId: "1:637495517002:web:7bd220994a7611a5606bb3",
    };

    let fb = null;
    if (!PREVIEW_MODE) {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const { getAuth, RecaptchaVerifier, signInWithPhoneNumber } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        fb = { app, auth, RecaptchaVerifier, signInWithPhoneNumber };
      } catch (e) {
        console.warn('Firebase SDK load failed. Falling back to preview mode.', e);
      }
    }

    const scrollBox = document.getElementById('scroll-box');
    const chatWindow = document.getElementById('chat-window');
    const chatInputArea = document.getElementById('chat-input-area');
    const progressBar = document.getElementById('progress-bar');
    const qbar = document.getElementById('question-bar');
    const qtext = document.getElementById('q-text');

    function updateSticky(){ qbar.style.position = (scrollBox.scrollHeight - (scrollBox.scrollTop + scrollBox.clientHeight) < 16) ? 'sticky':'relative'; qbar.style.top = (scrollBox.scrollHeight - (scrollBox.scrollTop + scrollBox.clientHeight) < 16) ? '0':'auto'; }
    scrollBox.addEventListener('scroll', updateSticky);
    function ensureBottom(){ requestAnimationFrame(()=>{ scrollBox.scrollTop = scrollBox.scrollHeight; updateSticky(); }); }
    function createBaseContainer(){ chatInputArea.innerHTML=''; const c=document.createElement('div'); return chatInputArea.appendChild(c); }
    function setQuestion(text){ qtext.innerHTML = text || ''; }
    function addAnswer(text){ const el=document.createElement('div'); el.className='bubble'; el.innerHTML=`<div>${text}</div>`; chatWindow.appendChild(el); }
    function addAbandon(container){ const a=document.createElement('button'); a.className='abandon'; a.textContent='Abandon Survey'; a.onclick=()=> goToStep('leaveSurvey'); container.appendChild(a); }

    const Q_OPTION = 'I have a question about debt relief';
    const DEBT_KB = [ { q:'What is debt settlement?', a:'Debt settlement negotiates with creditors to accept less than the full balance. You make one monthly deposit; when funds accrue, settlements are approved. It typically lasts 24–48 months.', k:['what is debt settlement','how works','negotiate'] }, { q:'Which debts qualify?', a:'Unsecured debts like credit cards, personal loans, and medical bills. Secured debts (auto, mortgage) and federal student loans are generally not eligible.', k:['qualify','eligible','unsecured'] }, { q:'How does it affect my credit?', a:'Expect a short-term score drop as accounts may become delinquent. Many rebuild credit 6–24 months after completion.', k:['credit','score','impact'] }, ];
    function answerDebtQuestion(q){ const qq=(q||'').toLowerCase(); let best=null, score=0; for(const item of DEBT_KB){ let s=0; item.k.forEach(kw=>{ if(qq.includes(kw)) s++; }); if(s>score){score=s; best=item;} } if(!best) return 'A specialist can provide detailed answers. General info: debt settlement aims to reduce unsecured debt balances.'; return `<strong>${best.q}</strong><br>${best.a}`; }
    function openQAModal(){
      const overlay=document.createElement('div'); overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:60';
      const box=document.createElement('div'); box.style.cssText='background:#fff;width:min(92%,420px);border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(15,23,42,.2)';
      box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Ask a Question</div><button id="qa-close" style="border:none;background:none;font-size:22px;color:#475569;cursor:pointer">×</button></div><div class="muted" style="margin-top:6px">General info only.</div><div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px"><input id="qa-input" class="field" placeholder="Will this hurt my credit?"><button id="qa-ask" class="cta" style="width:auto;padding:10px 14px">Ask</button></div><div id="qa-ans" style="margin-top:10px;font-size:14px;"></div>`;
      overlay.appendChild(box); document.body.appendChild(overlay);
      const ans=box.querySelector('#qa-ans');
      box.querySelector('#qa-close').onclick=()=>overlay.remove();
      box.querySelector('#qa-ask').onclick=()=>{ const v=box.querySelector('#qa-input').value.trim(); if(v) ans.innerHTML=answerDebtQuestion(v); };
    }

    function showOptions(options, onSelect){
      const c=createBaseContainer();
      const btns=options.map(opt=>{const b=document.createElement('button');b.className='btn';b.textContent=opt;b.onclick=()=>finalize(opt);c.appendChild(b);return b;});
      const qaBtn=document.createElement('button');qaBtn.className='btn';qaBtn.textContent=Q_OPTION;qaBtn.onclick=openQAModal;c.appendChild(qaBtn);
      addAbandon(c);
      function finalize(v){ [...btns, qaBtn].forEach(b=>b.disabled=true); onSelect(v); }
      ensureBottom();
    }

    let prefillDebtAmount=null;
    const surveyFlow = {
      start: { message: "Hello! I'm Chloe, an AI assistant for a research study on the debt settlement process. Would you be willing to participate?", type:'multiple-choice', options:["Yes, I'll participate","No, thank you"], action:(a)=> a.startsWith('Yes')? goToStep('qDebtRange'): goToStep('leaveSurvey') },
      leaveSurvey: { message: 'No problem. Thank you for your time.', end:true },
      qDebtRange: { message:'About how much unsecured debt do you have (credit cards, personal loans, etc.)?', type:'multiple-choice', options:['Below $10,000','$10,000–$40,000','$40,000+'], action:(a)=>{ if(a==='Below $10,000') return goToStep('disqualify'); prefillDebtAmount = a==='$10,000–$40,000' ? 25000 : 50000; return goToStep('qIncome'); } },
      qIncome: { message:'Do you have a steady source of income?', type:'multiple-choice', options:['Yes','No'], action:(a)=> a==='Yes'? goToStep('qWilling'): goToStep('disqualify') },
      qWilling: { message:'As part of the study, would you speak with a debt specialist for a free, no-obligation consultation?', type:'multiple-choice', options:['Yes','No'], action:(a)=> a==='Yes'? goToStep('preFormInfo'): goToStep('disqualify') },
      preFormInfo: { message:`
        <strong>Fantastic! You've qualified for the study.</strong>
        <p style="margin-top: 8px; margin-bottom: 8px;">The main part of our research involves having you complete a short, secure form to request a free consultation from a debt specialist. To get genuine feedback, this study is for people who are truly interested in getting help with their debt. We've carefully researched and selected a reputable company, <strong>CuraDebt</strong>, to connect our participants with.</p>
        <p style="margin-top: 8px; margin-bottom: 8px;">A debt settlement service works to negotiate with your creditors to lower the amount you owe. The goal is often to combine your payments into a single, more manageable monthly amount, with a plan to get you out of debt in about 2–4 years.</p>
        <p style="margin-top: 8px; margin-bottom: 8px;">After you submit this form, you may receive a call from a toll free number to connect you to a specialist. Press 1 to be connected to the agent. We will also send an email to confirm your participation. <strong>Please reply to that email to let us know how your call went.</strong></p>
        Are you ready to take the next step?`, type:'multiple-choice', options:["Yes, I'm ready"], action:()=> goToStep('showApiForm') },
      showApiForm: { message:"Excellent! Please complete the secure form below.", type:'api-form' },
      formSuccess: { message:'Thank you! Your information has been sent. Watch for a call from a toll free number and check your email for confirmation.', next:'askToContinueToFeedback' },
      askToContinueToFeedback: { message:'Now for the final step. Ready to provide feedback?', type:'multiple-choice', options:['Yes, Continue to Feedback'], action:()=> goToStep('askForFeedback') },
      askForFeedback: { message:"Please submit your email below. After your consultation, we'll send a reminder to ask how it went.", type:'brevo-form', next:'complete' },
      complete: { message:"That's everything! Thank you for your valuable feedback.", end:true },
      disqualify: { message:"Based on your responses, this study isn't the right fit. Thank you for your time.", end:true }
    };

    function updateProgress(stepKey){ const keys=Object.keys(surveyFlow); progressBar.style.width=`${(keys.indexOf(stepKey)/Math.max(1,keys.length-1))*100}%`; }

    function goToStep(stepKey){
      const step=surveyFlow[stepKey]; if(!step) return; updateProgress(stepKey); setQuestion(step.message);
      if(step.end){ chatInputArea.innerHTML=`<div class="muted" style="text-align:center">You may now close this window.</div>`; return; }
      const action = step.action || (()=>goToStep(step.next));
      if(step.type==='multiple-choice') showOptions(step.options, (val)=>{ addAnswer(val); action(val); ensureBottom(); });
      else if(step.type==='api-form') showApiForm();
      else if(step.type==='brevo-form') showBrevoForm(()=>goToStep(step.next));
      else action();
    }

    function showIntro(){
      chatWindow.innerHTML=''; chatInputArea.innerHTML='';
      const card=document.createElement('div'); card.className='card'; card.style.textAlign='center'; card.style.padding='24px';
      card.innerHTML=`<div style="width:64px;height:64px;margin:0 auto 16px;border-radius:20px;background:linear-gradient(135deg,#6366f1,#a78bfa,#ec4899);display:grid;place-items:center;color:#fff;font-weight:800;font-size:32px;">C</div><h2 style="margin:0 0 8px 0;font-size:22px;">Debt Relief Research Study</h2><div class="muted" style="font-size:15px;max-width:300px;margin:0 auto 16px;">Help us improve the debt settlement process.</div><ul style="text-align:left;max-width:280px;margin:24px auto;padding-left:20px;font-size:14px;color:var(--sub);list-style-type:'✓  '"><li style="margin-bottom:8px;padding-left:8px;">Answer a few quick questions.</li><li style="margin-bottom:8px;padding-left:8px;">Securely verify your information.</li><li style="margin-bottom:8px;padding-left:8px;">Provide optional feedback.</li></ul><button id="begin-btn" class="cta" style="margin-top:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));">Begin Secure Survey</button>`;
      chatWindow.appendChild(card);
      document.getElementById('begin-btn').onclick=()=>{ card.remove(); goToStep('start'); };
      ensureBottom();
    }

    function showApiForm(){
      chatInputArea.innerHTML='';
      chatWindow.innerHTML = '';
      const wrapper=document.createElement('div'); wrapper.className='card';
      wrapper.innerHTML=`
        <div style="text-align:center">
          <div class="label">Select Amount Of Unsecured Debt</div>
          <div id="debtAmountDisplay" class="money">$25,000</div>
          <input id="debtSlider" class="slider" type="range" min="10000" max="100000" value="25000" step="100">
          <div class="help">Move the slider or type the exact amount below.</div>
          <div class="row" style="margin-top:6px"><label class="label" style="align-self:center">Exact Amount</label><input id="debtNumber" class="field" inputmode="numeric"></div>
          <input id="debtHidden" type="hidden">
          <div id="qualifyMsg" class="help" style="color:#ef4444;display:none;">Minimum debt is $10,000 to qualify.</div>
        </div>
        <div class="row" style="margin-top:8px"><input class="field" name="f_fname" placeholder="First Name"><input class="field" name="f_lname" placeholder="Last Name"></div>
        <input class="field" id="f_email" placeholder="Email Address" style="margin-top:8px"><div id="email-hint" class="help"></div>
        <input class="field" id="f_phone" placeholder="Phone Number" style="margin-top:8px"><div id="phone-hint" class="help"></div>
        <div class="otp-row"><button type="button" id="send-otp" class="otp-send">Send Code</button><input id="otp-code" class="field otp-code" placeholder="6-digit code"><button type="button" id="check-otp" class="otp-verify">Verify</button><span id="otp-countdown" class="badge hidden"></span></div>
        <div id="recaptcha-container" style="margin-top:8px;"></div>
        <div id="tf-call-note" class="notice">✅ Number verified. Expect a call from a toll free number.</div>
        <select id="state" class="field" style="margin-top:8px"><option value="" disabled selected>Select Your State</option></select>
        <label style="display:flex;gap:8px;margin-top:8px;font-size:12px;color:#334155"><input id="tcpa" type="checkbox"><span>By clicking Submit, you agree to be contacted by CuraDebt & partners (autodial/texts may be used). Consent not required for purchase.</span></label>
        <button id="submit-btn" class="cta" disabled style="margin-top:10px">Complete All Fields to Submit</button>
        <div id="form-error" style="color:#b91c1c;text-align:center;font-weight:600;display:none;margin-top:6px"></div>
      `;
      chatWindow.appendChild(wrapper);
      requestAnimationFrame(()=>{ const y=wrapper.offsetTop-qbar.offsetHeight-8; scrollBox.scrollTop=Math.max(0,y); updateSticky(); });

      const allStates=["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"]; 
      const excluded=['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','RI']; 
      const stateSel=wrapper.querySelector('#state'); 
      allStates.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSel.appendChild(o); });

      const debtSlider=document.getElementById('debtSlider'), debtNumber=document.getElementById('debtNumber');
      const debtAmountDisplay=document.getElementById('debtAmountDisplay'), debtHidden=document.getElementById('debtHidden');
      const qualifyMsg=document.getElementById('qualifyMsg');
      const toInt=(v)=>parseInt(String(v||'').replace(/\D/g,''),10)||0;
      const fmtMoney=(n)=>`$${n.toLocaleString('en-US')}`;
      let otpVerified=false;

      const updateSubmitButton=()=>{
        const v=toInt(debtHidden.value), consent=document.getElementById('tcpa').checked;
        const stateOK=stateSel.value&&!excluded.includes(stateSel.value);
        const ready=v>=10000&&consent&&stateOK&&otpVerified;
        const btn=document.getElementById('submit-btn'); btn.disabled=!ready;
        btn.textContent=ready?'Submit':(otpVerified?'Complete All Fields':'Verify Your Phone');
      };

      const syncDebtUI=(val)=>{
        const v=toInt(val); 
        if(v > 0) {
            debtHidden.value=v;
            debtSlider.value=v;
            debtAmountDisplay.textContent=v>=100000?`${fmtMoney(v)}+`:fmtMoney(v);
        }
        qualifyMsg.style.display=v<10000?'block':'none';
      };
      
      debtSlider.addEventListener('input',()=>{debtNumber.value=debtSlider.value;syncDebtUI(debtSlider.value);});
      debtNumber.addEventListener('input',()=>{syncDebtUI(debtNumber.value);});
      debtNumber.addEventListener('blur',()=>{const v=Math.max(10000,Math.min(100000,toInt(debtNumber.value)));debtNumber.value=v.toLocaleString('en-US');syncDebtUI(v);});
      
      const initialDebt = prefillDebtAmount || 25000;
      syncDebtUI(initialDebt);
      debtNumber.value = initialDebt.toLocaleString('en-US');
      
      ['f_fname','f_lname','f_email','state','tcpa'].forEach(id => wrapper.querySelector(`#${id}, [name='${id}']`)?.addEventListener('change', updateSubmitButton));

      const phone=wrapper.querySelector('#f_phone'), pHint=wrapper.querySelector('#phone-hint');
      const isUSPhone=(v)=>/(^\+?1?[2-9]\d{2}[2-9]\d{6}$)|(^\(?[2-9]\d{2}\)?[-. ]?[2-9]\d{2}[-. ]?[2-9]\d{4}$)/.test(v);
      const toE164US=(v)=>{const d=(v||'').replace(/\D/g,'');return`+${d.startsWith('1')?d:'1'+d}`;};
      phone.onblur=()=>{pHint.textContent=isUSPhone(phone.value)?'OK':'Invalid US number';};
      
      const sendOtpBtn=wrapper.querySelector('#send-otp'),codeInput=wrapper.querySelector('#otp-code');
      const verifyBtn=wrapper.querySelector('#check-otp'),callNote=wrapper.querySelector('#tf-call-note');
      const countdown=wrapper.querySelector('#otp-countdown'),formError=wrapper.querySelector('#form-error');
      let confirmationResult=null, resendTimer=null;
      
      function setFormError(msg){formError.textContent=msg;formError.style.display=msg?'block':'none';}
      function setVerifiedUI(){otpVerified=true;callNote.style.display='block';[verifyBtn,sendOtpBtn,codeInput].forEach(el=>el.disabled=true);sendOtpBtn.textContent='Verified';updateSubmitButton();}
      function startResendCountdown(sec=60){let s=sec;countdown.classList.remove('hidden');countdown.textContent=`${s}s`;sendOtpBtn.disabled=true;resendTimer&&clearInterval(resendTimer);resendTimer=setInterval(()=>{s--;countdown.textContent=`${s}s`;if(s<=0){clearInterval(resendTimer);countdown.classList.add('hidden');sendOtpBtn.disabled=false;sendOtpBtn.textContent='Resend';}},1000);}

      function initializeRecaptcha() {
          if (fb && !PREVIEW_MODE) {
              try {
                  if (window.recaptchaVerifier) window.recaptchaVerifier.clear();
                  window.recaptchaVerifier = new fb.RecaptchaVerifier('recaptcha-container', {
                      'size': 'invisible',
                  }, fb.auth);
                  window.recaptchaVerifier.render();
              } catch(e) {
                  console.error("reCAPTCHA verifier error", e);
                  setFormError("Could not initialize phone verification.");
              }
          }
      }
      initializeRecaptcha();

      async function sendOtp(){
        setFormError('');if(!isUSPhone(phone.value.trim())){pHint.textContent='Enter valid US number.';return;}
        sendOtpBtn.textContent='Sending...';sendOtpBtn.disabled=true;
        try{
          confirmationResult=await fb.signInWithPhoneNumber(fb.auth, toE164US(phone.value), window.recaptchaVerifier);
          sendOtpBtn.textContent='Sent!';startResendCountdown(60);codeInput.focus();
        }catch(err){console.error(err);setFormError('Failed to send. Please check the domain authorization in your Firebase console.');sendOtpBtn.textContent='Send Code';sendOtpBtn.disabled=false;initializeRecaptcha();}
      }
      async function verifyOtp(){
        setFormError('');if(codeInput.value.length!==6)return;
        try{verifyBtn.textContent='Verifying...';verifyBtn.disabled=true;await confirmationResult.confirm(codeInput.value);setVerifiedUI();}
        catch(err){setFormError('Invalid code.');verifyBtn.textContent='Verify';verifyBtn.disabled=false;}
      }
      function previewOtp(){if(!isUSPhone(phone.value))return;startResendCountdown(10);codeInput.focus();}
      
      sendOtpBtn.onclick=(fb&&!PREVIEW_MODE)?sendOtp:previewOtp;
      verifyBtn.onclick=(fb&&!PREVIEW_MODE)?verifyOtp:()=>{if(codeInput.value.length===6)setVerifiedUI();};
      codeInput.addEventListener('input',()=>{if(codeInput.value.length===6)verifyBtn.click();});
      
      stateSel.onchange=updateSubmitButton;document.getElementById('tcpa').onchange=updateSubmitButton;
      document.getElementById('submit-btn').onclick=(e)=>{e.preventDefault();if(e.currentTarget.disabled)return;addAnswer('Form submitted');goToStep('formSuccess');};
      
      chatInputArea.innerHTML='';addAbandon(chatInputArea);
    }
    
    function showBrevoForm(onContinue) {
      chatInputArea.innerHTML = ''; const box = document.createElement('div'); box.className = 'card';
      box.innerHTML = `<div class="sib-form" style="text-align: center; background-color: #EFF2F7;"><div id="sib-form-container" class="sib-form-container"><div id="error-message" class="sib-form-message-panel" style="font-size:16px; text-align:left; font-family:Helvetica, sans-serif; color:#661d1d; background-color:#ffeded; border-radius:3px; border-color:#ff4949;max-width:540px; display: none;"><div class="sib-form-message-panel__text sib-form-message-panel__text--center"><svg viewBox="0 0 512 512" class="sib-icon sib-notification__icon"><path d="M256 40c118.621 0 216 96.075 216 216 0 119.291-96.61 216-216 216-119.244 0-216-96.562-216-216 0-119.203 96.602-216 216-216m0-32C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm-11.49 120h22.979c6.823 0 12.274 5.682 11.99 12.5l-7 168c-.268 6.428-5.556 11.5-11.99 11.5h-8.979c-6.433 0-11.722-5.073-11.99-11.5l-7-168c-.283-6.818 5.167-12.5 11.99-12.5zM256 340c-15.464 0-28 12.536-28 28s12.536 28 28 28 28-12.536 28-28-12.536-28-28-28z" /></svg><span class="sib-form-message-panel__inner-text">Your subscription could not be saved. Please try again.</span></div></div><div id="success-message" class="sib-form-message-panel" style="font-size:16px; text-align:left; font-family:Helvetica, sans-serif; color:#085229; background-color:#e7faf0; border-radius:3px; border-color:#13ce66;max-width:540px; display: none;"><div class="sib-form-message-panel__text sib-form-message-panel__text--center"><svg viewBox="0 0 512 512" class="sib-icon sib-notification__icon"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 464c-118.664 0-216-96.055-216-216 0-118.663 96.055-216 216-216 118.664 0 216 96.055 216 216 0 118.663-96.055 216-216 216zm141.63-274.961L217.15 376.071c-4.705 4.667-12.303 4.637-16.97-.068l-85.878-86.572c-4.667-4.705-4.637-12.303.068-16.97l8.52-8.451c4.705-4.667 12.303-4.637 16.97.068l68.976 69.533 163.441-162.13c4.705-4.667 12.303-4.637 16.97.068l8.451 8.52c4.668 4.705 4.637 12.303-.068 16.97z" /></svg><span class="sib-form-message-panel__inner-text">Your subscription has been successful.</span></div></div><div id="sib-container" class="sib-container--large sib-container--vertical" style="text-align:center; background-color:rgba(255,255,255,1); max-width:540px; border-radius:3px; border-width:1px; border-color:#C0CCD9; border-style:solid; direction:ltr"><form id="sib-form" method="POST" action="https://52bcaf92.sibforms.com/serve/MUIFAHSjC575kZdZLR2gfSVZufZJVTER1M1nuoDMmZYuekIjSqJaRvFM7Ln7hSu09BNb5nCYVsyDbBVG1y2AXDx_uEbwMcrpxmZS2-I4v_tUd0gEcT4HG09KEOIJHZCK_MYSYxabHwoz8a34msSuKYk2uuxSJF7uFPo5nSAprH7fNsCGXdYj0jOePAFZlz7nR4dwm7Sy0s-kgYBy" data-type="subscription"><div style="padding: 8px 0;"><div class="sib-form-block" style="font-size:32px; text-align:left; font-weight:700; font-family:Helvetica, sans-serif; color:#3C4858; background-color:transparent;"><p>Survey Feedback</p></div></div><div style="padding: 8px 0;"><div class="sib-form-block" style="font-size:16px; text-align:left; font-family:Helvetica, sans-serif; color:#3C4858; background-color:transparent;"><div class="sib-text-form-block"><p>Please provide your email to receive a reminder for the feedback of the survey</p></div></div></div><div style="padding: 8px 0;"><div class="sib-input sib-form-block"><div class="form__entry entry_block"><div class="form__label-row "><label class="entry__label" style="font-weight: 700; font-size:16px; font-family:Helvetica, sans-serif; color:#3c4858;" for="EMAIL" data-required="*">Enter your email address</label><div class="entry__field"><input class="input " type="text" id="EMAIL" name="EMAIL" autocomplete="off" placeholder="EMAIL" data-required="true" required /></div></div><label class="entry__error entry__error--primary"></label><label class="entry__specification" style="font-size:12px; font-family:Helvetica, sans-serif; color:#8390A4;">Provide your email address to subscribe. For e.g abc@xyz.com</label></div></div></div><div style="padding: 8px 0;"><div class="sib-optin sib-form-block"><div class="form__entry entry_mcq"><div class="form__label-row "><div class="entry__choice"><label><input type="checkbox" class="input_replaced" value="1" id="OPT_IN" name="OPT_IN" /><span class="checkbox checkbox_tick_positive"></span><span style="font-size:14px; font-family:Helvetica, sans-serif; color:#3C4858;"><p>I agree to receive your email and accept the data privacy statement.</p></span></label></div></div><label class="entry__error entry__error--primary"></label><label class="entry__specification" style="font-size:12px; font-family:Helvetica, sans-serif; color:#8390A4;">You may unsubscribe at any time using the link in our newsletter.</label></div></div></div><div style="padding: 8px 0;"><div class="sib-form-block" style="text-align: left"><button class="sib-form-block__button sib-form-block__button-with-loader" style="font-size:16px; font-weight:700; font-family:Helvetica, sans-serif; color:#FFFFFF; background-color:#3E4857; border-radius:3px; border-width:0px;" form="sib-form" type="submit"><svg class="icon clickable__icon progress-indicator__icon sib-hide-loader-icon" viewBox="0 0 512 512"><path d="M460.116 373.846l-20.823-12.022c-5.541-3.199-7.54-10.159-4.663-15.874 30.137-59.886 28.343-131.652-5.386-189.946-33.641-58.394-94.896-95.833-161.827-99.676C261.028 55.961 256 50.751 256 44.352V20.309c0-6.904 5.808-12.337 12.703-11.982 83.556 4.306 160.163 50.864 202.11 123.677 42.063 72.696 44.079 162.316 6.031 236.832-3.14 6.148-10.75 8.461-16.728 5.01z" /></svg>SUBMIT</button></div></div><input type="text" name="email_address_check" value="" class="input--hidden"><input type="hidden" name="locale" value="en"></form></div></div></div>`;
      const brevoScript = document.createElement('script'); brevoScript.defer = true; brevoScript.src = "https://sibforms.com/forms/end-form/build/main.js";
      chatWindow.appendChild(box); document.body.appendChild(brevoScript);
      requestAnimationFrame(()=>{ const y=box.offsetTop-qbar.offsetHeight-8; scrollBox.scrollTop=Math.max(0,y); updateSticky(); });
      const btn = document.createElement('button'); btn.className = 'cta'; btn.style.marginTop = '10px'; btn.textContent = "I've Submitted My Feedback"; btn.disabled = true;
      btn.onclick = () => onContinue();
      chatInputArea.appendChild(btn); addAbandon(chatInputArea);
      const successMessage = box.querySelector('#success-message');
      if(successMessage) { new MutationObserver(() => { if (successMessage.style.display !== 'none') btn.disabled = false; }).observe(successMessage, { attributes: true, attributeFilter: ['style'] }); }
    }

    showIntro(); updateProgressBar();
  </script>
</body>
</html>



