<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Debt Settlement Survey — Chloe (Production)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html,body{ height:100%; }
    body{ font-family: 'Inter', sans-serif; background:#f6f7fb; color:#0f172a; }
    body::before{ content:""; position:fixed; inset:-10vmax; pointer-events:none; background:
      radial-gradient(60vmax 60vmax at 10% -10%, rgba(165,180,252,.45), transparent 60%),
      radial-gradient(70vmax 70vmax at 110% 10%, rgba(251,207,232,.35), transparent 60%),
      radial-gradient(80vmax 80vmax at 50% 120%, rgba(191,219,254,.30), transparent 60%);
      filter: blur(20px) saturate(120%); z-index:-2; }
    body::after{ content:""; position:fixed; inset:0; pointer-events:none; z-index:-1; background-image: url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">\
        <path d="M0 31h32" stroke="rgba(0,0,0,.035)"/>\
        <path d="M31 0v32" stroke="rgba(0,0,0,.035)"/>\
      </svg>'); background-size: 32px 32px; opacity:.9; }

    .glass{ background: rgba(255,255,255,.78); backdrop-filter: blur(12px) saturate(140%); }
    .glass-border{ position:relative; }
    .glass-border::before{ content:""; position:absolute; inset:0; padding:1px; border-radius:1.5rem; pointer-events:none; background: linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.3)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }

    .bubble-bot{ background: linear-gradient(90deg, #eef2ff, #fae8ff, #ecfeff); color:#0f172a; border:1px solid rgba(15,23,42,.06); }
    .bubble-user{ background: #f1f5f9; color:#0f172a; border:1px solid rgba(15,23,42,.06); }
    .chat-bubble { animation: pop-in 0.22s ease-out; word-wrap: break-word; }
    @keyframes pop-in { 0% { transform: translateY(4px) scale(.98); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }

    /* Scroll area */
    #scroll-box::-webkit-scrollbar{ width:10px; }
    #scroll-box::-webkit-scrollbar-thumb{ background: #e5e7eb; border-radius:9999px; border:3px solid transparent; background-clip:padding-box; }

    /* Range aesthetics (robust) */
    input[type=range].slider{ -webkit-appearance:none; appearance:none; width:100%; background:transparent; height:34px; position:relative; z-index:1; touch-action: pan-y; pointer-events:auto; }
    input[type=range].slider::-webkit-slider-runnable-track{ height:8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); border-radius: 9999px; }
    input[type=range].slider::-webkit-slider-thumb{ -webkit-appearance:none; height: 24px; width:24px; border-radius:50%; background: linear-gradient(135deg, #818cf8, #a78bfa); margin-top:-8px; border: 3px solid white; box-shadow: 0 6px 20px rgba(99,102,241,.35); }
    input[type=range].slider::-moz-range-track{ height:8px; background: linear-gradient(90deg, #e5e7eb, #d1d5db); border-radius:9999px; }
    input[type=range].slider::-moz-range-thumb{ height:24px; width:24px; border-radius:50%; background: linear-gradient(135deg, #818cf8, #a78bfa); border:3px solid white; box-shadow: 0 6px 20px rgba(99,102,241,.35); }

    .safe-bottom{ padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
    .progress-dot{ height:10px; width:10px; border-radius:9999px; box-shadow: 0 0 0 4px rgba(34,197,94,.15); }
    .loader { border: 2px solid #cbd5e1; border-top: 2px solid #6366f1; border-radius: 9999px; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="mx-auto max-w-md px-4 py-8 md:py-12">
    <div class="glass-border rounded-3xl">
      <div class="glass rounded-3xl border border-black/5 shadow-2xl overflow-hidden flex flex-col h-[85vh]">
        <!-- Header -->
        <header class="bg-gradient-to-b from-white to-white/40 px-5 py-4 border-b border-black/5">
          <div class="flex items-center gap-3">
            <div class="relative">
              <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-500 via-violet-500 to-fuchsia-500 grid place-items-center font-extrabold text-white">C</div>
              <span class="absolute -right-0 -bottom-0 progress-dot bg-emerald-500"></span>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h2 class="text-base font-semibold tracking-tight">Chloe</h2>
                <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-700 border border-emerald-500/30">online</span>
              </div>
              <p class="text-[11px] text-slate-600">AI Research Assistant · Debt Settlement Feedback Study</p>
            </div>
            <div class="text-xs text-slate-500 hidden sm:block">Secure</div>
          </div>
        </header>

        <!-- Progress -->
        <div class="px-5 pb-3 pt-2">
          <div class="w-full h-2 rounded-full bg-slate-200 overflow-hidden">
            <div id="progress-bar" class="h-2 w-0 bg-gradient-to-r from-indigo-500 via-violet-500 to-fuchsia-500 transition-all duration-500"></div>
          </div>
        </div>

        <!-- Scroll area with sticky/movable question bar -->
        <div class="relative flex-1 overflow-hidden">
          <div id="scroll-box" class="absolute inset-0 overflow-y-auto">
            <div id="question-bar" class="px-5 py-3 bg-white/80 border-y border-black/5">
              <div class="text-[11px] uppercase tracking-wider text-slate-500">Question</div>
              <div id="q-text" class="text-sm font-semibold text-slate-900"></div>
              <div id="q-hint" class="text-[11px] text-slate-500 mt-1 hidden">Scroll to the end to continue</div>
            </div>
            <div id="chat-window" class="px-4 pb-6 space-y-3">
              <div class="pointer-events-none sticky top-0 -mt-3 h-6 bg-gradient-to-b from-white to-transparent"></div>
            </div>
          </div>
        </div>

        <!-- Controls -->
        <footer id="chat-input-area" class="safe-bottom px-4 pt-2 pb-4 bg-gradient-to-t from-white via-white/70 to-transparent border-t border-black/5"></footer>
      </div>
    </div>
  </div>

  <!-- Hidden background POST (CORS-safe) -->
  <iframe name="hidden_post_target" style="display:none;"></iframe>
  <iframe name="hidden_td_target" style="display:none;"></iframe>

  <!-- Hidden CuraDebt POST -->
  <form id="hidden-curadebt-post" action="https://signup.curadebt.com/apkconnect/" method="POST" target="hidden_post_target" style="display:none;">
    <input name="f_fname"><input name="f_lname"><input name="f_email"><input name="f_phone"><input name="f_whereyoulive"><input name="f_totaldebt">
    <input name="f_comments" value="Lead from AI Chatbot Survey"><input name="data1"><input name="data2" value="CLICKID2"><input name="f_ip">
  </form>

  <!-- Hidden TrackDrive POST (Lead-to-Call) -->
  <form id="hidden-trackdrive-post" action="https://curadebt.trackdrive.com/api/v1/leads" method="POST" target="hidden_td_target" style="display:none;">
    <input name="lead_token" value="3346b0458309406ba4b8beac90a8a532"><input name="traffic_source_id" value="1000"><input name="caller_id"><input name="call_now" value="1">
    <input name="first_name"><input name="last_name"><input name="email"><input name="state"><input name="zip"><input name="ip_address"><input name="source_url"><input name="useragent"><input name="original_lead_submit_date"><input name="tcpa_opt_in"><input name="tcpa_optin_consent_language"><input name="sub_id"><input name="gclid"><input name="fbeventid"><input name="msclkid"><input name="traffic_source_lead_id">
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBF5wdHyOlOi_bntJHXto7f6RbJMkOdMSE", authDomain: "otp-c6311.firebaseapp.com", projectId: "otp-c6311", storageBucket: "otp-c6311.firebasestorage.app", messagingSenderId: "637495517002", appId: "1:637495517002:web:7bd220994a7611a5606bb3" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app);

    const scrollBox = document.getElementById('scroll-box');
    const chatWindow = document.getElementById('chat-window');
    const chatInputArea = document.getElementById('chat-input-area');
    const progressBar = document.getElementById('progress-bar');
    const qbar = document.getElementById('question-bar');
    const qtext = document.getElementById('q-text');
    const qhint = document.getElementById('q-hint');

    let currentStepKey = 'start'; let transactionId = ''; let clientIp = '';
    window.otpOK = false; let confirmationResult = null;
    let prefillDebtAmount = null; // set by debt range

    const allStates = ["AK","AL","AR","AS","AZ","CA","CO","CT","DC","DE","FL","GA","GU","HI","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","ND","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","PR","RI","SC","SD","TN","TX","UT","VA","VI","VT","WA","WI","WV","WY"];
    const excludedStates = ['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','RI'];

    const VALIDATE_ENDPOINT = "https://silent-sea-a717.kasindeesther.workers.dev/";
    const VALIDATE_EMAIL_ENDPOINT = "https://solitary-base-4a8b.kasindeesther.workers.dev/";

    // === Ask Chloe (Debt Relief) ===
    const Q_OPTION = "I have a question about debt relief";
    const DEBT_KB = [
      { q: 'What is debt settlement and how does it work?', a: 'Debt settlement is a negotiation process where a company (or you) asks creditors/collectors to accept less than the full balance as payment in full. You typically make one monthly deposit into a dedicated account. When enough funds accrue, settlements are negotiated one by one. Programs commonly run ~24–48 months. It is not a loan.', k: ['what is debt settlement','how works','negotiate','reduce balance','process','program'] },
      { q: 'Which debts qualify?', a: 'Usually eligible: unsecured debts such as credit cards, personal loans, medical bills, collections, store cards, some payday loans. Not eligible: secured debts (auto, mortgage), child support, alimony, most taxes; federal student loans are generally excluded (different options apply).', k: ['qualify','eligible','unsecured','secured','medical','credit cards','personal loans','collections','payday','student'] },
      { q: 'How long does a program take?', a: 'Many programs last ~24–48 months. Timeline varies by total debt, monthly deposit, creditor behavior, and the order/size of settlements.', k: ['how long','duration','time','months','years','timeline'] },
      { q: 'How does it affect my credit?', a: 'Expect a short‑term drop in credit score. Enrolled accounts may become or remain delinquent during negotiations; settled accounts report as “settled for less.” Many people rebuild credit 6–24 months after completion with on‑time payments and low utilization.', k: ['credit','score','fico','impact','report'] },
      { q: 'What fees are charged?', a: 'Reputable companies charge performance‑based fees earned only after you approve a settlement. Effective fees vary (often ~15–25% of enrolled debt, provider/state dependent). You should receive a clear fee schedule.', k: ['fees','cost','charge','pricing'] },
      { q: 'Taxes on forgiven debt', a: 'Forgiven debt may be reported on IRS Form 1099‑C and could be taxable income. The insolvency exclusion may reduce/eliminate the tax in some cases. Consult a tax professional for advice.', k: ['tax','irs','1099','1099-c','insolvency'] },
      { q: 'Legal risks', a: 'There is a risk a creditor/collector could sue on delinquent accounts. Programs monitor for this and discuss options. If served, respond promptly and consider local legal counsel.', k: ['sue','lawsuit','legal'] },
      { q: 'Debt management vs settlement', a: 'Debt management plans (credit counseling) consolidate payments and usually reduce interest but repay 100% of principal. Settlement aims to reduce principal owed. Each has trade‑offs.', k: ['dmp','credit counseling','compare'] },
      { q: 'Bankruptcy vs settlement', a: 'Bankruptcy (Chapter 7/13) may be faster/cheaper for some, but with different legal/credit effects. Legal advice is best for bankruptcy questions.', k: ['bankruptcy','chapter 7','chapter 13'] },
      { q: 'After program / rebuild', a: 'After finishing, settled items remain on reports but age; many rebuild within 6–24 months with on‑time payments and responsible use.', k: ['after program','rebuild'] },
    ];
    function answerDebtQuestion(q){ const qq=(q||'').toLowerCase(); let best=DEBT_KB[0], score=-1; for(const item of DEBT_KB){ let s=0; (item.k||[]).forEach(kw=>{ if(qq.includes(kw)) s+=3; }); qq.split(/[^a-z0-9]+/g).forEach(t=>{ if(item.q.toLowerCase().includes(t)) s+=1; }); if(s>score){ score=s; best=item; } } return score<=0? "Debt settlement negotiates down unsecured debts using one monthly deposit; programs typically last 24–48 months. It can lower credit short‑term and may have tax/legal considerations. A specialist can compare this with credit counseling or bankruptcy. General info only." : `<strong>${best.q}</strong><br>${best.a}`; }
    function openQAModal(onClose){ const overlay=document.createElement('div'); overlay.className='fixed inset-0 bg-black/30 flex items-center justify-center z-[60]'; const box=document.createElement('div'); box.className='bg-white w-[92%] max-w-md rounded-2xl shadow-xl border border-slate-200 p-4'; box.innerHTML=`<div class='flex items-start justify-between'><h3 class='text-lg font-bold'>Ask Chloe about Debt Relief</h3><button id='qa-close' class='text-slate-500 hover:text-slate-700' aria-label='Close'>&times;</button></div><p class='text-xs text-slate-500 mt-1'>General information — not legal/tax advice.</p><div class='mt-3 grid grid-cols-1 sm:grid-cols-5 gap-2'><input id='qa-input' class='sm:col-span-4 bg-white border border-slate-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500/60' placeholder='e.g., Will this hurt my credit?' /><button id='qa-ask' class='sm:col-span-1 px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-white text-sm shadow'>Ask</button></div><div id='qa-ans' class='mt-3 text-sm text-slate-800'></div>`; overlay.appendChild(box); document.body.appendChild(overlay); const ans=box.querySelector('#qa-ans'); const close=()=>{ overlay.remove(); if(typeof onClose==='function') onClose(); }; box.querySelector('#qa-close').addEventListener('click', close); box.querySelector('#qa-ask').addEventListener('click', ()=>{ const v=String(box.querySelector('#qa-input').value||'').trim(); if(!v) return; ans.innerHTML=answerDebtQuestion(v); }); box.querySelector('#qa-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); box.querySelector('#qa-ask').click(); }}); }

    // Sticky behavior: stick only when near bottom
    function isAtBottom(){ return scrollBox.scrollHeight - (scrollBox.scrollTop + scrollBox.clientHeight) < 16; }
    function updateSticky(){ const stick=isAtBottom(); qbar.classList.toggle('sticky', stick); qbar.classList.toggle('top-0', stick); qbar.classList.toggle('shadow-sm', stick); }
    scrollBox.addEventListener('scroll', updateSticky, {passive:true});
    function ensureBottom(){ requestAnimationFrame(()=>{ scrollBox.scrollTop = scrollBox.scrollHeight; updateSticky(); }); }

    function createBaseContainer(){ chatInputArea.innerHTML=''; const c=document.createElement('div'); c.className='sticky bottom-0 w-full safe-bottom pt-2'; return c; }
    function setQuestion(text){ qtext.className='text-sm text-slate-900'; qtext.innerHTML = text || ''; const shouldGate = (text && text.replace(/<[^>]+>/g,'').length > 380); qtext.dataset.gated = shouldGate ? '1' : '0'; qtext.dataset.scrolled = shouldGate ? '0' : '1'; if(shouldGate){ qtext.classList.add('max-h-60','overflow-y-auto','pr-2','leading-relaxed'); qtext.classList.remove('font-semibold'); qhint.classList.remove('hidden'); } else { qtext.classList.add('font-semibold'); qhint.classList.add('hidden'); } updateSticky(); }
    function addAnswer(text){ if(!text) return; const el=document.createElement('div'); el.className='chat-bubble flex items-end gap-2 justify-end'; const bubble=document.createElement('div'); bubble.className='px-4 py-3 rounded-2xl text-sm shadow ring-1 bubble-user'; bubble.textContent=text; el.appendChild(bubble); chatWindow.appendChild(el); }
    function addAbandon(container){ const abandon=document.createElement('button'); abandon.type='button'; abandon.className='block mx-auto mt-2 text-rose-600 hover:text-rose-700 text-xs'; abandon.textContent='Abandon Survey'; abandon.addEventListener('click',()=>{ goToStep('leaveSurvey'); }); container.appendChild(abandon); }

    function showOptions(options, onSelect){
      const c=createBaseContainer();
      const oc=document.createElement('div'); oc.className='flex flex-col gap-2 px-1'; c.appendChild(oc);
      const btns=[]; const finalize=v=>{ btns.forEach(b=>{b.disabled=true;b.classList.add('opacity-60','cursor-not-allowed');}); onSelect(v); };

      options.forEach((t)=>{ const b=document.createElement('button'); b.type='button'; b.className='w-full px-4 py-3 rounded-full font-semibold text-sm shadow-sm ring-1 transition bg-white hover:bg-slate-50 text-slate-900 ring-slate-200 border border-slate-200 text-left'; b.textContent=t; b.addEventListener('click',()=>finalize(t)); oc.appendChild(b); btns.push(b); });

      // Q&A always present and enabled
      const qaBtn=document.createElement('button'); qaBtn.type='button'; qaBtn.dataset.role='qa'; qaBtn.className='w-full px-4 py-3 rounded-full font-semibold text-sm shadow-sm ring-1 transition bg-white hover:bg-slate-50 text-slate-900 ring-slate-200 border border-slate-200 text-left'; qaBtn.textContent=Q_OPTION; qaBtn.addEventListener('click',()=>{ openQAModal(()=>{ showOptions(options, onSelect); }); }); oc.appendChild(qaBtn); btns.push(qaBtn);

      addAbandon(c);
      chatInputArea.appendChild(c);
      if(btns[0]) btns[0].focus();

      // Gate primary buttons until long message scrolled to end; QA button stays enabled
      const gateIfNeeded=()=>{ const gated = qtext.dataset.gated==='1'; const ok = qtext.dataset.scrolled==='1'; const disable = gated && !ok; btns.forEach(b=>{ const isQA=b.dataset.role==='qa'; b.disabled = disable && !isQA; b.classList.toggle('opacity-60', b.disabled); b.classList.toggle('cursor-not-allowed', b.disabled); }); };
      gateIfNeeded();
      qtext.addEventListener('scroll', ()=>{ if(qtext.scrollTop + qtext.clientHeight >= qtext.scrollHeight - 4){ qtext.dataset.scrolled='1'; qhint.classList.add('hidden'); gateIfNeeded(); } }, {passive:true});

      ensureBottom();
    }

    // Validators (same strict rules as your original)
    const digitsOnly = s => String(s||'').replace(/\D+/g,'');
    function parseStrictNANP(raw){ const d=digitsOnly(raw); const m=d.match(/^1?([2-9]\d{2})([2-9]\d{2})(\d{4})$/); if(!m) return { ok:false, error:'Enter a valid US number (NANP).' }; const [,area,prefix,line]=m; if(/^[2-9]11$/.test(area)||/^[2-9]11$/.test(prefix)) return { ok:false, error:'N11 service codes are invalid.' }; if(area==='900') return { ok:false, error:'Premium-rate (900) not accepted.' }; if(prefix==='555'&&/^01\d{2}$/.test(line)) return { ok:false, error:'555-01xx test numbers not accepted.' }; const ten=area+prefix+line; if(/^(\d)\1{9}$/.test(ten)) return { ok:false, error:'Invalid pattern (all digits identical).' }; const seq='0123456789'.repeat(3), rseq='9876543210'.repeat(3); if(seq.includes(ten)||rseq.includes(ten)) return { ok:false, error:'Invalid pattern (sequential digits).' }; const TOLL_FREE=new Set(['800','833','844','855','866','877','888','822']); return { ok:true, e164:`+1${area}${prefix}${line}`, meta:{ tollFree:TOLL_FREE.has(area) } } }
    async function validatePhoneWithSignalWire(raw){ const strict=parseStrictNANP(raw); if(!strict.ok) return strict; try{ const r=await fetch(VALIDATE_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:strict.e164})}); const j=await r.json(); if(!j.ok) return {ok:false,error:j.error||'Validation failed.'}; return {...j,e164:strict.e164,meta:{...(strict.meta||{})}}; }catch{ return { ok:true, e164: strict.e164, meta: strict.meta||{} }; } }
    const ROLE_LOCALS=new Set(['admin','administrator','root','support','help','helpdesk','info','contact','sales','marketing','billing','accounts','accounting','abuse','postmaster','webmaster','no-reply','noreply','donotreply','security','compliance','legal','test']);
    const FREEMAIL=new Set(['gmail.com','googlemail.com','yahoo.com','ymail.com','rocketmail.com','outlook.com','hotmail.com','live.com','msn.com','icloud.com','me.com','proton.me','aol.com','mail.com']);
    const DOMAIN_TYPO_MAP={'gamil.com':'gmail.com','gmial.com':'gmail.com','gmai.com':'gmail.com','gmail.con':'gmail.com','yahoo.con':'yahoo.com','yhoo.com':'yahoo.com','hotnail.com':'hotmail.com','hotmial.com':'hotmail.com','outlok.com':'outlook.com','outllok.com':'outlook.com','icloud,com':'icloud.com','protonn.me':'proton.me'};
    function strictEmailClient(raw){ const email=String(raw||'').trim(); const at=email.indexOf('@'); if(at<1||at===email.length-1) return {ok:false,error:'Enter a valid email address.'}; const local=email.slice(0,at), domain=email.slice(at+1).toLowerCase(); if(local.length<3||local.length>64) return {ok:false,error:'Email local part length is invalid.'}; if(domain.length<4||domain.length>255) return {ok:false,error:'Email domain length is invalid.'}; if(!/^[A-Za-z0-9](?:[A-Za-z0-9._%'+\-]{0,62}[A-Za-z0-9])?$/.test(local)) return {ok:false,error:'Invalid characters in email.'}; if(local.includes('..')) return {ok:false,error:'Email local has consecutive dots.'}; if(!/[A-Za-z]/.test(local)) return {ok:false,error:'Email must contain letters.'}; if((local.match(/\./g)||[]).length>2) return {ok:false,error:'Too many dots in email local.'}; if(domain.indexOf('.')<1) return {ok:false,error:'Email domain must contain a dot.'}; const labels=domain.split('.'); for(const lab of labels){ if(lab.length<1||lab.length>63) return {ok:false,error:'Email domain label length is invalid.'}; if(!/^[A-Za-z0-9-]+$/.test(lab)) return {ok:false,error:'Email domain contains invalid chars.'}; if(lab.startsWith('-')||lab.endsWith('-')) return {ok:false,error:'Domain label cannot start/end with -.'}; } const tld=labels[labels.length-1]; if(tld.length<2||tld.length>63) return {ok:false,error:'Email TLD invalid.'}; if(/^\d+$/.test(tld)) return {ok:false,error:'Email TLD cannot be all digits.'}; if(tld==='con') return {ok:false,error:'TLD looks mistyped (.con). Did you mean .com?'}; const info={ role:ROLE_LOCALS.has(local.toLowerCase()), plusAnywhere:local.includes('+'), gmailDot:(domain==='gmail.com'||'googlemail.com')&&local.includes('.'), freemail:FREEMAIL.has(domain) }; return { ok:true, normalized:`${local}@${domain}`, info, suggestion: DOMAIN_TYPO_MAP[domain]||null } }
    async function validateEmailWithWorker(raw){ const base=strictEmailClient(raw); if(!base.ok) return base; try{ const r=await fetch(VALIDATE_EMAIL_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ email: base.normalized, want_mx:true })}); const j=await r.json(); if(!j.ok) return { ok:false, error:j.error||'Email validation failed.' }; return { ok:true, normalized: base.normalized, disposable: !!j.disposable, has_mx: typeof j.has_mx==='boolean'? j.has_mx: undefined, suggestion: j.suggestion||base.suggestion||null, info: base.info }; }catch{ return base; } }

    // === Survey flow ===
    const surveyFlow = {
      start: { message: "Hello! I'm Chloe, an AI assistant for a research study. We're gathering feedback from people to better understand the debt settlement process. Would you be willing to participate?", type: "multiple-choice", options: ["Yes, I'll participate", "No, thank you"], action: (a) => (a === "Yes, I'll participate" ? goToStep("qDebtRange") : goToStep("leaveSurvey")) },
      leaveSurvey: { message: "No problem at all. Thank you for your time. You will now be redirected.", end: true, status: 18 },
      qDebtRange: { message: "About how much unsecured debt do you have? (credit cards, personal loans, medical bills, etc.)", type: "multiple-choice", options: ["Below $10,000", "$10,000–$40,000", "$40,000+"], action: (a) => { if (a === "Below $10,000") return goToStep("disqualify"); if (a === "$10,000–$40,000") { prefillDebtAmount = 25000; return goToStep("qIncome"); } if (a === "$40,000+") { prefillDebtAmount = 50000; return goToStep("qIncome"); } } },
      qIncome: { message: "Do you have a steady source of income?", type: "multiple-choice", options: ["Yes", "No"], action: (a) => (a === "Yes" ? goToStep("qWilling") : goToStep("disqualify")) },
      qWilling: { message: "As part of the study, are you willing to speak with a debt specialist for a free, no-obligation consultation?", type: "multiple-choice", options: ["Yes", "No"], action: (a) => (a === "Yes" ? goToStep("preFormInfo") : goToStep("disqualify")) },
      preFormInfo: { message: `Fantastic! You've qualified for the study. The main part of our research involves having you complete a short, secure form to request a free consultation from a debt specialist. Before I show you the form, I want to be transparent. To get genuine feedback, this study is for people who are truly interested in getting help with their debt. We've carefully researched and selected a reputable company, CuraDebt, to connect our participants with. They will be the ones to contact you. Just so you know what to expect, a debt settlement service works to negotiate with your creditors to lower the amount you owe. The goal is often to combine your payments into a single, more manageable monthly amount, with a plan to get you out of debt in about 2–4 years. It's a powerful option for many people. Your real-world experience with them is what makes this study so valuable. After you verify your phone number and submit this form, you may receive a call from a toll-free number (e.g., 800/833/844/855/866/877/888) to connect you directly to a specialist. If you miss it, you can call back from that number. Are you ready to take the next step?`, type: "multiple-choice", options: ["Yes, I'm ready"], action: () => goToStep("showApiForm") },
      showApiForm: { message: "Excellent! Please complete the secure form below. I'll be here once you've submitted it.", type: "api-form" },
      formSuccess: { message: "Thank you! Your information has been sent securely. Watch for a toll-free call to connect you to a debt specialist.", next: "askToContinueToFeedback" },
      askToContinueToFeedback: { message: "Now for the final step. Ready to provide your feedback?", type: "multiple-choice", options: ["Yes, Continue to Feedback"], action: () => goToStep("askForFeedback") },
      askForFeedback: { message: "Please complete the form below. You'll need to enter your email address so we can match your feedback to your initial submission.", type: "iframe-form", iframeSrc: "https://digitalresearch1.github.io/debt/brevo.html", next: "complete" },
      complete: { message: "That's everything! Thank you so much for your valuable feedback. You will now be redirected to finalize your entry.", end: true, status: 21 },
      disqualify: { message: "I appreciate you answering. Based on your responses, this study isn't the right fit. Thank you for your time. You will be redirected now.", end: true, status: 18 },
    };

    function updateProgress(index,total){ const p=Math.max(0, Math.min(100, (index/Math.max(1,total-1))*100)); progressBar.style.width=`${p}%`; }

    function goToStep(stepKey){
      const step=surveyFlow[stepKey]; if(!step) return; currentStepKey=stepKey; const keys=Object.keys(surveyFlow); updateProgress(keys.indexOf(stepKey), keys.length);
      setQuestion(step.message || '');
      if(step.end){ chatInputArea.innerHTML='<p class="text-center text-slate-600 text-sm">You will be redirected shortly...</p>'; const finalUrl=`https://spectrumsurveys.com/surveydone?st=${step.status}&transaction_id=${transactionId}`; setTimeout(()=>{ window.location.href=finalUrl; },2000); return; }
      if(step.type==='multiple-choice'){
        showOptions(step.options, (val)=>{ addAnswer(val); step.action(val); ensureBottom(); });
      } else if(step.type==='api-form'){
        chatWindow.innerHTML = '<div class="pointer-events-none sticky top-0 -mt-3 h-6 bg-gradient-to-b from-white to-transparent"></div>';
        showApiForm();
      } else if(step.type==='iframe-form'){
        chatWindow.innerHTML = '<div class="pointer-events-none sticky top-0 -mt-3 h-6 bg-gradient-to-b from-white to-transparent"></div>';
        showIframeForm(step.iframeSrc, ()=> goToStep(step.next));
      } else if(step.next){
        goToStep(step.next);
      }
    }

    function showIntro(){ setQuestion(''); chatWindow.innerHTML=''; chatInputArea.innerHTML=''; const card=document.createElement('div'); card.className='mx-4 my-3 p-5 bg-white border border-slate-200 rounded-2xl shadow'; card.innerHTML = `<div class="space-y-4"><h1 class="text-xl font-extrabold tracking-tight">Welcome to the AI Debt Settlement Survey</h1><p class="text-slate-700">This short study helps us understand real experiences with debt settlement. It includes quick eligibility questions, secure phone verification, and an optional feedback form.</p><button id="begin-btn" class="w-full bg-gradient-to-r from-indigo-500 to-fuchsia-500 hover:from-indigo-600 hover:to-fuchsia-600 text-white font-semibold text-base py-3 rounded-xl shadow">Begin Survey</button></div>`; chatWindow.appendChild(card); document.getElementById('begin-btn').addEventListener('click', ()=>{ card.remove(); goToStep('start'); ensureBottom(); }); ensureBottom(); }

    // === Form ===
    function showApiForm(){
      chatInputArea.innerHTML='';
      const wrapper=document.createElement('div'); wrapper.className='w-full bg-white border border-slate-200 rounded-2xl p-4 my-2 text-slate-900 backdrop-blur';
      const form=document.createElement('form'); form.id='cura-debt-form'; form.className='embedded-form w-full space-y-4';
      form.innerHTML=`
        <div class="text-center">
          <label for="debt-slider" class="text-sm font-medium text-slate-700">Select Amount Of Unsecured Debt</label>
          <p id="debt-amount-display" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-violet-600 to-fuchsia-600 my-2">$25,000</p>
          <input type="range" id="debt-slider" class="slider" min="0" max="100000" value="25000" step="100" list="debt-ticks" aria-label="Unsecured debt amount slider">
          <p class="text-xs text-slate-600 mt-2">Move the slider to select the exact amount you owe.</p>
          <datalist id="debt-ticks"><option value="0"></option><option value="5000"></option><option value="10000"></option><option value="20000"></option><option value="30000"></option><option value="40000"></option><option value="50000"></option><option value="75000"></option><option value="100000"></option></datalist>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 items-center gap-3">
            <label class="text-xs text-slate-600 sm:col-span-1" for="debt-number">Or type exact amount</label>
            <input type="text" id="debt-number" inputmode="numeric" placeholder="e.g. 12,450" class="sm:col-span-2 bg-white border border-slate-300 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500/60" value="25,000">
          </div>
          <p id="move-hint" class="text-xs text-amber-700 mt-2">Move the slider to confirm your amount.</p>
          <div id="debt-warning" class="text-[11px] text-amber-700 mt-2 hidden">Minimum debt is $10,000 to qualify.</div>
          <input type="hidden" id="debt-confirmed" value="0">
        </div>
        <div class="grid grid-cols-2 gap-3 pt-2">
          <input type="text" name="f_fname" placeholder="First Name" required class="bg-white border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500/60" />
          <input type="text" name="f_lname" placeholder="Last Name" required class="bg-white border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500/60" />
        </div>
        <input type="email" name="f_email" id="f_email" placeholder="Email Address" required class="bg-white border border-slate-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-indigo-500/60" />
        <div id="email-hint" class="text-[11px] mt-1 text-slate-600" aria-live="polite"></div>
        <input type="tel" name="f_phone" id="f_phone" placeholder="Phone Number" required class="bg-white border border-slate-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-indigo-500/60" />
        <div id="phone-hint" class="text-[11px] mt-1 text-slate-600" aria-live="polite"></div>
        <div id="otp-ui" class="mt-2 space-y-2">
          <div class="flex flex-wrap gap-2 items-center">
            <button type="button" id="send-otp" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-xs shadow ring-1 ring-black/5">Send verification code</button>
            <input id="otp-code" class="bg-white border border-slate-300 p-2 rounded w-36 focus:ring-2 focus:ring-indigo-500/60" placeholder="6-digit code" maxlength="6" />
            <button type="button" id="check-otp" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-xs shadow ring-1 ring-black/5">Verify number</button>
            <span id="otp-status" class="text-xs text-slate-700"></span>
          </div>
          <div id="tf-call-note" class="hidden text-[12px] text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-md px-3 py-2">✅ Number verified. You may receive a call from a <strong>toll-free</strong> number (800, 833, 844, 855, 866, 877, 888) to connect you with a specialist. If you miss it, call back from that number.</div>
          <div id="recaptcha-container"></div>
        </div>
        <select name="f_whereyoulive" required class="bg-white border border-slate-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-indigo-500/60"><option value="" disabled selected>Select Your State</option></select>
        <label class="flex items-start gap-2 text-[11px] text-slate-700"><input type="checkbox" id="tcpa" required class="mt-1"><span>By clicking, you agree to be contacted by CuraDebt and its partners at the number and email provided (including via automated dialing/texts). Your consent is not required to purchase. Message/data rates may apply.</span></label>
        <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold text-base py-3 rounded-xl transition disabled:opacity-60 disabled:cursor-not-allowed shadow">Select amount to continue</button>
        <div id="form-error" class="text-rose-600 font-semibold text-center text-sm hidden"></div>`;
      wrapper.appendChild(form); chatWindow.appendChild(wrapper);
      requestAnimationFrame(()=>{ const y = wrapper.offsetTop - qbar.offsetHeight - 8; scrollBox.scrollTop = Math.max(0, y); updateSticky(); });

      // Abandon on form step
      const footer=document.createElement('div'); footer.className='text-center mt-2'; const abandon=document.createElement('button'); abandon.type='button'; abandon.className='text-rose-600 hover:text-rose-700 text-xs'; abandon.textContent='Abandon Survey'; abandon.addEventListener('click',()=>{ goToStep('leaveSurvey'); }); footer.appendChild(abandon); wrapper.appendChild(footer);

      // State options
      const stateSelect=form.querySelector('select[name="f_whereyoulive"]'); allStates.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSelect.appendChild(o); });

      const MIN_QUAL=10000, MAX_DEBT=100000;
      const debtSlider=form.querySelector('#debt-slider'), debtDisplay=form.querySelector('#debt-amount-display'), debtNumber=form.querySelector('#debt-number');
      const submitBtn=form.querySelector('#submit-btn'), debtConfirmedEl=form.querySelector('#debt-confirmed');
      const debtWarning=form.querySelector('#debt-warning'), moveHint=form.querySelector('#move-hint');
      const fmt=n=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0}).format(n);
      const toInt=s=>{ const n=parseInt(String(s||'').replace(/[^\d]/g,''),10); return isNaN(n)?0:n; };

      function setSubmitState(){ const v=parseInt(debtSlider?.value||'0',10)||0; const confirmed=debtConfirmedEl.value==='1'; const state=stateSelect.value; const consentOK=form.querySelector('#tcpa')?.checked; const amountOK=confirmed && v>=MIN_QUAL; const stateOK=!!state && !excludedStates.includes(state); const otpOK=window.otpOK===true; if(moveHint) moveHint.classList.toggle('hidden', confirmed); let btnText='See If I Qualify'; if(!confirmed) btnText='Select amount to continue'; else if(v<MIN_QUAL) btnText='Minimum $10,000 required'; else if(!otpOK) btnText='Verify your phone to continue'; else if(!consentOK) btnText='Consent required'; else if(!stateOK) btnText='State not serviced'; submitBtn.disabled=!(amountOK&&stateOK&&consentOK&&otpOK); submitBtn.textContent=btnText; debtWarning?.classList.toggle('hidden', v>=MIN_QUAL); }

      function applyAmount(raw){ const clamped=Math.max(0, Math.min(MAX_DEBT, Math.round(raw||0))); debtSlider.value=String(clamped); debtNumber.value=clamped.toLocaleString('en-US'); debtDisplay.textContent= clamped>=MAX_DEBT ? `${fmt(clamped)}+` : fmt(clamped); debtConfirmedEl.value='1'; setSubmitState(); }

      // Initialize amount (use prefill if set)
      if (typeof prefillDebtAmount === 'number' && prefillDebtAmount > 0) { applyAmount(prefillDebtAmount); }
      else { applyAmount(parseInt(debtSlider.value,10) || 25000); }

      // Bind slider + input (robust across browsers)
      const syncFromSlider=()=> applyAmount(Number(debtSlider.value)||0);
      debtSlider.addEventListener('input', syncFromSlider, {passive:true});
      debtSlider.addEventListener('change', syncFromSlider);
      debtSlider.addEventListener('pointerup', syncFromSlider);
      debtSlider.addEventListener('touchend', syncFromSlider);
      debtSlider.addEventListener('keyup', (e)=>{ if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End','PageUp','PageDown'].includes(e.key)) syncFromSlider(); });
      const syncFromInput=()=> applyAmount(toInt(debtNumber.value));
      debtNumber.addEventListener('input', syncFromInput);
      debtNumber.addEventListener('change', syncFromInput);
      debtNumber.addEventListener('blur', ()=>{ const v=toInt(debtNumber.value); debtNumber.value=v? v.toLocaleString('en-US'):''; });

      stateSelect.addEventListener('change', setSubmitState);
      form.querySelector('#tcpa').addEventListener('change', setSubmitState);

      // Email validation UI
      const emailInput=form.querySelector('#f_email'); const emailHint=form.querySelector('#email-hint');
      const runEmailUI=async()=>{ if(!emailInput.value){ emailHint.textContent=''; return; } emailHint.textContent='Checking email…'; const res=await validateEmailWithWorker(emailInput.value); if(res.ok){ let msg='✅ Valid'; if(res.suggestion) msg+=` (did you mean ${emailInput.value.split('@')[0]}@${res.suggestion}?)`; if(res.disposable) msg='⚠️ Disposable address detected. Use a personal/work email.'; if(res.info?.role) msg='⚠️ Role account not accepted.'; if(res.info?.plusAnywhere) msg='⚠️ Plus-alias not accepted.'; if(res.info?.gmailDot) msg='⚠️ Gmail dot alias not accepted.'; emailHint.textContent=msg; emailHint.classList.toggle('text-emerald-700', !res.disposable && !res.info?.role && !res.info?.plusAnywhere && !res.info?.gmailDot); emailHint.classList.toggle('text-amber-700', !!(res.disposable||res.info?.role||res.info?.plusAnywhere||res.info?.gmailDot)); emailHint.classList.remove('text-rose-600'); } else { emailHint.textContent=`❌ ${res.error}`; emailHint.classList.add('text-rose-600'); emailHint.classList.remove('text-emerald-700','text-amber-700'); } };
      emailInput.addEventListener('blur', runEmailUI); emailInput.addEventListener('change', runEmailUI);

      // Phone validation + OTP
      const phoneInput=form.querySelector('#f_phone'); const phoneHint=form.querySelector('#phone-hint'); const tfCallNote=document.getElementById('tf-call-note');
      const runPhoneUI=async()=>{ if(!phoneInput.value){ phoneHint.textContent=''; return; } phoneHint.textContent='Checking number…'; const res=await validatePhoneWithSignalWire(phoneInput.value); if(res.ok){ const extra=res?.meta?.tollFree?' (toll-free)':''; phoneHint.textContent=`✅ ${res.e164}${extra}`; phoneHint.classList.add('text-emerald-700'); phoneHint.classList.remove('text-rose-600','text-amber-700'); } else { phoneHint.textContent=`❌ ${res.error}`; phoneHint.classList.add('text-rose-600'); phoneHint.classList.remove('text-emerald-700','text-amber-700'); } };
      phoneInput.addEventListener('blur', runPhoneUI); phoneInput.addEventListener('change', runPhoneUI);

      const sendBtn=form.querySelector('#send-otp'); const checkBtn=form.querySelector('#check-otp'); const codeInput=form.querySelector('#otp-code'); const statusEl=form.querySelector('#otp-status'); const recaptchaDiv=form.querySelector('#recaptcha-container');
      let verifier; function ensureRecaptcha(){ if(!verifier){ verifier=new RecaptchaVerifier(auth, recaptchaDiv, { size:'invisible' }); } return verifier; }

      sendBtn.addEventListener('click', async ()=>{ const parsed=parseStrictNANP(phoneInput.value); if(!parsed.ok){ statusEl.textContent=parsed.error; statusEl.className='text-xs text-rose-600'; return; } try{ statusEl.textContent='Sending code…'; statusEl.className='text-xs text-slate-700'; confirmationResult=await signInWithPhoneNumber(auth, parsed.e164, ensureRecaptcha()); statusEl.textContent='Code sent. Check SMS.'; statusEl.className='text-xs text-emerald-700'; }catch(e){ statusEl.textContent=`Failed to send (${e?.code||'unknown'}): ${e?.message||e}`; statusEl.className='text-xs text-rose-600'; } });

      checkBtn.addEventListener('click', async ()=>{ const code=(codeInput.value||'').trim(); if(!confirmationResult){ statusEl.textContent='Click "Send verification code" first.'; statusEl.className='text-xs text-rose-600'; return; } if(code.length!==6){ statusEl.textContent='Enter the 6-digit code.'; statusEl.className='text-xs text-rose-600'; return; } try{ statusEl.textContent='Verifying…'; statusEl.className='text-xs text-slate-700'; await confirmationResult.confirm(code); window.otpOK=true; statusEl.textContent='Verified ✓'; statusEl.className='text-xs text-emerald-700'; if(tfCallNote) tfCallNote.classList.remove('hidden'); setSubmitState(); }catch(e){ window.otpOK=false; statusEl.textContent=`Verify failed. ${e?.code||''}`; statusEl.className='text-xs text-rose-600'; if(tfCallNote) tfCallNote.classList.add('hidden'); setSubmitState(); } });

      phoneInput.addEventListener('input', ()=>{ window.otpOK=false; statusEl.textContent=''; if(tfCallNote) tfCallNote.classList.add('hidden'); setSubmitState(); });

      form.addEventListener('submit', handleApiFormSubmit);
    }

    async function handleApiFormSubmit(e){
      e.preventDefault();
      const form=e.target; const submitButton=form.querySelector('#submit-btn'); const formError=form.querySelector('#form-error'); formError.classList.add('hidden');
      if(!window.otpOK){ formError.textContent='Please verify your phone number to continue.'; formError.classList.remove('hidden'); return; }
      submitButton.disabled=true; submitButton.innerHTML='<div class="loader mx-auto"></div>';

      const debtAmount=parseInt(form.querySelector('#debt-slider').value,10)||0; const selectedState=form.querySelector('select[name="f_whereyoulive"]').value; const confirmed=(document.getElementById('debt-confirmed')?.value==='1');
      if(!confirmed){ formError.textContent='Please confirm your debt amount by moving the slider or typing the exact amount.'; formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return; }
      if(debtAmount<10000){ formError.textContent='Minimum debt of $10,000 is required to qualify.'; formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return; }
      if(['NH','MI','MN','CO','VA','IA','WA','PA','IL','KS','OR','TN','UT','VI','WV','RI'].includes(selectedState)){ formError.textContent='Unfortunately, we do not service your state at this time.'; formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return; }
      if(!form.querySelector('#tcpa')?.checked){ formError.textContent='Please agree to the consent to continue.'; formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return; }

      const emailRaw=form.querySelector('input[name="f_email"]').value||''; const emailCheck=await validateEmailWithWorker(emailRaw); if(!emailCheck.ok||emailCheck.disposable||emailCheck.info?.role||emailCheck.info?.plusAnywhere||emailCheck.info?.gmailDot){ formError.textContent=emailCheck.ok?'Please use a personal, non-role, non-alias email.':(emailCheck.error||'Invalid email.'); formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return; }
      const normalizedEmail=emailCheck.normalized; let emailStatusTag='normal'; if(emailCheck.disposable) emailStatusTag='disposable'; else if(emailCheck.info?.role) emailStatusTag='role'; else if(emailCheck.info?.plusAnywhere) emailStatusTag='plus'; else if(emailCheck.info?.gmailDot) emailStatusTag='gmaildot';

      const phoneRaw=form.querySelector('input[name="f_phone"]').value||''; const phoneCheck=await validatePhoneWithSignalWire(phoneRaw); if(!phoneCheck.ok){ formError.textContent=phoneCheck.error||'Please enter a valid phone number.'; formError.classList.remove('hidden'); submitButton.disabled=false; submitButton.textContent='See If I Qualify'; return; }
      const normalizedE164=phoneCheck.e164||phoneRaw; const phoneType=phoneCheck.type||'unknown'; const isTollFree=!!(phoneCheck.meta&&phoneCheck.meta.tollFree);

      try{ const r=await fetch('https://api.ipify.org?format=json'); const j=await r.json(); clientIp=j.ip||''; }catch{ clientIp=''; }

      const hidden=document.getElementById('hidden-curadebt-post'); const fd=new FormData(form);
      const data1=(new URLSearchParams(location.search).get('data1')|| new URLSearchParams(location.search).get('click_id')|| new URLSearchParams(location.search).get('gclid')|| new URLSearchParams(location.search).get('fbclid')|| new URLSearchParams(location.search).get('msclkid')|| '') || transactionId || 'no_click_id';
      hidden.elements['f_fname'].value=fd.get('f_fname')||'';
      hidden.elements['f_lname'].value=fd.get('f_lname')||'';
      hidden.elements['f_email'].value=normalizedEmail;
      hidden.elements['f_phone'].value= normalizedE164.startsWith('+1')? normalizedE164.replace('+1','') : normalizedE164;
      hidden.elements['f_whereyoulive'].value=fd.get('f_whereyoulive')||'';
      hidden.elements['f_totaldebt'].value=String(debtAmount);
      hidden.elements['data1'].value=data1;
      hidden.elements['f_comments'].value=`Lead from AI Chatbot Survey | phone_type=${phoneType} | email_status=${emailStatusTag} | toll_free=${isTollFree}`;
      hidden.elements['data2'].value='CLICKID2';
      hidden.elements['f_ip'].value=clientIp;
      hidden.submit();

      const tdForm=document.getElementById('hidden-trackdrive-post'); const qs=new URLSearchParams(location.search);
      const gclid=qs.get('gclid')||''; const fbeventid=qs.get('fbclid')||''; const msclkid=qs.get('msclkid')||'';
      tdForm.elements['caller_id'].value=normalizedE164;
      tdForm.elements['first_name'].value=fd.get('f_fname')||'';
      tdForm.elements['last_name'].value=fd.get('f_lname')||'';
      tdForm.elements['email'].value=normalizedEmail;
      tdForm.elements['state'].value=fd.get('f_whereyoulive')||'';
      tdForm.elements['zip'].value=fd.get('f_zip')||'';
      tdForm.elements['ip_address'].value=clientIp||'';
      tdForm.elements['source_url'].value=location.href;
      tdForm.elements['useragent'].value=navigator.userAgent||'';
      tdForm.elements['original_lead_submit_date'].value=new Date().toISOString().replace('T',' ').slice(0,19);
      tdForm.elements['tcpa_opt_in'].value='true';
      tdForm.elements['tcpa_optin_consent_language'].value=(document.querySelector('label[for="tcpa"] span')?.innerText||'TCPA consent captured').trim();
      tdForm.elements['sub_id'].value=data1;
      tdForm.elements['gclid'].value=gclid;
      tdForm.elements['fbeventid'].value=fbeventid;
      tdForm.elements['msclkid'].value=msclkid;
      tdForm.elements['traffic_source_lead_id'].value=transactionId;
      tdForm.submit();

      addAnswer("Form submitted");
      goToStep('formSuccess');
    }

    function showIframeForm(iframeSrc, onContinue) {
      const c=createBaseContainer();
      const w=document.createElement('div'); w.className='w-full h-[70vh] flex-grow bg-white rounded-xl p-1 ring-1 ring-slate-200';
      const iframe=document.createElement('iframe');
      const rid=transactionId || (window.__rid ||= ('tx_'+Date.now()));
      iframe.src=`${iframeSrc}?rid=${encodeURIComponent(rid)}`;
      iframe.className='w-full h-full border-0 rounded-md';
      iframe.setAttribute('loading','lazy');
      iframe.setAttribute('referrerpolicy','no-referrer-when-downgrade');
      w.appendChild(iframe);
      chatWindow.appendChild(w);
      requestAnimationFrame(()=>{ const y = w.offsetTop - qbar.offsetHeight - 8; scrollBox.scrollTop = Math.max(0, y); updateSticky(); });
      const btn=document.createElement('button'); btn.className='bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold text-base py-3 px-6 rounded-xl transition mt-4 shadow'; btn.textContent="I've Submitted My Feedback"; btn.onclick=()=>{ w.remove(); onContinue(); };
      c.appendChild(btn);
      addAbandon(c); chatInputArea.innerHTML=''; chatInputArea.appendChild(c); ensureBottom();
    }

    async function init(){ const urlParams=new URLSearchParams(window.location.search); transactionId=urlParams.get('transaction_id')||urlParams.get('RID')||`tx_${Date.now()}`; try{ const r=await fetch('https://api.ipify.org?format=json'); const j=await r.json(); clientIp=j.ip; }catch{ clientIp=''; } showIntro(); updateSticky(); }
    init();
  </script>
</body>
</html>


