<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/>
  <title>Financial Wellness Research Study</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { box-shadow: 0 10px 30px rgba(15,23,42,.08); }
    .btn { transition: transform .12s ease, opacity .12s ease; }
    .btn:hover { transform: translateY(-1px); }
    .disabled { opacity: .55; pointer-events: none; }
  </style>
</head>

<body class="bg-slate-100 min-h-screen">
  <main class="max-w-3xl mx-auto px-4 py-8">

    <!-- Header -->
    <div class="card bg-white rounded-2xl p-6 border border-slate-200">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div>
          <p class="text-xs font-semibold text-slate-500">üîí Independent research study</p>
          <h1 class="text-2xl md:text-3xl font-bold text-slate-900 mt-1">Financial Wellness Research Study</h1>
          <p class="text-sm text-slate-600 mt-2">
            Please follow the steps below. Only completed and verified participants are approved.
          </p>
        </div>
        <div class="rounded-xl bg-indigo-50 border border-indigo-200 px-3 py-2">
          <p class="text-xs font-semibold text-indigo-900">1 page ‚Ä¢ Fast flow</p>
          <p class="text-[11px] text-indigo-700">Open form ‚Üí Email ‚Üí Verify</p>
        </div>
      </div>

      <div class="mt-4 bg-slate-50 border border-slate-200 rounded-xl p-4">
        <p class="text-xs md:text-sm text-slate-700 leading-relaxed">
          <strong>Important:</strong> This is an <strong>independent research study</strong>. We are not the debt-relief company and we do not
          provide debt settlement services. You will open a <strong>third-party website</strong> to complete their form, then we‚Äôll verify completion.
        </p>
      </div>
    </div>

    <!-- Eligibility -->
    <div class="card bg-white rounded-2xl p-6 border border-slate-200 mt-5">
      <h2 class="text-lg font-semibold text-slate-900">Quick eligibility check</h2>
      <p class="text-sm text-slate-600 mt-1">If you don‚Äôt qualify, please exit to avoid disqualification.</p>

      <div class="mt-4 space-y-3">
        <label class="flex items-start gap-3 bg-slate-50 border border-slate-200 rounded-xl p-3">
          <input id="qDebt" type="checkbox" class="mt-1 h-4 w-4">
          <span class="text-sm text-slate-700">
            I have <strong>unsecured debt</strong> (credit cards, personal loans, medical bills, etc.).
          </span>
        </label>

        <label class="flex items-start gap-3 bg-slate-50 border border-slate-200 rounded-xl p-3">
          <input id="q15k" type="checkbox" class="mt-1 h-4 w-4">
          <span class="text-sm text-slate-700">
            My total unsecured balances are typically <strong>$15,000+</strong>.
          </span>
        </label>

        <label class="flex items-start gap-3 bg-slate-50 border border-slate-200 rounded-xl p-3">
          <input id="qCall" type="checkbox" class="mt-1 h-4 w-4">
          <span class="text-sm text-slate-700">
            I‚Äôm willing to provide a phone number on the third-party form and may receive a call within <strong>24‚Äì48 hours</strong>.
          </span>
        </label>
      </div>

      <div class="mt-4 flex flex-wrap gap-3">
        <button id="btnExit"
          class="btn px-4 py-2 rounded-full text-sm font-semibold border border-red-200 bg-red-50 text-red-700">
          I don‚Äôt qualify / Exit
        </button>

        <span id="eligMsg" class="text-sm text-slate-600 self-center"></span>
      </div>
    </div>

    <!-- Open offer -->
    <div class="card bg-white rounded-2xl p-6 border border-slate-200 mt-5">
      <h2 class="text-lg font-semibold text-slate-900">Open the third-party form</h2>
      <p class="text-sm text-slate-600 mt-1">
        Click the button to open the form in a new tab. Complete it fully, then return here.
      </p>

      <div class="mt-4 bg-amber-50 border border-amber-200 rounded-xl p-4">
        <p class="text-sm text-amber-900 font-semibold">Typical actions on the third-party form:</p>
        <ul class="list-disc list-inside mt-2 text-sm text-amber-900/90 space-y-1">
          <li>Answer 2‚Äì3 quick eligibility questions</li>
          <li>Enter your phone number (may require verification)</li>
          <li>Provide email, basic identity and address details</li>
          <li>Submit and reach a confirmation / thank you page</li>
        </ul>
        <p class="text-xs text-amber-800 mt-3 font-semibold">
          ‚ö†Ô∏è We verify completion. If it can‚Äôt be verified, participation can‚Äôt be approved.
        </p>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <a id="offerLink"
           href="#"
           target="_blank"
           rel="noopener noreferrer"
           class="btn px-5 py-3 rounded-full bg-indigo-600 text-white text-sm font-semibold">
          Open the form (new tab)
        </a>

        <button id="btnICompleted"
          class="btn px-5 py-3 rounded-full bg-emerald-600 text-white text-sm font-semibold disabled"
          disabled>
          I completed the form
        </button>

        <span id="openStatus" class="text-sm text-slate-600"></span>
      </div>

      <p class="text-[12px] text-slate-500 mt-3">
        Tip: After you open the form, we‚Äôll unlock ‚ÄúI completed the form‚Äù after a short delay to reduce accidental clicks.
      </p>
    </div>

    <!-- Brevo email -->
    <div id="emailBlock" class="card bg-white rounded-2xl p-6 border border-slate-200 mt-5 hidden">
      <h2 class="text-lg font-semibold text-slate-900">Email for research follow-up</h2>
      <p class="text-sm text-slate-600 mt-1">
        Your email is required so we can send a short follow-up about your experience.
      </p>

      <!-- Your own status (instead of Brevo's ‚Äúsubscription saved‚Äù) -->
      <div id="emailUiMsg" class="hidden mt-4 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700"></div>

      <!-- Brevo embed (hidden iframe target prevents Brevo success UI) -->
      <div class="mt-4">
        <iframe name="brevo_iframe" id="brevo_iframe" style="display:none;"></iframe>

        <form id="sib-form"
              method="POST"
              action="https://52bcaf92.sibforms.com/serve/MUIFAO5vlejSCs-rWtk8_hSGgyILb9Oi-aOLbS_zI5_FjrtRovBWkBZlGVuoCXxEbmOMZMrdo0ZllgcfYtt7jPnKOHgyHT2TYdf3Q-xFXArnK8ikp21kPr7-iXsfMeK4CtD4cAPf2oHHMJLw5OtgVzgyKMt0hXTJ3UiMJVGUXzHbWENuGdgb7j-x2xeZ6iW5f9ix4gocwCjOBdct"
              target="brevo_iframe"
              class="max-w-xl">

          <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
            <label class="block text-sm font-semibold text-slate-900" for="EMAIL">
              Enter your email address
            </label>
            <input class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 text-sm"
                   type="text" id="EMAIL" name="EMAIL" placeholder="abc@xyz.com" autocomplete="off" required>

            <div id="email_error" class="hidden mt-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-2"></div>

            <label class="mt-3 flex items-start gap-2 text-sm text-slate-700">
              <input id="OPT_IN" name="OPT_IN" type="checkbox" value="1" class="mt-1 h-4 w-4" required>
              <span>I agree to receive your email and accept the data privacy statement.</span>
            </label>
            <div id="optin_error" class="hidden mt-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-2"></div>

            <button id="brevoSubmitBtn"
                    type="submit"
                    class="btn mt-4 w-full rounded-full bg-slate-900 text-white text-sm font-semibold px-5 py-3">
              Submit email
            </button>
          </div>

          <input type="text" name="email_address_check" value="" class="hidden">
          <input type="hidden" name="locale" value="en">
          <input type="hidden" name="html_type" value="simple">
        </form>
      </div>
    </div>

    <!-- Verify -->
    <div id="verifyBlock" class="card bg-white rounded-2xl p-6 border border-slate-200 mt-5 hidden">
      <h2 class="text-lg font-semibold text-slate-900">Final verification & redirect</h2>
      <p class="text-sm text-slate-600 mt-1">
        We will check your third-party submission using our verification system. Do not refresh while checking.
      </p>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <button id="btnVerify"
          class="btn px-5 py-3 rounded-full bg-amber-600 text-white text-sm font-semibold">
          Verify & Finish
        </button>
        <span id="verifyMsg" class="text-sm text-slate-600"></span>
      </div>
    </div>

    <footer class="text-center text-xs text-slate-500 mt-6">
      Transaction ID is generated automatically for tracking and verification.
    </footer>
  </main>

<script>
  // -----------------------------
  // Tracking / IDs
  // -----------------------------
  const urlParams = new URLSearchParams(window.location.search);
  let transactionId =
    urlParams.get('RID') ||
    urlParams.get('participant_id') ||
    urlParams.get('transaction_id');

  if (!transactionId) {
    transactionId = 'tx_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
  }

  // -----------------------------
  // Redirect URLs (Spectrum)
  // -----------------------------
  const completionUrl  = `https://spectrumsurveys.com/surveydone?st=21&transaction_id=${encodeURIComponent(transactionId)}`;
  const terminationUrl = `https://spectrumsurveys.com/surveydone?st=18&transaction_id=${encodeURIComponent(transactionId)}`;

  // -----------------------------
  // Offer + Worker verify
  // -----------------------------
  const offerBaseUrl    = 'https://trkmcl.com/wy8odpg43k/xwndpp7qne';
  const offerTrackedUrl = `${offerBaseUrl}${offerBaseUrl.includes('?') ? '&' : '?'}subid=${encodeURIComponent(transactionId)}`;

  const verifyFormUrl = `https://marketcall.kayembakasongo.workers.dev/verify-form?transaction_id=${encodeURIComponent(transactionId)}`;

  // -----------------------------
  // Elements
  // -----------------------------
  const qDebt = document.getElementById('qDebt');
  const q15k  = document.getElementById('q15k');
  const qCall = document.getElementById('qCall');
  const eligMsg = document.getElementById('eligMsg');

  const btnExit = document.getElementById('btnExit');

  const offerLink = document.getElementById('offerLink');
  const btnICompleted = document.getElementById('btnICompleted');
  const openStatus = document.getElementById('openStatus');

  const emailBlock = document.getElementById('emailBlock');
  const verifyBlock = document.getElementById('verifyBlock');

  const sibForm = document.getElementById('sib-form');
  const emailInput = document.getElementById('EMAIL');
  const optIn = document.getElementById('OPT_IN');
  const emailErr = document.getElementById('email_error');
  const optinErr = document.getElementById('optin_error');
  const brevoSubmitBtn = document.getElementById('brevoSubmitBtn');
  const emailUiMsg = document.getElementById('emailUiMsg');

  const btnVerify = document.getElementById('btnVerify');
  const verifyMsg = document.getElementById('verifyMsg');

  // -----------------------------
  // Simple gating state
  // -----------------------------
  const offerKey = 'offer_opened_' + transactionId;
  const delayKey = 'offer_delay_done_' + transactionId;
  const emailKey = 'email_done_' + transactionId;

  function eligible() {
    return qDebt.checked && q15k.checked && qCall.checked;
  }

  function setCompletedEnabled(enabled) {
    btnICompleted.disabled = !enabled;
    btnICompleted.classList.toggle('disabled', !enabled);
  }

  function show(el) { el.classList.remove('hidden'); }
  function hide(el) { el.classList.add('hidden'); }

  function startOfferDelay() {
    if (sessionStorage.getItem(delayKey) === '1') {
      setCompletedEnabled(true);
      openStatus.textContent = 'Return after submitting the form, then click ‚ÄúI completed the form‚Äù.';
      return;
    }

    let seconds = 15;
    setCompletedEnabled(false);
    openStatus.textContent = `Form opened. Please complete it in the new tab. You can confirm here in ${seconds}s‚Ä¶`;

    const t = setInterval(() => {
      seconds--;
      if (seconds <= 0) {
        clearInterval(t);
        sessionStorage.setItem(delayKey, '1');
        setCompletedEnabled(true);
        openStatus.textContent = 'If you submitted the form, click ‚ÄúI completed the form‚Äù.';
      } else {
        openStatus.textContent = `Form opened. Please complete it in the new tab. You can confirm here in ${seconds}s‚Ä¶`;
      }
    }, 1000);
  }

  function updateEligibilityUi() {
    if (eligible()) {
      eligMsg.textContent = '‚úÖ You appear eligible. Please open the form below.';
      eligMsg.className = 'text-sm text-emerald-700 self-center';
      offerLink.classList.remove('disabled');
      offerLink.style.pointerEvents = 'auto';
      offerLink.style.opacity = '1';
    } else {
      eligMsg.textContent = 'Please check all boxes to proceed.';
      eligMsg.className = 'text-sm text-slate-600 self-center';
      offerLink.style.pointerEvents = 'none';
      offerLink.style.opacity = '.55';
    }
  }

  // -----------------------------
  // Init
  // -----------------------------
  offerLink.href = offerTrackedUrl;
  updateEligibilityUi();

  // restore states
  if (sessionStorage.getItem(offerKey) === '1') {
    startOfferDelay();
  }
  if (sessionStorage.getItem(emailKey) === '1') {
    show(verifyBlock);
  }

  // -----------------------------
  // Handlers
  // -----------------------------
  [qDebt, q15k, qCall].forEach(cb => cb.addEventListener('change', updateEligibilityUi));

  btnExit.addEventListener('click', () => {
    window.location.href = terminationUrl;
  });

  offerLink.addEventListener('click', () => {
    if (!eligible()) {
      // block if not eligible
      alert('Please confirm eligibility first.');
      return;
    }
    sessionStorage.setItem(offerKey, '1');
    startOfferDelay();
  });

  btnICompleted.addEventListener('click', () => {
    const opened = sessionStorage.getItem(offerKey) === '1';
    const delayed = sessionStorage.getItem(delayKey) === '1';
    if (!opened || !delayed) {
      alert('Please open the form and complete it before continuing.');
      return;
    }
    show(emailBlock);
    emailBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  // Brevo validation: keep Brevo result hidden, show your UI message, then unlock verify
  sibForm.addEventListener('submit', function(e) {
    // reset errors
    emailErr.classList.add('hidden');
    optinErr.classList.add('hidden');
    emailErr.textContent = '';
    optinErr.textContent = '';

    const emailVal = (emailInput.value || '').trim();
    let hasError = false;

    if (!emailVal) {
      hasError = true;
      emailErr.textContent = 'Please enter your email address.';
      emailErr.classList.remove('hidden');
    } else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)) {
      hasError = true;
      emailErr.textContent = 'Please enter a valid email address.';
      emailErr.classList.remove('hidden');
    }

    if (!optIn.checked) {
      hasError = true;
      optinErr.textContent = 'Please agree to the privacy statement to continue.';
      optinErr.classList.remove('hidden');
    }

    if (hasError) {
      e.preventDefault();
      return;
    }

    // let Brevo submit to hidden iframe
    brevoSubmitBtn.disabled = true;
    brevoSubmitBtn.textContent = 'Submitting‚Ä¶';

    // after a short delay, mark email as done and unlock verify
    setTimeout(() => {
      sessionStorage.setItem(emailKey, '1');
      emailUiMsg.textContent = '‚úÖ Email saved. You can now run final verification.';
      emailUiMsg.classList.remove('hidden');

      show(verifyBlock);
      verifyBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });

      brevoSubmitBtn.textContent = 'Submitted';
      brevoSubmitBtn.classList.add('disabled');
    }, 2500);
  });

  // Verify -> Worker -> redirect
  btnVerify.addEventListener('click', async () => {
    btnVerify.disabled = true;
    btnVerify.classList.add('disabled');
    verifyMsg.textContent = 'Checking your submission‚Ä¶';

    try {
      const resp = await fetch(verifyFormUrl, { method: 'GET' });
      const data = await resp.json();
      window.location.href = (data && data.submitted) ? completionUrl : terminationUrl;
    } catch (e) {
      window.location.href = terminationUrl;
    }
  });
</script>
</body>
</html>

