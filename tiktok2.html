<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Survey</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tesseract.js v5 (pinned + explicit paths) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { border: 1px solid rgb(226 232 240); border-radius: 18px; }
    input[type="radio"] { width: 16px; height: 16px; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
<main class="max-w-xl mx-auto px-4 py-10">

  <!-- MAIN -->
  <section class="card bg-white shadow-sm p-6 space-y-5">
    <div class="space-y-2">
      <p class="text-sm text-slate-600">App experience research study</p>
      <p class="text-lg font-semibold leading-snug">Help us understand first-time experience</p>
    </div>

    <div class="space-y-3 text-sm text-slate-700">
      <p>
        The purpose of this study is to understand how people who have
        <strong>not used TikTok before</strong> experience the app when they try it for the first time.
      </p>

      <p>
        Click the button below to download the app. You will be taken to the App Store to install it.
        After installing, open the app, complete the sign-up, and spend about one minute using it.
        Then return to this page and continue.
      </p>

      <p>
        After completing the experience, please upload a screenshot of the welcome email you receive and then continue to share your feedback.
      </p>

      <p class="text-xs text-slate-500">
        Tip: Upload a screenshot where the subject line “Welcome to TikTok” is clearly visible (top of the screen is best).
      </p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <button id="btnOpen"
        class="rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition">
        Click To Download
      </button>

      <button id="btnGoFeedback"
        class="rounded-xl px-4 py-3 text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition disabled:opacity-40 disabled:cursor-not-allowed"
        disabled>
        Continue to feedback
      </button>
    </div>

    <p id="hint" class="text-xs text-slate-500"></p>

    <!-- Upload + OCR -->
    <div class="rounded-2xl border border-slate-200 bg-white p-4 space-y-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-sm font-semibold text-slate-900">Upload screenshot (required)</p>
          <p class="text-xs text-slate-600">
            Upload a screenshot of the email welcome message. We unlock “Continue” only if we detect the words:
            <strong>Welcome</strong> and <strong>TikTok</strong>.
          </p>
        </div>
        <div class="text-xs text-slate-500 mono" id="statusChip"></div>
      </div>

      <input id="shot" type="file" accept="image/*"
        class="block w-full text-sm text-slate-700 file:mr-4 file:rounded-lg file:border-0 file:bg-slate-100 file:px-4 file:py-2 file:text-sm file:font-semibold hover:file:bg-slate-200"/>

      <div id="previewWrap" class="hidden">
        <img id="preview" class="w-full rounded-xl border border-slate-200" alt="Preview"/>
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <button id="btnOcr" type="button"
          class="rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition disabled:opacity-40 disabled:cursor-not-allowed"
          disabled>
          Validate screenshot
        </button>

        <div class="flex-1 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
          <div class="flex items-center justify-between">
            <span class="text-xs text-slate-600">OCR status</span>
            <span id="ocrPct" class="text-xs text-slate-600 mono">0%</span>
          </div>
          <div class="mt-2 h-2 rounded-full bg-slate-200 overflow-hidden">
            <div id="ocrBar" class="h-full bg-indigo-600" style="width:0%"></div>
          </div>
          <p id="ocrMsg" class="text-xs text-slate-600 mt-2"></p>
        </div>
      </div>

      <div id="ocrResult" class="hidden rounded-xl border border-slate-200 bg-white p-3">
        <p class="text-xs text-slate-600">Detected text (preview):</p>
        <pre id="ocrText" class="text-xs text-slate-700 whitespace-pre-wrap mt-2"></pre>
      </div>

      <p id="gateMsg" class="text-xs text-slate-500"></p>
    </div>
  </section>

  <!-- FEEDBACK -->
  <section id="feedback" class="card bg-white shadow-sm p-6 mt-6 space-y-5 hidden">
    <div class="space-y-1">
      <p class="text-sm text-slate-600">Feedback</p>
      <p class="text-lg font-semibold">Tell us about your experience</p>
    </div>

    <div class="space-y-4">
      <div class="rounded-2xl border border-slate-200 p-4 space-y-2">
        <p class="font-semibold">What was your overall first impression?</p>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="very_positive"> Very positive</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="somewhat_positive"> Somewhat positive</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="neutral"> Neutral</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="somewhat_negative"> Somewhat negative</label>
        <label class="flex gap-2"><input type="radio" name="fb_impression" value="very_negative"> Very negative</label>
      </div>

      <div class="rounded-2xl border border-slate-200 p-4 space-y-2">
        <p class="font-semibold">How easy was sign-up?</p>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="very_easy"> Very easy</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="easy"> Easy</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="ok"> Okay</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="hard"> Difficult</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="very_hard"> Very difficult</label>
        <label class="flex gap-2"><input type="radio" name="fb_signup" value="did_not"> I didn’t complete sign-up</label>
      </div>

      <div class="rounded-2xl border border-slate-200 p-4 space-y-2">
        <p class="font-semibold">How likely are you to use it again?</p>
        <div class="flex gap-2">
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="1">1</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="2">2</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="3">3</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="4">4</label>
          <label class="flex gap-1"><input type="radio" name="fb_likely" value="5">5</label>
        </div>
        <p class="text-xs text-slate-500">1 = Not likely, 5 = Very likely</p>
      </div>
    </div>

    <button id="btnSubmit" type="button"
      class="w-full rounded-xl px-4 py-3 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800 transition disabled:opacity-40 disabled:cursor-not-allowed"
      disabled>
      Submit & finish
    </button>

    <p id="hint2" class="text-xs text-slate-500"></p>
  </section>

</main>

<script>
  // ====== CONFIG ======
  const OFFER_BASE_URL = "https://smrturl.co/a/scd13071c18/86?s1=";
  const COMPLETE_URL   = "https://connect.cloudresearch.com/participant/project/31CCC7C024/complete";

  // We validate by keyword presence (more reliable than exact phrase with highlights)
  const REQUIRED_KEYWORDS = ["welcome", "tiktok"]; // tiktok may appear as "tik tok" or slightly broken

  // ====== STATE ======
  let openedOnce = false;
  let ocrPassed = false;

  // One worker per page
  let worker = null;

  // ====== RID ======
  const qp = new URLSearchParams(location.search);
  let rid = qp.get("RID") || qp.get("transaction_id") || qp.get("s1") || sessionStorage.getItem("RID");
  if (!rid) rid = "tx_" + Date.now().toString(36) + Math.random().toString(36).slice(2);
  sessionStorage.setItem("RID", rid);
  const offerUrl = OFFER_BASE_URL + encodeURIComponent(rid);

  // ====== DOM ======
  const btnOpen = document.getElementById("btnOpen");
  const btnGoFeedback = document.getElementById("btnGoFeedback");
  const hint = document.getElementById("hint");

  const shot = document.getElementById("shot");
  const previewWrap = document.getElementById("previewWrap");
  const preview = document.getElementById("preview");
  const btnOcr = document.getElementById("btnOcr");

  const ocrPct = document.getElementById("ocrPct");
  const ocrBar = document.getElementById("ocrBar");
  const ocrMsg = document.getElementById("ocrMsg");
  const ocrResult = document.getElementById("ocrResult");
  const ocrText = document.getElementById("ocrText");
  const gateMsg = document.getElementById("gateMsg");
  const statusChip = document.getElementById("statusChip");

  const feedback = document.getElementById("feedback");
  const btnSubmit = document.getElementById("btnSubmit");
  const hint2 = document.getElementById("hint2");

  // ====== Helpers ======
  function normalize(text) {
    return (text || "")
      .toLowerCase()
      .replace(/[^\w\s]/g, " ")     // drop punctuation
      .replace(/\s+/g, " ")
      .trim();
  }

  function setProgress(p, msg){
    const pct = Math.max(0, Math.min(100, Math.round(p)));
    ocrPct.textContent = pct + "%";
    ocrBar.style.width = pct + "%";
    if (msg) ocrMsg.textContent = msg;
  }

  function updateGate(){
    if (!openedOnce){
      gateMsg.textContent = "Step 1: Click “Click To Download” first.";
      btnGoFeedback.disabled = true;
      statusChip.textContent = "";
      return;
    }
    if (!ocrPassed){
      gateMsg.textContent = "Step 2: Upload + validate the screenshot to unlock Continue.";
      btnGoFeedback.disabled = true;
      statusChip.textContent = "";
      return;
    }
    gateMsg.textContent = "Verified ✅ Continue is unlocked.";
    btnGoFeedback.disabled = false;
    statusChip.textContent = "Verified ✅";
  }

  // ====== Fast OCR: do NOT hang at 5% ======
  // We pin worker/core/langPath explicitly (this avoids “stuck at 5%” issues)
  async function getWorker(){
    if (!window.Tesseract) throw new Error("Tesseract not loaded.");

    if (worker) return worker;

    worker = await Tesseract.createWorker({
      logger: m => {
        if (m.status === "recognizing text") {
          setProgress((m.progress || 0) * 100, "Reading screenshot…");
        } else if (m.status === "loading tesseract core") {
          setProgress(5, "Loading OCR core…");
        } else if (m.status === "loading language traineddata") {
          setProgress(10, "Loading language data…");
        }
      },
      workerPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",
      corePath: "https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js",
      langPath: "https://tessdata.projectnaptha.com/4.0.0"
    });

    await worker.loadLanguage("eng");
    await worker.initialize("eng");

    // PSM 6: assume a block of text (good for subject lines)
    try { await worker.setParameters({ tessedit_pageseg_mode: "6" }); } catch {}

    return worker;
  }

  // ====== Image preprocessing tuned for YOUR screenshot ======
  // - crop top area (subject line)
  // - upscale
  // - produce 3 variants:
  //   1) highlight-removal (turn colored highlight to white)
  //   2) normal threshold
  //   3) inverted threshold
  async function preprocessVariants(file){
    const img = new Image();
    const url = URL.createObjectURL(file);
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });

    const scale = Math.min(1, 1600 / img.width);
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const base = document.createElement("canvas");
    base.width = w; base.height = h;
    base.getContext("2d").drawImage(img, 0, 0, w, h);

    // Crop top ~28% where "Welcome to TikTok" subject sits in your screenshot
    const cropH = Math.max(260, Math.round(h * 0.28));
    const crop = document.createElement("canvas");
    crop.width = w; crop.height = cropH;
    crop.getContext("2d").drawImage(base, 0, 0, w, cropH, 0, 0, w, cropH);

    // Upscale 3x
    const up = document.createElement("canvas");
    up.width = crop.width * 3;
    up.height = crop.height * 3;
    const uctx = up.getContext("2d");
    uctx.imageSmoothingEnabled = true;
    uctx.drawImage(crop, 0, 0, up.width, up.height);

    const imgData = uctx.getImageData(0, 0, up.width, up.height);
    const d = imgData.data;

    const toGray = (r,g,b)=>0.299*r + 0.587*g + 0.114*b;

    function buildCanvas(mode){
      const out = new ImageData(up.width, up.height);
      const o = out.data;

      for (let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];

        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        const sat = max === 0 ? 0 : (max - min) / max; // 0..1
        const gray = toGray(r,g,b);

        let v;
        if (mode === "dehighlight") {
          // If pixel is “colored” (highlight) and not super-dark, wipe it to white.
          // This is what fixes the yellow highlight on TikTok word.
          if (sat > 0.18 && gray > 95) v = 255;
          else v = (gray > 155) ? 255 : 0;
        } else if (mode === "normal") {
          v = (gray > 165) ? 255 : 0;
        } else { // invert
          const bw = (gray > 165) ? 255 : 0;
          v = 255 - bw;
        }

        o[i]=o[i+1]=o[i+2]=v;
        o[i+3]=a;
      }

      const c = document.createElement("canvas");
      c.width = up.width; c.height = up.height;
      c.getContext("2d").putImageData(out, 0, 0);
      return c;
    }

    URL.revokeObjectURL(url);

    const canvases = [buildCanvas("dehighlight"), buildCanvas("normal"), buildCanvas("invert")];

    async function canvasToBlobSafe(canvas, type="image/jpeg", quality=0.92){
      const blob = await new Promise(res => canvas.toBlob(res, type, quality));
      if (blob) return blob;
      const dataUrl = canvas.toDataURL(type, quality);
      const resp = await fetch(dataUrl);
      return await resp.blob();
    }

    return Promise.all(canvases.map(c => canvasToBlobSafe(c)));
  }

  async function runOCR(blob){
    const w = await getWorker();
    const { data } = await w.recognize(blob);
    return data?.text || "";
  }

  function keywordPass(textRaw){
    const t = normalize(textRaw);

    // welcome must be present
    const hasWelcome = t.includes("welcome");

    // TikTok may be broken due to highlight: accept variations
    const hasTikTok =
      t.includes("tiktok") ||
      t.includes("tik tok") ||
      t.includes("tikto")  ||
      (t.includes("tik") && t.includes("tok"));

    return hasWelcome && hasTikTok;
  }

  // ====== Actions ======
  btnOpen.addEventListener("click", () => {
    window.open(offerUrl, "_blank", "noopener,noreferrer");
    openedOnce = true;
    hint.textContent = "After you finish, upload your screenshot and click “Validate screenshot”.";
    updateGate();
  });

  let currentPreviewUrl = null;

  shot.addEventListener("change", () => {
    ocrPassed = false;
    setProgress(0, "");
    ocrMsg.textContent = "";
    ocrResult.classList.add("hidden");
    ocrText.textContent = "";
    statusChip.textContent = "";

    const file = shot.files && shot.files[0];
    if (!file){
      previewWrap.classList.add("hidden");
      btnOcr.disabled = true;
      updateGate();
      return;
    }

    if (!file.type.startsWith("image/")){
      btnOcr.disabled = true;
      ocrMsg.textContent = "Please upload an image.";
      updateGate();
      return;
    }

    if (currentPreviewUrl) URL.revokeObjectURL(currentPreviewUrl);
    currentPreviewUrl = URL.createObjectURL(file);
    preview.src = currentPreviewUrl;
    previewWrap.classList.remove("hidden");

    btnOcr.disabled = false;
    ocrMsg.textContent = "Ready to validate.";
    updateGate();
  });

  btnOcr.addEventListener("click", async () => {
    const file = shot.files && shot.files[0];
    if (!file) return;

    btnOcr.disabled = true;
    btnGoFeedback.disabled = true;
    ocrPassed = false;
    statusChip.textContent = "";
    ocrResult.classList.add("hidden");
    ocrText.textContent = "";

    try {
      setProgress(3, "Preparing screenshot…");

      const variants = await preprocessVariants(file);

      let best = { raw: "", ok: false };

      // Try variants (dehighlight first) – fast and reliable for your highlighted TikTok text
      for (let i=0;i<variants.length;i++){
        setProgress(10 + i*10, "Running OCR…");
        const raw = await runOCR(variants[i]);
        const ok = keywordPass(raw);

        if (ok){
          best = { raw, ok: true };
          break;
        }
        if (raw.length > best.raw.length) best = { raw, ok: false };
      }

      ocrResult.classList.remove("hidden");
      ocrText.textContent = best.raw.slice(0, 1500) + (best.raw.length > 1500 ? "\n…(truncated)" : "");

      setProgress(100, "Done.");

      if (best.ok){
        ocrPassed = true;
        ocrMsg.textContent = "✅ Verified: Welcome email detected. Continue is unlocked.";
      } else {
        ocrPassed = false;
        ocrMsg.textContent =
          "❌ Not verified. Please upload a clearer screenshot where the subject line “Welcome to TikTok” is visible (top area).";
      }

    } catch (e){
      ocrPassed = false;
      setProgress(0, "Error.");
      ocrMsg.textContent =
        "❌ OCR failed. Common causes: blocked CDN or very large screenshot. Try again with a clearer screenshot.";
    } finally {
      btnOcr.disabled = false;
      updateGate();
    }
  });

  btnGoFeedback.addEventListener("click", () => {
    if (!openedOnce) { hint.textContent = "Please click “Click To Download” first."; return; }
    if (!ocrPassed) { hint.textContent = "Please validate the screenshot first."; return; }

    feedback.classList.remove("hidden");
    feedback.scrollIntoView({ behavior: "smooth" });
    validateFeedback();
  });

  function validateFeedback(){
    const ok =
      document.querySelector('input[name="fb_impression"]:checked') &&
      document.querySelector('input[name="fb_signup"]:checked') &&
      document.querySelector('input[name="fb_likely"]:checked');
    btnSubmit.disabled = !ok;
    hint2.textContent = ok ? "" : "Please answer the required questions.";
  }

  document.querySelectorAll('input[name="fb_impression"], input[name="fb_signup"], input[name="fb_likely"]')
    .forEach(r => r.addEventListener("change", validateFeedback));

  btnSubmit.addEventListener("click", () => {
    window.location.href = COMPLETE_URL;
  });

  window.addEventListener("beforeunload", async () => {
    try { if (worker) await worker.terminate(); } catch {}
  });

  updateGate();
</script>

</body>
</html>

